{% extends "base.html" %}

{% block content %}
<div class="space-y-4">
    <!-- Service Health Status Bar (Gap #13) -->
    <div class="panel p-3"
         id="service-health-container"
         hx-get="/partials/service-health"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <!-- Skeleton loader while health check loads -->
        <div class="flex items-center gap-3 text-sm">
            <div class="flex items-center gap-2">
                <div class="h-3 w-3 skeleton rounded-full"></div>
                <div class="h-4 w-32 skeleton rounded"></div>
            </div>
            <div class="h-4 w-px skeleton"></div>
            <div class="h-4 w-16 skeleton rounded"></div>
            <div class="h-4 w-16 skeleton rounded"></div>
            <div class="ml-auto h-3 w-24 skeleton rounded"></div>
        </div>
    </div>

    <!-- Application Statistics Progress Bars (Compact) -->
    <div id="application-stats-container"
         hx-get="/partials/application-stats"
         hx-trigger="load, every 60s"
         hx-swap="innerHTML">
        <!-- Progress bars loaded via HTMX with auto-refresh every 60 seconds -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Analytics Dashboard Section -->
    <details id="analytics-dashboard-details" class="panel">
        <summary class="p-2 cursor-pointer select-none flex items-center gap-2 text-sm font-medium theme-text-secondary hover:theme-text-primary transition-colors">
            <svg class="h-4 w-4 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>ðŸ“Š Cost & Budget Analytics</span>
            <span class="text-xs theme-text-tertiary ml-auto">(click to expand)</span>
        </summary>

        <div class="p-3 pt-0 space-y-3">
            <!-- Cost Trends Sparkline (Gap #15) -->
            <div id="cost-trends-container"
                 hx-get="/partials/cost-trends?period=hourly&count=24"
                 hx-trigger="load, every 60s"
                 hx-swap="innerHTML">
                <!-- Cost trends loaded via HTMX with auto-refresh every 60 seconds -->
                <div class="panel p-3">
                    <div class="flex items-center justify-between mb-3">
                        <div class="h-4 skeleton rounded w-24"></div>
                        <div class="flex gap-2">
                            <div class="h-5 skeleton rounded w-14"></div>
                            <div class="h-3 skeleton rounded w-6"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-grow h-10 skeleton rounded"></div>
                        <div class="space-y-1 min-w-[80px]">
                            <div class="h-3 skeleton rounded w-16"></div>
                            <div class="h-2 skeleton rounded w-12"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Budget Monitor, FireCrawl Credits & Alert History Grid (Gap #14, GAP-070 & OB-2) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                <!-- API Budget Monitor (Gap #14) -->
                <div id="budget-monitor-container"
                     hx-get="/partials/budget-monitor"
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <!-- Budget monitor loaded via HTMX with auto-refresh every 30 seconds -->
                    <div class="panel p-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="h-4 skeleton rounded w-28"></div>
                            <div class="h-3 skeleton rounded w-6"></div>
                        </div>
                        <div class="mb-3 p-2 theme-bg-secondary rounded-lg">
                            <div class="h-3 skeleton rounded w-40 mb-1"></div>
                            <div class="h-1.5 skeleton rounded mb-1"></div>
                            <div class="h-2 skeleton rounded w-20"></div>
                        </div>
                        <div class="space-y-1">
                            <div class="h-2 skeleton rounded w-16"></div>
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>

                <!-- FireCrawl Credits (GAP-070) -->
                <div id="firecrawl-credits-container"
                     hx-get="/partials/firecrawl-credits"
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <!-- FireCrawl credits loaded via HTMX with auto-refresh every 30 seconds -->
                    <div class="panel p-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="h-4 skeleton rounded w-32"></div>
                            <div class="h-3 skeleton rounded w-12"></div>
                        </div>
                        <div class="mb-3 p-2 theme-bg-secondary rounded-lg">
                            <div class="h-3 skeleton rounded w-24 mb-1"></div>
                            <div class="h-2 skeleton rounded mb-1"></div>
                            <div class="h-2 skeleton rounded w-20"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>

                <!-- Alert History (Gap OB-2) -->
                <div id="alert-history-container"
                     hx-get="/partials/alert-history"
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <!-- Alert history loaded via HTMX with auto-refresh every 30 seconds -->
                    <div class="panel p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="h-4 skeleton rounded w-24"></div>
                            <div class="h-3 skeleton rounded w-8"></div>
                        </div>
                        <div class="space-y-1">
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </details>

    <!-- Toolbar Card -->
    <div class="card">
        <div class="card-body">
            <!-- Top row: Quick Time Filters -->
            <div class="mb-4 pb-4 theme-border border-b">
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-semibold theme-text-secondary uppercase tracking-wide">Quick Time Filters</label>
                    <div class="flex flex-wrap gap-2">
                        <!-- Hour filters (blue) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'hour')" class="quick-date-btn quick-date-btn-hour btn btn-sm btn-ghost border">1h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'hour')" class="quick-date-btn quick-date-btn-hour btn btn-sm btn-ghost border">2h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 3, 'hour')" class="quick-date-btn quick-date-btn-hour btn btn-sm btn-ghost border">3h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 6, 'hour')" class="quick-date-btn quick-date-btn-hour btn btn-sm btn-ghost border">6h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 12, 'hour')" class="quick-date-btn quick-date-btn-hour btn btn-sm btn-ghost border">12h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 24, 'hour')" class="quick-date-btn quick-date-btn-hour btn btn-sm btn-ghost border">24h</button>

                        <!-- Day filters (orange) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'day')" class="quick-date-btn quick-date-btn-day btn btn-sm btn-ghost border">1d</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'day')" class="quick-date-btn quick-date-btn-day btn btn-sm btn-ghost border">2d</button>
                        <button type="button" onclick="setQuickDateFilter(this, 3, 'day')" class="quick-date-btn quick-date-btn-day btn btn-sm btn-ghost border">3d</button>
                        <button type="button" onclick="setQuickDateFilter(this, 5, 'day')" class="quick-date-btn quick-date-btn-day btn btn-sm btn-ghost border">5d</button>

                        <!-- Week filters (green) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'week')" class="quick-date-btn quick-date-btn-week btn btn-sm btn-ghost border">1w</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'week')" class="quick-date-btn quick-date-btn-week btn btn-sm btn-ghost border">2w</button>

                        <!-- Month filters (purple) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'month')" class="quick-date-btn quick-date-btn-month btn btn-sm btn-ghost border">1m</button>

                        <!-- Clear date filter -->
                        <button type="button" onclick="clearDateFilter()" class="btn btn-sm btn-ghost">Clear</button>

                        <!-- Reset ALL filters -->
                        <button type="button" onclick="resetAllFilters()" class="btn btn-sm btn-error btn-ghost" title="Reset all filters to defaults">Reset All</button>

                        <!-- LinkedIn Multi-Import Dropdown -->
                        <div class="ml-2 border-l theme-border pl-2">
                            {% include 'components/linkedin_import.html' %}
                        </div>

                        <!-- Indeed Multi-Import Dropdown -->
                        <div class="ml-2 border-l theme-border pl-2">
                            {% include 'components/indeed_import.html' %}
                        </div>

                        <!-- Show Applied Only toggle -->
                        <label class="flex items-center gap-2 cursor-pointer ml-4">
                            <input type="checkbox"
                                   id="applied-only-checkbox"
                                   name="applied_only"
                                   value="true"
                                   class="filter-input h-4 w-4 rounded border-gray-300 text-accent-500 focus:ring-accent-500"
                                   hx-get="/partials/job-rows"
                                   hx-trigger="change"
                                   hx-target="#job-table-container"
                                   hx-include=".filter-input">
                            <span class="text-sm font-medium theme-text-secondary">Applied Only</span>
                        </label>

                        <!-- Leadership Only toggle -->
                        <label class="flex items-center gap-2 cursor-pointer ml-4">
                            <input type="checkbox"
                                   id="leadership-only-checkbox"
                                   name="leadership_only"
                                   value="true"
                                   class="filter-input h-4 w-4 rounded border-gray-300 text-amber-500 focus:ring-amber-500"
                                   hx-get="/partials/job-rows"
                                   hx-trigger="change"
                                   hx-target="#job-table-container"
                                   hx-include=".filter-input">
                            <span class="text-sm font-medium theme-text-secondary">Leadership Only</span>
                            <span class="text-xs theme-text-tertiary" title="CTO, VP, Director roles">(C-level)</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-4">
                <!-- Search - Full width on mobile -->
                <div class="w-full sm:flex-1 sm:min-w-[200px]">
                    <div class="relative">
                        <input type="text"
                               id="search-input"
                               placeholder="Search jobs..."
                               class="filter-input form-input pl-10"
                               hx-get="/partials/job-rows"
                               hx-trigger="keyup changed delay:300ms, search"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               name="query">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Filter toggle button -->
                <button type="button"
                        onclick="toggleFilters()"
                        class="btn btn-secondary btn-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <span>More Filters</span>
                    <span id="active-filter-count" class="hidden badge badge-primary ml-2"></span>
                </button>

                <!-- Bottom row on mobile: page size, selection, delete -->
                <div class="flex flex-wrap items-center justify-between sm:justify-start gap-4">
                    <!-- Page size selector -->
                    <div class="flex items-center gap-2">
                        <label for="page-size-select" class="text-sm theme-text-secondary font-medium">Show:</label>
                        <select id="page-size-select"
                                name="page_size"
                                class="filter-input form-select py-1.5"
                                hx-get="/partials/job-rows"
                                hx-trigger="change"
                                hx-target="#job-table-container"
                                hx-include=".filter-input">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <!-- Selection info & action buttons -->
                    <div class="flex items-center gap-3">
                        <span class="text-sm theme-text-secondary">
                            <span class="hidden sm:inline">Selected: </span><span id="selection-count" class="font-semibold">0</span><span class="sm:hidden"> sel.</span>
                        </span>
                        <!-- Process Selected Button with Tier Dropdown -->
                        <div id="tier-dropdown" class="relative btn-with-hint" x-data="{ open: false }" @click.away="open = false">
                            <input type="hidden" id="bulk-selected-tier" value="auto">
                            <div class="flex items-center">
                                <button id="process-selected-btn"
                                        onclick="processSelectedJobs()"
                                        disabled
                                        class="btn btn-success btn-md rounded-r-none border-r border-green-700">
                                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    <span id="bulk-process-btn-label" class="hidden sm:inline">Process (Auto)</span>
                                    <span class="sm:hidden">Process</span>
                                </button>
                                <button @click="open = !open"
                                        id="process-tier-toggle"
                                        disabled
                                        class="btn btn-success btn-md rounded-l-none px-2">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </div>
                            <!-- Tier dropdown menu -->
                            <div x-show="open" x-cloak x-transition
                                 class="absolute left-0 mt-2 w-72 rounded-lg shadow-xl bg-white dark:bg-gray-800 border theme-border z-[100]">
                                <div class="py-1">
                                    <div class="px-4 py-2 text-xs font-semibold theme-text-tertiary uppercase tracking-wide border-b theme-border">
                                        Processing Tier
                                    </div>
                                    <button onclick="setBulkProcessingTier('auto')" @click="open = false"
                                            class="bulk-tier-option w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-3" data-tier="auto">
                                        <span class="w-6 h-6 rounded-full bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                                            <svg class="w-3 h-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                            </svg>
                                        </span>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm">Auto</div>
                                            <div class="text-xs theme-text-tertiary">Based on fit score</div>
                                        </div>
                                    </button>
                                    <button onclick="setBulkProcessingTier('A')" @click="open = false"
                                            class="bulk-tier-option w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-3" data-tier="A">
                                        <span class="w-6 h-6 rounded-full bg-yellow-100 dark:bg-yellow-900 flex items-center justify-center">
                                            <svg class="w-3 h-3 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                            </svg>
                                        </span>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm">Gold (A)</div>
                                            <div class="text-xs theme-text-tertiary">Premium models</div>
                                        </div>
                                    </button>
                                    <button onclick="setBulkProcessingTier('B')" @click="open = false"
                                            class="bulk-tier-option w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-3" data-tier="B">
                                        <span class="w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                            <svg class="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </span>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm">Silver (B)</div>
                                            <div class="text-xs theme-text-tertiary">Standard models</div>
                                        </div>
                                    </button>
                                    <button onclick="setBulkProcessingTier('C')" @click="open = false"
                                            class="bulk-tier-option w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-3" data-tier="C">
                                        <span class="w-6 h-6 rounded-full bg-orange-100 dark:bg-orange-900 flex items-center justify-center">
                                            <svg class="w-3 h-3 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </span>
                                        <div class="flex-1">
                                            <div class="font-medium text-sm">Bronze (C)</div>
                                            <div class="text-xs theme-text-tertiary">Economy models</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            <span class="shortcut-hint">(T)</span>
                        </div>
                        <!-- Star Selected Button -->
                        <div class="btn-with-hint">
                            <button id="star-selected-btn"
                                    onclick="toggleSelectedFavorites()"
                                    disabled
                                    class="btn btn-secondary btn-md"
                                    style="--btn-bg: var(--bg-secondary); --btn-hover-bg: rgba(234, 179, 8, 0.2);">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                                </svg>
                                <span class="hidden sm:inline">Star</span>
                            </button>
                            <span class="shortcut-hint">(F)</span>
                        </div>
                        <!-- Move to Batch Button -->
                        <div class="btn-with-hint">
                            <button id="move-to-batch-btn"
                                    onclick="moveSelectedToBatch()"
                                    disabled
                                    class="btn btn-secondary btn-md">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                                <span class="hidden sm:inline">Move to Batch</span>
                                <span class="sm:hidden">Batch</span>
                            </button>
                            <span class="shortcut-hint">(B)</span>
                        </div>
                        <!-- Mark as Applied Button -->
                        <div class="btn-with-hint">
                            <button id="apply-selected-btn"
                                    onclick="markSelectedAsApplied()"
                                    disabled
                                    class="btn btn-primary btn-md">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span class="hidden sm:inline">Mark Applied</span>
                                <span class="sm:hidden">Applied</span>
                            </button>
                            <span class="shortcut-hint">(A)</span>
                        </div>
                        <!-- Discard Selected Button -->
                        <div class="btn-with-hint">
                            <button id="discard-selected-btn"
                                    onclick="markSelectedAsDiscarded()"
                                    disabled
                                    class="btn btn-warning btn-md">
                                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                                </svg>
                                <span class="hidden sm:inline">Discard Selected</span>
                                <span class="sm:hidden">Discard</span>
                            </button>
                            <span class="shortcut-hint">(D)</span>
                        </div>
                        <div class="btn-with-hint">
                            <button id="delete-selected-btn"
                                    onclick="openDeleteModal()"
                                    disabled
                                    class="btn btn-danger btn-md">
                                <span class="hidden sm:inline">Delete Selected</span>
                                <span class="sm:hidden">Delete</span>
                            </button>
                            <span class="shortcut-hint">(âŒ«)</span>
                        </div>
                    </div>

                    <!-- Loading indicator -->
                    <div class="htmx-indicator">
                        <div class="spinner spinner-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Panel (collapsible) -->
    <div id="filter-panel" class="hidden card">
        <div class="card-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Date Range Filter (GAP-016: Enhanced with datetime-local for hour/minute precision) -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Custom Date Range</label>
                    <div class="flex items-center gap-2">
                        <input type="datetime-local"
                               id="date-from"
                               name="datetime_from"
                               class="filter-input form-input text-sm"
                               hx-get="/partials/job-rows"
                               hx-trigger="change"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               title="Start date and time">
                        <span class="theme-text-tertiary">to</span>
                        <input type="datetime-local"
                               id="date-to"
                               name="datetime_to"
                               class="filter-input form-input text-sm"
                               hx-get="/partials/job-rows"
                               hx-trigger="change"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               title="End date and time">
                    </div>
                </div>

                <!-- Status Multi-Select Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Status</label>
                    <div class="space-y-1.5 max-h-48 overflow-y-auto theme-border border rounded-md p-2">
                        {% for status in statuses %}
                        <label class="flex items-center gap-2 p-1.5 hover:theme-bg-hover rounded cursor-pointer transition-colors select-none">
                            <input type="checkbox"
                                   name="statuses"
                                   value="{{ status }}"
                                   class="filter-input status-checkbox h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500 focus:ring-offset-0 flex-shrink-0"
                                   {% if status not in ['discarded', 'applied', 'interview scheduled', 'under processing'] %}checked{% endif %}
                                   onchange="updateStatusFilter()"
                                   hx-get="/partials/job-rows"
                                   hx-trigger="change"
                                   hx-target="#job-table-container"
                                   hx-include=".filter-input">
                            <span class="text-sm theme-text-primary truncate">{{ status }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button"
                                onclick="selectAllStatuses()"
                                class="text-xs text-accent-500 hover:text-accent-400 underline font-medium">
                            Select All
                        </button>
                        <button type="button"
                                onclick="deselectAllStatuses()"
                                class="text-xs theme-text-secondary hover:theme-text-primary underline font-medium">
                            Deselect All
                        </button>
                    </div>
                </div>

                <!-- Location Multi-Select Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Location</label>
                    <div class="relative">
                        <button type="button"
                                id="location-dropdown-btn"
                                onclick="toggleLocationDropdown()"
                                class="form-select w-full flex items-center justify-between">
                            <span id="location-btn-text" class="truncate theme-text-tertiary">Select locations...</span>
                            <svg class="h-4 w-4 theme-text-tertiary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="location-dropdown"
                             class="hidden absolute z-20 mt-1 w-full theme-bg-card theme-border border rounded-md shadow-lg max-h-60 overflow-auto">
                            <div class="p-2 theme-border border-b">
                                <input type="text"
                                       id="location-search"
                                       placeholder="Search locations..."
                                       class="form-input py-1.5"
                                       oninput="filterLocations(this.value)">
                            </div>
                            <div id="location-options" class="py-1">
                                <!-- Options loaded dynamically -->
                                <div class="px-3 py-2 text-sm theme-text-tertiary">Loading locations...</div>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden inputs for selected locations (populated by JS) -->
                    <div id="selected-locations-inputs"></div>
                </div>

                <!-- Clear Filters -->
                <div class="flex items-end">
                    <button type="button"
                            onclick="clearAllFilters()"
                            class="btn btn-ghost btn-md">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Table -->
    <div class="card">
        <div class="overflow-hidden">
            <div id="job-table-container"
                 hx-get="/partials/job-rows"
                 hx-trigger="refresh from:body"
                 hx-include=".filter-input"
                 hx-indicator=".htmx-indicator">
                <!-- Table content loaded via HTMX -->
                <div class="p-8 text-center theme-text-tertiary">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="mt-2 text-sm font-medium theme-text-secondary">Loading jobs...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Row Context Menu -->
<div id="job-context-menu" class="cli-context-menu hidden" style="position: fixed; z-index: 9999;">
    <button onclick="contextMenuAction('batch')" class="cli-context-item">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
        Move to Batch
    </button>
    <button onclick="contextMenuAction('open')" class="cli-context-item">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
        </svg>
        Open in New Tab
    </button>
    <button id="context-menu-open-job-url" onclick="contextMenuAction('openJobUrl')" class="cli-context-item">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
        </svg>
        Open Job URL
    </button>
    <div class="cli-context-divider"></div>
    <button onclick="contextMenuAction('applied')" class="cli-context-item">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        Mark as Applied
    </button>
    <button onclick="contextMenuAction('discard')" class="cli-context-item">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
        </svg>
        Discard
    </button>
</div>

{# JD Preview Sidebar - reuses batch sidebar system #}
{% include 'partials/batch/_batch_sidebars.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/batch-sidebars.js') }}"></script>
<script>
    // ============================================================================
    // Filter State Management
    // ============================================================================

    let allLocations = [];
    let selectedLocations = new Set();

    // Toggle filter panel visibility
    function toggleFilters() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('hidden');
    }

    // ============================================================================
    // Location Multi-Select Dropdown
    // ============================================================================

    // Load locations from API with optional date filtering
    async function loadLocations(datetimeFrom = '', datetimeTo = '') {
        try {
            const params = new URLSearchParams();
            if (datetimeFrom) params.set('datetime_from', datetimeFrom);
            if (datetimeTo) params.set('datetime_to', datetimeTo);

            const url = '/api/locations' + (params.toString() ? '?' + params.toString() : '');

            // Show loading state
            renderLocationOptions([], true);

            const response = await fetch(url);
            const data = await response.json();
            allLocations = data.locations || [];
            renderLocationOptions(allLocations);

            // Validate selected locations still exist in filtered list
            validateSelectedLocations();
        } catch (err) {
            console.error('Failed to load locations:', err);
            document.getElementById('location-options').innerHTML =
                '<div class="px-3 py-2 text-sm text-red-500">Failed to load locations</div>';
        }
    }

    // Validate that selected locations still exist after filtering
    function validateSelectedLocations() {
        if (selectedLocations.size === 0) return;

        const validLocationNames = new Set(allLocations.map(l => l.location));
        const invalidLocations = Array.from(selectedLocations).filter(loc => !validLocationNames.has(loc));

        if (invalidLocations.length > 0) {
            // Remove invalid locations from selection
            invalidLocations.forEach(loc => selectedLocations.delete(loc));
            updateLocationButtonText();
            updateSelectedLocationInputs();
            updateActiveFilterCount();
        }
    }

    // Render location options in dropdown
    function renderLocationOptions(locations, isLoading = false) {
        const container = document.getElementById('location-options');
        if (isLoading) {
            container.innerHTML = '<div class="px-3 py-2 text-sm theme-text-tertiary">Loading locations...</div>';
            return;
        }
        if (locations.length === 0) {
            container.innerHTML = '<div class="px-3 py-2 text-sm theme-text-tertiary">No locations found</div>';
            return;
        }

        container.innerHTML = locations.map(loc => `
            <label class="location-option flex items-center px-3 py-2 hover:theme-bg-hover cursor-pointer transition-colors"
                   data-location="${escapeHtml(loc.location)}">
                <input type="checkbox"
                       class="h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500"
                       value="${escapeHtml(loc.location)}"
                       ${selectedLocations.has(loc.location) ? 'checked' : ''}
                       onchange="toggleLocation('${escapeJs(loc.location)}', this.checked)">
                <span class="ml-2 text-sm theme-text-primary truncate flex-1">${escapeHtml(loc.location)}</span>
                <span class="ml-2 text-xs theme-text-tertiary">(${loc.count})</span>
            </label>
        `).join('');
    }

    // Toggle location dropdown visibility
    function toggleLocationDropdown() {
        const dropdown = document.getElementById('location-dropdown');
        dropdown.classList.toggle('hidden');

        // Close when clicking outside
        if (!dropdown.classList.contains('hidden')) {
            setTimeout(() => {
                document.addEventListener('click', closeLocationDropdownOnClickOutside);
            }, 0);
        }
    }

    function closeLocationDropdownOnClickOutside(event) {
        const dropdown = document.getElementById('location-dropdown');
        const btn = document.getElementById('location-dropdown-btn');

        if (!dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
            document.removeEventListener('click', closeLocationDropdownOnClickOutside);
        }
    }

    // Filter locations by search text
    function filterLocations(searchText) {
        const filtered = allLocations.filter(loc =>
            loc.location.toLowerCase().includes(searchText.toLowerCase())
        );
        renderLocationOptions(filtered);
    }

    // Toggle a location selection
    function toggleLocation(location, isSelected) {
        if (isSelected) {
            selectedLocations.add(location);
        } else {
            selectedLocations.delete(location);
        }
        updateLocationButtonText();
        updateSelectedLocationInputs();
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    // Update the button text to show selected locations
    function updateLocationButtonText() {
        const btn = document.getElementById('location-btn-text');
        const count = selectedLocations.size;

        if (count === 0) {
            btn.textContent = 'Select locations...';
            btn.className = 'truncate theme-text-tertiary';
        } else if (count === 1) {
            btn.textContent = Array.from(selectedLocations)[0];
            btn.className = 'truncate theme-text-primary';
        } else {
            btn.textContent = `${count} locations selected`;
            btn.className = 'truncate theme-text-primary';
        }
    }

    // Update hidden inputs for form submission
    function updateSelectedLocationInputs() {
        const container = document.getElementById('selected-locations-inputs');
        container.innerHTML = Array.from(selectedLocations).map(loc =>
            `<input type="hidden" class="filter-input" name="locations" value="${escapeHtml(loc)}">`
        ).join('');
    }

    // ============================================================================
    // Filter Actions
    // ============================================================================

    // Clear all filters
    function clearAllFilters() {
        // Clear date inputs (GAP-016: now datetime-local inputs)
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';

        // Remove active state from quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Clear locations
        selectedLocations.clear();
        updateLocationButtonText();
        updateSelectedLocationInputs();

        // Uncheck all location checkboxes
        document.querySelectorAll('#location-options input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });

        // Clear search
        document.getElementById('search-input').value = '';

        // Update filter count
        updateActiveFilterCount();

        // Refresh table
        triggerTableRefresh();
    }

    // Update active filter count badge
    function updateActiveFilterCount() {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        const locationCount = selectedLocations.size;

        let count = 0;
        if (dateFrom || dateTo) count++;
        if (locationCount > 0) count++;

        const badge = document.getElementById('active-filter-count');
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Trigger HTMX table refresh with current filters
    // GAP-FIX: Guard against htmx not being loaded yet (CDN race condition)
    function triggerTableRefresh() {
        if (typeof htmx !== 'undefined') {
            htmx.trigger('#job-table-container', 'refresh');
        } else {
            // htmx not loaded yet - retry after a short delay
            setTimeout(triggerTableRefresh, 100);
        }
    }

    // ============================================================================
    // Utility Functions
    // ============================================================================

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeJs(text) {
        return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================
    // Quick Date Filter
    // ============================================================================

    // Set quick date filter (hours, weeks, or months ago)
    // GAP-016: Updated to use datetime-local format for hour/minute precision
    function setQuickDateFilter(button, amount, unit) {
        const now = new Date();
        let fromDate = new Date();

        switch (unit) {
            case 'hour':
                fromDate.setTime(now.getTime() - (amount * 60 * 60 * 1000));
                break;
            case 'day':
                fromDate.setTime(now.getTime() - (amount * 24 * 60 * 60 * 1000));
                break;
            case 'week':
                fromDate.setTime(now.getTime() - (amount * 7 * 24 * 60 * 60 * 1000));
                break;
            case 'month':
                fromDate.setMonth(now.getMonth() - amount);
                break;
        }

        // Format for datetime-local input: YYYY-MM-DDTHH:MM in UTC
        // MongoDB stores dates in UTC, so we must send UTC times for correct filtering
        const formatDateTimeUTC = (d) => {
            const year = d.getUTCFullYear();
            const month = String(d.getUTCMonth() + 1).padStart(2, '0');
            const day = String(d.getUTCDate()).padStart(2, '0');
            const hours = String(d.getUTCHours()).padStart(2, '0');
            const minutes = String(d.getUTCMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        // Set datetime-local inputs directly (GAP-016: inputs now have datetime_from/datetime_to names)
        document.getElementById('date-from').value = formatDateTimeUTC(fromDate);
        document.getElementById('date-to').value = formatDateTimeUTC(now);

        // Update active state for buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');

        // Update active filter count
        updateActiveFilterCount();

        // Refresh locations with new date range
        loadLocations(
            document.getElementById('date-from').value,
            document.getElementById('date-to').value
        );

        // Trigger table refresh
        triggerTableRefresh();
    }

    // Clear date filter
    function clearDateFilter() {
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';

        // Remove active state from all quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Update active filter count
        updateActiveFilterCount();

        // Reload all locations (no date filter)
        loadLocations();

        // Trigger table refresh
        triggerTableRefresh();
    }

    // Status filter functions
    function updateStatusFilter() {
        updateActiveFilterCount();
        // HTMX will handle the refresh automatically via hx-trigger="change"
    }

    function selectAllStatuses() {
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    function deselectAllStatuses() {
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    // Reset statuses to default (all checked except discarded, applied, interview scheduled)
    function resetStatusesToDefault() {
        const excludedStatuses = ['discarded', 'applied', 'interview scheduled', 'under processing'];
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = !excludedStatuses.includes(checkbox.value);
        });
        updateActiveFilterCount();
    }

    // Reset ALL filters (date + status + search + locations + applied-only)
    function resetAllFilters() {
        // Clear date filter
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Reset status to defaults
        resetStatusesToDefault();

        // Clear search
        document.getElementById('search-input').value = '';

        // Clear locations
        selectedLocations.clear();
        updateLocationButtonText();
        updateSelectedLocationInputs();

        // Uncheck all location checkboxes
        document.querySelectorAll('#location-options input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });

        // Clear applied-only checkbox
        document.getElementById('applied-only-checkbox').checked = false;

        // Clear leadership-only checkbox
        document.getElementById('leadership-only-checkbox').checked = false;

        // Reload all locations (no date filter)
        loadLocations();

        // Update active filter count
        updateActiveFilterCount();

        // Trigger table refresh
        triggerTableRefresh();
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================

    // Debounce helper for performance optimization
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // Update filter count when date inputs change
    document.getElementById('date-from')?.addEventListener('change', updateActiveFilterCount);
    document.getElementById('date-to')?.addEventListener('change', updateActiveFilterCount);

    // Refresh locations when custom date range changes (debounced to avoid excessive API calls)
    const refreshLocationsDebounced = debounce(() => {
        loadLocations(
            document.getElementById('date-from').value,
            document.getElementById('date-to').value
        );
    }, 300);

    document.getElementById('date-from')?.addEventListener('change', refreshLocationsDebounced);
    document.getElementById('date-to')?.addEventListener('change', refreshLocationsDebounced);

    // Set default filters on page load: 1-hour date filter + default statuses
    // Only apply defaults if user doesn't have active filters (from URL params or checkbox state)
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user has existing filters (from URL params or checkbox state)
        const appliedOnlyChecked = document.getElementById('applied-only-checkbox')?.checked;
        const urlParams = new URLSearchParams(window.location.search);
        const hasUrlFilters = urlParams.has('applied_only') || urlParams.has('datetime_from');

        // Only set defaults if no existing filters
        if (!appliedOnlyChecked && !hasUrlFilters) {
            // Reset statuses to default (overrides any browser-cached form state)
            resetStatusesToDefault();

            // Find the 1h button and trigger the filter
            const oneHourBtn = document.querySelector('.quick-date-btn-hour');
            if (oneHourBtn && oneHourBtn.textContent.trim() === '1h') {
                setQuickDateFilter(oneHourBtn, 1, 'hour');
            }
        } else {
            // User has filters - just load locations without triggering refresh
            loadLocations(
                document.getElementById('date-from').value,
                document.getElementById('date-to').value
            );
        }
    });

    // Make table refresh include filters via HTMX
    document.body.addEventListener('htmx:configRequest', function(event) {
        if (event.target.id === 'job-table-container') {
            // Date parameters are already included via hx-include=".filter-input"
            // (inputs have name="datetime_from" and name="datetime_to" with class="filter-input")

            // Status parameters are already included via hx-include=".filter-input"
            // (checkboxes have class="filter-input status-checkbox" and name="statuses")

            // Include selected locations (these are dynamically generated hidden inputs)
            selectedLocations.forEach(loc => {
                if (!event.detail.parameters['locations']) {
                    event.detail.parameters['locations'] = [];
                }
                if (Array.isArray(event.detail.parameters['locations'])) {
                    event.detail.parameters['locations'].push(loc);
                } else {
                    event.detail.parameters['locations'] = [event.detail.parameters['locations'], loc];
                }
            });
        }
    });

    // ============================================================================
    // Keyboard Shortcuts for Job Actions
    // ============================================================================
    // Backspace/Delete: Delete selected (with confirmation)
    // D: Discard selected
    // B: Move to Batch
    // A: Mark as Applied
    // T: Toggle tier dropdown
    // 1-4 (when tier dropdown open): Select tier option

    // Track which dropdown is open for number key selection
    let activeDropdown = null; // 'tier' | null

    // Tier options mapping (1-4 keys)
    const tierOptions = ['auto', 'A', 'B', 'C'];

    // Toggle tier dropdown
    function toggleTierDropdown() {
        const dropdown = document.getElementById('tier-dropdown');
        if (dropdown && dropdown.__x) {
            const isOpen = dropdown.__x.$data.open;
            if (isOpen) {
                dropdown.__x.$data.open = false;
                activeDropdown = null;
            } else {
                dropdown.__x.$data.open = true;
                activeDropdown = 'tier';
            }
        }
    }

    // Close tier dropdown
    function closeTierDropdown() {
        const dropdown = document.getElementById('tier-dropdown');
        if (dropdown && dropdown.__x) {
            dropdown.__x.$data.open = false;
        }
        activeDropdown = null;
    }

    // Select tier by index (0-3)
    function selectTierByIndex(index) {
        if (index >= 0 && index < tierOptions.length) {
            setBulkProcessingTier(tierOptions[index]);
            closeTierDropdown();
        }
    }

    document.addEventListener('keydown', function(e) {
        // Skip if user is typing in an input field
        const activeElement = document.activeElement;
        const isInputFocused = activeElement && (
            (activeElement.tagName === 'INPUT' && activeElement.type !== 'checkbox') ||
            activeElement.tagName === 'TEXTAREA' ||
            activeElement.tagName === 'SELECT' ||
            activeElement.isContentEditable
        );

        if (isInputFocused) return;

        // Handle Escape to close dropdown
        if (e.key === 'Escape' && activeDropdown) {
            e.preventDefault();
            closeTierDropdown();
            return;
        }

        // Handle number keys when dropdown is open
        if (activeDropdown === 'tier' && e.key >= '1' && e.key <= '4') {
            e.preventDefault();
            selectTierByIndex(parseInt(e.key) - 1);
            return;
        }

        // Only act on other shortcuts if jobs are selected
        if (typeof selectedJobIds === 'undefined' || selectedJobIds.size === 0) return;

        switch (e.key) {
            case 'Backspace':
            case 'Delete':
                e.preventDefault();
                openDeleteModal();
                break;
            case 'd':
            case 'D':
                e.preventDefault();
                markSelectedAsDiscarded();
                break;
            case 'b':
            case 'B':
                e.preventDefault();
                moveSelectedToBatch();
                break;
            case 'a':
            case 'A':
                e.preventDefault();
                markSelectedAsApplied();
                break;
            case 't':
            case 'T':
                e.preventDefault();
                toggleTierDropdown();
                break;
            case 'f':
            case 'F':
                e.preventDefault();
                toggleSelectedFavorites();
                break;
        }
    });

    // ============================================================================
    // Star/Favorite Selected Jobs
    // ============================================================================

    async function toggleSelectedFavorites() {
        const jobIds = Array.from(selectedJobIds);
        if (jobIds.length === 0) return;

        // Use bulk toggle to star all selected jobs
        const result = await toggleFavoriteBulk(jobIds, true);

        if (result !== null) {
            // Refresh the table to show updated star states
            htmx.trigger('#job-table-container', 'refresh');
        }
    }

    // ============================================================================
    // Shortcut Hint Visibility
    // ============================================================================
    // Show/hide shortcut hints based on job selection

    function updateShortcutHintVisibility() {
        const hasSelection = typeof selectedJobIds !== 'undefined' && selectedJobIds.size > 0;
        document.querySelectorAll('.shortcut-hint').forEach(hint => {
            hint.classList.toggle('visible', hasSelection);
        });
    }

    // Hook into the existing selection count update (called from job_rows.html)
    const originalUpdateSelectionCount = window.updateSelectionCount;
    window.updateSelectionCount = function() {
        if (originalUpdateSelectionCount) {
            originalUpdateSelectionCount.apply(this, arguments);
        }
        updateShortcutHintVisibility();
    };
</script>
{% endblock %}
