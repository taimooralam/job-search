{% extends "base.html" %}

{% block content %}
<div class="space-y-4">
    <!-- Service Health Status Bar (Gap #13) -->
    <div class="panel p-3"
         id="service-health-container"
         hx-get="/partials/service-health"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <!-- Skeleton loader while health check loads -->
        <div class="flex items-center gap-3 text-sm">
            <div class="flex items-center gap-2">
                <div class="h-3 w-3 skeleton rounded-full"></div>
                <div class="h-4 w-32 skeleton rounded"></div>
            </div>
            <div class="h-4 w-px skeleton"></div>
            <div class="h-4 w-16 skeleton rounded"></div>
            <div class="h-4 w-16 skeleton rounded"></div>
            <div class="ml-auto h-3 w-24 skeleton rounded"></div>
        </div>
    </div>

    <!-- Application Statistics Progress Bars (Compact) -->
    <div id="application-stats-container"
         hx-get="/partials/application-stats"
         hx-trigger="load, every 60s"
         hx-swap="innerHTML">
        <!-- Progress bars loaded via HTMX with auto-refresh every 60 seconds -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
            <div class="panel p-2">
                <div>
                    <div class="h-3 skeleton rounded w-16 mb-1"></div>
                    <div class="h-6 skeleton rounded w-12 mb-2"></div>
                    <div class="h-1.5 skeleton rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Analytics Dashboard Section -->
    <details id="analytics-dashboard-details" class="panel">
        <summary class="p-2 cursor-pointer select-none flex items-center gap-2 text-sm font-medium theme-text-secondary hover:theme-text-primary transition-colors">
            <svg class="h-4 w-4 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            <span>ðŸ“Š Cost & Budget Analytics</span>
            <span class="text-xs theme-text-tertiary ml-auto">(click to expand)</span>
        </summary>

        <div class="p-3 pt-0 space-y-3">
            <!-- Cost Trends Sparkline (Gap #15) -->
            <div id="cost-trends-container"
                 hx-get="/partials/cost-trends?period=hourly&count=24"
                 hx-trigger="load, every 60s"
                 hx-swap="innerHTML">
                <!-- Cost trends loaded via HTMX with auto-refresh every 60 seconds -->
                <div class="panel p-3">
                    <div class="flex items-center justify-between mb-3">
                        <div class="h-4 skeleton rounded w-24"></div>
                        <div class="flex gap-2">
                            <div class="h-5 skeleton rounded w-14"></div>
                            <div class="h-3 skeleton rounded w-6"></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex-grow h-10 skeleton rounded"></div>
                        <div class="space-y-1 min-w-[80px]">
                            <div class="h-3 skeleton rounded w-16"></div>
                            <div class="h-2 skeleton rounded w-12"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Budget Monitor & Alert History Grid (Gap #14 & OB-2) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                <!-- API Budget Monitor (Gap #14) -->
                <div id="budget-monitor-container"
                     hx-get="/partials/budget-monitor"
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <!-- Budget monitor loaded via HTMX with auto-refresh every 30 seconds -->
                    <div class="panel p-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="h-4 skeleton rounded w-28"></div>
                            <div class="h-3 skeleton rounded w-6"></div>
                        </div>
                        <div class="mb-3 p-2 theme-bg-secondary rounded-lg">
                            <div class="h-3 skeleton rounded w-40 mb-1"></div>
                            <div class="h-1.5 skeleton rounded mb-1"></div>
                            <div class="h-2 skeleton rounded w-20"></div>
                        </div>
                        <div class="space-y-1">
                            <div class="h-2 skeleton rounded w-16"></div>
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>

                <!-- Alert History (Gap OB-2) -->
                <div id="alert-history-container"
                     hx-get="/partials/alert-history"
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <!-- Alert history loaded via HTMX with auto-refresh every 30 seconds -->
                    <div class="panel p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="h-4 skeleton rounded w-24"></div>
                            <div class="h-3 skeleton rounded w-8"></div>
                        </div>
                        <div class="space-y-1">
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                            <div class="h-10 skeleton rounded"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </details>

    <!-- LinkedIn Job Import (GAP-065) -->
    <div class="card">
        <div class="card-body py-3">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
                <div class="flex items-center gap-2">
                    <svg class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    <span class="text-sm font-medium theme-text-secondary">Import LinkedIn Job:</span>
                </div>
                <div class="flex-1 flex items-center gap-2">
                    <input type="text"
                           id="linkedin-job-input"
                           placeholder="Enter job ID or URL (e.g., 4081234567)"
                           class="form-input text-sm flex-1 min-w-0 max-w-md"
                           onkeypress="if(event.key==='Enter') importLinkedInJob()">
                    <button type="button"
                            id="linkedin-import-btn"
                            onclick="importLinkedInJob()"
                            class="btn btn-primary btn-md whitespace-nowrap">
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        <span class="hidden sm:inline">Import & Score</span>
                        <span class="sm:hidden">Import</span>
                    </button>
                </div>
                <div id="linkedin-import-status" class="hidden text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="card">
        <div class="card-body">
            <!-- Top row: Quick Time Filters -->
            <div class="mb-4 pb-4 theme-border border-b">
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-semibold theme-text-secondary uppercase tracking-wide">Quick Time Filters</label>
                    <div class="flex flex-wrap gap-2">
                        <!-- Hour filters (blue) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">1h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">2h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 3, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">3h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 6, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">6h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 12, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">12h</button>

                        <!-- Week filters (green) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'week')" class="quick-date-btn btn btn-sm btn-ghost border border-green-200 text-green-700 hover:bg-green-50">1w</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'week')" class="quick-date-btn btn btn-sm btn-ghost border border-green-200 text-green-700 hover:bg-green-50">2w</button>

                        <!-- Month filters (purple) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'month')" class="quick-date-btn btn btn-sm btn-ghost border border-purple-200 text-purple-700 hover:bg-purple-50">1m</button>

                        <!-- Clear filter -->
                        <button type="button" onclick="clearDateFilter()" class="btn btn-sm btn-ghost">Clear</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-4">
                <!-- Search - Full width on mobile -->
                <div class="w-full sm:flex-1 sm:min-w-[200px]">
                    <div class="relative">
                        <input type="text"
                               id="search-input"
                               placeholder="Search jobs..."
                               class="form-input pl-10"
                               hx-get="/partials/job-rows"
                               hx-trigger="keyup changed delay:300ms, search"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               name="query">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Filter toggle button -->
                <button type="button"
                        onclick="toggleFilters()"
                        class="btn btn-secondary btn-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <span>More Filters</span>
                    <span id="active-filter-count" class="hidden badge badge-primary ml-2"></span>
                </button>

                <!-- Bottom row on mobile: page size, selection, delete -->
                <div class="flex flex-wrap items-center justify-between sm:justify-start gap-4">
                    <!-- Page size selector -->
                    <div class="flex items-center gap-2">
                        <label for="page-size-select" class="text-sm theme-text-secondary font-medium">Show:</label>
                        <select id="page-size-select"
                                name="page_size"
                                class="filter-input form-select py-1.5"
                                hx-get="/partials/job-rows"
                                hx-trigger="change"
                                hx-target="#job-table-container"
                                hx-include=".filter-input">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <!-- Selection info & action buttons -->
                    <div class="flex items-center gap-3">
                        <span class="text-sm theme-text-secondary">
                            <span class="hidden sm:inline">Selected: </span><span id="selection-count" class="font-semibold">0</span><span class="sm:hidden"> sel.</span>
                        </span>
                        <!-- Process Selected Button -->
                        <button id="process-selected-btn"
                                onclick="processSelectedJobs()"
                                disabled
                                class="btn btn-success btn-md">
                            <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            <span class="hidden sm:inline">Process Selected</span>
                            <span class="sm:hidden">Process</span>
                        </button>
                        <!-- Mark as Applied Button -->
                        <button id="apply-selected-btn"
                                onclick="markSelectedAsApplied()"
                                disabled
                                class="btn btn-primary btn-md">
                            <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span class="hidden sm:inline">Mark Applied</span>
                            <span class="sm:hidden">Applied</span>
                        </button>
                        <button id="delete-selected-btn"
                                onclick="openDeleteModal()"
                                disabled
                                class="btn btn-danger btn-md">
                            <span class="hidden sm:inline">Delete Selected</span>
                            <span class="sm:hidden">Delete</span>
                        </button>
                    </div>

                    <!-- Loading indicator -->
                    <div class="htmx-indicator">
                        <div class="spinner spinner-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Panel (collapsible) -->
    <div id="filter-panel" class="hidden card">
        <div class="card-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Date Range Filter (GAP-016: Enhanced with datetime-local for hour/minute precision) -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Custom Date Range</label>
                    <div class="flex items-center gap-2">
                        <input type="datetime-local"
                               id="date-from"
                               name="datetime_from"
                               class="filter-input form-input text-sm"
                               hx-get="/partials/job-rows"
                               hx-trigger="change"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               title="Start date and time">
                        <span class="theme-text-tertiary">to</span>
                        <input type="datetime-local"
                               id="date-to"
                               name="datetime_to"
                               class="filter-input form-input text-sm"
                               hx-get="/partials/job-rows"
                               hx-trigger="change"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               title="End date and time">
                    </div>
                </div>

                <!-- Status Multi-Select Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Status</label>
                    <div class="space-y-1.5 max-h-48 overflow-y-auto theme-border border rounded-md p-2">
                        {% for status in statuses %}
                        <label class="flex items-center gap-2 p-1.5 hover:theme-bg-hover rounded cursor-pointer transition-colors">
                            <input type="checkbox"
                                   name="statuses"
                                   value="{{ status }}"
                                   class="filter-input status-checkbox rounded theme-border text-accent-500 focus:ring-accent-500"
                                   {% if status not in ['discarded', 'applied', 'interview scheduled'] %}checked{% endif %}
                                   onchange="updateStatusFilter()"
                                   hx-get="/partials/job-rows"
                                   hx-trigger="change"
                                   hx-target="#job-table-container"
                                   hx-include=".filter-input">
                            <span class="text-sm theme-text-primary">{{ status }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button"
                                onclick="selectAllStatuses()"
                                class="text-xs text-accent-500 hover:text-accent-400 underline font-medium">
                            Select All
                        </button>
                        <button type="button"
                                onclick="deselectAllStatuses()"
                                class="text-xs theme-text-secondary hover:theme-text-primary underline font-medium">
                            Deselect All
                        </button>
                    </div>
                </div>

                <!-- Location Multi-Select Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Location</label>
                    <div class="relative">
                        <button type="button"
                                id="location-dropdown-btn"
                                onclick="toggleLocationDropdown()"
                                class="form-select w-full flex items-center justify-between">
                            <span id="location-btn-text" class="truncate theme-text-tertiary">Select locations...</span>
                            <svg class="h-4 w-4 theme-text-tertiary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="location-dropdown"
                             class="hidden absolute z-20 mt-1 w-full theme-bg-card theme-border border rounded-md shadow-lg max-h-60 overflow-auto">
                            <div class="p-2 theme-border border-b">
                                <input type="text"
                                       id="location-search"
                                       placeholder="Search locations..."
                                       class="form-input py-1.5"
                                       oninput="filterLocations(this.value)">
                            </div>
                            <div id="location-options" class="py-1">
                                <!-- Options loaded dynamically -->
                                <div class="px-3 py-2 text-sm theme-text-tertiary">Loading locations...</div>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden inputs for selected locations (populated by JS) -->
                    <div id="selected-locations-inputs"></div>
                </div>

                <!-- Clear Filters -->
                <div class="flex items-end">
                    <button type="button"
                            onclick="clearAllFilters()"
                            class="btn btn-ghost btn-md">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Table -->
    <div class="card">
        <div class="overflow-x-auto">
            <div id="job-table-container"
                 hx-get="/partials/job-rows"
                 hx-trigger="load, refresh from:body"
                 hx-include=".filter-input"
                 hx-indicator=".htmx-indicator">
                <!-- Table content loaded via HTMX -->
                <div class="p-8 text-center theme-text-tertiary">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="mt-2 text-sm font-medium theme-text-secondary">Loading jobs...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================================================
    // Filter State Management
    // ============================================================================

    let allLocations = [];
    let selectedLocations = new Set();

    // Toggle filter panel visibility
    function toggleFilters() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('hidden');
    }

    // ============================================================================
    // Location Multi-Select Dropdown
    // ============================================================================

    // Load locations from API
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const data = await response.json();
            allLocations = data.locations || [];
            renderLocationOptions(allLocations);
        } catch (err) {
            console.error('Failed to load locations:', err);
            document.getElementById('location-options').innerHTML =
                '<div class="px-3 py-2 text-sm text-red-500">Failed to load locations</div>';
        }
    }

    // Render location options in dropdown
    function renderLocationOptions(locations) {
        const container = document.getElementById('location-options');
        if (locations.length === 0) {
            container.innerHTML = '<div class="px-3 py-2 text-sm theme-text-tertiary">No locations found</div>';
            return;
        }

        container.innerHTML = locations.map(loc => `
            <label class="location-option flex items-center px-3 py-2 hover:theme-bg-hover cursor-pointer transition-colors"
                   data-location="${escapeHtml(loc.location)}">
                <input type="checkbox"
                       class="h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500"
                       value="${escapeHtml(loc.location)}"
                       ${selectedLocations.has(loc.location) ? 'checked' : ''}
                       onchange="toggleLocation('${escapeJs(loc.location)}', this.checked)">
                <span class="ml-2 text-sm theme-text-primary truncate flex-1">${escapeHtml(loc.location)}</span>
                <span class="ml-2 text-xs theme-text-tertiary">(${loc.count})</span>
            </label>
        `).join('');
    }

    // Toggle location dropdown visibility
    function toggleLocationDropdown() {
        const dropdown = document.getElementById('location-dropdown');
        dropdown.classList.toggle('hidden');

        // Close when clicking outside
        if (!dropdown.classList.contains('hidden')) {
            setTimeout(() => {
                document.addEventListener('click', closeLocationDropdownOnClickOutside);
            }, 0);
        }
    }

    function closeLocationDropdownOnClickOutside(event) {
        const dropdown = document.getElementById('location-dropdown');
        const btn = document.getElementById('location-dropdown-btn');

        if (!dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
            document.removeEventListener('click', closeLocationDropdownOnClickOutside);
        }
    }

    // Filter locations by search text
    function filterLocations(searchText) {
        const filtered = allLocations.filter(loc =>
            loc.location.toLowerCase().includes(searchText.toLowerCase())
        );
        renderLocationOptions(filtered);
    }

    // Toggle a location selection
    function toggleLocation(location, isSelected) {
        if (isSelected) {
            selectedLocations.add(location);
        } else {
            selectedLocations.delete(location);
        }
        updateLocationButtonText();
        updateSelectedLocationInputs();
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    // Update the button text to show selected locations
    function updateLocationButtonText() {
        const btn = document.getElementById('location-btn-text');
        const count = selectedLocations.size;

        if (count === 0) {
            btn.textContent = 'Select locations...';
            btn.className = 'truncate theme-text-tertiary';
        } else if (count === 1) {
            btn.textContent = Array.from(selectedLocations)[0];
            btn.className = 'truncate theme-text-primary';
        } else {
            btn.textContent = `${count} locations selected`;
            btn.className = 'truncate theme-text-primary';
        }
    }

    // Update hidden inputs for form submission
    function updateSelectedLocationInputs() {
        const container = document.getElementById('selected-locations-inputs');
        container.innerHTML = Array.from(selectedLocations).map(loc =>
            `<input type="hidden" class="filter-input" name="locations" value="${escapeHtml(loc)}">`
        ).join('');
    }

    // ============================================================================
    // Filter Actions
    // ============================================================================

    // Clear all filters
    function clearAllFilters() {
        // Clear date inputs (GAP-016: now datetime-local inputs)
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';

        // Remove active state from quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Clear locations
        selectedLocations.clear();
        updateLocationButtonText();
        updateSelectedLocationInputs();

        // Uncheck all location checkboxes
        document.querySelectorAll('#location-options input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });

        // Clear search
        document.getElementById('search-input').value = '';

        // Update filter count
        updateActiveFilterCount();

        // Refresh table
        triggerTableRefresh();
    }

    // Update active filter count badge
    function updateActiveFilterCount() {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        const locationCount = selectedLocations.size;

        let count = 0;
        if (dateFrom || dateTo) count++;
        if (locationCount > 0) count++;

        const badge = document.getElementById('active-filter-count');
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Trigger HTMX table refresh with current filters
    function triggerTableRefresh() {
        htmx.trigger('#job-table-container', 'refresh');
    }

    // ============================================================================
    // Utility Functions
    // ============================================================================

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeJs(text) {
        return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================
    // Quick Date Filter
    // ============================================================================

    // Set quick date filter (hours, weeks, or months ago)
    // GAP-016: Updated to use datetime-local format for hour/minute precision
    function setQuickDateFilter(button, amount, unit) {
        const now = new Date();
        let fromDate = new Date();

        switch (unit) {
            case 'hour':
                fromDate.setTime(now.getTime() - (amount * 60 * 60 * 1000));
                break;
            case 'week':
                fromDate.setTime(now.getTime() - (amount * 7 * 24 * 60 * 60 * 1000));
                break;
            case 'month':
                fromDate.setMonth(now.getMonth() - amount);
                break;
        }

        // Format for datetime-local input: YYYY-MM-DDTHH:MM (local time, no Z suffix)
        const formatDateTimeLocal = (d) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };

        // Set datetime-local inputs directly (GAP-016: inputs now have datetime_from/datetime_to names)
        document.getElementById('date-from').value = formatDateTimeLocal(fromDate);
        document.getElementById('date-to').value = formatDateTimeLocal(now);

        // Update active state for buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');

        // Update active filter count
        updateActiveFilterCount();

        // Trigger table refresh
        triggerTableRefresh();
    }

    // Clear date filter
    function clearDateFilter() {
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';

        // Remove active state from all quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Update active filter count
        updateActiveFilterCount();

        // Trigger table refresh
        triggerTableRefresh();
    }

    // Status filter functions
    function updateStatusFilter() {
        updateActiveFilterCount();
        // HTMX will handle the refresh automatically via hx-trigger="change"
    }

    function selectAllStatuses() {
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    function deselectAllStatuses() {
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================

    // Update filter count when date inputs change
    document.getElementById('date-from')?.addEventListener('change', updateActiveFilterCount);
    document.getElementById('date-to')?.addEventListener('change', updateActiveFilterCount);

    // Load locations on page load
    document.addEventListener('DOMContentLoaded', loadLocations);

    // Make table refresh include filters via HTMX
    document.body.addEventListener('htmx:configRequest', function(event) {
        if (event.target.id === 'job-table-container') {
            // Include all filter values
            const dateFrom = document.getElementById('date-from')?.value || '';
            const dateTo = document.getElementById('date-to')?.value || '';

            if (dateFrom) event.detail.parameters['date_from'] = dateFrom;
            if (dateTo) event.detail.parameters['date_to'] = dateTo;

            // Include selected locations
            selectedLocations.forEach(loc => {
                if (!event.detail.parameters['locations']) {
                    event.detail.parameters['locations'] = [];
                }
                if (Array.isArray(event.detail.parameters['locations'])) {
                    event.detail.parameters['locations'].push(loc);
                } else {
                    event.detail.parameters['locations'] = [event.detail.parameters['locations'], loc];
                }
            });

            // Include selected statuses
            const selectedStatuses = Array.from(document.querySelectorAll('.status-checkbox:checked'))
                .map(cb => cb.value);
            selectedStatuses.forEach(status => {
                if (!event.detail.parameters['statuses']) {
                    event.detail.parameters['statuses'] = [];
                }
                if (Array.isArray(event.detail.parameters['statuses'])) {
                    event.detail.parameters['statuses'].push(status);
                } else {
                    event.detail.parameters['statuses'] = [event.detail.parameters['statuses'], status];
                }
            });
        }
    });
</script>
{% endblock %}
