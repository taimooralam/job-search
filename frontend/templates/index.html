{% extends "base.html" %}

{% block content %}
<div class="space-y-4">
    <!-- Application Statistics Progress Bars -->
    <div id="application-stats-container"
         hx-get="/partials/application-stats"
         hx-trigger="load, every 60s"
         hx-swap="innerHTML">
        <!-- Progress bars loaded via HTMX with auto-refresh every 60 seconds -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-16 mb-3"></div>
                    <div class="h-2 bg-gray-200 rounded"></div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-16 mb-3"></div>
                    <div class="h-2 bg-gray-200 rounded"></div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-16 mb-3"></div>
                    <div class="h-2 bg-gray-200 rounded"></div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-20 mb-2"></div>
                    <div class="h-8 bg-gray-200 rounded w-16 mb-3"></div>
                    <div class="h-2 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toolbar Card -->
    <div class="card">
        <div class="card-body">
            <!-- Top row: Quick Time Filters -->
            <div class="mb-4 pb-4 border-b border-gray-200">
                <div class="flex flex-col gap-2">
                    <label class="text-xs font-semibold text-gray-700 uppercase tracking-wide">Quick Time Filters</label>
                    <div class="flex flex-wrap gap-2">
                        <!-- Hour filters (blue) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">1h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">2h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 3, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">3h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 6, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">6h</button>
                        <button type="button" onclick="setQuickDateFilter(this, 12, 'hour')" class="quick-date-btn btn btn-sm btn-ghost border border-blue-200 text-blue-700 hover:bg-blue-50">12h</button>

                        <!-- Week filters (green) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'week')" class="quick-date-btn btn btn-sm btn-ghost border border-green-200 text-green-700 hover:bg-green-50">1w</button>
                        <button type="button" onclick="setQuickDateFilter(this, 2, 'week')" class="quick-date-btn btn btn-sm btn-ghost border border-green-200 text-green-700 hover:bg-green-50">2w</button>

                        <!-- Month filters (purple) -->
                        <button type="button" onclick="setQuickDateFilter(this, 1, 'month')" class="quick-date-btn btn btn-sm btn-ghost border border-purple-200 text-purple-700 hover:bg-purple-50">1m</button>

                        <!-- Clear filter -->
                        <button type="button" onclick="clearDateFilter()" class="btn btn-sm btn-ghost">Clear</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-4">
                <!-- Search - Full width on mobile -->
                <div class="w-full sm:flex-1 sm:min-w-[200px]">
                    <div class="relative">
                        <input type="text"
                               id="search-input"
                               placeholder="Search jobs..."
                               class="form-input pl-10"
                               hx-get="/partials/job-rows"
                               hx-trigger="keyup changed delay:300ms, search"
                               hx-target="#job-table-container"
                               hx-include=".filter-input"
                               name="query">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Filter toggle button -->
                <button type="button"
                        onclick="toggleFilters()"
                        class="btn btn-secondary btn-md">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    <span>More Filters</span>
                    <span id="active-filter-count" class="hidden badge badge-primary ml-2"></span>
                </button>

                <!-- Bottom row on mobile: page size, selection, delete -->
                <div class="flex flex-wrap items-center justify-between sm:justify-start gap-4">
                    <!-- Page size selector -->
                    <div class="flex items-center gap-2">
                        <label for="page-size-select" class="text-sm text-gray-600 font-medium">Show:</label>
                        <select id="page-size-select"
                                name="page_size"
                                class="filter-input form-select py-1.5"
                                hx-get="/partials/job-rows"
                                hx-trigger="change"
                                hx-target="#job-table-container"
                                hx-include=".filter-input">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>

                    <!-- Selection info & delete button -->
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-600">
                            <span class="hidden sm:inline">Selected: </span><span id="selection-count" class="font-semibold">0</span><span class="sm:hidden"> sel.</span>
                        </span>
                        <button id="delete-selected-btn"
                                onclick="openDeleteModal()"
                                disabled
                                class="btn btn-danger btn-md">
                            <span class="hidden sm:inline">Delete Selected</span>
                            <span class="sm:hidden">Delete</span>
                        </button>
                    </div>

                    <!-- Loading indicator -->
                    <div class="htmx-indicator">
                        <div class="spinner spinner-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Panel (collapsible) -->
    <div id="filter-panel" class="hidden card">
        <div class="card-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Date Range Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Custom Date Range</label>
                    <div class="flex items-center gap-2">
                        <input type="date"
                               id="date-from"
                               name="date_from"
                               class="filter-input form-input"
                               hx-get="/partials/job-rows"
                               hx-trigger="change"
                               hx-target="#job-table-container"
                               hx-include=".filter-input">
                        <span class="text-gray-400">to</span>
                        <input type="date"
                               id="date-to"
                               name="date_to"
                               class="filter-input form-input"
                               hx-get="/partials/job-rows"
                               hx-trigger="change"
                               hx-target="#job-table-container"
                               hx-include=".filter-input">
                        <!-- Hidden datetime inputs for precise time filtering -->
                        <input type="hidden" id="datetime-from" name="datetime_from" class="filter-input">
                        <input type="hidden" id="datetime-to" name="datetime_to" class="filter-input">
                    </div>
                </div>

                <!-- Status Multi-Select Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Status</label>
                    <div class="space-y-1.5 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-2">
                        {% for status in statuses %}
                        <label class="flex items-center gap-2 p-1.5 hover:bg-gray-50 rounded cursor-pointer transition-colors">
                            <input type="checkbox"
                                   name="statuses"
                                   value="{{ status }}"
                                   class="filter-input status-checkbox rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                   {% if status not in ['discarded', 'applied', 'interview scheduled'] %}checked{% endif %}
                                   onchange="updateStatusFilter()"
                                   hx-get="/partials/job-rows"
                                   hx-trigger="change"
                                   hx-target="#job-table-container"
                                   hx-include=".filter-input">
                            <span class="text-sm text-gray-700">{{ status }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button type="button"
                                onclick="selectAllStatuses()"
                                class="text-xs text-indigo-600 hover:text-indigo-800 underline font-medium">
                            Select All
                        </button>
                        <button type="button"
                                onclick="deselectAllStatuses()"
                                class="text-xs text-gray-600 hover:text-gray-800 underline font-medium">
                            Deselect All
                        </button>
                    </div>
                </div>

                <!-- Location Multi-Select Filter -->
                <div class="space-y-2 sm:col-span-2 lg:col-span-1">
                    <label class="form-label">Location</label>
                    <div class="relative">
                        <button type="button"
                                id="location-dropdown-btn"
                                onclick="toggleLocationDropdown()"
                                class="form-select w-full flex items-center justify-between">
                            <span id="location-btn-text" class="truncate text-gray-500">Select locations...</span>
                            <svg class="h-4 w-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="location-dropdown"
                             class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                            <div class="p-2 border-b border-gray-200">
                                <input type="text"
                                       id="location-search"
                                       placeholder="Search locations..."
                                       class="form-input py-1.5"
                                       oninput="filterLocations(this.value)">
                            </div>
                            <div id="location-options" class="py-1">
                                <!-- Options loaded dynamically -->
                                <div class="px-3 py-2 text-sm text-gray-500">Loading locations...</div>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden inputs for selected locations (populated by JS) -->
                    <div id="selected-locations-inputs"></div>
                </div>

                <!-- Clear Filters -->
                <div class="flex items-end">
                    <button type="button"
                            onclick="clearAllFilters()"
                            class="btn btn-ghost btn-md">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Table -->
    <div class="card">
        <div class="overflow-x-auto">
            <div id="job-table-container"
                 hx-get="/partials/job-rows"
                 hx-trigger="load, refresh from:body"
                 hx-indicator=".htmx-indicator">
                <!-- Table content loaded via HTMX -->
                <div class="p-8 text-center text-gray-500">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="mt-2 text-sm font-medium text-gray-600">Loading jobs...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================================================
    // Filter State Management
    // ============================================================================

    let allLocations = [];
    let selectedLocations = new Set();

    // Toggle filter panel visibility
    function toggleFilters() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('hidden');
    }

    // ============================================================================
    // Location Multi-Select Dropdown
    // ============================================================================

    // Load locations from API
    async function loadLocations() {
        try {
            const response = await fetch('/api/locations');
            const data = await response.json();
            allLocations = data.locations || [];
            renderLocationOptions(allLocations);
        } catch (err) {
            console.error('Failed to load locations:', err);
            document.getElementById('location-options').innerHTML =
                '<div class="px-3 py-2 text-sm text-red-500">Failed to load locations</div>';
        }
    }

    // Render location options in dropdown
    function renderLocationOptions(locations) {
        const container = document.getElementById('location-options');
        if (locations.length === 0) {
            container.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">No locations found</div>';
            return;
        }

        container.innerHTML = locations.map(loc => `
            <label class="location-option flex items-center px-3 py-2 hover:bg-gray-100 cursor-pointer transition-colors"
                   data-location="${escapeHtml(loc.location)}">
                <input type="checkbox"
                       class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                       value="${escapeHtml(loc.location)}"
                       ${selectedLocations.has(loc.location) ? 'checked' : ''}
                       onchange="toggleLocation('${escapeJs(loc.location)}', this.checked)">
                <span class="ml-2 text-sm text-gray-700 truncate flex-1">${escapeHtml(loc.location)}</span>
                <span class="ml-2 text-xs text-gray-400">(${loc.count})</span>
            </label>
        `).join('');
    }

    // Toggle location dropdown visibility
    function toggleLocationDropdown() {
        const dropdown = document.getElementById('location-dropdown');
        dropdown.classList.toggle('hidden');

        // Close when clicking outside
        if (!dropdown.classList.contains('hidden')) {
            setTimeout(() => {
                document.addEventListener('click', closeLocationDropdownOnClickOutside);
            }, 0);
        }
    }

    function closeLocationDropdownOnClickOutside(event) {
        const dropdown = document.getElementById('location-dropdown');
        const btn = document.getElementById('location-dropdown-btn');

        if (!dropdown.contains(event.target) && !btn.contains(event.target)) {
            dropdown.classList.add('hidden');
            document.removeEventListener('click', closeLocationDropdownOnClickOutside);
        }
    }

    // Filter locations by search text
    function filterLocations(searchText) {
        const filtered = allLocations.filter(loc =>
            loc.location.toLowerCase().includes(searchText.toLowerCase())
        );
        renderLocationOptions(filtered);
    }

    // Toggle a location selection
    function toggleLocation(location, isSelected) {
        if (isSelected) {
            selectedLocations.add(location);
        } else {
            selectedLocations.delete(location);
        }
        updateLocationButtonText();
        updateSelectedLocationInputs();
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    // Update the button text to show selected locations
    function updateLocationButtonText() {
        const btn = document.getElementById('location-btn-text');
        const count = selectedLocations.size;

        if (count === 0) {
            btn.textContent = 'Select locations...';
            btn.className = 'truncate text-gray-500';
        } else if (count === 1) {
            btn.textContent = Array.from(selectedLocations)[0];
            btn.className = 'truncate text-gray-900';
        } else {
            btn.textContent = `${count} locations selected`;
            btn.className = 'truncate text-gray-900';
        }
    }

    // Update hidden inputs for form submission
    function updateSelectedLocationInputs() {
        const container = document.getElementById('selected-locations-inputs');
        container.innerHTML = Array.from(selectedLocations).map(loc =>
            `<input type="hidden" class="filter-input" name="locations" value="${escapeHtml(loc)}">`
        ).join('');
    }

    // ============================================================================
    // Filter Actions
    // ============================================================================

    // Clear all filters
    function clearAllFilters() {
        // Clear date inputs
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.getElementById('datetime-from').value = '';
        document.getElementById('datetime-to').value = '';

        // Remove active state from quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Clear locations
        selectedLocations.clear();
        updateLocationButtonText();
        updateSelectedLocationInputs();

        // Uncheck all location checkboxes
        document.querySelectorAll('#location-options input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });

        // Clear search
        document.getElementById('search-input').value = '';

        // Update filter count
        updateActiveFilterCount();

        // Refresh table
        triggerTableRefresh();
    }

    // Update active filter count badge
    function updateActiveFilterCount() {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        const locationCount = selectedLocations.size;

        let count = 0;
        if (dateFrom || dateTo) count++;
        if (locationCount > 0) count++;

        const badge = document.getElementById('active-filter-count');
        if (count > 0) {
            badge.textContent = count;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    // Trigger HTMX table refresh with current filters
    function triggerTableRefresh() {
        htmx.trigger('#job-table-container', 'refresh');
    }

    // ============================================================================
    // Utility Functions
    // ============================================================================

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeJs(text) {
        return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================
    // Quick Date Filter
    // ============================================================================

    // Set quick date filter (hours, weeks, or months ago)
    function setQuickDateFilter(button, amount, unit) {
        const now = new Date();
        let fromDate = new Date();

        switch (unit) {
            case 'hour':
                fromDate.setTime(now.getTime() - (amount * 60 * 60 * 1000));
                break;
            case 'week':
                fromDate.setTime(now.getTime() - (amount * 7 * 24 * 60 * 60 * 1000));
                break;
            case 'month':
                fromDate.setMonth(now.getMonth() - amount);
                break;
        }

        // Format as YYYY-MM-DD for the visible date input
        const formatDate = (d) => d.toISOString().split('T')[0];
        // Format as full ISO timestamp for precise filtering
        const formatDateTime = (d) => d.toISOString();

        document.getElementById('date-from').value = formatDate(fromDate);
        document.getElementById('date-to').value = formatDate(now);

        // Set hidden datetime inputs for precise time filtering
        document.getElementById('datetime-from').value = formatDateTime(fromDate);
        document.getElementById('datetime-to').value = formatDateTime(now);

        // Update active state for buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');

        // Update active filter count
        updateActiveFilterCount();

        // Trigger table refresh
        triggerTableRefresh();
    }

    // Clear date filter
    function clearDateFilter() {
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        document.getElementById('datetime-from').value = '';
        document.getElementById('datetime-to').value = '';

        // Remove active state from all quick date buttons
        document.querySelectorAll('.quick-date-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Update active filter count
        updateActiveFilterCount();

        // Trigger table refresh
        triggerTableRefresh();
    }

    // Status filter functions
    function updateStatusFilter() {
        updateActiveFilterCount();
        // HTMX will handle the refresh automatically via hx-trigger="change"
    }

    function selectAllStatuses() {
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    function deselectAllStatuses() {
        document.querySelectorAll('.status-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateActiveFilterCount();
        triggerTableRefresh();
    }

    // ============================================================================
    // Event Listeners
    // ============================================================================

    // Update filter count when date inputs change
    document.getElementById('date-from')?.addEventListener('change', updateActiveFilterCount);
    document.getElementById('date-to')?.addEventListener('change', updateActiveFilterCount);

    // Load locations on page load
    document.addEventListener('DOMContentLoaded', loadLocations);

    // Make table refresh include filters via HTMX
    document.body.addEventListener('htmx:configRequest', function(event) {
        if (event.target.id === 'job-table-container') {
            // Include all filter values
            const dateFrom = document.getElementById('date-from')?.value || '';
            const dateTo = document.getElementById('date-to')?.value || '';

            if (dateFrom) event.detail.parameters['date_from'] = dateFrom;
            if (dateTo) event.detail.parameters['date_to'] = dateTo;

            // Include selected locations
            selectedLocations.forEach(loc => {
                if (!event.detail.parameters['locations']) {
                    event.detail.parameters['locations'] = [];
                }
                if (Array.isArray(event.detail.parameters['locations'])) {
                    event.detail.parameters['locations'].push(loc);
                } else {
                    event.detail.parameters['locations'] = [event.detail.parameters['locations'], loc];
                }
            });

            // Include selected statuses
            const selectedStatuses = Array.from(document.querySelectorAll('.status-checkbox:checked'))
                .map(cb => cb.value);
            selectedStatuses.forEach(status => {
                if (!event.detail.parameters['statuses']) {
                    event.detail.parameters['statuses'] = [];
                }
                if (Array.isArray(event.detail.parameters['statuses'])) {
                    event.detail.parameters['statuses'].push(status);
                } else {
                    event.detail.parameters['statuses'] = [event.detail.parameters['statuses'], status];
                }
            });
        }
    });
</script>
{% endblock %}
