<!-- Global CLI Panel - AWS/GCP Console Style -->
<!-- This panel lives OUTSIDE the main HTMX swap target to survive navigation -->
<div id="cli-panel"
     x-data
     x-init="$store.cli.init()"
     class="cli-panel"
     :class="{
         'cli-panel--expanded': $store.cli.expanded,
         'cli-panel--small': $store.cli.panelSize === 'small',
         'cli-panel--medium': $store.cli.panelSize === 'medium',
         'cli-panel--large': $store.cli.panelSize === 'large',
         'cli-panel--xlarge': $store.cli.panelSize === 'xlarge',
         'cli-font--small': $store.cli.fontSize === 'small',
         'cli-font--medium': $store.cli.fontSize === 'medium',
         'cli-font--large': $store.cli.fontSize === 'large'
     }"
     @keydown.ctrl.`="$store.cli.toggle()"
     @keydown.escape="$store.cli.expanded && $store.cli.toggle()">

    <!-- Toggle Bar (always visible) -->
    <div class="cli-toggle-bar" @click="$store.cli.toggle()">
        <div class="cli-toggle-left">
            <!-- Terminal Icon -->
            <svg class="cli-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span class="cli-title">Pipeline Console</span>

            <!-- Run count badge -->
            <template x-if="$store.cli.runOrder.length > 0">
                <span class="cli-badge" x-text="$store.cli.runOrder.length + ' run' + ($store.cli.runOrder.length > 1 ? 's' : '')"></span>
            </template>

            <!-- Active run indicator -->
            <template x-if="$store.cli.hasRunningPipeline()">
                <span class="cli-running-indicator">
                    <span class="cli-running-dot"></span>
                    <span x-text="$store.cli.getActiveRunTitle()"></span>
                </span>
            </template>

            <!-- Polling activity indicator - amber pulsing dot when fetching logs -->
            <template x-if="$store.cli.isPollingActive()">
                <span class="cli-polling-indicator" title="Fetching logs from runner...">
                    <span class="cli-polling-dot"></span>
                </span>
            </template>
        </div>

        <div class="cli-toggle-right">
            <!-- Expand/Collapse chevron -->
            <svg class="cli-chevron" :class="{ 'rotate-180': $store.cli.expanded }"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
            </svg>
        </div>
    </div>

    <!-- Expanded Panel Content -->
    <div class="cli-content" x-show="$store.cli.expanded" x-cloak x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0">

        <!-- Tab Bar -->
        <div class="cli-tabs" x-show="$store.cli.runOrder.length > 0">
            <div class="cli-tabs-scroll">
                <template x-for="runId in $store.cli.runOrder.filter(id => id && $store.cli.runs[id])" :key="runId">
                    <button class="cli-tab"
                            :class="{ 'cli-tab--active': $store.cli.activeRunId === runId }"
                            @click.stop="$store.cli.switchToRun(runId)"
                            @contextmenu.prevent="$store.cli.showTabContextMenu($event, runId)">
                        <!-- Status indicator -->
                        <span class="cli-tab-status"
                              :class="{
                                  'cli-tab-status--running': $store.cli.runs[runId]?.status === 'running',
                                  'cli-tab-status--success': $store.cli.runs[runId]?.status === 'success',
                                  'cli-tab-status--error': $store.cli.runs[runId]?.status === 'error'
                              }">
                            <!-- Use x-show with wrapper span for status icons to avoid x-if timing issues -->
                            <span x-show="$store.cli.runs[runId]?.status === 'running'">
                                <svg class="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                            <span x-show="$store.cli.runs[runId]?.status === 'success'">‚úì</span>
                            <span x-show="$store.cli.runs[runId]?.status === 'error'">‚úó</span>
                        </span>
                        <!-- Tab title -->
                        <span class="cli-tab-title" x-text="$store.cli.runs[runId]?.jobTitle || 'Unknown'"></span>
                        <!-- Close button -->
                        <button class="cli-tab-close" @click.stop="$store.cli.closeRun(runId)" title="Close tab">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </button>
                </template>
            </div>

            <!-- Actions -->
            <div class="cli-tabs-actions">
                <button class="cli-action-btn" @click.stop="$store.cli.clearCurrentLogs()" title="Clear logs">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <button class="cli-action-btn" @click.stop="$store.cli.copyLogs()" title="Copy logs">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </button>
                <!-- Load from Redis button (for completed runs) -->
                <button class="cli-action-btn"
                        x-show="$store.cli.activeRunId && ['success', 'error', 'completed'].includes($store.cli.runs[$store.cli.activeRunId]?.status)"
                        @click.stop="$store.cli.loadRedisLogs($store.cli.activeRunId, $store.cli.runs[$store.cli.activeRunId]?.jobId, $store.cli.runs[$store.cli.activeRunId]?.jobTitle)"
                        title="Load/refresh logs from Redis cache (24h)">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
                <!-- Retry fetch logs button (shows when logs are empty but run exists) -->
                <button class="cli-action-btn"
                        x-show="$store.cli.activeRunId &&
                                $store.cli.runs[$store.cli.activeRunId] &&
                                (!$store.cli.runs[$store.cli.activeRunId].logs ||
                                 $store.cli.runs[$store.cli.activeRunId].logs.length === 0)"
                        @click.stop="$store.cli.fetchRunLogs($store.cli.activeRunId, $store.cli.runs[$store.cli.activeRunId]?.jobId)"
                        title="Fetch logs from server (logs are empty)">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                </button>

                <!-- Separator -->
                <span class="cli-action-separator"></span>

                <!-- Panel height toggle button -->
                <button class="cli-action-btn cli-action-btn--text"
                        @click.stop="$store.cli.cyclePanelSize()"
                        :title="'Panel size: ' + $store.cli.panelSize + ' (click to cycle)'">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                    </svg>
                    <span class="cli-action-label" x-text="$store.cli.getPanelSizeLabel()"></span>
                </button>

                <!-- Font size toggle button -->
                <button class="cli-action-btn cli-action-btn--text"
                        @click.stop="$store.cli.cycleFontSize()"
                        :title="'Font size: ' + $store.cli.fontSize + ' (click to cycle)'">
                    <span class="cli-font-icon">A</span>
                    <span class="cli-action-label" x-text="$store.cli.getFontSizeLabel()"></span>
                </button>
            </div>
        </div>

        <!-- Log Output Area -->
        <div class="cli-logs" x-ref="logsContainer">
            <template x-if="!$store.cli.activeRunId || !$store.cli.runs[$store.cli.activeRunId]">
                <div class="cli-empty">
                    <svg class="w-8 h-8 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p>No pipeline runs yet</p>
                    <p class="text-xs text-gray-500 mt-1">Run a pipeline action to see logs here</p>
                </div>
            </template>

            <template x-if="$store.cli.activeRunId && $store.cli.runs[$store.cli.activeRunId]">
                <div class="cli-log-content">
                    <!-- Diagnostics Header (collapsible, default open) -->
                    <div class="cli-diagnostics" x-data="{ diagOpen: true }">
                        <button class="cli-diag-toggle" @click="diagOpen = !diagOpen">
                            <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-90': diagOpen }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            <span class="cli-diag-toggle-text">Diagnostics</span>
                        </button>
                        <div x-show="diagOpen" x-collapse class="cli-diag-content">
                            <!-- Run ID with copy -->
                            <div class="cli-diag-row">
                                <span class="cli-diag-label">Run ID:</span>
                                <code class="cli-diag-value" x-text="$store.cli.activeRunId"></code>
                                <button class="cli-diag-copy"
                                        @click="navigator.clipboard.writeText($store.cli.activeRunId); typeof showToast === 'function' && showToast('Run ID copied', 'success')"
                                        title="Copy run ID">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </div>
                            <!-- Logs API URL -->
                            <div class="cli-diag-row">
                                <span class="cli-diag-label">Logs API:</span>
                                <a class="cli-diag-link"
                                   :href="`/api/runner/operations/${$store.cli.activeRunId}/status`"
                                   target="_blank"
                                   x-text="`/api/runner/operations/${$store.cli.activeRunId}/status`"></a>
                            </div>
                            <!-- Job Title -->
                            <div class="cli-diag-row" x-show="$store.cli.runs[$store.cli.activeRunId]?.jobTitle">
                                <span class="cli-diag-label">Job:</span>
                                <span class="cli-diag-value font-medium" x-text="$store.cli.runs[$store.cli.activeRunId]?.jobTitle"></span>
                            </div>
                            <!-- Company -->
                            <div class="cli-diag-row" x-show="$store.cli.runs[$store.cli.activeRunId]?.company && $store.cli.runs[$store.cli.activeRunId]?.company !== 'Unknown Company'">
                                <span class="cli-diag-label">Company:</span>
                                <span class="cli-diag-value" x-text="$store.cli.runs[$store.cli.activeRunId]?.company"></span>
                            </div>
                            <!-- Job ID -->
                            <div class="cli-diag-row" x-show="$store.cli.runs[$store.cli.activeRunId]?.jobId">
                                <span class="cli-diag-label">Job ID:</span>
                                <code class="cli-diag-value" x-text="$store.cli.runs[$store.cli.activeRunId]?.jobId"></code>
                            </div>
                            <!-- Status -->
                            <div class="cli-diag-row">
                                <span class="cli-diag-label">Status:</span>
                                <span class="cli-diag-status"
                                      :class="{
                                          'text-yellow-400': $store.cli.runs[$store.cli.activeRunId]?.status === 'running',
                                          'text-green-400': $store.cli.runs[$store.cli.activeRunId]?.status === 'success',
                                          'text-red-400': $store.cli.runs[$store.cli.activeRunId]?.status === 'error'
                                      }"
                                      x-text="$store.cli.runs[$store.cli.activeRunId]?.status || 'unknown'"></span>
                            </div>
                            <!-- Started At -->
                            <div class="cli-diag-row" x-show="$store.cli.runs[$store.cli.activeRunId]?.startedAt">
                                <span class="cli-diag-label">Started:</span>
                                <span class="cli-diag-value"
                                      x-text="$store.cli.runs[$store.cli.activeRunId]?.startedAt ? new Date($store.cli.runs[$store.cli.activeRunId].startedAt).toLocaleString() : ''"></span>
                            </div>
                            <!-- LangSmith URL (if available) -->
                            <div class="cli-diag-row" x-show="$store.cli.runs[$store.cli.activeRunId]?.langsmithUrl">
                                <span class="cli-diag-label">LangSmith:</span>
                                <a class="cli-diag-link"
                                   :href="$store.cli.runs[$store.cli.activeRunId]?.langsmithUrl"
                                   target="_blank">View Trace ‚Üí</a>
                            </div>
                            <!-- Redis indicator -->
                            <div class="cli-diag-row" x-show="$store.cli.runs[$store.cli.activeRunId]?.fromRedis">
                                <span class="cli-diag-label">Source:</span>
                                <span class="cli-diag-badge">Loaded from Redis</span>
                            </div>
                        </div>
                    </div>
                    <!-- Log Lines -->
                    <template x-for="(log, index) in $store.cli.runs[$store.cli.activeRunId].logs" :key="index">
                        <div class="cli-log-line"
                             x-data="{
                                 detectedBackend: log.backend || $store.cli.detectBackendFromText(log.text),
                                 parsed: log.isStructuredFromBackend
                                     ? { isStructured: true, message: log.text, event: log.event, metadata: { ...(log.metadata || {}), ...(log.traceback ? { traceback: log.traceback } : {}) }, hasMetadata: (log.metadata && Object.keys(log.metadata).length > 0) || log.traceback, prefix: log.prefix }
                                     : window.cliParseStructuredLog(log.text),
                                 metaOpen: false
                             }"
                             :class="{
                                 'cli-log--error': log.type === 'error',
                                 'cli-log--warning': log.type === 'warning',
                                 'cli-log--success': log.type === 'success',
                                 'cli-log--debug': log.type === 'debug',
                                 'claude-cli': detectedBackend === 'claude_cli',
                                 'langchain-fallback': detectedBackend === 'langchain',
                                 'cli-log--structured': parsed.isStructured
                             }">
                            <!-- Backend indicator icon -->
                            <span class="cli-log-backend-icon"
                                  x-show="detectedBackend === 'claude_cli'"
                                  title="Claude CLI">&#129302;</span>
                            <span class="cli-log-backend-icon"
                                  x-show="detectedBackend === 'langchain'"
                                  title="LangChain Fallback">&#9888;&#65039;</span>

                            <!-- Structured log with metadata -->
                            <template x-if="parsed.isStructured">
                                <div class="cli-structured-log">
                                    <!-- Event icon and message -->
                                    <span class="cli-log-event-icon" x-text="window.cliGetEventIcon(parsed.event)"></span>
                                    <span class="cli-log-message" x-text="parsed.message"></span>

                                    <!-- Metadata toggle button (if has metadata) -->
                                    <button x-show="parsed.hasMetadata"
                                            class="cli-meta-toggle"
                                            @click.stop="metaOpen = !metaOpen"
                                            :title="metaOpen ? 'Hide details' : 'Show details'">
                                        <span x-text="metaOpen ? '‚ñº' : '‚ñ∂'"></span>
                                        <span class="cli-meta-count" x-text="Object.keys(parsed.metadata).length + ' fields'"></span>
                                    </button>

                                    <!-- Collapsible metadata section -->
                                    <div x-show="metaOpen && parsed.hasMetadata"
                                         x-collapse
                                         class="cli-meta-content">
                                        <!-- Copy button for metadata (copies as JSON) -->
                                        <button class="cli-copy-btn"
                                                @click.stop="(() => {
                                                    const metaWithoutTraceback = Object.fromEntries(
                                                        Object.entries(parsed.metadata).filter(([k]) => k !== 'traceback')
                                                    );
                                                    navigator.clipboard.writeText(JSON.stringify(metaWithoutTraceback, null, 2));
                                                    typeof showToast === 'function' && showToast('Metadata copied as JSON', 'success');
                                                })()"
                                                title="Copy metadata as JSON">
                                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                            </svg>
                                            <span>Copy JSON</span>
                                        </button>
                                        <template x-for="(value, key) in parsed.metadata" :key="key">
                                            <!-- Skip traceback in regular metadata - it gets its own section -->
                                            <template x-if="key !== 'traceback'">
                                                <div class="cli-meta-row">
                                                    <span class="cli-meta-key" x-text="key + ':'"></span>
                                                    <span class="cli-meta-value" x-text="window.cliFormatMetadataValue(value)"></span>
                                                </div>
                                            </template>
                                        </template>
                                    </div>

                                    <!-- Collapsible Stack Trace section (for error events) -->
                                    <template x-if="parsed.metadata && parsed.metadata.traceback">
                                        <div class="cli-traceback-section" x-data="{ traceOpen: false }">
                                            <button class="cli-traceback-toggle"
                                                    @click.stop="traceOpen = !traceOpen"
                                                    :class="{ 'active': traceOpen }">
                                                <span x-text="traceOpen ? '‚ñº' : '‚ñ∂'"></span>
                                                <span class="cli-traceback-label">üîç Stack Trace</span>
                                            </button>
                                            <div x-show="traceOpen"
                                                 x-collapse
                                                 class="cli-traceback-content">
                                                <!-- Copy button for stack trace -->
                                                <button class="cli-copy-btn cli-copy-btn--traceback"
                                                        @click.stop="navigator.clipboard.writeText(parsed.metadata.traceback); typeof showToast === 'function' && showToast('Stack trace copied', 'success')"
                                                        title="Copy stack trace">
                                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                                    </svg>
                                                    <span>Copy</span>
                                                </button>
                                                <pre class="cli-traceback-pre" x-text="parsed.metadata.traceback"></pre>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Plain text log (non-structured) -->
                            <template x-if="!parsed.isStructured">
                                <span>
                                    <span class="cli-log-prefix" x-show="!detectedBackend">></span>
                                    <span x-text="log.text"></span>
                                </span>
                            </template>

                            <!-- Tier badge if available -->
                            <span class="cli-tier-badge"
                                  x-show="log.tier"
                                  :class="log.tier"
                                  x-text="log.tier"></span>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Backend Stats / Cost Panel (collapsible) -->
        <div class="cli-cost-panel"
             x-show="$store.cli.activeRunId && $store.cli.runs[$store.cli.activeRunId] && $store.cli.hasBackendData($store.cli.activeRunId)"
             x-data="{ costPanelOpen: true }">
            <div class="cli-cost-header">
                <span class="cli-cost-title">Backend Stats</span>
                <button class="cli-cost-toggle" @click="costPanelOpen = !costPanelOpen" :title="costPanelOpen ? 'Collapse' : 'Expand'">
                    <svg class="w-3 h-3 transition-transform" :class="{ 'rotate-180': !costPanelOpen }" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
            </div>
            <div class="cli-cost-content" x-show="costPanelOpen" x-collapse>
                <!-- Claude CLI row -->
                <div class="cli-cost-row">
                    <div class="cli-cost-row-label">
                        <span class="icon">&#129302;</span>
                        <span>Claude CLI</span>
                    </div>
                    <div class="cli-cost-row-stats">
                        <span class="cli-cost-count" x-text="$store.cli.getClaudeCliCount($store.cli.activeRunId) + ' calls'"></span>
                        <span class="cli-cost-amount" x-text="'$' + $store.cli.getClaudeCliCost($store.cli.activeRunId).toFixed(4)"></span>
                    </div>
                </div>
                <!-- LangChain Fallback row -->
                <div class="cli-cost-row fallback" x-show="$store.cli.getLangchainCount($store.cli.activeRunId) > 0">
                    <div class="cli-cost-row-label">
                        <span class="icon">&#9888;&#65039;</span>
                        <span>LangChain Fallback</span>
                    </div>
                    <div class="cli-cost-row-stats">
                        <span class="cli-cost-count" x-text="$store.cli.getLangchainCount($store.cli.activeRunId) + ' calls'"></span>
                        <span class="cli-cost-amount" x-text="'$' + $store.cli.getLangchainCost($store.cli.activeRunId).toFixed(4)"></span>
                    </div>
                </div>
                <!-- Total row (only show if there are costs) -->
                <div class="cli-cost-total" x-show="$store.cli.getTotalCost($store.cli.activeRunId) > 0">
                    <span class="cli-cost-total-label">Total</span>
                    <span class="cli-cost-total-amount" x-text="'$' + $store.cli.getTotalCost($store.cli.activeRunId).toFixed(4)"></span>
                </div>
            </div>
        </div>

        <!-- Layer Status Footer -->
        <div class="cli-footer" x-show="$store.cli.activeRunId && $store.cli.runs[$store.cli.activeRunId]">
            <div class="cli-layers">
                <span class="cli-layers-label">Layers:</span>
                <template x-for="(layer, key) in $store.cli.getActiveLayerStatus()" :key="key">
                    <span class="cli-layer"
                          :class="{
                              'cli-layer--pending': layer === 'pending',
                              'cli-layer--running': layer === 'running',
                              'cli-layer--complete': layer === 'complete',
                              'cli-layer--error': layer === 'error'
                          }"
                          :title="key + ': ' + layer">
                        <!-- Use x-show instead of x-if for status icons to prevent DOM timing issues -->
                        <span x-show="layer === 'running'" class="inline-flex">
                            <svg class="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                        </span>
                        <span x-show="layer === 'complete'">‚úì</span>
                        <span x-show="layer === 'error'">‚úó</span>
                        <span x-show="layer === 'pending'">‚óã</span>
                        <span class="cli-layer-name" x-text="key"></span>
                    </span>
                </template>
            </div>

            <div class="cli-footer-right">
                <span x-show="$store.cli.runs[$store.cli.activeRunId]?.action"
                      class="cli-action-badge"
                      x-text="$store.cli.runs[$store.cli.activeRunId]?.action?.replace('_', ' ') || ''"></span>
            </div>
        </div>
    </div>

    <!-- Tab Context Menu -->
    <div id="cli-tab-context-menu"
         x-show="$store.cli.contextMenu.visible"
         x-cloak
         @click.away="$store.cli.hideContextMenu()"
         :style="`left: ${$store.cli.contextMenu.x}px; top: ${$store.cli.contextMenu.y}px;`"
         class="cli-context-menu">
        <button class="cli-context-item" @click="$store.cli.closeContextMenuTab()">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
            Close Tab
        </button>
        <button class="cli-context-item" @click="$store.cli.closeOtherTabs()">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Close Other Tabs
        </button>
        <button class="cli-context-item" @click="$store.cli.closeCompletedTabs()">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Close Completed
        </button>
        <div class="cli-context-divider"></div>
        <button class="cli-context-item" @click="$store.cli.closeAllTabs()">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Close All Tabs
        </button>
    </div>
</div>
