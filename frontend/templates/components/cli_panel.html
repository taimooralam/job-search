<!-- Global CLI Panel - AWS/GCP Console Style -->
<!-- This panel lives OUTSIDE the main HTMX swap target to survive navigation -->
<div id="cli-panel"
     x-data
     x-init="$store.cli.init()"
     class="cli-panel"
     :class="{ 'cli-panel--expanded': $store.cli.expanded }"
     @keydown.ctrl.`="$store.cli.toggle()"
     @keydown.escape="$store.cli.expanded && $store.cli.toggle()">

    <!-- Toggle Bar (always visible) -->
    <div class="cli-toggle-bar" @click="$store.cli.toggle()">
        <div class="cli-toggle-left">
            <!-- Terminal Icon -->
            <svg class="cli-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <span class="cli-title">Pipeline Console</span>

            <!-- Run count badge -->
            <template x-if="$store.cli.runOrder.length > 0">
                <span class="cli-badge" x-text="$store.cli.runOrder.length + ' run' + ($store.cli.runOrder.length > 1 ? 's' : '')"></span>
            </template>

            <!-- Active run indicator -->
            <template x-if="$store.cli.hasRunningPipeline()">
                <span class="cli-running-indicator">
                    <span class="cli-running-dot"></span>
                    <span x-text="$store.cli.getActiveRunTitle()"></span>
                </span>
            </template>
        </div>

        <div class="cli-toggle-right">
            <!-- Expand/Collapse chevron -->
            <svg class="cli-chevron" :class="{ 'rotate-180': $store.cli.expanded }"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
            </svg>
        </div>
    </div>

    <!-- Expanded Panel Content -->
    <div class="cli-content" x-show="$store.cli.expanded" x-cloak x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 transform translate-y-4"
         x-transition:enter-end="opacity-100 transform translate-y-0">

        <!-- Tab Bar -->
        <div class="cli-tabs" x-show="$store.cli.runOrder.length > 0">
            <div class="cli-tabs-scroll">
                <template x-for="runId in $store.cli.runOrder" :key="runId">
                    <button class="cli-tab"
                            :class="{ 'cli-tab--active': $store.cli.activeRunId === runId }"
                            @click.stop="$store.cli.switchToRun(runId)">
                        <!-- Status indicator -->
                        <span class="cli-tab-status"
                              :class="{
                                  'cli-tab-status--running': $store.cli.runs[runId]?.status === 'running',
                                  'cli-tab-status--success': $store.cli.runs[runId]?.status === 'success',
                                  'cli-tab-status--error': $store.cli.runs[runId]?.status === 'error'
                              }">
                            <template x-if="$store.cli.runs[runId]?.status === 'running'">
                                <svg class="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </template>
                            <template x-if="$store.cli.runs[runId]?.status === 'success'">
                                <span>✓</span>
                            </template>
                            <template x-if="$store.cli.runs[runId]?.status === 'error'">
                                <span>✗</span>
                            </template>
                        </span>
                        <!-- Tab title -->
                        <span class="cli-tab-title" x-text="$store.cli.runs[runId]?.jobTitle || 'Unknown'"></span>
                        <!-- Close button -->
                        <button class="cli-tab-close" @click.stop="$store.cli.closeRun(runId)" title="Close">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </button>
                </template>
            </div>

            <!-- Actions -->
            <div class="cli-tabs-actions">
                <button class="cli-action-btn" @click.stop="$store.cli.clearCurrentLogs()" title="Clear logs">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
                <button class="cli-action-btn" @click.stop="$store.cli.copyLogs()" title="Copy logs">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Log Output Area -->
        <div class="cli-logs" x-ref="logsContainer">
            <template x-if="!$store.cli.activeRunId || !$store.cli.runs[$store.cli.activeRunId]">
                <div class="cli-empty">
                    <svg class="w-8 h-8 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p>No pipeline runs yet</p>
                    <p class="text-xs text-gray-500 mt-1">Run a pipeline action to see logs here</p>
                </div>
            </template>

            <template x-if="$store.cli.activeRunId && $store.cli.runs[$store.cli.activeRunId]">
                <div class="cli-log-content">
                    <template x-for="(log, index) in $store.cli.runs[$store.cli.activeRunId].logs" :key="index">
                        <div class="cli-log-line"
                             :class="{
                                 'cli-log--error': log.type === 'error',
                                 'cli-log--warning': log.type === 'warning',
                                 'cli-log--success': log.type === 'success',
                                 'cli-log--debug': log.type === 'debug'
                             }">
                            <span class="cli-log-prefix">></span>
                            <span x-text="log.text"></span>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <!-- Layer Status Footer -->
        <div class="cli-footer" x-show="$store.cli.activeRunId && $store.cli.runs[$store.cli.activeRunId]">
            <div class="cli-layers">
                <span class="cli-layers-label">Layers:</span>
                <template x-for="(layer, key) in $store.cli.getActiveLayerStatus()" :key="key">
                    <span class="cli-layer"
                          :class="{
                              'cli-layer--pending': layer === 'pending',
                              'cli-layer--running': layer === 'running',
                              'cli-layer--complete': layer === 'complete',
                              'cli-layer--error': layer === 'error'
                          }"
                          :title="key + ': ' + layer">
                        <template x-if="layer === 'running'">
                            <svg class="animate-spin w-3 h-3" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                        </template>
                        <template x-if="layer === 'complete'">
                            <span>✓</span>
                        </template>
                        <template x-if="layer === 'error'">
                            <span>✗</span>
                        </template>
                        <template x-if="layer === 'pending'">
                            <span>○</span>
                        </template>
                        <span class="cli-layer-name" x-text="key"></span>
                    </span>
                </template>
            </div>

            <div class="cli-footer-right">
                <template x-if="$store.cli.runs[$store.cli.activeRunId]?.action">
                    <span class="cli-action-badge" x-text="$store.cli.runs[$store.cli.activeRunId].action.replace('_', ' ')"></span>
                </template>
            </div>
        </div>
    </div>
</div>
