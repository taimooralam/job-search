{% extends "base.html" %}

{% block title %}{{ job.title or 'Job' }} at {{ job.company or 'Unknown' }} - Job Search{% endblock %}

{% block extra_head %}
<!-- Pipeline Progress Indicator CSS -->
<link rel="stylesheet" href="/static/css/pipeline-progress.css">
<!-- CV Editor Styles - Phase 5.2: Mobile Responsiveness & Accessibility -->
<link rel="stylesheet" href="/static/css/cv-editor.css">
<!-- CV Preview Styles -->
<style>
.cv-preview-content {
    padding: 1in;
    max-width: 8.5in;
    margin: 0 auto;
    background: white;
    min-height: 11in;
}

.cv-preview-content p {
    margin-bottom: 0.5em;
}

.cv-preview-content h1 {
    font-size: 1.8em;
    font-weight: 700;
    margin-top: 1em;
    margin-bottom: 0.5em;
}

.cv-preview-content h2 {
    font-size: 1.5em;
    font-weight: 700;
    margin-top: 0.8em;
    margin-bottom: 0.4em;
}

.cv-preview-content h3 {
    font-size: 1.3em;
    font-weight: 600;
    margin-top: 0.6em;
    margin-bottom: 0.3em;
}

.cv-preview-content ul,
.cv-preview-content ol {
    margin-left: 1.5em;
    margin-bottom: 0.5em;
}

.cv-preview-content li {
    margin-bottom: 0.25em;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back navigation -->
    <div class="mb-4">
        <a href="/" class="inline-flex items-center text-indigo-600 hover:text-indigo-800">
            <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Jobs
        </a>
    </div>

    <!-- Job Header -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
        <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-indigo-600 to-indigo-700">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold text-white">{{ job.title or 'Untitled Position' }}</h1>
                    <p class="text-indigo-100 mt-1">{{ job.company or 'Unknown Company' }}</p>
                </div>
                {% set header_job_url = job.url or job.jobUrl %}
                {% if header_job_url %}
                <a href="{{ header_job_url }}" target="_blank"
                   class="inline-flex items-center px-4 py-2 bg-white text-indigo-600 rounded-md hover:bg-indigo-50 transition">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                    View Posting
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Quick Info Bar -->
        <div class="px-6 py-3 bg-gray-50 border-b border-gray-200 flex flex-wrap gap-4 text-sm">
            <div class="flex items-center text-gray-600">
                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                {{ job.location or 'Location not specified' }}
            </div>
            {% if job.createdAt %}
            <div class="flex items-center text-gray-600">
                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Added {{ job.createdAt[:10] }}
            </div>
            {% endif %}
            {% if job.score is not none %}
            <div class="flex items-center">
                <span class="px-2 py-0.5 rounded-full text-xs font-medium
                    {% if job.score >= 80 %}bg-green-100 text-green-800
                    {% elif job.score >= 60 %}bg-yellow-100 text-yellow-800
                    {% else %}bg-gray-100 text-gray-600{% endif %}">
                    Score: {{ job.score }}
                </span>
            </div>
            {% endif %}
        </div>

        <!-- Main Content -->
        <div class="p-6">
            <!-- Status & Actions -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">Status & Actions</h2>
                <div class="flex flex-wrap items-center gap-4">
                    <div>
                        <label for="status-select" class="block text-xs text-gray-500 mb-1">Current Status</label>
                        <select id="status-select"
                                class="border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500"
                                onchange="updateJobField('status', this.value)">
                            {% for s in statuses %}
                            <option value="{{ s }}" {{ 'selected' if (job.status or 'not processed') == s else '' }}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="priority-select" class="block text-xs text-gray-500 mb-1">Priority</label>
                        <select id="priority-select"
                                class="border border-gray-300 rounded-md py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500"
                                onchange="updateJobField('priority', this.value)">
                            <option value="" {{ 'selected' if not job.priority }}>None</option>
                            <option value="low" {{ 'selected' if job.priority == 'low' }}>Low</option>
                            <option value="medium" {{ 'selected' if job.priority == 'medium' }}>Medium</option>
                            <option value="high" {{ 'selected' if job.priority == 'high' }}>High</option>
                        </select>
                    </div>
                    {% if job.updatedAt %}
                    <div class="text-xs text-gray-500">
                        Last updated: {{ job.updatedAt[:19] | replace('T', ' ') }}
                    </div>
                    {% endif %}
                    <div class="ml-auto">
                        <button onclick="processJobDetail('{{ job._id }}', '{{ job.title | replace("'", "\\'") | replace('"', '&quot;') }}')"
                                class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition">
                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Process Job
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pipeline Progress Indicator (shown when processing) -->
            <div id="pipeline-progress-container" class="hidden mb-6">
                <div class="card">
                    <div class="card-header flex items-start justify-between">
                        <div>
                            <h2 class="text-base font-semibold text-gray-900 flex items-center gap-2">
                                <svg class="h-5 w-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                Pipeline Execution Progress
                            </h2>
                            <p class="text-sm text-gray-600 mt-1">7-layer intelligence pipeline processing job application</p>
                        </div>
                        <span id="pipeline-run-id" class="text-xs font-mono text-indigo-700 bg-indigo-50 px-3 py-1.5 rounded-md border border-indigo-200"></span>
                    </div>

                    <div class="card-body">
                        <!-- Overall Progress Bar -->
                        <div class="pipeline-overall-progress">
                            <div class="pipeline-overall-progress-text">
                                <span class="font-medium">Overall Progress</span>
                                <span id="pipeline-overall-percent" class="font-semibold text-indigo-700">0%</span>
                            </div>
                            <div class="pipeline-overall-progress-bar-container">
                                <div id="pipeline-overall-progress-bar" class="pipeline-overall-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Pipeline Stepper -->
                        <ol class="pipeline-stepper" id="pipeline-stepper">
                            <!-- Layer 1: Intake -->
                            <li class="pipeline-step pending" data-layer="intake">
                                <div class="step-icon">1</div>
                                <div class="step-content">
                                    <div class="step-title">Intake</div>
                                    <div class="step-description">Parse job posting and candidate profile</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Layer 2: Pain Point Mining -->
                            <li class="pipeline-step pending" data-layer="pain_points">
                                <div class="step-icon">2</div>
                                <div class="step-content">
                                    <div class="step-title">Pain Point Mining</div>
                                    <div class="step-description">Extract company and role pain points</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Layer 3: Company Research -->
                            <li class="pipeline-step pending" data-layer="company_research">
                                <div class="step-icon">3</div>
                                <div class="step-content">
                                    <div class="step-title">Company Research</div>
                                    <div class="step-description">Research company via FireCrawl</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Layer 4: Role Research -->
                            <li class="pipeline-step pending" data-layer="role_research">
                                <div class="step-icon">4</div>
                                <div class="step-content">
                                    <div class="step-title">Role Research</div>
                                    <div class="step-description">Research specific role requirements</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Layer 5: Fit Scoring -->
                            <li class="pipeline-step pending" data-layer="fit_scoring">
                                <div class="step-icon">5</div>
                                <div class="step-content">
                                    <div class="step-title">Fit Scoring</div>
                                    <div class="step-description">Score candidate fit (0-100)</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Layer 6: People Mapping -->
                            <li class="pipeline-step pending" data-layer="people_mapping">
                                <div class="step-icon">6</div>
                                <div class="step-content">
                                    <div class="step-title">People Mapping</div>
                                    <div class="step-description">Find LinkedIn recruiters and contacts</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Layer 7: CV/Outreach Generation -->
                            <li class="pipeline-step pending" data-layer="cv_outreach_generation">
                                <div class="step-icon">7</div>
                                <div class="step-content">
                                    <div class="step-title">CV &amp; Outreach Generation</div>
                                    <div class="step-description">Generate personalized CV and outreach messages</div>
                                    <div class="step-status">Pending</div>
                                    <div class="step-error"></div>
                                    <div class="step-metadata">
                                        <div class="step-metadata-item">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <span class="step-duration">--</span>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ol>

                        <!-- Logs Terminal (collapsed by default) -->
                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Live Logs</h3>
                                <div class="flex items-center space-x-3">
                                    <button onclick="copyLogsToClipboard()"
                                            class="inline-flex items-center text-xs text-gray-600 hover:text-gray-800 font-medium transition"
                                            title="Copy all logs to clipboard">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                        </svg>
                                        Copy
                                    </button>
                                    <button onclick="toggleLogsFull()" class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">
                                        <span id="logs-toggle-text">Show</span>
                                    </button>
                                </div>
                            </div>
                            <div id="logs-container" class="hidden bg-gray-900 rounded-lg p-4 font-mono text-xs text-green-400 h-64 overflow-y-auto">
                                <div id="logs-content">Waiting for logs...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CV Section -->
            {% if job.has_cv %}
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Generated CV</h2>
                    <div class="flex gap-2">
                        <button onclick="openCVEditorPanel('{{ job._id }}')"
                                class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-indigo-700 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 transition">
                            <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                            Edit CV
                        </button>
                        <button onclick="exportCVFromDetailPage()"
                                class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">
                            <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                            </svg>
                            Export PDF
                        </button>
                    </div>
                </div>

                <!-- CV Preview Container (TipTap rendered with styles) -->
                <div id="cv-container" class="border border-gray-200 rounded-lg overflow-auto bg-white" style="max-height: 800px;">
                    {% if job.has_cv %}
                        <div id="cv-display-area" class="cv-preview-content">
                            <!-- Will be rendered by TipTap from editor state -->
                        </div>
                        <script>
                            // Render CV content from editor state (WYSIWYG)
                            async function renderCVPreview() {
                                try {
                                    // Fetch editor state from backend
                                    const response = await fetch('/api/jobs/{{ job._id }}/cv-editor');
                                    if (!response.ok) {
                                        console.error('Failed to load CV editor state');
                                        return;
                                    }

                                    const data = await response.json();
                                    const editorState = data.editor_state;

                                    if (!editorState || !editorState.content) {
                                        console.error('No editor state content found');
                                        return;
                                    }

                                    // Convert TipTap JSON to HTML using client-side converter
                                    const htmlContent = tiptapJsonToHtml(editorState.content);

                                    // Apply document styles
                                    const displayArea = document.getElementById('cv-display-area');
                                    displayArea.innerHTML = htmlContent;

                                    // Apply document-level styles
                                    if (editorState.documentStyles) {
                                        const styles = editorState.documentStyles;
                                        displayArea.style.fontFamily = styles.fontFamily || 'Inter, sans-serif';
                                        displayArea.style.fontSize = (styles.fontSize || 11) + 'pt';
                                        displayArea.style.lineHeight = styles.lineHeight || 1.5;
                                        displayArea.style.color = styles.colorText || '#1f2a38';
                                        displayArea.style.padding = `${styles.margins?.top || 1}in ${styles.margins?.right || 1}in ${styles.margins?.bottom || 1}in ${styles.margins?.left || 1}in`;
                                    }

                                } catch (error) {
                                    console.error('Error rendering CV preview:', error);
                                    document.getElementById('cv-display-area').innerHTML =
                                        '<p class="text-gray-500 text-center p-8">Error loading CV preview</p>';
                                }
                            }

                            // Helper function to convert TipTap JSON to HTML (client-side)
                            function tiptapJsonToHtml(content) {
                                if (!content || content.type !== 'doc') {
                                    return '';
                                }

                                function processNode(node) {
                                    const type = node.type;
                                    const children = node.content || [];
                                    const attrs = node.attrs || {};
                                    const marks = node.marks || [];

                                    // Text node
                                    if (type === 'text') {
                                        let text = node.text || '';
                                        // Apply marks
                                        marks.forEach(mark => {
                                            if (mark.type === 'bold') text = `<strong>${text}</strong>`;
                                            if (mark.type === 'italic') text = `<em>${text}</em>`;
                                            if (mark.type === 'underline') text = `<u>${text}</u>`;
                                            if (mark.type === 'textStyle') {
                                                const markAttrs = mark.attrs || {};
                                                const styles = [];
                                                if (markAttrs.fontFamily) styles.push(`font-family: ${markAttrs.fontFamily}`);
                                                if (markAttrs.fontSize) styles.push(`font-size: ${markAttrs.fontSize}`);
                                                if (markAttrs.color) styles.push(`color: ${markAttrs.color}`);
                                                if (styles.length > 0) {
                                                    text = `<span style="${styles.join('; ')}">${text}</span>`;
                                                }
                                            }
                                            if (mark.type === 'highlight') {
                                                const color = mark.attrs?.color || 'yellow';
                                                text = `<mark style="background-color: ${color}">${text}</mark>`;
                                            }
                                        });
                                        return text;
                                    }

                                    // Block nodes
                                    const innerHtml = children.map(processNode).join('');

                                    if (type === 'paragraph') {
                                        const align = attrs.textAlign || 'left';
                                        return align === 'left'
                                            ? `<p>${innerHtml}</p>`
                                            : `<p style="text-align: ${align}">${innerHtml}</p>`;
                                    }
                                    if (type === 'heading') {
                                        const level = attrs.level || 1;
                                        const align = attrs.textAlign || 'left';
                                        return align === 'left'
                                            ? `<h${level}>${innerHtml}</h${level}>`
                                            : `<h${level} style="text-align: ${align}">${innerHtml}</h${level}>`;
                                    }
                                    if (type === 'bulletList') return `<ul>${innerHtml}</ul>`;
                                    if (type === 'orderedList') return `<ol>${innerHtml}</ol>`;
                                    if (type === 'listItem') return `<li>${innerHtml}</li>`;
                                    if (type === 'hardBreak') return '<br>';
                                    if (type === 'horizontalRule') return '<hr>';

                                    return innerHtml;
                                }

                                return content.content.map(processNode).join('');
                            }

                            // Render on page load
                            document.addEventListener('DOMContentLoaded', renderCVPreview);

                            // Listen for CV content updates from editor
                            window.addEventListener('cvContentUpdated', (event) => {
                                if (event.detail.jobId === '{{ job._id }}') {
                                    renderCVPreview();  // Refresh display
                                }
                            });
                        </script>
                    {% else %}
                        <div class="p-8 text-center text-gray-500">
                            <p>No CV generated yet. Run the pipeline to generate a CV.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Cover Letter Section -->
            {% if job.cover_letter %}
            <div class="mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">
                        <svg class="inline-block h-4 w-4 mr-1 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Cover Letter
                    </h2>
                    <div class="flex gap-2">
                        <button id="edit-cl-btn" onclick="toggleCoverLetterEdit()"
                                class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-purple-700 bg-purple-50 hover:bg-purple-100 border border-purple-200 transition">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            <span id="edit-cl-text">Edit</span>
                        </button>
                        <button id="save-cl-btn" onclick="saveCoverLetterChanges()"
                                class="hidden inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Save
                        </button>
                        <button onclick="generateCoverLetterPDF()"
                                class="inline-flex items-center px-3 py-1 text-xs font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                            </svg>
                            Export PDF
                        </button>
                    </div>
                </div>

                <!-- Display Mode -->
                <div id="cl-display" class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <pre id="cl-text" class="whitespace-pre-wrap font-sans text-sm text-gray-800 leading-relaxed">{{ job.cover_letter }}</pre>
                </div>

                <!-- Edit Mode (hidden by default) -->
                <textarea id="cl-textarea"
                          class="hidden w-full h-64 p-4 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm"
                          placeholder="Enter cover letter text...">{{ job.cover_letter }}</textarea>

                <!-- Validation Warnings (shown after save) -->
                <div id="cl-warnings" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm text-yellow-800"></div>
            </div>
            {% endif %}

            <!-- Remarks Section -->
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">Notes & Remarks</h2>
                <div class="space-y-4">
                    <div>
                        <label for="remarks-textarea" class="block text-xs text-gray-500 mb-1">Your Remarks</label>
                        <textarea id="remarks-textarea"
                                  rows="4"
                                  class="w-full border border-gray-300 rounded-md p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Add your notes about this job opportunity...">{{ job.remarks or '' }}</textarea>
                    </div>
                    <div>
                        <label for="notes-textarea" class="block text-xs text-gray-500 mb-1">Additional Notes</label>
                        <textarea id="notes-textarea"
                                  rows="3"
                                  class="w-full border border-gray-300 rounded-md p-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                  placeholder="Additional notes (e.g., contact info, interview prep)...">{{ job.notes or '' }}</textarea>
                    </div>
                    <button onclick="saveRemarks()"
                            class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Notes
                    </button>
                </div>
            </div>

            <!-- Job Details Grid -->
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">Job Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Job ID (read-only) -->
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <span class="block text-xs text-gray-500 mb-1">Job ID</span>
                        <span class="text-sm font-mono">{{ job.jobId or '-' }}</span>
                    </div>
                    <!-- Dedupe Key (read-only) -->
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <span class="block text-xs text-gray-500 mb-1">Dedupe Key</span>
                        <span class="text-sm font-mono break-all">{{ job.dedupeKey or '-' }}</span>
                    </div>
                    <!-- Company (editable) -->
                    <div class="p-3 bg-gray-50 rounded-lg editable-field" data-field="company">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">Company</span>
                            <button onclick="enableEdit(this.closest('.editable-field'))" class="edit-btn text-gray-400 hover:text-indigo-600">
                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <span class="field-value text-sm">{{ job.company or '-' }}</span>
                        <input type="text" class="field-input hidden w-full border border-indigo-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-500" value="{{ job.company or '' }}">
                    </div>
                    <!-- Title (editable) -->
                    <div class="p-3 bg-gray-50 rounded-lg editable-field" data-field="title">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">Role/Title</span>
                            <button onclick="enableEdit(this.closest('.editable-field'))" class="edit-btn text-gray-400 hover:text-indigo-600">
                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <span class="field-value text-sm">{{ job.title or '-' }}</span>
                        <input type="text" class="field-input hidden w-full border border-indigo-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-500" value="{{ job.title or '' }}">
                    </div>
                    <!-- Location (editable) -->
                    <div class="p-3 bg-gray-50 rounded-lg editable-field" data-field="location">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">Location</span>
                            <button onclick="enableEdit(this.closest('.editable-field'))" class="edit-btn text-gray-400 hover:text-indigo-600">
                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <span class="field-value text-sm">{{ job.location or '-' }}</span>
                        <input type="text" class="field-input hidden w-full border border-indigo-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-500" value="{{ job.location or '' }}">
                    </div>
                    <!-- Score (editable) -->
                    <div class="p-3 bg-gray-50 rounded-lg editable-field" data-field="score">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">Score</span>
                            <button onclick="enableEdit(this.closest('.editable-field'))" class="edit-btn text-gray-400 hover:text-indigo-600">
                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        <span class="field-value text-sm">{{ job.score if job.score is not none else '-' }}</span>
                        <input type="number" class="field-input hidden w-full border border-indigo-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-500" value="{{ job.score if job.score is not none else '' }}">
                    </div>
                    <!-- Job URL (editable) -->
                    <div class="p-3 bg-gray-50 rounded-lg md:col-span-2 editable-field" data-field="url">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">Job URL</span>
                            <button onclick="enableEdit(this.closest('.editable-field'))" class="edit-btn text-gray-400 hover:text-indigo-600">
                                <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                        </div>
                        {% set job_url = job.url or job.jobUrl %}
                        {% if job_url %}
                        <a href="{{ job_url }}" target="_blank" class="field-value text-sm text-indigo-600 hover:underline break-all">{{ job_url }}</a>
                        {% else %}
                        <span class="field-value text-sm">-</span>
                        {% endif %}
                        <input type="url" class="field-input hidden w-full border border-indigo-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-indigo-500" value="{{ job_url or '' }}">
                    </div>
                </div>
            </div>

            <!-- Pain Points -->
            {% if job.pain_points is defined and job.pain_points %}
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">
                    <svg class="inline-block h-4 w-4 mr-1 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    Key Pain Points
                </h2>
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <ul class="space-y-2">
                        {% for pain_point in job.pain_points %}
                        <li class="flex items-start text-sm text-gray-700">
                            <svg class="h-5 w-5 text-red-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>{{ pain_point }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Opportunity/Fit Analysis -->
            {% if (job.fit_score is defined and job.fit_score is not none) or (job.fit_rationale is defined and job.fit_rationale) %}
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">
                    <svg class="inline-block h-4 w-4 mr-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Opportunity & Fit Analysis
                </h2>
                <div class="p-4 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg">
                    {% if job.fit_score is defined and job.fit_score is not none %}
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-medium text-gray-700">Fit Score:</span>
                        <span class="px-3 py-1 rounded-full text-sm font-bold
                            {% if job.fit_score >= 80 %}bg-green-100 text-green-800
                            {% elif job.fit_score >= 60 %}bg-blue-100 text-blue-800
                            {% elif job.fit_score >= 40 %}bg-yellow-100 text-yellow-800
                            {% else %}bg-gray-100 text-gray-600{% endif %}">
                            {{ job.fit_score }}/100
                            {% if job.fit_category is defined and job.fit_category %}({{ job.fit_category|capitalize }}){% endif %}
                        </span>
                    </div>
                    {% endif %}
                    {% if job.fit_rationale is defined and job.fit_rationale %}
                    <div class="text-sm text-gray-700 leading-relaxed">
                        {{ job.fit_rationale }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- People Mapper / Contacts -->
            {% if (job.primary_contacts is defined and job.primary_contacts) or (job.secondary_contacts is defined and job.secondary_contacts) %}
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">
                    <svg class="inline-block h-4 w-4 mr-1 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    Key Contacts & Outreach
                </h2>

                <!-- Primary Contacts -->
                {% if job.primary_contacts is defined and job.primary_contacts %}
                <div class="mb-4">
                    <h3 class="text-xs font-semibold text-indigo-700 uppercase mb-2">Primary Contacts (Hiring-Related)</h3>
                    <div class="space-y-3">
                        {% for contact in job.primary_contacts %}
                        <div class="p-4 bg-white border border-indigo-200 rounded-lg hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-semibold text-gray-900">{{ contact.name or contact.contact_name }}</h4>
                                    <p class="text-sm text-gray-600">{{ contact.role or contact.contact_role }}</p>
                                </div>
                                {% if contact.linkedin_url %}
                                <a href="{{ contact.linkedin_url }}" target="_blank"
                                   class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-indigo-700 bg-indigo-50 hover:bg-indigo-100 transition">
                                    <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                    </svg>
                                    LinkedIn
                                </a>
                                {% endif %}
                            </div>
                            {% if contact.why_relevant %}
                            <p class="text-xs text-gray-600 mb-2"><strong>Why relevant:</strong> {{ contact.why_relevant }}</p>
                            {% endif %}
                            {% if contact.linkedin_message %}
                            <details class="mt-2">
                                <summary class="cursor-pointer text-xs font-medium text-indigo-600 hover:text-indigo-800">View LinkedIn Message</summary>
                                <div class="mt-2 p-3 bg-gray-50 rounded text-xs text-gray-700">{{ contact.linkedin_message }}</div>
                            </details>
                            {% endif %}
                            {% if contact.email_subject and contact.email_body %}
                            <details class="mt-2">
                                <summary class="cursor-pointer text-xs font-medium text-indigo-600 hover:text-indigo-800">View Email Outreach</summary>
                                <div class="mt-2 space-y-2">
                                    <div class="p-2 bg-gray-50 rounded">
                                        <span class="text-xs font-semibold text-gray-700">Subject:</span>
                                        <p class="text-xs text-gray-600 mt-1">{{ contact.email_subject }}</p>
                                    </div>
                                    <div class="p-3 bg-gray-50 rounded">
                                        <span class="text-xs font-semibold text-gray-700">Body:</span>
                                        <p class="text-xs text-gray-700 mt-1 whitespace-pre-wrap">{{ contact.email_body }}</p>
                                    </div>
                                </div>
                            </details>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Secondary Contacts -->
                {% if job.secondary_contacts is defined and job.secondary_contacts %}
                <div>
                    <h3 class="text-xs font-semibold text-gray-600 uppercase mb-2">Secondary Contacts (Cross-Functional)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for contact in job.secondary_contacts %}
                        <div class="p-3 bg-gray-50 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-900">{{ contact.name or contact.contact_name }}</h4>
                                    <p class="text-xs text-gray-600">{{ contact.role or contact.contact_role }}</p>
                                </div>
                                {% if contact.linkedin_url %}
                                <a href="{{ contact.linkedin_url }}" target="_blank" class="text-gray-400 hover:text-indigo-600 transition">
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
                                    </svg>
                                </a>
                                {% endif %}
                            </div>
                            {% if contact.why_relevant %}
                            <p class="text-xs text-gray-500 mt-1">{{ contact.why_relevant }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Extracted JD Fields -->
            {% if job.extracted_jd is defined and job.extracted_jd %}
            <div class="mb-6">
                <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">
                    <svg class="inline-block h-4 w-4 mr-1 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    Extracted Job Requirements
                </h2>
                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg space-y-4">
                    <!-- Role Category & Seniority -->
                    <div class="flex flex-wrap gap-3">
                        {% if job.extracted_jd.role_category %}
                        <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            {{ job.extracted_jd.role_category|replace('_', ' ')|title }}
                        </div>
                        {% endif %}
                        {% if job.extracted_jd.seniority_level %}
                        <div class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                            <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            {{ job.extracted_jd.seniority_level|title }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Key Responsibilities -->
                    {% if job.extracted_jd.responsibilities %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                            Key Responsibilities
                        </h3>
                        <ul class="space-y-1 text-sm text-gray-700">
                            {% for responsibility in job.extracted_jd.responsibilities %}
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-indigo-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                {{ responsibility }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Qualifications -->
                    {% if job.extracted_jd.qualifications %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                            </svg>
                            Required Qualifications
                        </h3>
                        <ul class="space-y-1 text-sm text-gray-700">
                            {% for qualification in job.extracted_jd.qualifications %}
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-amber-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {{ qualification }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Top Keywords -->
                    {% if job.extracted_jd.top_keywords %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">Top Keywords</h3>
                        <div class="flex flex-wrap gap-2">
                            {% for keyword in job.extracted_jd.top_keywords %}
                            <span class="px-2 py-1 text-xs bg-white border border-purple-200 rounded text-gray-700">{{ keyword }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Technical Skills -->
                    {% if job.extracted_jd.technical_skills %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                            </svg>
                            Technical Skills
                        </h3>
                        <ul class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                            {% for skill in job.extracted_jd.technical_skills %}
                            <li class="flex items-center">
                                <svg class="h-4 w-4 text-blue-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {{ skill }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Soft Skills -->
                    {% if job.extracted_jd.soft_skills %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Soft Skills
                        </h3>
                        <ul class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                            {% for skill in job.extracted_jd.soft_skills %}
                            <li class="flex items-center">
                                <svg class="h-4 w-4 text-green-500 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {{ skill }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Implied Pain Points -->
                    {% if job.extracted_jd.implied_pain_points %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            Implied Pain Points
                        </h3>
                        <ul class="space-y-1 text-sm text-gray-700">
                            {% for pain_point in job.extracted_jd.implied_pain_points %}
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-orange-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                {{ pain_point }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Success Metrics -->
                    {% if job.extracted_jd.success_metrics %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Success Metrics
                        </h3>
                        <ul class="space-y-1 text-sm text-gray-700">
                            {% for metric in job.extracted_jd.success_metrics %}
                            <li class="flex items-start">
                                <svg class="h-4 w-4 text-teal-500 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                                {{ metric }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Competency Weights -->
                    {% if job.extracted_jd.competency_weights %}
                    <div>
                        <h3 class="text-xs font-semibold text-gray-700 mb-2">
                            <svg class="inline-block h-3 w-3 mr-1 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                            </svg>
                            Competency Weights
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            {% if job.extracted_jd.competency_weights.delivery is defined %}
                            <div class="bg-white p-2 rounded border border-purple-200">
                                <div class="text-xs text-gray-600">Delivery</div>
                                <div class="text-lg font-semibold text-violet-700">{{ job.extracted_jd.competency_weights.delivery }}%</div>
                            </div>
                            {% endif %}
                            {% if job.extracted_jd.competency_weights.process is defined %}
                            <div class="bg-white p-2 rounded border border-purple-200">
                                <div class="text-xs text-gray-600">Process</div>
                                <div class="text-lg font-semibold text-violet-700">{{ job.extracted_jd.competency_weights.process }}%</div>
                            </div>
                            {% endif %}
                            {% if job.extracted_jd.competency_weights.architecture is defined %}
                            <div class="bg-white p-2 rounded border border-purple-200">
                                <div class="text-xs text-gray-600">Architecture</div>
                                <div class="text-lg font-semibold text-violet-700">{{ job.extracted_jd.competency_weights.architecture }}%</div>
                            </div>
                            {% endif %}
                            {% if job.extracted_jd.competency_weights.leadership is defined %}
                            <div class="bg-white p-2 rounded border border-purple-200">
                                <div class="text-xs text-gray-600">Leadership</div>
                                <div class="text-lg font-semibold text-violet-700">{{ job.extracted_jd.competency_weights.leadership }}%</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Job Description (Collapsible) -->
            {% if job.description %}
            <div class="mb-6">
                <button onclick="toggleJobDescription()"
                        class="flex items-center text-sm font-semibold text-gray-700 uppercase tracking-wide hover:text-gray-900 mb-3">
                    <svg id="job-description-chevron" class="h-4 w-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    Job Description
                </button>
                <div id="job-description-preview" class="p-4 bg-gray-50 rounded-lg cursor-pointer" onclick="toggleJobDescription()">
                    <div class="prose prose-sm max-w-none text-gray-700 line-clamp-3">{{ job.description[:200] }}{% if job.description|length > 200 %}...{% endif %}</div>
                    <div class="mt-2 text-xs text-indigo-600 hover:text-indigo-800">Click to expand</div>
                </div>
                <div id="job-description-full" class="hidden p-4 bg-gray-50 rounded-lg">
                    <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap">{{ job.description }}</div>
                </div>
            </div>
            {% endif %}

            <!-- Original Job Posting Viewer (Iframe) -->
            {% set job_url = job.url or job.jobUrl %}
            {% if job_url %}
            <div class="mb-6">
                <button onclick="toggleJobViewer()"
                        class="flex items-center gap-2 text-sm font-semibold text-indigo-600 hover:text-indigo-800 mb-3"
                        aria-expanded="false"
                        aria-controls="job-viewer-container">
                    <svg id="job-viewer-icon" class="h-4 w-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span>View Original Job Posting</span>
                </button>

                <div id="job-viewer-container" class="hidden mt-4" role="region" aria-label="Original Job Posting Viewer">
                    <div class="border border-gray-300 rounded-lg overflow-hidden shadow-sm">
                        <!-- Iframe Header -->
                        <div class="bg-gray-100 px-4 py-3 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 border-b border-gray-300">
                            <div class="flex items-center gap-2 text-sm text-gray-600 truncate max-w-full">
                                <svg class="h-4 w-4 flex-shrink-0 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                </svg>
                                <span class="truncate">Source: <a href="{{ job_url }}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">
                                    {% if job_url|length > 50 %}{{ job_url[:50] }}...{% else %}{{ job_url }}{% endif %}
                                </a></span>
                            </div>
                            <div class="flex gap-2 flex-shrink-0">
                                <button id="export-page-pdf-btn"
                                        onclick="exportPagePDF('{{ job._id }}', '{{ job_url }}')"
                                        class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 transition">
                                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span id="export-page-pdf-text">Export PDF</span>
                                </button>
                                <button onclick="window.open('{{ job_url }}', '_blank')"
                                        class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 transition">
                                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                    Open in New Tab
                                </button>
                            </div>
                        </div>

                        <!-- Iframe Content -->
                        <div id="iframe-loading" class="p-8 bg-gray-50 text-center">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-2 text-indigo-600" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="text-sm text-gray-600">Loading job posting...</p>
                        </div>
                        <div id="iframe-error" class="hidden p-6 bg-yellow-50 border-t border-yellow-200">
                            <div class="flex items-start gap-3">
                                <svg class="h-6 w-6 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="flex-1">
                                    <h4 class="text-sm font-semibold text-yellow-800 mb-1">Unable to load job posting</h4>
                                    <p class="text-sm text-yellow-700 mb-3">This site prevents embedding in iframes for security reasons. This is common for job boards like LinkedIn, Indeed, and Glassdoor.</p>
                                    <a href="{{ job_url }}" target="_blank" rel="noopener noreferrer"
                                       class="inline-flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800">
                                        Open in new tab instead
                                        <svg class="h-4 w-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <iframe
                            id="job-iframe"
                            src="{{ job_url }}"
                            class="w-full h-[600px] border-0 bg-white hidden"
                            sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
                            referrerpolicy="no-referrer"
                            loading="lazy"
                            title="Original Job Posting"
                        ></iframe>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Raw Data (Expandable) -->
            <div>
                <button onclick="toggleRawData()"
                        class="flex items-center text-sm text-gray-500 hover:text-gray-700">
                    <svg id="raw-data-chevron" class="h-4 w-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    View Raw Data
                </button>
                <div id="raw-data-container" class="hidden mt-3">
                    <pre class="p-4 bg-gray-800 text-gray-100 rounded-lg overflow-x-auto text-xs">{{ job | tojson(indent=2) }}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Section -->
    <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
        <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">Danger Zone</h2>
        <p class="text-sm text-gray-600 mb-4">Once you delete this job, there is no going back. Please be certain.</p>
        <button onclick="deleteJob()"
                class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete This Job
        </button>
    </div>
</div>

<!-- CV Rich Text Editor Side Panel -->
<!-- Phase 5: Skip link for accessibility -->
<a href="#cv-editor-content" class="skip-link">Skip to CV editor</a>

<div id="cv-editor-overlay"
     class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-200"
     onclick="closeCVEditorPanel()"
     role="presentation"
     aria-hidden="true">
</div>

<div id="cv-editor-panel"
     class="fixed inset-y-0 right-0 w-11/12 sm:w-2/3 lg:w-1/2 bg-white shadow-2xl
            transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col"
     role="dialog"
     aria-labelledby="cv-editor-title"
     aria-modal="true">

    <!-- Header -->
    <div class="flex items-center justify-between px-4 sm:px-6 py-4 border-b border-gray-200 bg-gray-50">
        <div class="flex items-center space-x-2 sm:space-x-4">
            <button onclick="closeCVEditorPanel()"
                    class="text-gray-400 hover:text-gray-600 transition p-2"
                    aria-label="Close CV editor (Escape key)"
                    title="Close (Esc)">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            <h2 id="cv-editor-title" class="text-base sm:text-lg font-semibold text-gray-900">Edit CV</h2>
        </div>

        <div class="flex items-center space-x-2 sm:space-x-4">
            <!-- Phase 5.2: Undo/Redo Buttons -->
            <div class="hidden sm:flex items-center gap-1" role="group" aria-label="Edit history">
                <button id="cv-undo-btn"
                        onclick="if(cvEditorInstance && cvEditorInstance.editor) cvEditorInstance.editor.chain().focus().undo().run()"
                        class="text-gray-400 hover:text-gray-600 transition p-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        aria-label="Undo (Ctrl+Z)"
                        title="Undo (Ctrl+Z)"
                        disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                    </svg>
                </button>
                <button id="cv-redo-btn"
                        onclick="if(cvEditorInstance && cvEditorInstance.editor) cvEditorInstance.editor.chain().focus().redo().run()"
                        class="text-gray-400 hover:text-gray-600 transition p-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        aria-label="Redo (Ctrl+Shift+Z)"
                        title="Redo (Ctrl+Shift+Z)"
                        disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 10H11a8 8 0 00-8 8v2m18-10l-6 6m6-6l-6-6"/>
                    </svg>
                </button>
            </div>

            <!-- Divider (hidden on mobile) -->
            <div class="hidden sm:block w-px h-6 bg-gray-300"></div>

            <!-- Phase 5.2: Keyboard Shortcuts Help Button -->
            <button onclick="toggleKeyboardShortcutsPanel()"
                    class="hidden sm:block text-gray-400 hover:text-gray-600 transition p-2"
                    aria-label="Keyboard shortcuts (Ctrl+/)"
                    title="Keyboard Shortcuts (Ctrl+/)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </button>

            <!-- Divider -->
            <div class="hidden sm:block w-px h-6 bg-gray-300"></div>

            <!-- Phase 5.2: Enhanced Save Indicator (with unsaved changes tracking) -->
            <span id="cv-save-indicator"
                  class="text-xs sm:text-sm text-gray-500"
                  role="status"
                  aria-live="polite"
                  aria-atomic="true">
                <span class="text-green-500" aria-label="CV saved successfully"> Saved</span>
            </span>

            <!-- Expand/Collapse Button -->
            <button onclick="toggleCVPanelSize()"
                    class="hidden sm:block text-gray-400 hover:text-gray-600 transition p-2"
                    aria-label="Toggle panel size"
                    title="Expand/Collapse">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                </svg>
            </button>

            <!-- Export PDF Button -->
            <button onclick="exportCVToPDF()"
                    class="inline-flex items-center px-2 sm:px-3 py-1.5 text-xs sm:text-sm font-medium
                           rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition
                           focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                    aria-label="Export CV as PDF (Ctrl+P)"
                    title="Export PDF (Ctrl+P)">
                <svg class="w-3 h-3 sm:w-4 sm:h-4 sm:mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>
                <span class="hidden sm:inline">Export PDF</span>
                <span class="sm:hidden">PDF</span>
            </button>
        </div>
    </div>

    <!-- Toolbar (Phase 2: Enhanced, Phase 5: Accessible + Mobile) -->
    <div class="px-4 sm:px-6 py-3 border-b border-gray-200 bg-white cv-toolbar"
         role="toolbar"
         aria-label="Text formatting controls"
         aria-controls="cv-editor-content">
        <div class="flex flex-wrap items-center gap-2">
            <!-- Font Group -->
            <div class="flex gap-1">
                <label for="cv-font-family" class="sr-only">Font family</label>
                <select id="cv-font-family" onchange="applyCVFormat('fontFamily', this.value)"
                        class="text-sm border-gray-300 rounded-md px-2 py-1.5 focus:ring-2 focus:ring-indigo-500 w-48"
                        aria-label="Select font family">
                    <optgroup label="Serif (Professional)">
                        <option value="Crimson Text">Crimson Text</option>
                        <option value="EB Garamond">EB Garamond</option>
                        <option value="Libre Baskerville">Libre Baskerville</option>
                        <option value="Lora">Lora</option>
                        <option value="Merriweather">Merriweather</option>
                        <option value="Playfair Display">Playfair Display</option>
                        <option value="Spectral">Spectral</option>
                        <option value="Source Serif Pro">Source Serif Pro</option>
                        <option value="PT Serif">PT Serif</option>
                        <option value="Bitter">Bitter</option>
                        <option value="Arvo">Arvo</option>
                        <option value="Cardo">Cardo</option>
                        <option value="Cormorant Garamond">Cormorant Garamond</option>
                        <option value="Neuton">Neuton</option>
                        <option value="Vollkorn">Vollkorn</option>
                    </optgroup>
                    <optgroup label="Sans-Serif (Modern)">
                        <option value="Inter" selected>Inter</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Open Sans">Open Sans</option>
                        <option value="Lato">Lato</option>
                        <option value="Montserrat">Montserrat</option>
                        <option value="Raleway">Raleway</option>
                        <option value="Nunito">Nunito</option>
                        <option value="Poppins">Poppins</option>
                        <option value="Work Sans">Work Sans</option>
                        <option value="IBM Plex Sans">IBM Plex Sans</option>
                        <option value="Karla">Karla</option>
                        <option value="Rubik">Rubik</option>
                        <option value="DM Sans">DM Sans</option>
                        <option value="Manrope">Manrope</option>
                        <option value="Plus Jakarta Sans">Plus Jakarta Sans</option>
                        <option value="Space Grotesk">Space Grotesk</option>
                        <option value="Outfit">Outfit</option>
                        <option value="Archivo">Archivo</option>
                        <option value="Public Sans">Public Sans</option>
                        <option value="Red Hat Display">Red Hat Display</option>
                    </optgroup>
                    <optgroup label="Monospace (Technical)">
                        <option value="Fira Code">Fira Code</option>
                        <option value="JetBrains Mono">JetBrains Mono</option>
                        <option value="Source Code Pro">Source Code Pro</option>
                        <option value="IBM Plex Mono">IBM Plex Mono</option>
                        <option value="Roboto Mono">Roboto Mono</option>
                        <option value="Inconsolata">Inconsolata</option>
                    </optgroup>
                    <optgroup label="Display (Creative)">
                        <option value="Bebas Neue">Bebas Neue</option>
                        <option value="Archivo Black">Archivo Black</option>
                        <option value="Righteous">Righteous</option>
                        <option value="Josefin Sans">Josefin Sans</option>
                        <option value="Oswald">Oswald</option>
                        <option value="Anton">Anton</option>
                        <option value="Kanit">Kanit</option>
                    </optgroup>
                    <optgroup label="Condensed (Space-Saving)">
                        <option value="Roboto Condensed">Roboto Condensed</option>
                        <option value="PT Sans Narrow">PT Sans Narrow</option>
                        <option value="Fira Sans Condensed">Fira Sans Condensed</option>
                        <option value="Barlow Condensed">Barlow Condensed</option>
                    </optgroup>
                    <optgroup label="Rounded (Friendly)">
                        <option value="Nunito Sans">Nunito Sans</option>
                        <option value="Quicksand">Quicksand</option>
                        <option value="Varela Round">Varela Round</option>
                        <option value="Comfortaa">Comfortaa</option>
                    </optgroup>
                </select>
                <label for="cv-font-size" class="sr-only">Font size</label>
                <select id="cv-font-size" onchange="applyCVFormat('fontSize', this.value)"
                        class="text-sm border-gray-300 rounded-md px-2 py-1.5 focus:ring-2 focus:ring-indigo-500 w-20"
                        aria-label="Select font size">
                    <option value="8pt">8pt</option>
                    <option value="9pt">9pt</option>
                    <option value="10pt">10pt</option>
                    <option value="11pt" selected>11pt</option>
                    <option value="12pt">12pt</option>
                    <option value="13pt">13pt</option>
                    <option value="14pt">14pt</option>
                    <option value="16pt">16pt</option>
                    <option value="18pt">18pt</option>
                    <option value="20pt">20pt</option>
                    <option value="22pt">22pt</option>
                    <option value="24pt">24pt</option>
                </select>
            </div>

            <div class="w-px h-6 bg-gray-300"></div>

            <!-- Formatting Group -->
            <div class="flex gap-1" role="group" aria-label="Text formatting">
                <button onclick="applyCVFormat('bold')" data-format="bold"
                        class="p-1.5 rounded hover:bg-gray-200 transition font-bold min-w-[2.75rem]"
                        aria-label="Bold (Ctrl+B)"
                        aria-pressed="false"
                        title="Bold (Ctrl+B)">
                    B
                </button>
                <button onclick="applyCVFormat('italic')" data-format="italic"
                        class="p-1.5 rounded hover:bg-gray-200 transition italic min-w-[2.75rem]"
                        aria-label="Italic (Ctrl+I)"
                        aria-pressed="false"
                        title="Italic (Ctrl+I)">
                    I
                </button>
                <button onclick="applyCVFormat('underline')" data-format="underline"
                        class="p-1.5 rounded hover:bg-gray-200 transition underline min-w-[2.75rem]"
                        aria-label="Underline (Ctrl+U)"
                        aria-pressed="false"
                        title="Underline (Ctrl+U)">
                    U
                </button>
            </div>

            <div class="w-px h-6 bg-gray-300"></div>

            <!-- Headings Group -->
            <div class="flex gap-1" role="group" aria-label="Heading levels">
                <button onclick="applyCVFormat('heading1')" data-heading="1"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-sm font-semibold min-w-[2.75rem]"
                        aria-label="Heading 1"
                        aria-pressed="false"
                        title="Heading 1">
                    H1
                </button>
                <button onclick="applyCVFormat('heading2')" data-heading="2"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-sm font-semibold min-w-[2.75rem]"
                        aria-label="Heading 2"
                        aria-pressed="false"
                        title="Heading 2">
                    H2
                </button>
                <button onclick="applyCVFormat('heading3')" data-heading="3"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-sm font-semibold min-w-[2.75rem]"
                        aria-label="Heading 3"
                        aria-pressed="false"
                        title="Heading 3">
                    H3
                </button>
            </div>

            <div class="w-px h-6 bg-gray-300"></div>

            <!-- Lists Group -->
            <div class="flex gap-1" role="group" aria-label="List formatting">
                <button onclick="applyCVFormat('bulletList')" data-format="bulletList"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-sm"
                        aria-label="Bullet list"
                        aria-pressed="false"
                        title="Bullet List">
                    <span aria-hidden="true"></span> List
                </button>
                <button onclick="applyCVFormat('orderedList')" data-format="orderedList"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-sm"
                        aria-label="Numbered list"
                        aria-pressed="false"
                        title="Numbered List">
                    <span aria-hidden="true">1.</span> List
                </button>
            </div>

            <div class="w-px h-6 bg-gray-300" aria-hidden="true"></div>

            <!-- Alignment Group (Phase 2) -->
            <div class="flex gap-1" role="group" aria-label="Text alignment">
                <button onclick="applyCVFormat('textAlign', 'left')" data-align="left"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition border border-transparent min-w-[2.75rem]"
                        aria-label="Align left"
                        aria-pressed="false"
                        title="Align Left">
                    <span aria-hidden="true"></span>
                </button>
                <button onclick="applyCVFormat('textAlign', 'center')" data-align="center"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition border border-transparent min-w-[2.75rem]"
                        aria-label="Align center"
                        aria-pressed="false"
                        title="Align Center">
                    <span aria-hidden="true"></span>
                </button>
                <button onclick="applyCVFormat('textAlign', 'right')" data-align="right"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition border border-transparent min-w-[2.75rem]"
                        aria-label="Align right"
                        aria-pressed="false"
                        title="Align Right">
                    <span aria-hidden="true"></span>
                </button>
                <button onclick="applyCVFormat('textAlign', 'justify')" data-align="justify"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition border border-transparent min-w-[2.75rem]"
                        aria-label="Justify"
                        aria-pressed="false"
                        title="Justify">
                    <span aria-hidden="true"></span>
                </button>
            </div>

            <div class="w-px h-6 bg-gray-300"></div>

            <!-- Indentation Group (Phase 2) -->
            <div class="flex gap-1" role="group" aria-label="Text indentation">
                <button onclick="cvEditorInstance?.decreaseIndent()"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-xs"
                        aria-label="Decrease indent (Shift+Tab)"
                        title="Decrease Indent (Shift+Tab)">
                    <span aria-hidden="true"></span> <span class="hidden sm:inline">Outdent</span>
                </button>
                <button onclick="cvEditorInstance?.increaseIndent()"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-xs"
                        aria-label="Increase indent (Tab)"
                        title="Increase Indent (Tab)">
                    <span class="hidden sm:inline">Indent</span> <span aria-hidden="true"></span>
                </button>
            </div>

            <div class="w-px h-6 bg-gray-300" aria-hidden="true"></div>

            <!-- Color Group (Phase 2) -->
            <div class="flex gap-1" role="group" aria-label="Text and highlight colors">
                <label class="px-2 py-1.5 rounded hover:bg-gray-200 cursor-pointer inline-flex items-center text-xs border border-gray-300"
                       aria-label="Text color picker"
                       title="Text Color">
                    <span aria-hidden="true">A</span> <span class="ml-1 text-xs" aria-hidden="true"></span>
                    <input type="color" id="cv-text-color" value="#1a1a1a"
                           onchange="applyCVFormat('color', this.value)"
                           aria-label="Select text color"
                           class="hidden">
                </label>
                <label class="px-2 py-1.5 rounded hover:bg-gray-200 cursor-pointer inline-flex items-center text-xs border border-gray-300"
                       aria-label="Highlight color picker"
                       title="Highlight Color">
                    <span aria-hidden="true"></span>
                    <input type="color" id="cv-highlight-color" value="#ffff00"
                           onchange="applyCVFormat('highlight', this.value)"
                           aria-label="Select highlight color"
                           class="hidden">
                </label>
                <button onclick="applyCVFormat('removeHighlight')"
                        class="px-2 py-1.5 rounded hover:bg-gray-200 transition text-xs border border-gray-300"
                        aria-label="Remove highlight"
                        title="Remove Highlight">
                    <span aria-hidden="true"></span>
                </button>
            </div>
        </div>

        <!-- Phase 3: Document-Level Styles Toolbar -->
        <div class="px-4 sm:px-6 py-3 border-b border-gray-200 bg-gray-100 cv-document-settings"
             role="region"
             aria-labelledby="document-settings-heading">
            <details class="group">
                <summary class="cursor-pointer text-xs font-semibold text-gray-700 uppercase tracking-wide mb-2 hover:text-indigo-600"
                         id="document-settings-heading"
                         aria-expanded="false"
                         aria-controls="document-settings-content">
                    <span class="inline-block transform transition-transform group-open:rotate-90" aria-hidden="true"></span>
                    Document Settings (Page Layout)
                </summary>
                <div id="document-settings-content" class="flex flex-wrap items-center gap-4 pl-5">
                    <!-- Line Height -->
                    <div class="flex flex-col gap-1">
                        <label for="cv-line-height" class="text-xs text-gray-600">Line Height</label>
                        <select id="cv-line-height" onchange="applyDocumentStyle('lineHeight')"
                                class="text-sm border-gray-300 rounded-md px-2 py-1.5 focus:ring-2 focus:ring-indigo-500 w-28">
                            <option value="1.0">Single (1.0)</option>
                            <option value="1.15" selected>Standard (1.15)</option>
                            <option value="1.5">1.5 Lines</option>
                            <option value="2.0">Double (2.0)</option>
                        </select>
                    </div>

                    <div class="w-px h-12 bg-gray-300"></div>

                    <!-- Margins -->
                    <div class="flex flex-col gap-1">
                        <label class="text-xs text-gray-600">Margins (inches)</label>
                        <div class="flex gap-2">
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500">Top</span>
                                <select id="cv-margin-top" onchange="applyDocumentStyle('margins')"
                                        class="text-sm border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-indigo-500 w-20">
                                    <option value="0.5">0.5"</option>
                                    <option value="0.75">0.75"</option>
                                    <option value="1.0" selected>1.0"</option>
                                    <option value="1.25">1.25"</option>
                                    <option value="1.5">1.5"</option>
                                    <option value="1.75">1.75"</option>
                                    <option value="2.0">2.0"</option>
                                </select>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500">Right</span>
                                <select id="cv-margin-right" onchange="applyDocumentStyle('margins')"
                                        class="text-sm border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-indigo-500 w-20">
                                    <option value="0.5">0.5"</option>
                                    <option value="0.75">0.75"</option>
                                    <option value="1.0" selected>1.0"</option>
                                    <option value="1.25">1.25"</option>
                                    <option value="1.5">1.5"</option>
                                    <option value="1.75">1.75"</option>
                                    <option value="2.0">2.0"</option>
                                </select>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500">Bottom</span>
                                <select id="cv-margin-bottom" onchange="applyDocumentStyle('margins')"
                                        class="text-sm border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-indigo-500 w-20">
                                    <option value="0.5">0.5"</option>
                                    <option value="0.75">0.75"</option>
                                    <option value="1.0" selected>1.0"</option>
                                    <option value="1.25">1.25"</option>
                                    <option value="1.5">1.5"</option>
                                    <option value="1.75">1.75"</option>
                                    <option value="2.0">2.0"</option>
                                </select>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-xs text-gray-500">Left</span>
                                <select id="cv-margin-left" onchange="applyDocumentStyle('margins')"
                                        class="text-sm border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-indigo-500 w-20">
                                    <option value="0.5">0.5"</option>
                                    <option value="0.75">0.75"</option>
                                    <option value="1.0" selected>1.0"</option>
                                    <option value="1.25">1.25"</option>
                                    <option value="1.5">1.5"</option>
                                    <option value="1.75">1.75"</option>
                                    <option value="2.0">2.0"</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="w-px h-12 bg-gray-300"></div>

                    <!-- Page Size -->
                    <div class="flex flex-col gap-1">
                        <label for="cv-page-size" class="text-xs text-gray-600">Page Size</label>
                        <select id="cv-page-size" onchange="applyDocumentStyle('pageSize')"
                                class="text-sm border-gray-300 rounded-md px-2 py-1.5 focus:ring-2 focus:ring-indigo-500 w-32">
                            <option value="letter" selected>Letter (8.5" x 11")</option>
                            <option value="a4">A4 (210mm x 297mm)</option>
                        </select>
                    </div>

                    <div class="w-px h-12 bg-gray-300"></div>

                    <!-- Header/Footer -->
                    <div class="flex flex-col gap-1">
                        <label class="text-xs text-gray-600">Header/Footer (Optional)</label>
                        <div class="flex gap-2">
                            <input type="text" id="cv-header-text" placeholder="Header text (e.g., Name | Email | Phone)"
                                   class="text-xs border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-indigo-500 w-64"
                                   onchange="applyDocumentStyle('header')">
                            <input type="text" id="cv-footer-text" placeholder="Footer text (e.g., Page number)"
                                   class="text-xs border-gray-300 rounded-md px-2 py-1 focus:ring-2 focus:ring-indigo-500 w-64"
                                   onchange="applyDocumentStyle('footer')">
                        </div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- Editor Content Area -->
    <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
        <div id="cv-editor-content"
             class="bg-white border border-gray-200 rounded-lg shadow-inner
                    min-h-full mx-auto"
             style="max-width: 8.5in; min-height: 11in;">
            <!-- TipTap renders here -->
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Job Detail Scripts - Updated 2025-11-28-21:30 - Fix syntax error in eventSource listeners
    const jobId = "{{ job._id }}";

    // Toast notification function
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');

        // Map type to toast class
        const typeClass = type === 'error' ? 'toast-error' : type === 'info' ? 'toast-info' : 'toast-success';
        toast.className = `toast ${typeClass}`;

        // Icon based on type
        const icons = {
            success: `<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>`,
            error: `<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>`,
            info: `<svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>`
        };

        toast.innerHTML = `
            ${icons[type] || icons.success}
            <span class="text-sm font-medium text-gray-900">${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        `;

        document.body.appendChild(toast);

        // Auto-dismiss after 4 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(2rem)';
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    }

    // Update a single job field
    async function updateJobField(field, value) {
        try {
            const response = await fetch(`/api/jobs/${jobId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: value })
            });

            const result = await response.json();

            if (result.success) {
                showToast(`${field} updated successfully`);
            } else {
                showToast(result.error || 'Update failed', 'error');
            }
        } catch (err) {
            showToast('Update failed: ' + err.message, 'error');
        }
    }

    // Save remarks and notes
    async function saveRemarks() {
        const remarks = document.getElementById('remarks-textarea').value;
        const notes = document.getElementById('notes-textarea').value;

        try {
            const response = await fetch(`/api/jobs/${jobId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ remarks, notes })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Notes saved successfully');
            } else {
                showToast(result.error || 'Save failed', 'error');
            }
        } catch (err) {
            showToast('Save failed: ' + err.message, 'error');
        }
    }

    // Delete job
    async function deleteJob() {
        if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch('/api/jobs/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ job_ids: [jobId] })
            });

            const result = await response.json();

            if (result.success) {
                showToast('Job deleted successfully');
                // Redirect to home after short delay
                setTimeout(() => {
                    window.location.href = '/';
                }, 1000);
            } else {
                showToast(result.error || 'Delete failed', 'error');
            }
        } catch (err) {
            showToast('Delete failed: ' + err.message, 'error');
        }
    }

    // Toggle raw data visibility
    function toggleRawData() {
        const container = document.getElementById('raw-data-container');
        const chevron = document.getElementById('raw-data-chevron');

        container.classList.toggle('hidden');
        chevron.classList.toggle('rotate-90');
    }

    function toggleJobDescription() {
        const preview = document.getElementById('job-description-preview');
        const full = document.getElementById('job-description-full');
        const chevron = document.getElementById('job-description-chevron');

        if (preview.classList.contains('hidden')) {
            // Show preview, hide full
            preview.classList.remove('hidden');
            full.classList.add('hidden');
            chevron.classList.remove('rotate-90');
        } else {
            // Show full, hide preview
            preview.classList.add('hidden');
            full.classList.remove('hidden');
            chevron.classList.add('rotate-90');
        }
    }

    function toggleJobViewer() {
        const container = document.getElementById('job-viewer-container');
        const icon = document.getElementById('job-viewer-icon');
        const button = document.querySelector('[aria-controls="job-viewer-container"]');

        if (container.classList.contains('hidden')) {
            // Show iframe viewer
            container.classList.remove('hidden');
            icon.classList.add('rotate-90');
            button.setAttribute('aria-expanded', 'true');

            // Initialize iframe on first open
            const iframe = document.getElementById('job-iframe');
            if (!iframe.dataset.initialized) {
                iframe.dataset.initialized = 'true';
                setupIframeHandlers();
            }
        } else {
            // Hide iframe viewer
            container.classList.add('hidden');
            icon.classList.remove('rotate-90');
            button.setAttribute('aria-expanded', 'false');
        }
    }

    /**
     * Export job posting URL to PDF (Bug #7 Phase 2)
     * Uses Playwright on the server to capture the page
     */
    async function exportPagePDF(jobId, url) {
        const btn = document.getElementById('export-page-pdf-btn');
        const textEl = document.getElementById('export-page-pdf-text');
        const originalText = textEl.textContent;

        // Disable button and show loading state
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
        textEl.textContent = 'Generating...';

        try {
            const response = await fetch(`/api/jobs/${jobId}/export-page-pdf`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: url })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error || `PDF generation failed (${response.status})`;
                throw new Error(errorMsg);
            }

            // Download the PDF
            const blob = await response.blob();
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;

            // Extract filename from Content-Disposition header
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'job_posting.pdf';
            if (contentDisposition && contentDisposition.includes('filename=')) {
                const match = contentDisposition.match(/filename="?([^"]+)"?/);
                if (match) filename = match[1];
            }
            a.download = filename;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);

            // Show success briefly
            textEl.textContent = 'Downloaded!';
            setTimeout(() => {
                textEl.textContent = originalText;
            }, 2000);

        } catch (error) {
            console.error('Export PDF failed:', error);
            showToast(error.message || 'Failed to export PDF. Try opening in new tab instead.', 'error');
            textEl.textContent = originalText;
        } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    function setupIframeHandlers() {
        const iframe = document.getElementById('job-iframe');
        const loading = document.getElementById('iframe-loading');
        const error = document.getElementById('iframe-error');

        // Timeout to detect if iframe doesn't load (blocked by X-Frame-Options)
        const loadTimeout = setTimeout(() => {
            // If still loading after 10 seconds, assume it's blocked
            if (!loading.classList.contains('hidden')) {
                loading.classList.add('hidden');
                error.classList.remove('hidden');
            }
        }, 10000);

        // Handle successful load
        iframe.addEventListener('load', function() {
            clearTimeout(loadTimeout);
            loading.classList.add('hidden');

            // Try to access iframe content to check if blocked
            try {
                // This will throw if X-Frame-Options blocks access
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc) {
                    // Successfully loaded
                    iframe.classList.remove('hidden');
                } else {
                    // Blocked
                    error.classList.remove('hidden');
                }
            } catch (e) {
                // Cross-origin or blocked - show error
                error.classList.remove('hidden');
            }
        });

        // Handle load errors
        iframe.addEventListener('error', function() {
            clearTimeout(loadTimeout);
            loading.classList.add('hidden');
            error.classList.remove('hidden');
        });
    }

    // ============================================================================
    // Inline Editing
    // ============================================================================

    // Enable edit mode for a field
    function enableEdit(fieldElement) {
        const valueEl = fieldElement.querySelector('.field-value');
        const inputEl = fieldElement.querySelector('.field-input');
        const editBtn = fieldElement.querySelector('.edit-btn');

        // Hide value, show input
        valueEl.classList.add('hidden');
        inputEl.classList.remove('hidden');
        editBtn.classList.add('hidden');

        // Focus and select input
        inputEl.focus();
        inputEl.select();

        // Handle blur (auto-save)
        inputEl.addEventListener('blur', () => saveFieldEdit(fieldElement), { once: true });

        // Handle Enter key
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                inputEl.blur();
            }
            if (e.key === 'Escape') {
                cancelFieldEdit(fieldElement);
            }
        });
    }

    // Save the field edit
    async function saveFieldEdit(fieldElement) {
        const field = fieldElement.dataset.field;
        const valueEl = fieldElement.querySelector('.field-value');
        const inputEl = fieldElement.querySelector('.field-input');
        const editBtn = fieldElement.querySelector('.edit-btn');

        let newValue = inputEl.value.trim();

        // Convert score to number if applicable
        if (field === 'score' && newValue !== '') {
            newValue = parseInt(newValue, 10);
            if (isNaN(newValue)) newValue = null;
        }

        try {
            const response = await fetch(`/api/jobs/${jobId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [field]: newValue || null })
            });

            const result = await response.json();

            if (result.success) {
                // Update displayed value
                if (field === 'url' && newValue) {
                    valueEl.innerHTML = `<a href="${escapeHtml(newValue)}" target="_blank" class="text-indigo-600 hover:underline break-all">${escapeHtml(newValue)}</a>`;
                } else {
                    valueEl.textContent = newValue || '-';
                }
                showToast(`${field} updated`);
            } else {
                showToast(result.error || 'Update failed', 'error');
            }
        } catch (err) {
            showToast('Update failed: ' + err.message, 'error');
        }

        // Show value, hide input
        valueEl.classList.remove('hidden');
        inputEl.classList.add('hidden');
        editBtn.classList.remove('hidden');
    }

    // Cancel field edit (restore original value)
    function cancelFieldEdit(fieldElement) {
        const valueEl = fieldElement.querySelector('.field-value');
        const inputEl = fieldElement.querySelector('.field-input');
        const editBtn = fieldElement.querySelector('.edit-btn');

        // Restore input to original displayed value
        inputEl.value = valueEl.textContent === '-' ? '' : valueEl.textContent;

        // Show value, hide input
        valueEl.classList.remove('hidden');
        inputEl.classList.add('hidden');
        editBtn.classList.remove('hidden');
    }

    // Escape HTML for safe display
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ============================================================================
    // Pipeline Processing
    // ============================================================================

    let statusPollingInterval = null;
    let eventSource = null;

    // Process job through pipeline
    async function processJobDetail(jobId, jobTitle) {
        const confirmed = confirm(
            `Process job through pipeline?\n\n` +
            `Job: ${jobTitle}\n\n` +
            `This will trigger the full processing pipeline on the VPS runner.`
        );

        if (!confirmed) return;

        try {
            showToast('Starting pipeline...', 'info');

            const response = await fetch('/api/runner/jobs/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    job_id: jobId,
                    level: 2
                })
            });

            // Check for network errors
            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage;
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorData.detail || `Server error: ${response.status}`;
                } catch {
                    errorMessage = `Server error: ${response.status} - ${errorText}`;
                }
                showToast(errorMessage, 'error');
                return;
            }

            const result = await response.json();

            if (result.run_id) {
                showToast(`Pipeline started! Run ID: ${result.run_id}`);
                // Show pipeline status UI and start monitoring
                monitorPipeline(result.run_id);
            } else {
                showToast(result.error || 'Failed to start pipeline', 'error');
            }
        } catch (err) {
            console.error('Pipeline execution error:', err);
            showToast(`Pipeline failed: ${err.message}`, 'error');
        }
    }

    // Monitor pipeline execution
    function monitorPipeline(runId) {
        // Show pipeline progress container
        const container = document.getElementById('pipeline-progress-container');
        container.classList.remove('hidden');

        // Update run ID display
        document.getElementById('pipeline-run-id').textContent = `Run: ${runId}`;

        // Reset all steps to pending
        resetPipelineSteps();

        // Start log streaming
        startLogStreaming(runId);

        // OPTION 1: Use Server-Sent Events (SSE) for real-time updates
        // Uncomment when backend SSE endpoint is ready
        // connectPipelineSSE(runId);

        // OPTION 2: Poll status every 2 seconds (current fallback)
        statusPollingInterval = setInterval(() => pollPipelineStatus(runId), 2000);
        pollPipelineStatus(runId); // Initial poll
    }

    // Reset all pipeline steps to pending state
    function resetPipelineSteps() {
        const steps = document.querySelectorAll('.pipeline-step');
        steps.forEach(step => {
            step.className = 'pipeline-step pending';
            step.querySelector('.step-status').textContent = 'Pending';
            step.querySelector('.step-error').textContent = '';
            step.querySelector('.step-error').style.display = 'none';
            step.querySelector('.step-duration').textContent = '--';
        });

        // Reset overall progress
        document.getElementById('pipeline-overall-percent').textContent = '0%';
        document.getElementById('pipeline-overall-progress-bar').style.width = '0%';
    }

    // Connect to SSE endpoint for real-time pipeline updates
    function connectPipelineSSE(runId) {
        // Close existing connection if any
        if (eventSource) {
            eventSource.close();
        }

        // Connect to SSE endpoint (to be implemented in backend)
        eventSource = new EventSource(`/api/runner/jobs/${runId}/progress`);

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handlePipelineProgressUpdate(data);
            } catch (err) {
                console.error('Failed to parse SSE data:', err);
            }
        };

        eventSource.onerror = (err) => {
            console.error('SSE connection error:', err);
            // Fallback to polling on connection error
            eventSource.close();
            if (!statusPollingInterval) {
                statusPollingInterval = setInterval(() => pollPipelineStatus(runId), 2000);
            }
        };
    }

    // Handle pipeline progress update from SSE or polling
    function handlePipelineProgressUpdate(data) {
        if (!data) return;

        // Update specific layer if provided
        if (data.layer && data.status) {
            updatePipelineStep(data.layer, data.status, data.error, data.duration);
        }

        // Update overall progress
        if (data.progress !== undefined) {
            updateOverallProgress(data.progress);
        }

        // Handle completion
        if (data.status === 'complete' || data.status === 'completed') {
            handlePipelineComplete();
        }

        // Handle failure
        if (data.status === 'failed') {
            handlePipelineFailed(data.error);
        }
    }

    // Update individual pipeline step
    function updatePipelineStep(layerName, status, errorMessage, duration) {
        const step = document.querySelector(`[data-layer="${layerName}"]`);
        if (!step) {
            console.warn(`Layer not found: ${layerName}`);
            return;
        }

        // Remove all state classes
        step.classList.remove('pending', 'executing', 'success', 'failed', 'skipped');

        // Add new state class
        step.classList.add(status);

        // Update status text
        const statusEl = step.querySelector('.step-status');
        const statusText = {
            pending: 'Pending',
            executing: 'Executing...',
            success: 'Complete',
            failed: 'Failed',
            skipped: 'Skipped'
        };
        statusEl.textContent = statusText[status] || status;

        // Update error message if failed
        const errorEl = step.querySelector('.step-error');
        if (status === 'failed' && errorMessage) {
            errorEl.textContent = errorMessage;
            errorEl.style.display = 'block';
        } else {
            errorEl.style.display = 'none';
        }

        // Update duration if provided
        if (duration) {
            const durationEl = step.querySelector('.step-duration');
            durationEl.textContent = formatDuration(duration);
        }

        // Auto-scroll to executing step
        if (status === 'executing') {
            step.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Update overall progress bar
    function updateOverallProgress(percent) {
        const percentEl = document.getElementById('pipeline-overall-percent');
        const progressBar = document.getElementById('pipeline-overall-progress-bar');

        percentEl.textContent = `${Math.round(percent)}%`;
        progressBar.style.width = `${percent}%`;
    }

    // Calculate overall progress based on completed steps
    function calculateOverallProgress() {
        const steps = document.querySelectorAll('.pipeline-step');
        const totalSteps = steps.length;
        let completedSteps = 0;

        steps.forEach(step => {
            if (step.classList.contains('success')) {
                completedSteps++;
            } else if (step.classList.contains('executing')) {
                completedSteps += 0.5; // Half credit for in-progress
            }
        });

        const progress = (completedSteps / totalSteps) * 100;
        updateOverallProgress(progress);
    }

    // Handle pipeline completion
    function handlePipelineComplete() {
        // Stop polling
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }

        // Close SSE connection
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // Update overall progress to 100%
        updateOverallProgress(100);

        // Show success toast
        showToast('Pipeline completed successfully!', 'success');

        // Reload page after 3 seconds to show new results
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    }

    // Handle pipeline failure
    function handlePipelineFailed(errorMessage) {
        // Stop polling
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }

        // Close SSE connection
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        // Show error toast
        showToast(errorMessage || 'Pipeline failed', 'error');
    }

    // Format duration in seconds to human-readable format
    function formatDuration(seconds) {
        if (seconds < 1) return '<1s';
        if (seconds < 60) return `${Math.round(seconds)}s`;
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${minutes}m ${secs}s`;
    }

    // Poll pipeline status
    async function pollPipelineStatus(runId) {
        try {
            const response = await fetch(`/api/runner/jobs/${runId}/status`);
            const data = await response.json();

            if (response.ok) {
                // Update pipeline progress using new stepper UI
                handlePipelineProgressUpdate(data);

                // If backend provides layer-specific status, update individual steps
                if (data.layers && Array.isArray(data.layers)) {
                    data.layers.forEach(layer => {
                        updatePipelineStep(layer.name, layer.status, layer.error, layer.duration);
                    });
                    // Recalculate overall progress based on steps
                    calculateOverallProgress();
                } else {
                    // Fallback: calculate progress from overall status
                    const progressValue = data.progress ? Math.round(data.progress * 100) : 0;
                    updateOverallProgress(progressValue);
                }

                // Stop polling if complete or failed
                if (data.status === 'completed' || data.status === 'failed') {
                    if (data.status === 'completed') {
                        handlePipelineComplete();
                    } else {
                        handlePipelineFailed(data.error);
                    }
                }
            }
        } catch (err) {
            console.error('Status poll failed:', err);
        }
    }

    // Start SSE log streaming
    function startLogStreaming(runId) {
        const logsContent = document.getElementById('logs-content');
        logsContent.textContent = '';

        eventSource = new EventSource(`/api/runner/jobs/${runId}/logs`);

        // Listen for unnamed 'message' events (default SSE event type)
        eventSource.onmessage = (event) => {
            const logLine = document.createElement('div');
            logLine.textContent = event.data;
            logsContent.appendChild(logLine);

            // FIX: Parse log output to update pipeline steps
            parseLogAndUpdateSteps(event.data);

            // Auto-scroll to bottom
            const logsContainer = document.getElementById('logs-container');
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        // Listen for named 'end' event
        eventSource.addEventListener('end', (event) => {
            const endLine = document.createElement('div');
            endLine.className = 'text-yellow-400';
            endLine.textContent = `Pipeline ${event.data}`;
            logsContent.appendChild(endLine);

            // Close the connection
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        });

        // Listen for errors
        eventSource.addEventListener('error', (event) => {
            console.error('Log stream error:', event);
            const errorLine = document.createElement('div');
            errorLine.className = 'text-red-400';
            errorLine.textContent = 'Log streaming ended or encountered an error';
            logsContent.appendChild(errorLine);

            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        });
    }

    /**
     * Parse log output and update pipeline step states
     * FIX: Dynamically marks steps as in-progress or complete based on terminal output
     */
    function parseLogAndUpdateSteps(logText) {
        // Map of log patterns to layer names
        const layerPatterns = {
            'intake': /Layer 1.*Intake|Starting intake|Intake layer/i,
            'pain_points': /Layer 2.*Pain|Pain Point Mining|Starting pain/i,
            'company_research': /Layer 3.*Company|Company Research|Researching company/i,
            'role_research': /Layer 4.*Role|Role Research|Researching role/i,
            'fit_scoring': /Layer 5.*Fit|Fit Scoring|Calculating fit/i,
            'people_mapping': /Layer 6.*People|People Mapping|Finding contacts/i,
            'cv_outreach_generation': /Layer 7.*CV|Outreach|Generating CV/i
        };

        // Check for layer start (in-progress)
        for (const [layerName, pattern] of Object.entries(layerPatterns)) {
            if (pattern.test(logText)) {
                // Check if log indicates start
                if (/starting|running|executing|processing/i.test(logText)) {
                    updatePipelineStep(layerName, 'executing');
                    calculateOverallProgress();
                }
                // Check if log indicates completion
                else if (/complete|finished|done|success/i.test(logText)) {
                    updatePipelineStep(layerName, 'success');
                    calculateOverallProgress();
                }
                // Check if log indicates failure
                else if (/failed|error|exception/i.test(logText)) {
                    updatePipelineStep(layerName, 'failed', logText);
                    calculateOverallProgress();
                }
            }
        }

        // Generic layer completion pattern: " Layer N complete" or " N. LayerName"
        const completionMatch = logText.match(/[]\s*(Layer\s*)?(\d+|intake|pain|company|role|fit|people|cv)/i);
        if (completionMatch) {
            // Map number to layer name
            const layerMap = {
                '1': 'intake',
                '2': 'pain_points',
                '3': 'company_research',
                '4': 'role_research',
                '5': 'fit_scoring',
                '6': 'people_mapping',
                '7': 'cv_outreach_generation'
            };
            const layerKey = layerMap[completionMatch[2]] || completionMatch[2].toLowerCase();
            const layerName = Object.keys(layerPatterns).find(name =>
                name.includes(layerKey) || layerKey.includes(name.split('_')[0])
            );
            if (layerName) {
                updatePipelineStep(layerName, 'success');
                calculateOverallProgress();
            }
        }
    }

    // Display artifacts
    function displayArtifacts(runId, artifacts) {
        const container = document.getElementById('artifacts-container');
        const list = document.getElementById('artifacts-list');

        if (!artifacts || artifacts.length === 0) return;

        container.classList.remove('hidden');
        list.innerHTML = '';

        artifacts.forEach(artifact => {
            const button = document.createElement('a');
            button.href = `/api/runner/jobs/${runId}/artifacts/${artifact}`;
            button.download = artifact;
            button.className = 'inline-flex items-center px-3 py-2 border border-indigo-300 rounded-md text-sm font-medium text-indigo-700 bg-white hover:bg-indigo-50 transition';
            button.innerHTML = `
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                </svg>
                ${artifact}
            `;
            list.appendChild(button);
        });
    }

    // Toggle logs visibility
    function toggleLogsFull() {
        const logsContainer = document.getElementById('logs-container');
        const toggleText = document.getElementById('logs-toggle-text');

        if (logsContainer.classList.contains('hidden')) {
            logsContainer.classList.remove('hidden');
            toggleText.textContent = 'Hide';
        } else {
            logsContainer.classList.add('hidden');
            toggleText.textContent = 'Show';
        }
    }

    // Copy all logs to clipboard
    async function copyLogsToClipboard() {
        const logsContent = document.getElementById('logs-content');

        if (!logsContent) {
            showToast('Logs not found', 'error');
            return;
        }

        // Get all text content from the logs
        const logsText = logsContent.innerText || logsContent.textContent;

        if (!logsText || logsText.trim() === '' || logsText.includes('Waiting for logs')) {
            showToast('No logs to copy', 'info');
            return;
        }

        // Try modern Clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            try {
                await navigator.clipboard.writeText(logsText);
                showToast('Logs copied to clipboard!', 'success');
            } catch (err) {
                console.error('Clipboard API failed:', err);
                fallbackCopyTextToClipboard(logsText);
            }
        } else {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(logsText);
        }
    }

    // Fallback copy method for browsers without Clipboard API
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;

        // Make it invisible and out of viewport
        textArea.style.position = 'fixed';
        textArea.style.top = '-9999px';
        textArea.style.left = '-9999px';
        textArea.style.opacity = '0';

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('Logs copied to clipboard!', 'success');
            } else {
                showToast('Failed to copy logs', 'error');
            }
        } catch (err) {
            console.error('Fallback copy failed:', err);
            showToast('Copy not supported in this browser', 'error');
        }

        document.body.removeChild(textArea);
    }

    // Check if run_id in URL params and start monitoring
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const runId = urlParams.get('run_id');
        if (runId) {
            monitorPipeline(runId);
        }
    });

    // ============================================================================
    // CV Editor Functions
    // ============================================================================
    // Note: CV editing is now handled by the TipTap editor side panel
    // See cv-editor.js and the side panel in this template

    // Export CV to PDF (renamed to avoid collision with cv-editor.js)
    async function exportCVFromDetailPage() {
        try {
            showToast('Generating PDF...', 'info');
            console.log('Requesting PDF generation for job:', jobId);

            const response = await fetch(`/api/jobs/${jobId}/cv-editor/pdf`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin'  // Required to send session cookies
            });

            console.log('PDF generation response status:', response.status);

            if (!response.ok) {
                // Try to parse error as JSON first
                let errorMessage = 'PDF generation failed';
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.error || errorData.detail || errorMessage;
                    console.error('PDF generation error:', errorData);
                } catch (parseErr) {
                    // If not JSON, get text
                    const errorText = await response.text();
                    console.error('PDF generation error (non-JSON):', errorText);
                    errorMessage = errorText || errorMessage;
                }
                throw new Error(errorMessage);
            }

            // Download the PDF file
            const blob = await response.blob();
            console.log('PDF blob size:', blob.size, 'bytes');

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Get filename from Content-Disposition header or use default
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'CV.pdf';
            if (contentDisposition) {
                const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                if (matches != null && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
            }
            console.log('Downloading PDF as:', filename);

            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('PDF downloaded successfully');
        } catch (err) {
            console.error('Export PDF error:', err);
            showToast('PDF generation failed: ' + err.message, 'error');
        }
    }

    // ============================================================================
    // Cover Letter Editing
    // ============================================================================

    let clEditMode = false;

    function toggleCoverLetterEdit() {
        clEditMode = !clEditMode;

        const editBtn = document.getElementById('edit-cl-btn');
        const editText = document.getElementById('edit-cl-text');
        const saveBtn = document.getElementById('save-cl-btn');
        const displayDiv = document.getElementById('cl-display');
        const textArea = document.getElementById('cl-textarea');
        const warningsDiv = document.getElementById('cl-warnings');

        if (clEditMode) {
            // Enter edit mode
            editText.textContent = 'Cancel';
            editBtn.classList.remove('text-purple-700', 'bg-purple-50', 'border-purple-200');
            editBtn.classList.add('text-red-700', 'bg-red-50', 'border-red-200');
            saveBtn.classList.remove('hidden');
            displayDiv.classList.add('hidden');
            textArea.classList.remove('hidden');
            warningsDiv.classList.add('hidden');
            textArea.focus();
        } else {
            // Exit edit mode (cancel)
            editText.textContent = 'Edit';
            editBtn.classList.remove('text-red-700', 'bg-red-50', 'border-red-200');
            editBtn.classList.add('text-purple-700', 'bg-purple-50', 'border-purple-200');
            saveBtn.classList.add('hidden');
            displayDiv.classList.remove('hidden');
            textArea.classList.add('hidden');
            // Reset textarea to original value
            textArea.value = document.getElementById('cl-text').textContent;
        }
    }

    async function saveCoverLetterChanges() {
        const textArea = document.getElementById('cl-textarea');
        const newText = textArea.value.trim();

        if (!newText) {
            showToast('Cover letter cannot be empty', 'error');
            return;
        }

        showToast('Saving cover letter...', 'info');

        try {
            const response = await fetch(`/api/jobs/${jobId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cover_letter: newText })
            });

            const result = await response.json();

            if (result.success) {
                // Update display
                document.getElementById('cl-text').textContent = newText;
                showToast('Cover letter saved');

                // Validate and show warnings
                validateCoverLetter(newText);

                // Exit edit mode
                toggleCoverLetterEdit();
            } else {
                showToast(result.error || 'Failed to save', 'error');
            }
        } catch (err) {
            showToast('Save failed: ' + err.message, 'error');
        }
    }

    function validateCoverLetter(text) {
        const warnings = [];
        const words = text.split(/\s+/).length;

        // Word count check
        if (words < 180) warnings.push('Cover letter is short (' + words + ' words, recommended: 180-420)');
        if (words > 420) warnings.push('Cover letter is long (' + words + ' words, recommended: 180-420)');

        // Metrics check
        if (!/\d+%|\d+x|\$\d+|\d+\s*(years?|months?|days?|hours?)/i.test(text)) {
            warnings.push('No quantified metrics found (add percentages, multipliers, or dollar amounts)');
        }

        // Calendly check
        if (!text.includes('calendly.com/taimooralam')) {
            warnings.push('Missing Calendly link (required for call-to-action)');
        }

        // Boilerplate check
        const boilerplate = ['excited to apply', 'dream job', 'perfect fit', 'passionate about', 'eager to'];
        const found = boilerplate.filter(phrase => text.toLowerCase().includes(phrase));
        if (found.length > 2) {
            warnings.push('Contains generic phrases: ' + found.join(', '));
        }

        // Show warnings
        const warningsDiv = document.getElementById('cl-warnings');
        if (warnings.length > 0) {
            warningsDiv.innerHTML = '<strong>Validation Warnings:</strong><ul class="list-disc ml-4 mt-1">' +
                warnings.map(w => '<li>' + w + '</li>').join('') + '</ul>';
            warningsDiv.classList.remove('hidden');
        } else {
            warningsDiv.classList.add('hidden');
        }
    }

    // Generate PDF from cover letter
    async function generateCoverLetterPDF() {
        try {
            showToast('Generating cover letter PDF...', 'info');

            const response = await fetch(`/api/jobs/${jobId}/cover-letter/pdf`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                showToast('PDF generated successfully');

                // Open download link after a short delay
                setTimeout(() => {
                    window.location.href = `/api/jobs/${jobId}/cover-letter/download`;
                }, 500);
            } else {
                showToast(result.error || 'PDF generation failed', 'error');
            }
        } catch (err) {
            showToast('PDF generation failed: ' + err.message, 'error');
        }
    }

    // Expose inline handlers explicitly so they survive HTMX swaps & module scopes
    window.updateJobField = updateJobField;
    window.saveRemarks = saveRemarks;
    window.deleteJob = deleteJob;
    window.toggleRawData = toggleRawData;
    window.enableEdit = enableEdit;
    window.processJobDetail = processJobDetail;
    window.generateCoverLetterPDF = generateCoverLetterPDF;
</script>

<!-- Phase 5.1: Page Break Calculator Module -->
<script src="/static/js/page-break-calculator.js?v=20251128"></script>

<!-- CV Rich Text Editor Script -->
<script src="/static/js/cv-editor.js?v=20251128-fix"></script>
{% endblock %}
