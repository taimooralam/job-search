<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Job Search Manager{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- TipTap Editor (Using esm.sh CDN with importmap for browser extension compatibility) -->
    <script type="importmap">
    {
      "imports": {
        "@tiptap/core": "https://esm.sh/@tiptap/core@2.1.13",
        "@tiptap/starter-kit": "https://esm.sh/@tiptap/starter-kit@2.1.13",
        "@tiptap/extension-underline": "https://esm.sh/@tiptap/extension-underline@2.1.13",
        "@tiptap/extension-text-align": "https://esm.sh/@tiptap/extension-text-align@2.1.13",
        "@tiptap/extension-font-family": "https://esm.sh/@tiptap/extension-font-family@2.1.13",
        "@tiptap/extension-text-style": "https://esm.sh/@tiptap/extension-text-style@2.1.13",
        "@tiptap/extension-color": "https://esm.sh/@tiptap/extension-color@2.1.13",
        "@tiptap/extension-highlight": "https://esm.sh/@tiptap/extension-highlight@2.1.13"
      }
    }
    </script>
    <script type="module">
      // Load TipTap modules and expose to window for legacy code
      import { Editor } from '@tiptap/core';
      import StarterKit from '@tiptap/starter-kit';
      import Underline from '@tiptap/extension-underline';
      import TextAlign from '@tiptap/extension-text-align';
      import FontFamily from '@tiptap/extension-font-family';
      import TextStyle from '@tiptap/extension-text-style';
      import Color from '@tiptap/extension-color';
      import Highlight from '@tiptap/extension-highlight';

      // Expose to window for cv-editor.js
      window.tiptap = { Editor };
      window.tiptapStarterKit = { StarterKit };
      window.tiptapUnderline = { Underline };
      window.tiptapTextAlign = { TextAlign };
      window.tiptapFontFamily = { FontFamily };
      window.tiptapTextStyle = { TextStyle };
      window.tiptapColor = { Color };
      window.tiptapHighlight = { Highlight };

      // Signal that TipTap is loaded
      window.dispatchEvent(new Event('tiptap-loaded'));
      console.log('✅ TipTap loaded via ESM');
    </script>

    <!-- Custom TipTap FontSize Extension (inline implementation) -->
    <script type="module">
    // FontSize extension for TipTap - waits for TipTap to load
    import TextStyle from '@tiptap/extension-text-style';

    const FontSize = TextStyle.extend({
        name: 'fontSize',
        addOptions() {
            return {
                types: ['textStyle'],
            }
        },
        addGlobalAttributes() {
            return [
                {
                    types: this.options.types,
                    attributes: {
                        fontSize: {
                            default: null,
                            parseHTML: element => element.style.fontSize?.replace(/['"]+/g, ''),
                            renderHTML: attributes => {
                                if (!attributes.fontSize) {
                                    return {}
                                }
                                return {
                                    style: `font-size: ${attributes.fontSize}`,
                                }
                            },
                        },
                    },
                },
            ]
        },
        addCommands() {
            return {
                setFontSize: fontSize => ({ chain }) => {
                    return chain().setMark('textStyle', { fontSize }).run()
                },
                unsetFontSize: () => ({ chain }) => {
                    return chain().setMark('textStyle', { fontSize: null }).removeEmptyTextStyle().run()
                },
            }
        },
    });

    // Expose to window for cv-editor.js
    window.tiptapFontSize = { FontSize };
    console.log('✅ FontSize extension loaded');
    </script>

    <!-- Google Fonts for CV Editor (60+ Professional Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@400;600;700&family=Nunito:wght@400;600;700&family=Poppins:wght@400;600;700&family=Work+Sans:wght@400;600;700&family=IBM+Plex+Sans:wght@400;600;700&family=Karla:wght@400;700&family=Rubik:wght@400;600;700&family=DM+Sans:wght@400;700&family=Manrope:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=Space+Grotesk:wght@400;700&family=Outfit:wght@400;600;700&family=Archivo:wght@400;600;700&family=Public+Sans:wght@400;600;700&family=Red+Hat+Display:wght@400;700&family=Crimson+Text:wght@400;600;700&family=EB+Garamond:wght@400;500;600;700&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;500;600;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;500;600;700&family=Spectral:wght@400;600;700&family=Source+Serif+Pro:wght@400;600;700&family=PT+Serif:wght@400;700&family=Bitter:wght@400;700&family=Arvo:wght@400;700&family=Cardo:wght@400;700&family=Cormorant+Garamond:wght@400;600;700&family=Neuton:wght@400;700&family=Vollkorn:wght@400;600;700&family=Fira+Code:wght@400;600&family=JetBrains+Mono:wght@400;600&family=Source+Code+Pro:wght@400;600&family=IBM+Plex+Mono:wght@400;600&family=Roboto+Mono:wght@400;600&family=Inconsolata:wght@400;700&family=Bebas+Neue&family=Archivo+Black&family=Righteous&family=Josefin+Sans:wght@400;600;700&family=Oswald:wght@400;600;700&family=Anton&family=Kanit:wght@400;600;700&family=Roboto+Condensed:wght@400;700&family=PT+Sans+Narrow:wght@400;700&family=Fira+Sans+Condensed:wght@400;700&family=Barlow+Condensed:wght@400;600;700&family=Nunito+Sans:wght@400;600;700&family=Quicksand:wght@400;600;700&family=Varela+Round&family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom styles -->
    <style>
        /* Sticky header for table */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Loading indicator */
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-indicator {
            display: none;
        }

        /* Row hover effect */
        .job-row:hover {
            background-color: rgb(249 250 251);
        }

        /* Sort icons */
        .sort-icon {
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .sort-active .sort-icon {
            opacity: 1;
        }

        /* Status badge colors */
        .status-not-processed { background-color: #e5e7eb; color: #374151; }
        .status-marked-for-applying { background-color: #dbeafe; color: #1e40af; }
        .status-ready-for-applying { background-color: #bfdbfe; color: #1e3a8a; }
        .status-to-be-deleted { background-color: #fee2e2; color: #991b1b; }
        .status-discarded { background-color: #f3f4f6; color: #6b7280; }
        .status-applied { background-color: #d1fae5; color: #065f46; }
        .status-interview-scheduled { background-color: #fef3c7; color: #92400e; }
        .status-rejected { background-color: #fecaca; color: #991b1b; }
        .status-offer-received { background-color: #a7f3d0; color: #047857; }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Mobile responsive table */
        @media (max-width: 768px) {
            .hide-mobile {
                display: none !important;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .job-row td {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Touch-friendly buttons on mobile */
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
                gap: 0.75rem;
            }
            .mobile-full {
                width: 100%;
            }
        }

        /* Page loading overlay */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        #page-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Health indicator styles */
        .health-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .health-indicator:hover {
            transform: scale(1.05);
        }

        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .health-healthy { background-color: #10b981; }
        .health-unhealthy { background-color: #ef4444; }
        .health-unknown { background-color: #94a3b8; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .health-status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Quick date filter button active states */
        .quick-date-btn.active {
            font-weight: 600;
            box-shadow: 0 0 0 2px currentColor;
        }

        /* Blue buttons (hour filters) active state */
        .quick-date-btn.active.bg-blue-50 {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        /* Green buttons (week filters) active state */
        .quick-date-btn.active.bg-green-50 {
            background-color: #10b981 !important;
            color: white !important;
            border-color: #10b981 !important;
        }

        /* Purple buttons (month filters) active state */
        .quick-date-btn.active.bg-purple-50 {
            background-color: #a855f7 !important;
            color: white !important;
            border-color: #a855f7 !important;
        }

        /* ============================================================================
         * TipTap ProseMirror WYSIWYG Editor Styles
         * ============================================================================ */
        .ProseMirror {
            outline: none;
            min-height: 100%;
            padding: 2rem;
        }

        /* Headings */
        .ProseMirror h1 {
            font-size: 2em;
            font-weight: bold;
            margin: 0.67em 0;
            line-height: 1.2;
        }

        .ProseMirror h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0.5em 0;
            line-height: 1.3;
        }

        .ProseMirror h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin: 0.4em 0;
            line-height: 1.4;
        }

        /* Paragraphs */
        .ProseMirror p {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        .ProseMirror p:first-child {
            margin-top: 0;
        }

        .ProseMirror p:last-child {
            margin-bottom: 0;
        }

        /* Inline formatting */
        .ProseMirror strong {
            font-weight: bold;
        }

        .ProseMirror em {
            font-style: italic;
        }

        .ProseMirror u {
            text-decoration: underline;
        }

        /* Lists */
        .ProseMirror ul,
        .ProseMirror ol {
            padding-left: 1.5em;
            margin: 0.5em 0;
        }

        .ProseMirror ul {
            list-style-type: disc;
        }

        .ProseMirror ol {
            list-style-type: decimal;
        }

        .ProseMirror li {
            margin: 0.25em 0;
            line-height: 1.6;
        }

        .ProseMirror li > p {
            margin: 0;
        }

        /* Nested lists */
        .ProseMirror ul ul,
        .ProseMirror ol ul,
        .ProseMirror ul ol,
        .ProseMirror ol ol {
            margin: 0.25em 0;
        }

        /* Highlight/Mark */
        .ProseMirror mark {
            background-color: yellow;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }

        /* Text alignment */
        .ProseMirror [style*="text-align: left"] {
            text-align: left;
        }

        .ProseMirror [style*="text-align: center"] {
            text-align: center;
        }

        .ProseMirror [style*="text-align: right"] {
            text-align: right;
        }

        .ProseMirror [style*="text-align: justify"] {
            text-align: justify;
        }

        /* Placeholder for empty editor */
        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: #adb5bd;
            pointer-events: none;
            height: 0;
        }

        /* Code blocks */
        .ProseMirror code {
            background-color: #f3f4f6;
            padding: 0.1em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .ProseMirror pre {
            background-color: #f3f4f6;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
        }

        .ProseMirror pre code {
            background: none;
            padding: 0;
        }

        /* Blockquotes */
        .ProseMirror blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
        }

        /* Hard breaks */
        .ProseMirror br {
            content: '';
        }

        /* Selection */
        .ProseMirror ::selection {
            background-color: #b4d5fe;
        }

        /* Focus state */
        .ProseMirror:focus {
            outline: none;
        }

        /* Links (if enabled) */
        .ProseMirror a {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
        }

        .ProseMirror a:hover {
            color: #2563eb;
        }

        /* ============================================================================
         * Main CV Display Styles (Matches TipTap Editor WYSIWYG)
         * Applied to the read-only CV display on the detail page
         * ============================================================================ */
        #cv-markdown-display,
        #cv-container {
            line-height: 1.6;
        }

        /* Headings */
        #cv-markdown-display h1,
        #cv-container h1 {
            font-size: 2em;
            font-weight: bold;
            margin: 0.67em 0;
            line-height: 1.2;
        }

        #cv-markdown-display h2,
        #cv-container h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0.5em 0;
            line-height: 1.3;
        }

        #cv-markdown-display h3,
        #cv-container h3 {
            font-size: 1.25em;
            font-weight: bold;
            margin: 0.4em 0;
            line-height: 1.4;
        }

        /* Paragraphs */
        #cv-markdown-display p,
        #cv-container p {
            margin: 0.5em 0;
            line-height: 1.6;
        }

        #cv-markdown-display p:first-child,
        #cv-container p:first-child {
            margin-top: 0;
        }

        #cv-markdown-display p:last-child,
        #cv-container p:last-child {
            margin-bottom: 0;
        }

        /* Inline formatting */
        #cv-markdown-display strong,
        #cv-container strong {
            font-weight: bold;
        }

        #cv-markdown-display em,
        #cv-container em {
            font-style: italic;
        }

        #cv-markdown-display u,
        #cv-container u {
            text-decoration: underline;
        }

        /* Lists */
        #cv-markdown-display ul,
        #cv-markdown-display ol,
        #cv-container ul,
        #cv-container ol {
            padding-left: 1.5em;
            margin: 0.5em 0;
        }

        #cv-markdown-display ul,
        #cv-container ul {
            list-style-type: disc;
        }

        #cv-markdown-display ol,
        #cv-container ol {
            list-style-type: decimal;
        }

        #cv-markdown-display li,
        #cv-container li {
            margin: 0.25em 0;
            line-height: 1.6;
            list-style-position: outside;
        }

        #cv-markdown-display li > p,
        #cv-container li > p {
            margin: 0;
        }

        /* Nested lists */
        #cv-markdown-display ul ul,
        #cv-markdown-display ol ul,
        #cv-markdown-display ul ol,
        #cv-markdown-display ol ol,
        #cv-container ul ul,
        #cv-container ol ul,
        #cv-container ul ol,
        #cv-container ol ol {
            margin: 0.25em 0;
        }

        /* Highlight/Mark */
        #cv-markdown-display mark,
        #cv-container mark {
            background-color: yellow;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }

        /* Text alignment */
        #cv-markdown-display [style*="text-align: left"],
        #cv-container [style*="text-align: left"] {
            text-align: left;
        }

        #cv-markdown-display [style*="text-align: center"],
        #cv-container [style*="text-align: center"] {
            text-align: center;
        }

        #cv-markdown-display [style*="text-align: right"],
        #cv-container [style*="text-align: right"] {
            text-align: right;
        }

        #cv-markdown-display [style*="text-align: justify"],
        #cv-container [style*="text-align: justify"] {
            text-align: justify;
        }

        /* Code blocks */
        #cv-markdown-display code,
        #cv-container code {
            background-color: #f3f4f6;
            padding: 0.1em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        #cv-markdown-display pre,
        #cv-container pre {
            background-color: #f3f4f6;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
        }

        #cv-markdown-display pre code,
        #cv-container pre code {
            background: none;
            padding: 0;
        }

        /* Blockquotes */
        #cv-markdown-display blockquote,
        #cv-container blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
        }

        /* Links */
        #cv-markdown-display a,
        #cv-container a {
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
        }

        #cv-markdown-display a:hover,
        #cv-container a:hover {
            color: #2563eb;
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>
<body class="h-full">
    <!-- Page loading overlay -->
    <div id="page-loader">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Loading...</p>
        </div>
    </div>

    <div class="min-h-full">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-14 sm:h-16 justify-between items-center">
                    <a href="/" class="flex items-center">
                        <span class="text-xl sm:text-2xl font-bold text-indigo-600">JobSearch</span>
                        <span class="hidden sm:inline ml-2 text-sm text-gray-500">Level-2 Manager</span>
                    </a>
                    <div class="flex items-center gap-4">
                        <!-- Health indicators -->
                        <div id="health-status" class="health-status hidden sm:flex">
                            <!-- Health indicators loaded via JavaScript -->
                        </div>
                        <div id="stats-container" class="text-xs sm:text-sm text-gray-500">
                            <!-- Stats loaded via HTMX -->
                        </div>
                        <form method="POST" action="/logout" class="m-0">
                            <button
                                type="submit"
                                class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-md
                                       text-xs sm:text-sm font-medium text-gray-700 bg-white hover:bg-gray-50
                                       focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500
                                       transition duration-150 ease-in-out"
                                title="Logout"
                            >
                                <svg class="h-4 w-4 sm:mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                <span class="hidden sm:inline">Logout</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Delete confirmation modal -->
    <div id="delete-modal" class="hidden fixed inset-0 z-50">
        <div class="modal-backdrop fixed inset-0" onclick="closeDeleteModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 relative z-10">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Confirm Delete</h3>
                <p class="text-gray-600 mb-4">
                    Are you sure you want to delete <span id="delete-count" class="font-semibold">0</span> selected job(s)?
                    This action cannot be undone.
                </p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeDeleteModal()"
                            class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition">
                        Cancel
                    </button>
                    <button onclick="confirmDelete()"
                            class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-md transition">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for interactivity -->
    <script>
        // Track selected job IDs
        let selectedJobIds = new Set();

        // Update selection count in toolbar
        function updateSelectionCount() {
            const countEl = document.getElementById('selection-count');
            const deleteBtn = document.getElementById('delete-selected-btn');
            const count = selectedJobIds.size;

            if (countEl) {
                countEl.textContent = count;
            }
            if (deleteBtn) {
                deleteBtn.disabled = count === 0;
                deleteBtn.classList.toggle('opacity-50', count === 0);
                deleteBtn.classList.toggle('cursor-not-allowed', count === 0);
            }
        }

        // Toggle individual row selection
        function toggleRowSelection(checkbox) {
            const jobId = checkbox.dataset.jobId;
            if (checkbox.checked) {
                selectedJobIds.add(jobId);
            } else {
                selectedJobIds.delete(jobId);
            }
            updateSelectionCount();
            updateSelectAllCheckbox();
        }

        // Toggle all visible rows
        function toggleSelectAll(checkbox) {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            rowCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const jobId = cb.dataset.jobId;
                if (checkbox.checked) {
                    selectedJobIds.add(jobId);
                } else {
                    selectedJobIds.delete(jobId);
                }
            });
            updateSelectionCount();
        }

        // Update select-all checkbox state
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            if (selectAll && rowCheckboxes.length > 0) {
                const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            }
        }

        // Open delete confirmation modal
        function openDeleteModal() {
            if (selectedJobIds.size === 0) return;
            document.getElementById('delete-count').textContent = selectedJobIds.size;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        // Confirm and execute delete
        async function confirmDelete() {
            if (selectedJobIds.size === 0) return;

            try {
                const response = await fetch('/api/jobs/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_ids: Array.from(selectedJobIds) })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear selection
                    selectedJobIds.clear();
                    updateSelectionCount();

                    // Refresh table via HTMX
                    htmx.trigger('#job-table-container', 'refresh');

                    // Show success message
                    showToast(`Deleted ${result.deleted_count} job(s)`);
                } else {
                    showToast(result.error || 'Delete failed', 'error');
                }
            } catch (err) {
                showToast('Delete failed: ' + err.message, 'error');
            }

            closeDeleteModal();
        }

        // Update job status
        async function updateStatus(jobId, newStatus) {
            try {
                const response = await fetch('/api/jobs/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId, status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`Status updated to "${newStatus}"`);
                    // Refresh stats
                    htmx.trigger('#stats-container', 'refresh');
                } else {
                    showToast(result.error || 'Status update failed', 'error');
                }
            } catch (err) {
                showToast('Status update failed: ' + err.message, 'error');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 transition-opacity duration-300 ${
                type === 'error' ? 'bg-red-600 text-white' : 'bg-green-600 text-white'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Clear selections when table refreshes
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'job-table-container') {
                // Restore checkbox states for selected items
                selectedJobIds.forEach(id => {
                    const checkbox = document.querySelector(`input[data-job-id="${id}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                updateSelectAllCheckbox();
            }
        });

        // Navigate to job detail page
        function navigateToJob(event, jobId) {
            // Don't navigate if clicking on interactive elements
            const target = event.target;
            const tagName = target.tagName.toLowerCase();

            if (tagName === 'a' || tagName === 'button' || tagName === 'input' || tagName === 'select') {
                return;
            }

            // Check if clicking inside a link or button
            if (target.closest('a') || target.closest('button') || target.closest('select')) {
                return;
            }

            // Navigate to job detail page
            window.location.href = `/job/${jobId}`;
        }

        // Process job through pipeline
        async function processJob(jobId, jobTitle) {
            // Confirmation dialog
            const confirmed = confirm(
                `Process job through pipeline?\n\n` +
                `Job: ${jobTitle}\n\n` +
                `This will trigger the full processing pipeline on the VPS runner.`
            );

            if (!confirmed) return;

            try {
                showToast('Starting pipeline...', 'info');

                // Trigger pipeline via proxy
                const response = await fetch('/api/runner/jobs/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: jobId,
                        level: 2  // Process at level 2
                    })
                });

                const result = await response.json();

                if (response.ok && result.run_id) {
                    showToast(`Pipeline started! Run ID: ${result.run_id}`);
                    // Redirect to job detail page to see progress
                    setTimeout(() => {
                        window.location.href = `/job/${jobId}?run_id=${result.run_id}`;
                    }, 1500);
                } else {
                    showToast(result.error || 'Failed to start pipeline', 'error');
                }
            } catch (err) {
                showToast('Pipeline failed: ' + err.message, 'error');
            }
        }

        // Load health indicators
        async function updateHealthStatus() {
            const healthContainer = document.getElementById('health-status');
            if (!healthContainer) return;

            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                const indicators = [];

                // VPS Health
                const vpsClass = data.vps?.status === 'healthy' ? 'health-healthy' :
                                 data.vps?.status === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
                indicators.push(`
                    <div class="health-indicator" title="VPS Runner: ${data.vps?.status || 'unknown'}">
                        <div class="health-dot ${vpsClass}"></div>
                        <span class="text-gray-700">VPS</span>
                    </div>
                `);

                // MongoDB Health
                const mongoClass = data.mongodb?.status === 'healthy' ? 'health-healthy' :
                                   data.mongodb?.status === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
                indicators.push(`
                    <div class="health-indicator" title="MongoDB: ${data.mongodb?.status || 'unknown'}">
                        <div class="health-dot ${mongoClass}"></div>
                        <span class="text-gray-700">DB</span>
                    </div>
                `);

                // n8n Health (if available)
                if (data.n8n) {
                    const n8nClass = data.n8n?.status === 'healthy' ? 'health-healthy' :
                                     data.n8n?.status === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
                    indicators.push(`
                        <div class="health-indicator" title="n8n: ${data.n8n?.status || 'unknown'}">
                            <div class="health-dot ${n8nClass}"></div>
                            <span class="text-gray-700">n8n</span>
                        </div>
                    `);
                }

                healthContainer.innerHTML = indicators.join('');
            } catch (err) {
                console.error('Failed to load health status:', err);
            }
        }

        // Load initial stats
        document.addEventListener('DOMContentLoaded', function() {
            // Hide page loader
            setTimeout(() => {
                document.getElementById('page-loader').classList.add('hidden');
            }, 500);

            // Load stats
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('stats-container').innerHTML =
                        `Level-2: <span class="font-semibold">${data.level2_count.toLocaleString()}</span> jobs`;
                });

            // Load health status
            updateHealthStatus();

            // Refresh health status every 30 seconds
            setInterval(updateHealthStatus, 30000);
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
