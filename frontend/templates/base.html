<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Job Search Manager{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Alpine.js Collapse Plugin (must load before Alpine) -->
    <!-- Pin to specific version to prevent plugin/core version mismatch -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.14.8/dist/cdn.min.js"></script>

    <!-- Alpine.js for interactive components -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>

    <!-- Global configuration for JavaScript -->
    <script>
        // Runner URL for direct API calls (queue polling, etc.)
        // Used by queue-poller.js to bypass Flask proxy
        window.RUNNER_URL = "{{ runner_url }}";
        // Runner WebSocket URL for real-time queue updates
        // On Vercel, this connects directly to runner service
        // On Flask/VPS, this is used as fallback (Flask proxy is preferred)
        window.RUNNER_WS_URL = "{{ runner_ws_url }}";
    </script>

    <!-- Tailwind Configuration - Design System Integration -->
    <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            // Map design system tokens to Tailwind
            primary: {
              50: 'var(--color-primary-50)',
              100: 'var(--color-primary-100)',
              200: 'var(--color-primary-200)',
              300: 'var(--color-primary-300)',
              400: 'var(--color-primary-400)',
              500: 'var(--color-primary-500)',
              600: 'var(--color-primary-600)',
              700: 'var(--color-primary-700)',
              800: 'var(--color-primary-800)',
              900: 'var(--color-primary-900)',
              950: 'var(--color-primary-950)',
            },
            // Dark theme colors (Deep Blue - Technical Credibility)
            dark: {
              900: '#0f172a',  // Page background
              800: '#1e293b',  // Cards, modals, sidebar
              700: '#334155',  // Borders, dividers
              600: '#475569',  // Light borders
            },
            // Accent (Electric Blue - Call-to-Action)
            accent: {
              500: '#3b82f6',  // Primary buttons, links
              400: '#60a5fa',  // Hover states
              300: '#93c5fd',  // Subtle highlights
            }
          },
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
            mono: ['Fira Code', 'Monaco', 'Courier New', 'monospace'],
          },
          borderRadius: {
            'sm': 'var(--radius-sm)',
            'md': 'var(--radius-md)',
            'lg': 'var(--radius-lg)',
            'xl': 'var(--radius-xl)',
            '2xl': 'var(--radius-2xl)',
          },
          boxShadow: {
            'subtle': 'var(--shadow-subtle)',
            'sm': 'var(--shadow-sm)',
            'md': 'var(--shadow-md)',
            'lg': 'var(--shadow-lg)',
            'xl': 'var(--shadow-xl)',
            '2xl': 'var(--shadow-2xl)',
          },
          transitionDuration: {
            'fast': '150ms',
            'base': '200ms',
            'slow': '300ms',
          }
        }
      }
    }
    </script>

    <!-- Early Theme Initialization (prevents FOUC - Flash of Unstyled Content) -->
    <script>
    (function() {
      // Check localStorage first, then system preference
      const saved = localStorage.getItem('app-theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');

      // Apply immediately before page renders
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- HTTP Polling for Queue and Log Updates (replaces WebSocket/RxJS) -->
    <script src="/static/js/base-poller.js"></script>
    <script src="/static/js/queue-poller.js"></script>
    <script src="/static/js/log-poller.js"></script>

    <!-- Unified Execution State Management -->
    <script src="/static/js/execution-store.js"></script>

    <!-- TipTap Editor (Using esm.sh CDN with importmap for browser extension compatibility) -->
    <script type="importmap">
    {
      "imports": {
        "@tiptap/core": "https://esm.sh/@tiptap/core@2.1.13",
        "@tiptap/starter-kit": "https://esm.sh/@tiptap/starter-kit@2.1.13",
        "@tiptap/extension-underline": "https://esm.sh/@tiptap/extension-underline@2.1.13",
        "@tiptap/extension-text-align": "https://esm.sh/@tiptap/extension-text-align@2.1.13",
        "@tiptap/extension-font-family": "https://esm.sh/@tiptap/extension-font-family@2.1.13",
        "@tiptap/extension-text-style": "https://esm.sh/@tiptap/extension-text-style@2.1.13",
        "@tiptap/extension-color": "https://esm.sh/@tiptap/extension-color@2.1.13",
        "@tiptap/extension-highlight": "https://esm.sh/@tiptap/extension-highlight@2.1.13"
      }
    }
    </script>
    <script type="module">
      // Load TipTap modules and expose to window for legacy code
      import { Editor } from '@tiptap/core';
      import StarterKit from '@tiptap/starter-kit';
      import Underline from '@tiptap/extension-underline';
      import TextAlign from '@tiptap/extension-text-align';
      import FontFamily from '@tiptap/extension-font-family';
      import TextStyle from '@tiptap/extension-text-style';
      import Color from '@tiptap/extension-color';
      import Highlight from '@tiptap/extension-highlight';

      // Expose to window for cv-editor.js
      window.tiptap = { Editor };
      window.tiptapStarterKit = { StarterKit };
      window.tiptapUnderline = { Underline };
      window.tiptapTextAlign = { TextAlign };
      window.tiptapFontFamily = { FontFamily };
      window.tiptapTextStyle = { TextStyle };
      window.tiptapColor = { Color };
      window.tiptapHighlight = { Highlight };

      // Signal that TipTap is loaded
      window.dispatchEvent(new Event('tiptap-loaded'));
      console.log('✅ TipTap loaded via ESM');
    </script>

    <!-- Custom TipTap FontSize Extension (inline implementation) -->
    <script type="module">
    // FontSize extension for TipTap - waits for TipTap to load
    import TextStyle from '@tiptap/extension-text-style';

    const FontSize = TextStyle.extend({
        name: 'fontSize',
        addOptions() {
            return {
                types: ['textStyle'],
            }
        },
        addGlobalAttributes() {
            return [
                {
                    types: this.options.types,
                    attributes: {
                        fontSize: {
                            default: null,
                            parseHTML: element => element.style.fontSize?.replace(/['"]+/g, ''),
                            renderHTML: attributes => {
                                if (!attributes.fontSize) {
                                    return {}
                                }
                                return {
                                    style: `font-size: ${attributes.fontSize}`,
                                }
                            },
                        },
                    },
                },
            ]
        },
        addCommands() {
            return {
                setFontSize: fontSize => ({ chain }) => {
                    return chain().setMark('textStyle', { fontSize }).run()
                },
                unsetFontSize: () => ({ chain }) => {
                    return chain().setMark('textStyle', { fontSize: null }).removeEmptyTextStyle().run()
                },
            }
        },
    });

    // Expose to window for cv-editor.js
    window.tiptapFontSize = { FontSize };
    console.log('✅ FontSize extension loaded');
    </script>

    <!-- Google Fonts for CV Editor (60+ Professional Fonts + Source Sans 3) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&family=Inter:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600;700&family=Lato:wght@400;700&family=Montserrat:wght@400;600;700&family=Raleway:wght@400;600;700&family=Nunito:wght@400;600;700&family=Poppins:wght@400;600;700&family=Work+Sans:wght@400;600;700&family=IBM+Plex+Sans:wght@400;600;700&family=Karla:wght@400;700&family=Rubik:wght@400;600;700&family=DM+Sans:wght@400;700&family=Manrope:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=Space+Grotesk:wght@400;700&family=Outfit:wght@400;600;700&family=Archivo:wght@400;600;700&family=Public+Sans:wght@400;600;700&family=Red+Hat+Display:wght@400;700&family=Crimson+Text:wght@400;600;700&family=EB+Garamond:wght@400;500;600;700&family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;500;600;700&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;500;600;700&family=Spectral:wght@400;600;700&family=Source+Serif+Pro:wght@400;600;700&family=PT+Serif:wght@400;700&family=Bitter:wght@400;700&family=Arvo:wght@400;700&family=Cardo:wght@400;700&family=Cormorant+Garamond:wght@400;600;700&family=Neuton:wght@400;700&family=Vollkorn:wght@400;600;700&family=Fira+Code:wght@400;600&family=JetBrains+Mono:wght@400;600&family=Source+Code+Pro:wght@400;600&family=IBM+Plex+Mono:wght@400;600&family=Roboto+Mono:wght@400;600&family=Inconsolata:wght@400;700&family=Bebas+Neue&family=Archivo+Black&family=Righteous&family=Josefin+Sans:wght@400;600;700&family=Oswald:wght@400;600;700&family=Anton&family=Kanit:wght@400;600;700&family=Roboto+Condensed:wght@400;700&family=PT+Sans+Narrow:wght@400;700&family=Fira+Sans+Condensed:wght@400;700&family=Barlow+Condensed:wght@400;600;700&family=Nunito+Sans:wght@400;600;700&family=Quicksand:wght@400;600;700&family=Varela+Round&family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom styles -->
    <style>
        /* Alpine.js cloak - hide elements until Alpine initializes */
        [x-cloak] { display: none !important; }

        /* ============================================================================
         * Design System Foundation
         * Inspired by Linear, Notion, Stripe, Vercel, Figma
         * ============================================================================ */

        :root {
            /* Color Palette */
            --color-primary-50: #eef2ff;
            --color-primary-100: #e0e7ff;
            --color-primary-200: #c7d2fe;
            --color-primary-300: #a5b4fc;
            --color-primary-400: #818cf8;
            --color-primary-500: #6366f1;
            --color-primary-600: #4f46e5;
            --color-primary-700: #4338ca;
            --color-primary-800: #3730a3;
            --color-primary-900: #312e81;
            --color-primary-950: #1e1b4b;

            /* Semantic Colors */
            --color-success-50: #f0fdf4;
            --color-success-500: #10b981;
            --color-success-600: #059669;
            --color-success-700: #047857;

            --color-warning-50: #fffbeb;
            --color-warning-500: #f59e0b;
            --color-warning-600: #d97706;
            --color-warning-700: #b45309;

            --color-error-50: #fef2f2;
            --color-error-500: #ef4444;
            --color-error-600: #dc2626;
            --color-error-700: #b91c1c;

            --color-info-50: #eff6ff;
            --color-info-500: #3b82f6;
            --color-info-600: #2563eb;
            --color-info-700: #1d4ed8;

            /* Neutral Grays */
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-400: #9ca3af;
            --color-gray-500: #6b7280;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-gray-900: #111827;
            --color-gray-950: #030712;

            /* Typography Scale */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, 'DejaVu Sans Mono', monospace;

            --text-xs: 0.75rem;      /* 12px */
            --text-sm: 0.875rem;     /* 14px */
            --text-base: 1rem;       /* 16px */
            --text-lg: 1.125rem;     /* 18px */
            --text-xl: 1.25rem;      /* 20px */
            --text-2xl: 1.5rem;      /* 24px */
            --text-3xl: 1.875rem;    /* 30px */
            --text-4xl: 2.25rem;     /* 36px */

            --font-normal: 400;
            --font-medium: 500;
            --font-semibold: 600;
            --font-bold: 700;

            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;

            /* Spacing Scale (4px base grid) */
            --space-0: 0;
            --space-1: 0.25rem;      /* 4px */
            --space-2: 0.5rem;       /* 8px */
            --space-3: 0.75rem;      /* 12px */
            --space-4: 1rem;         /* 16px */
            --space-5: 1.25rem;      /* 20px */
            --space-6: 1.5rem;       /* 24px */
            --space-8: 2rem;         /* 32px */
            --space-10: 2.5rem;      /* 40px */
            --space-12: 3rem;        /* 48px */
            --space-16: 4rem;        /* 64px */
            --space-20: 5rem;        /* 80px */

            /* Border Radius */
            --radius-sm: 0.25rem;    /* 4px */
            --radius-md: 0.375rem;   /* 6px */
            --radius-lg: 0.5rem;     /* 8px */
            --radius-xl: 0.75rem;    /* 12px */
            --radius-2xl: 1rem;      /* 16px */
            --radius-full: 9999px;

            /* Shadows (Elevation System) */
            --shadow-subtle: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Z-Index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;

            /* ================================================================
             * Semantic Theme Variables (Light Mode - Default)
             * These variables change based on light/dark mode
             * ================================================================ */

            /* Background colors */
            --bg-page: #f9fafb;           /* Page background */
            --bg-secondary: #ffffff;       /* Secondary background */
            --bg-card: #ffffff;           /* Card/panel background */
            --bg-elevated: #ffffff;       /* Elevated surfaces, popovers */
            --bg-input: #ffffff;          /* Form input background */
            --bg-hover: #f3f4f6;          /* Hover states */

            /* Text colors */
            --text-primary: #111827;      /* Primary text color */
            --text-secondary: #4b5563;    /* Secondary text, labels */
            --text-tertiary: #6b7280;     /* Tertiary text, placeholders */
            --text-muted: #9ca3af;        /* Muted/disabled text */

            /* Border colors */
            --border-default: #e5e7eb;    /* Default borders */
            --border-light: #f3f4f6;      /* Light borders, dividers */
            --border-focus: var(--color-primary-500); /* Focus state borders */
        }

        /* ================================================================
         * Dark Mode Overrides
         * Applied when html has 'dark' class
         * ================================================================ */
        .dark {
            /* Background colors - Deep Blue palette */
            --bg-page: #0f172a;           /* Page background */
            --bg-secondary: #1e293b;       /* Secondary background */
            --bg-card: #1e293b;           /* Card/panel background */
            --bg-elevated: #334155;       /* Elevated surfaces */
            --bg-input: #1e293b;          /* Form input background */
            --bg-hover: #334155;          /* Hover states */

            /* Text colors - Light on dark */
            --text-primary: #f1f5f9;      /* Primary text color */
            --text-secondary: #94a3b8;    /* Secondary text */
            --text-tertiary: #64748b;     /* Tertiary text */
            --text-muted: #475569;        /* Muted/disabled text */

            /* Border colors */
            --border-default: #334155;    /* Default borders */
            --border-light: #475569;      /* Light borders */
            --border-focus: #60a5fa;      /* Focus state borders (lighter blue) */

            /* Adjusted shadows for dark mode */
            --shadow-subtle: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
        }

        /* Global Improvements */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            transition: background-color var(--transition-slow), color var(--transition-slow);
        }

        body {
            font-family: var(--font-sans);
            color: var(--text-primary);
            background-color: var(--bg-page);
            line-height: var(--line-height-normal);
            transition: background-color var(--transition-slow), color var(--transition-slow);
        }

        /* Form inputs - theme-aware */
        input, textarea, select {
            background-color: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--border-focus);
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .dark input:focus, .dark textarea:focus, .dark select:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }

        /* Sticky header for table */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 20; /* Increased from 10 to stay above expanded rows */
            background: var(--bg-primary); /* Ensure solid background */
        }

        /* Loading indicator */
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        .htmx-indicator {
            display: none;
        }

        /* ============================================================================
         * Component Library
         * Reusable, production-ready UI components
         * ============================================================================ */

        /* Button Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-medium);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
            cursor: pointer;
            border: 1px solid transparent;
            font-size: var(--text-sm);
            line-height: var(--line-height-tight);
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button Sizes (GAP-058: refined sizing hierarchy) */
        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: var(--text-xs);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: var(--text-xs);
        }

        .btn-md {
            padding: 0.5rem 1rem;
        }

        .btn-lg {
            padding: 0.625rem 1.25rem;
            font-size: var(--text-base);
        }

        /* Button Variants */
        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary-600) 0%, var(--color-primary-700) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary-700) 0%, var(--color-primary-800) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: white;
            color: var(--color-primary-700);
            border-color: var(--color-primary-200);
            box-shadow: var(--shadow-subtle);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--color-primary-50);
            border-color: var(--color-primary-300);
            box-shadow: var(--shadow-sm);
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--color-gray-700);
        }

        .btn-ghost:hover:not(:disabled) {
            background-color: var(--color-gray-100);
        }

        .btn-danger {
            background-color: var(--color-error-600);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-danger:hover:not(:disabled) {
            background-color: var(--color-error-700);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--color-success-600) 0%, var(--color-success-700) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-success:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-success-700) 0%, var(--color-success-700) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--color-warning-500) 0%, var(--color-warning-600) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-warning-600) 0%, var(--color-warning-700) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        /* Keyboard Shortcut Hints */
        .btn-with-hint {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .shortcut-hint {
            font-size: 0.65rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            color: var(--text-tertiary);
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
            user-select: none;
        }

        .shortcut-hint.visible {
            opacity: 0.7;
        }

        /* Keyboard shortcut badges (for dropdown menu items) */
        .shortcut-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 500;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            color: var(--text-tertiary);
            background: var(--bg-secondary);
            border-radius: 4px;
            padding: 2px 6px;
            margin-left: auto;
            opacity: 0.6;
            flex-shrink: 0;
        }

        .shortcut-badge-inline {
            display: inline-flex;
            font-size: 0.6rem;
            font-weight: 500;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            color: var(--text-tertiary);
            opacity: 0.5;
            margin-left: 4px;
        }

        /* Job Preview Hover Card */
        .job-preview-card {
            width: 28rem;
            max-height: 80vh;
            overflow-y: auto;
        }

        .job-preview-card .skill-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.7rem;
            border-radius: 9999px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            margin: 2px;
        }

        .job-preview-card .description-text {
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
        }

        /* Scrollable sections within hover card (responsibilities, qualifications) */
        .job-preview-card .preview-section {
            display: flex;
            flex-direction: column;
        }

        .job-preview-card .preview-section-scroll {
            max-height: 10rem;  /* ~160px per section */
            overflow-y: auto;
            padding-right: 4px;
        }

        /* Subtle scrollbar for preview sections */
        .job-preview-card .preview-section-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .job-preview-card .preview-section-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .job-preview-card .preview-section-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color, #d1d5db);
            border-radius: 2px;
        }

        .job-preview-card .preview-section-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary, #9ca3af);
        }

        /* Scrollable description within hover card */
        .job-preview-card .description-container {
            display: flex;
            flex-direction: column;
            max-height: 10rem;  /* ~160px */
        }

        .job-preview-card .description-scroll {
            overflow-y: auto;
            flex: 1;
            padding-right: 4px;
        }

        /* Subtle scrollbar for description */
        .job-preview-card .description-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .job-preview-card .description-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .job-preview-card .description-scroll::-webkit-scrollbar-thumb {
            background: var(--border-color, #d1d5db);
            border-radius: 2px;
        }

        .job-preview-card .description-scroll::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary, #9ca3af);
        }

        /* Row Action Animations (delete, batch, discard) */
        @keyframes row-action-gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
                opacity: 0;
            }
        }

        .row-action-deleting {
            background: linear-gradient(90deg,
                rgba(239, 68, 68, 0.15),
                rgba(239, 68, 68, 0.3),
                rgba(239, 68, 68, 0.15));
            background-size: 200% 100%;
            animation: row-action-gradient 0.6s ease-out forwards;
        }

        .row-action-batching {
            background: linear-gradient(90deg,
                rgba(59, 130, 246, 0.15),
                rgba(59, 130, 246, 0.3),
                rgba(59, 130, 246, 0.15));
            background-size: 200% 100%;
            animation: row-action-gradient 0.6s ease-out forwards;
        }

        .row-action-discarding {
            background: linear-gradient(90deg,
                rgba(245, 158, 11, 0.15),
                rgba(245, 158, 11, 0.3),
                rgba(245, 158, 11, 0.15));
            background-size: 200% 100%;
            animation: row-action-gradient 0.6s ease-out forwards;
        }

        .row-action-applying {
            background: linear-gradient(90deg,
                rgba(34, 197, 94, 0.15),
                rgba(34, 197, 94, 0.3),
                rgba(34, 197, 94, 0.15));
            background-size: 200% 100%;
            animation: row-action-gradient 0.6s ease-out forwards;
        }

        /* Card Components - Theme-aware */
        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-default);
            transition: all var(--transition-base);
        }

        .card-hover:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--border-focus);
        }

        /* Glass-morphism card variant (dark mode only) */
        .dark .card-glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(52, 65, 85, 0.5);
        }

        .card-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--border-default);
        }

        .card-body {
            padding: var(--space-6);
        }

        .card-footer {
            padding: var(--space-6);
            border-top: 1px solid var(--border-default);
        }

        /* ================================================================
         * Theme-Aware Utility Classes
         * Use these instead of hardcoded Tailwind color classes
         * ================================================================ */

        /* Backgrounds */
        .theme-bg-page { background-color: var(--bg-page); }
        .theme-bg-card { background-color: var(--bg-card); }
        .theme-bg-secondary { background-color: var(--bg-secondary); }
        .theme-bg-elevated { background-color: var(--bg-elevated); }
        .theme-bg-hover { background-color: var(--bg-hover); }

        /* Text */
        .theme-text-primary { color: var(--text-primary); }
        .theme-text-secondary { color: var(--text-secondary); }
        .theme-text-tertiary { color: var(--text-tertiary); }
        .theme-text-muted { color: var(--text-muted); }

        /* Borders */
        .theme-border { border-color: var(--border-default); }
        .theme-border-light { border-color: var(--border-light); }

        /* Hover utilities (escaped colon for Tailwind-like syntax) */
        .hover\:theme-bg-hover:hover { background-color: var(--bg-hover); }
        .hover\:theme-text-primary:hover { color: var(--text-primary); }

        /* Skeleton loaders - animate with theme colors */
        .skeleton {
            background: linear-gradient(90deg,
                var(--border-default) 25%,
                var(--bg-hover) 50%,
                var(--border-default) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Panel - theme-aware container */
        .panel {
            background-color: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
        }

        /* Table - theme-aware */
        .theme-table {
            background-color: var(--bg-card);
        }

        .theme-table th {
            background-color: var(--bg-secondary);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-default);
        }

        .theme-table td {
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        .theme-table tr:hover {
            background-color: var(--bg-hover);
        }

        /* Form Components - theme-aware */
        .form-input {
            display: block;
            width: 100%;
            padding: 0.625rem 0.875rem;
            font-size: var(--text-sm);
            line-height: var(--line-height-normal);
            color: var(--text-primary);
            background-color: var(--bg-input);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-label {
            display: block;
            font-size: var(--text-sm);
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .form-select {
            display: block;
            width: 100%;
            padding: 0.625rem 2.5rem 0.625rem 0.875rem;
            font-size: var(--text-sm);
            line-height: var(--line-height-normal);
            color: var(--text-primary);
            background-color: var(--bg-input);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            appearance: none;
        }

        /* Dark mode: lighter chevron for visibility */
        .dark .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        .form-select:focus {
            outline: none;
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Badge Components */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
            border-radius: var(--radius-full);
            line-height: 1;
        }

        .badge-primary {
            background-color: var(--color-primary-100);
            color: var(--color-primary-700);
        }

        .badge-success {
            background-color: var(--color-success-50);
            color: var(--color-success-700);
        }

        .badge-warning {
            background-color: var(--color-warning-50);
            color: var(--color-warning-700);
        }

        .badge-error {
            background-color: var(--color-error-50);
            color: var(--color-error-700);
        }

        .badge-gray {
            background-color: var(--color-gray-100);
            color: var(--color-gray-700);
        }

        .badge-info {
            background-color: var(--color-info-50);
            color: var(--color-info-700);
        }

        /* Dark mode badge adjustments for better visibility */
        .dark .badge-primary {
            background-color: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        .dark .badge-success {
            background-color: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .dark .badge-warning {
            background-color: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .dark .badge-error {
            background-color: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .dark .badge-gray {
            background-color: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .dark .badge-info {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        /* Status-specific colors (theme-aware) */
        .status-success { color: var(--color-success-600); }
        .status-error { color: var(--color-error-600); }
        .status-warning { color: var(--color-warning-600); }
        .status-info { color: var(--color-info-600); }

        .dark .status-success { color: #34d399; }
        .dark .status-error { color: #f87171; }
        .dark .status-warning { color: #fbbf24; }
        .dark .status-info { color: #60a5fa; }

        /* Quick date filter buttons - theme-aware */
        .quick-date-btn-hour {
            border-color: var(--color-info-200);
            color: var(--color-info-700);
        }
        .quick-date-btn-hour:hover {
            background-color: var(--color-info-50);
        }
        .quick-date-btn-hour.active {
            background-color: var(--color-info-100);
            border-color: var(--color-info-400);
        }

        .quick-date-btn-week {
            border-color: var(--color-success-200);
            color: var(--color-success-700);
        }
        .quick-date-btn-week:hover {
            background-color: var(--color-success-50);
        }
        .quick-date-btn-week.active {
            background-color: var(--color-success-100);
            border-color: var(--color-success-400);
        }

        .dark .quick-date-btn-hour {
            border-color: rgba(59, 130, 246, 0.4);
            color: #60a5fa;
        }
        .dark .quick-date-btn-hour:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dark .quick-date-btn-hour.active {
            background-color: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.6);
        }

        .dark .quick-date-btn-week {
            border-color: rgba(16, 185, 129, 0.4);
            color: #34d399;
        }
        .dark .quick-date-btn-week:hover {
            background-color: rgba(16, 185, 129, 0.1);
        }
        .dark .quick-date-btn-week.active {
            background-color: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.6);
        }

        .quick-date-btn-month {
            border-color: var(--color-primary-200);
            color: var(--color-primary-700);
        }
        .quick-date-btn-month:hover {
            background-color: var(--color-primary-50);
        }
        .quick-date-btn-month.active {
            background-color: var(--color-primary-100);
            border-color: var(--color-primary-400);
        }

        .dark .quick-date-btn-month {
            border-color: rgba(99, 102, 241, 0.4);
            color: #a5b4fc;
        }
        .dark .quick-date-btn-month:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }
        .dark .quick-date-btn-month.active {
            background-color: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.6);
        }

        /* LinkedIn brand color - theme aware */
        .linkedin-color {
            color: #0077b5;
        }
        .dark .linkedin-color {
            color: #60a5fa;
        }

        /* Modal Components */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: var(--z-modal-backdrop);
            animation: fadeIn var(--transition-base);
        }

        .modal {
            position: fixed;
            inset: 0;
            z-index: var(--z-modal);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .modal-content {
            position: relative;
            z-index: var(--z-modal);
            background-color: var(--bg-card);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            max-width: 28rem;
            width: 100%;
            animation: slideUp var(--transition-slow);
            border: 1px solid var(--border-default);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(1rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Components */
        .spinner {
            width: 2.5rem;
            height: 2.5rem;
            border: 3px solid var(--color-gray-200);
            border-top-color: var(--color-primary-600);
            border-radius: var(--radius-full);
            animation: spin 0.6s linear infinite;
        }

        .spinner-sm {
            width: 1rem;
            height: 1rem;
            border-width: 2px;
        }

        .spinner-lg {
            width: 4rem;
            height: 4rem;
            border-width: 4px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* NOTE: Primary .skeleton class is defined earlier with theme-aware colors */

        /* Toast Notifications - theme-aware (positioned top-right to avoid Pipeline Log panel) */
        .toast {
            position: fixed;
            top: var(--space-6);
            right: var(--space-6);
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            min-width: 20rem;
            z-index: var(--z-tooltip);
            animation: slideInFromTop var(--transition-slow);
            border: 1px solid var(--border-default);
        }

        .toast-success {
            border-left: 4px solid var(--color-success-500);
        }

        .toast-error {
            border-left: 4px solid var(--color-error-500);
        }

        .toast-info {
            border-left: 4px solid var(--color-info-500);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(2rem);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-1rem);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Row hover effect - theme-aware */
        .job-row:hover {
            background-color: var(--bg-hover);
        }

        /* Sort icons */
        .sort-icon {
            opacity: 0.3;
            transition: opacity var(--transition-base);
        }
        .sort-active .sort-icon {
            opacity: 1;
        }

        /* Status badge colors */
        .status-not-processed { background-color: #e5e7eb; color: #374151; }
        .status-marked-for-applying { background-color: #dbeafe; color: #1e40af; }
        .status-ready-for-applying { background-color: #bfdbfe; color: #1e3a8a; }
        .status-to-be-deleted { background-color: #fee2e2; color: #991b1b; }
        .status-discarded { background-color: #f3f4f6; color: #6b7280; }
        .status-applied { background-color: #d1fae5; color: #065f46; }
        .status-interview-scheduled { background-color: #fef3c7; color: #92400e; }
        .status-rejected { background-color: #fecaca; color: #991b1b; }
        .status-offer-received { background-color: #a7f3d0; color: #047857; }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Tablet responsive - hide less important columns */
        @media (max-width: 1024px) {
            .hide-tablet {
                display: none !important;
            }
        }

        /* Mobile responsive table */
        @media (max-width: 768px) {
            .hide-mobile {
                display: none !important;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .job-row td {
                padding: 0.5rem 0.25rem;
            }
        }

        /* Touch-friendly buttons on mobile */
        @media (max-width: 640px) {
            .mobile-stack {
                flex-direction: column;
                gap: 0.75rem;
            }
            .mobile-full {
                width: 100%;
            }
        }

        /* Page loading overlay */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        #page-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Health indicator styles */
        .health-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .health-indicator:hover {
            transform: scale(1.05);
        }

        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .health-healthy { background-color: #10b981; }
        .health-unhealthy { background-color: #ef4444; }
        .health-unknown { background-color: #94a3b8; }
        .health-warning { background-color: #f59e0b; } /* Amber/orange for reconnecting state */

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .health-status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Quick date filter button active states */
        .quick-date-btn.active {
            font-weight: 600;
            box-shadow: 0 0 0 2px currentColor;
        }

        /* Blue buttons (hour filters) active state */
        .quick-date-btn.active.bg-blue-50 {
            background-color: #3b82f6 !important;
            color: white !important;
            border-color: #3b82f6 !important;
        }

        /* Green buttons (week filters) active state */
        .quick-date-btn.active.bg-green-50 {
            background-color: #10b981 !important;
            color: white !important;
            border-color: #10b981 !important;
        }

        /* Purple buttons (month filters) active state */
        .quick-date-btn.active.bg-purple-50 {
            background-color: #a855f7 !important;
            color: white !important;
            border-color: #a855f7 !important;
        }

        /* ============================================================================
         * Phase 5: Accessibility & Mobile Responsiveness
         * ============================================================================ */

        /* Skip link for keyboard navigation */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--color-primary-600);
            color: white;
            padding: 0.5rem 1rem;
            text-decoration: none;
            z-index: 10000;
            border-radius: var(--radius-md);
            font-weight: var(--font-medium);
        }

        .skip-link:focus {
            top: 10px;
            left: 10px;
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Visible focus indicators (WCAG 2.1 AA) */
        *:focus-visible {
            outline: 2px solid var(--color-primary-600);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: 2px solid var(--color-primary-600);
            outline-offset: 2px;
        }

        /* Mobile-responsive touch targets (min 44x44px) */
        @media (max-width: 768px) {
            button,
            .btn,
            a.btn,
            input[type="button"],
            input[type="submit"],
            select,
            input {
                min-height: 44px;
                min-width: 44px;
            }

            /* Toolbar buttons stack on mobile */
            .cv-toolbar {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            /* Document settings collapse on mobile */
            .cv-document-settings {
                max-height: 400px;
                overflow-y: auto;
            }
        }

        /* Color contrast enhancements (WCAG AA: 4.5:1 for normal text) */
        .text-gray-500 {
            color: #6b7280; /* Contrast ratio: 4.54:1 on white */
        }

        .text-gray-600 {
            color: #4b5563; /* Contrast ratio: 7.26:1 on white */
        }

        .text-indigo-600 {
            color: #4f46e5; /* Contrast ratio: 4.5:1 on white */
        }

        /* ============================================================================
         * TipTap ProseMirror WYSIWYG Editor Styles
         * ============================================================================ */
        .ProseMirror {
            outline: none;
            min-height: 100%;
            padding: 2rem;
            color: #1f2a38;  /* Professional near-black */
            max-width: 720px;
            margin: 0 auto;
        }

        /* Mobile-responsive editor */
        @media (max-width: 768px) {
            .ProseMirror {
                padding: 1rem;
                font-size: 14px;
            }
        }

        /* Headings - Professional typography system
         * Note: line-height uses inherit to respect document-level settings (Bug #4 fix)
         * Headings keep min-height via line-height but respect document settings when higher
         */
        .ProseMirror h1 {
            font-family: 'Playfair Display', 'Cormorant Garamond', Georgia, serif;
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;  /* slate-800 - darker for executive presence */
            margin: 0 0 8px 0; /* GAP-026: 20% tighter spacing */
            line-height: inherit; /* Bug #4: Inherit from document settings */
            letter-spacing: 0.02em; /* Refined letter-spacing for elegance */
            text-transform: uppercase; /* Executive styling - uppercase name */
        }

        .ProseMirror h2 {
            font-family: 'Playfair Display', 'Cormorant Garamond', serif;
            font-size: 20px;
            font-weight: 700;
            color: #475569;  /* slate-600 */
            margin: 12px 0 8px; /* GAP-026: 20% tighter spacing */
            padding-top: 6px;
            border-top: 1px solid #e5e7eb;
            line-height: inherit; /* Bug #4: Inherit from document settings */
        }

        .ProseMirror h2:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        .ProseMirror h3 {
            font-family: 'Playfair Display', 'Cormorant Garamond', serif;
            font-size: 16px;
            font-weight: 600;
            color: #475569;  /* slate-600 */
            margin: 10px 0 6px; /* GAP-026: 20% tighter spacing */
            line-height: inherit; /* Bug #4: Inherit from document settings */
        }

        /* Paragraphs - GAP-026: 20% tighter (0.4em vs 0.5em) */
        .ProseMirror p {
            margin: 0.4em 0;
            line-height: inherit; /* Bug #4: Inherit from document settings */
        }

        .ProseMirror p:first-child {
            margin-top: 0;
        }

        .ProseMirror p:last-child {
            margin-bottom: 0;
        }

        /* Inline formatting */
        .ProseMirror strong {
            font-weight: bold;
        }

        .ProseMirror em {
            font-style: italic;
        }

        .ProseMirror u {
            text-decoration: underline;
        }

        /* Lists */
        /* Lists - GAP-026: 20% tighter spacing */
        .ProseMirror ul,
        .ProseMirror ol {
            padding-left: 1.5em;
            margin: 0.4em 0; /* GAP-026: 20% tighter (was 0.5em) */
        }

        .ProseMirror ul {
            list-style-type: disc;
        }

        .ProseMirror ol {
            list-style-type: decimal;
        }

        .ProseMirror li {
            margin: 0.2em 0; /* GAP-026: 20% tighter (was 0.25em) */
            line-height: inherit; /* Bug #4: Inherit from document settings */
        }

        .ProseMirror li > p {
            margin: 0;
        }

        /* Nested lists - GAP-026: 20% tighter */
        .ProseMirror ul ul,
        .ProseMirror ol ul,
        .ProseMirror ul ol,
        .ProseMirror ol ol {
            margin: 0.2em 0; /* GAP-026: 20% tighter (was 0.25em) */
        }

        /* Highlight/Mark */
        .ProseMirror mark {
            background-color: yellow;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }

        /* Text alignment */
        .ProseMirror [style*="text-align: left"] {
            text-align: left;
        }

        .ProseMirror [style*="text-align: center"] {
            text-align: center;
        }

        .ProseMirror [style*="text-align: right"] {
            text-align: right;
        }

        .ProseMirror [style*="text-align: justify"] {
            text-align: justify;
        }

        /* Placeholder for empty editor */
        .ProseMirror p.is-editor-empty:first-child::before {
            content: attr(data-placeholder);
            float: left;
            color: #adb5bd;
            pointer-events: none;
            height: 0;
        }

        /* Code blocks */
        .ProseMirror code {
            background-color: #f3f4f6;
            padding: 0.1em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .ProseMirror pre {
            background-color: #f3f4f6;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
        }

        .ProseMirror pre code {
            background: none;
            padding: 0;
        }

        /* Blockquotes */
        .ProseMirror blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
        }

        /* Hard breaks */
        .ProseMirror br {
            content: '';
        }

        /* Selection */
        .ProseMirror ::selection {
            background-color: #b4d5fe;
        }

        /* Focus state */
        .ProseMirror:focus {
            outline: none;
        }

        /* Links - Professional accent color */
        .ProseMirror a {
            color: #475569;  /* slate-600 */  /* Deep teal accent */
            text-decoration: none;
            cursor: pointer;
        }

        .ProseMirror a:hover {
            text-decoration: underline;
        }

        /* ============================================================================
         * Main CV Display Styles (Matches TipTap Editor WYSIWYG)
         * GAP-054: Unified with .ProseMirror editor styles for true WYSIWYG
         * Applied to the read-only CV display on the detail page
         * ============================================================================ */
        /* CV Display containers - Bug #4: Use inherit for line-height cascade */
        /* Note: #cv-display-area is used on job_detail.html for WYSIWYG preview */
        #cv-markdown-display,
        #cv-container,
        #cv-display-area {
            /* Default line-height; overridden by JS when document settings applied */
            line-height: 1.15;
        }

        /* Headings - GAP-054: Match .ProseMirror editor exactly, GAP-026: 20% tighter */
        #cv-markdown-display h1,
        #cv-container h1,
        #cv-display-area h1 {
            font-family: 'Playfair Display', 'Cormorant Garamond', serif;
            font-size: 34px;
            font-weight: 800;
            color: #475569;  /* slate-600 - matches editor */
            margin: 0 0 10px 0; /* GAP-026: 20% tighter */
            line-height: inherit;
        }

        #cv-markdown-display h2,
        #cv-container h2,
        #cv-display-area h2 {
            font-family: 'Playfair Display', 'Cormorant Garamond', serif;
            font-size: 20px;
            font-weight: 700;
            color: #475569;  /* slate-600 - matches editor */
            margin: 12px 0 8px; /* GAP-026: 20% tighter */
            padding-top: 6px;
            border-top: 1px solid #e5e7eb;
            line-height: inherit;
        }

        #cv-markdown-display h2:first-child,
        #cv-container h2:first-child,
        #cv-display-area h2:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        #cv-markdown-display h3,
        #cv-container h3,
        #cv-display-area h3 {
            font-family: 'Playfair Display', 'Cormorant Garamond', serif;
            font-size: 16px;
            font-weight: 600;
            color: #475569;  /* slate-600 - matches editor */
            margin: 10px 0 6px; /* GAP-026: 20% tighter */
            line-height: inherit;
        }

        /* Paragraphs - GAP-026: 20% tighter (0.4em vs 0.5em) */
        #cv-markdown-display p,
        #cv-container p,
        #cv-display-area p {
            margin: 0.4em 0;
            line-height: inherit; /* Bug #4: Inherit from document settings */
        }

        #cv-markdown-display p:first-child,
        #cv-container p:first-child,
        #cv-display-area p:first-child {
            margin-top: 0;
        }

        #cv-markdown-display p:last-child,
        #cv-container p:last-child,
        #cv-display-area p:last-child {
            margin-bottom: 0;
        }

        /* Inline formatting */
        #cv-markdown-display strong,
        #cv-container strong,
        #cv-display-area strong {
            font-weight: bold;
        }

        #cv-markdown-display em,
        #cv-container em,
        #cv-display-area em {
            font-style: italic;
        }

        #cv-markdown-display u,
        #cv-container u,
        #cv-display-area u {
            text-decoration: underline;
        }

        /* Lists - GAP-026: 20% tighter spacing */
        #cv-markdown-display ul,
        #cv-markdown-display ol,
        #cv-container ul,
        #cv-container ol,
        #cv-display-area ul,
        #cv-display-area ol {
            padding-left: 1.5em;
            margin: 0.4em 0; /* GAP-026: 20% tighter (was 0.5em) */
        }

        #cv-markdown-display ul,
        #cv-container ul,
        #cv-display-area ul {
            list-style-type: disc;
        }

        #cv-markdown-display ol,
        #cv-container ol,
        #cv-display-area ol {
            list-style-type: decimal;
        }

        #cv-markdown-display li,
        #cv-container li,
        #cv-display-area li {
            margin: 0.2em 0; /* GAP-026: 20% tighter (was 0.25em) */
            line-height: inherit; /* Bug #4: Inherit from document settings */
            list-style-position: outside;
        }

        #cv-markdown-display li > p,
        #cv-container li > p,
        #cv-display-area li > p {
            margin: 0;
        }

        /* Nested lists - GAP-026: 20% tighter */
        #cv-markdown-display ul ul,
        #cv-markdown-display ol ul,
        #cv-markdown-display ul ol,
        #cv-markdown-display ol ol,
        #cv-container ul ul,
        #cv-container ol ul,
        #cv-container ul ol,
        #cv-container ol ol,
        #cv-display-area ul ul,
        #cv-display-area ol ul,
        #cv-display-area ul ol,
        #cv-display-area ol ol {
            margin: 0.2em 0; /* GAP-026: 20% tighter (was 0.25em) */
        }

        /* Highlight/Mark */
        #cv-markdown-display mark,
        #cv-container mark,
        #cv-display-area mark {
            background-color: yellow;
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }

        /* Text alignment */
        #cv-markdown-display [style*="text-align: left"],
        #cv-container [style*="text-align: left"],
        #cv-display-area [style*="text-align: left"] {
            text-align: left;
        }

        #cv-markdown-display [style*="text-align: center"],
        #cv-container [style*="text-align: center"],
        #cv-display-area [style*="text-align: center"] {
            text-align: center;
        }

        #cv-markdown-display [style*="text-align: right"],
        #cv-container [style*="text-align: right"],
        #cv-display-area [style*="text-align: right"] {
            text-align: right;
        }

        #cv-markdown-display [style*="text-align: justify"],
        #cv-container [style*="text-align: justify"],
        #cv-display-area [style*="text-align: justify"] {
            text-align: justify;
        }

        /* Code blocks */
        #cv-markdown-display code,
        #cv-container code,
        #cv-display-area code {
            background-color: #f3f4f6;
            padding: 0.1em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        #cv-markdown-display pre,
        #cv-container pre,
        #cv-display-area pre {
            background-color: #f3f4f6;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
        }

        #cv-markdown-display pre code,
        #cv-container pre code,
        #cv-display-area pre code {
            background: none;
            padding: 0;
        }

        /* Blockquotes */
        #cv-markdown-display blockquote,
        #cv-container blockquote,
        #cv-display-area blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
        }

        /* Links - GAP-054: Match editor slate-600 accent */
        #cv-markdown-display a,
        #cv-container a,
        #cv-display-area a {
            color: #475569;  /* slate-600 - matches editor */
            text-decoration: none;
            cursor: pointer;
        }

        #cv-markdown-display a:hover,
        #cv-container a:hover,
        #cv-display-area a:hover {
            text-decoration: underline;
        }

        /* Collapsible details arrow rotation */
        details[open] .details-arrow {
            transform: rotate(90deg);
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details summary::marker {
            display: none;
        }

        /* Scoped CSS for jobs list table (#job-table-container) - DO NOT affect batch page */
        #job-table-container .theme-table td.status-col {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #job-table-container .theme-table td.status-col select {
            width: 100%;
            max-width: 120px;
        }

        #job-table-container .theme-table td.location-col {
            width: 50px;
            max-width: 50px;
            min-width: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #job-table-container .theme-table td.role-col {
            min-width: 180px;
            max-width: 280px;
        }

        #job-table-container .theme-table td.score-col {
            width: 60px;
            max-width: 60px;
            min-width: 50px;
            text-align: center;
        }
    </style>

    <!-- Pipeline Actions CSS -->
    <link rel="stylesheet" href="/static/css/pipeline-actions.css">

    <!-- CLI Panel CSS -->
    <link rel="stylesheet" href="/static/css/cli-panel.css">

    <!-- Job Detail Page CSS -->
    <link rel="stylesheet" href="/static/css/job-detail.css">

    <!-- JD Preview Panel CSS -->
    <link rel="stylesheet" href="/static/css/jd-preview.css">

    {% block extra_head %}{% endblock %}
</head>
<body class="h-full">
    <!-- Page loading overlay -->
    <div id="page-loader" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="spinner-lg mx-auto mb-4"></div>
            <p class="text-gray-600 font-medium">Loading...</p>
        </div>
    </div>

    <div class="min-h-full">
        <!-- Navigation - Theme-aware -->
        <nav class="border-b" style="background-color: var(--bg-card); border-color: var(--border-default); box-shadow: var(--shadow-sm);">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 justify-between items-center">
                    <a href="/" class="flex items-center group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-lg flex items-center justify-center shadow-sm group-hover:shadow-md transition-all">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div>
                                <span class="text-xl font-bold transition-colors" style="color: var(--text-primary);">JobSearch</span>
                                <p class="hidden sm:block text-xs" style="color: var(--text-tertiary);">Level-2 Manager <span class="font-mono text-[10px] px-1 py-0.5 rounded" style="background-color: var(--bg-hover);">v{{ version }}</span></p>
                            </div>
                        </div>
                    </a>
                    <div class="flex items-center gap-3 sm:gap-4">
                        <!-- Health indicators -->
                        <div id="health-status" class="health-status hidden sm:flex">
                            <!-- Health indicators loaded via JavaScript -->
                        </div>
                        <div id="stats-container" class="text-xs sm:text-sm" style="color: var(--text-secondary);">
                            <!-- Stats loaded via HTMX -->
                        </div>

                        <!-- Queue Dropdowns (WebSocket-powered) -->
                        {% include 'components/queue_dropdowns.html' %}

                        <!-- Batch Processing Button with Count Badge -->
                        <a
                            href="/batch-processing"
                            class="p-2 rounded-lg transition-all duration-200 hover:scale-105 relative"
                            style="background-color: var(--bg-hover); color: var(--text-secondary);"
                            title="Batch Processing"
                            aria-label="Batch Processing"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            <!-- Batch count badge -->
                            <span id="batch-count-badge"
                                  class="absolute -top-1 -right-1 min-w-[18px] h-[18px] flex items-center justify-center
                                         text-[10px] font-bold text-white bg-accent-500 rounded-full px-1
                                         opacity-0 scale-0 transition-all duration-200"
                                  style="display: none;">
                            </span>
                        </a>

                        <!-- Job Ingestion Button -->
                        <a
                            href="/ingestion"
                            class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                            style="background-color: var(--bg-hover); color: var(--text-secondary);"
                            title="Job Ingestion"
                            aria-label="Job Ingestion"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                        </a>

                        <!-- Master CV Button -->
                        <a
                            href="/master-cv"
                            class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                            style="background-color: var(--bg-hover); color: var(--text-secondary);"
                            title="Master CV Editor"
                            aria-label="Edit Master CV"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </a>

                        <!-- API Docs Button -->
                        <a
                            href="/api/docs"
                            target="_blank"
                            class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                            style="background-color: var(--bg-hover); color: var(--text-secondary);"
                            title="API Documentation (Swagger)"
                            aria-label="API Documentation"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                            </svg>
                        </a>

                        <!-- Diagnostics Button -->
                        <a
                            href="/diagnostics"
                            class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                            style="background-color: var(--bg-hover); color: var(--text-secondary);"
                            title="System Diagnostics"
                            aria-label="System Diagnostics"
                        >
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </a>

                        <!-- Theme Toggle Button -->
                        <button
                            id="theme-toggle"
                            type="button"
                            class="p-2 rounded-lg transition-all duration-200 hover:scale-105"
                            style="background-color: var(--bg-hover); color: var(--text-secondary);"
                            title="Toggle dark/light mode"
                            aria-label="Toggle theme"
                        >
                            <!-- Sun icon (shown in dark mode) -->
                            <svg id="theme-icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                            </svg>
                            <!-- Moon icon (shown in light mode) -->
                            <svg id="theme-icon-moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                            </svg>
                        </button>

                        <form method="POST" action="/logout" class="m-0">
                            <button
                                type="submit"
                                class="inline-flex items-center px-3 py-1.5 rounded-md
                                       text-xs sm:text-sm font-medium
                                       focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500
                                       transition duration-150 ease-in-out"
                                style="background-color: var(--bg-card); color: var(--text-secondary); border: 1px solid var(--border-default);"
                                title="Logout"
                            >
                                <svg class="h-4 w-4 sm:mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                                <span class="hidden sm:inline">Logout</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main content -->
        <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Global CLI Panel (outside main content to survive HTMX swaps) -->
    {% include 'components/cli_panel.html' %}

    <!-- Delete confirmation modal -->
    <div id="delete-modal" class="hidden modal">
        <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
        <div class="modal-content">
            <div class="card-header flex items-start gap-4">
                <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Confirm Delete</h3>
                    <p class="text-sm text-gray-600">
                        Are you sure you want to delete <span id="delete-count" class="font-semibold text-gray-900">0</span> selected job(s)?
                    </p>
                </div>
            </div>
            <div class="card-body">
                <p class="text-sm text-gray-600">
                    This action cannot be undone. All data associated with these jobs will be permanently removed from the database.
                </p>
            </div>
            <div class="card-footer flex justify-end gap-3">
                <button onclick="closeDeleteModal()" class="btn btn-ghost btn-md">
                    Cancel
                </button>
                <button onclick="confirmDelete()" class="btn btn-danger btn-md">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete Jobs
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for interactivity -->
    <script>
        // Track selected job IDs
        let selectedJobIds = new Set();

        // Update selection count in toolbar
        function updateSelectionCount() {
            const countEl = document.getElementById('selection-count');
            const deleteBtn = document.getElementById('delete-selected-btn');
            const processBtn = document.getElementById('process-selected-btn');
            const applyBtn = document.getElementById('apply-selected-btn');
            const count = selectedJobIds.size;

            if (countEl) {
                countEl.textContent = count;
            }
            if (deleteBtn) {
                deleteBtn.disabled = count === 0;
                deleteBtn.classList.toggle('opacity-50', count === 0);
                deleteBtn.classList.toggle('cursor-not-allowed', count === 0);
            }
            if (processBtn) {
                processBtn.disabled = count === 0;
                processBtn.classList.toggle('opacity-50', count === 0);
                processBtn.classList.toggle('cursor-not-allowed', count === 0);
            }
            // Also enable/disable the tier dropdown toggle button
            const tierToggle = document.getElementById('process-tier-toggle');
            if (tierToggle) {
                tierToggle.disabled = count === 0;
                tierToggle.classList.toggle('opacity-50', count === 0);
                tierToggle.classList.toggle('cursor-not-allowed', count === 0);
            }
            if (applyBtn) {
                applyBtn.disabled = count === 0;
                applyBtn.classList.toggle('opacity-50', count === 0);
                applyBtn.classList.toggle('cursor-not-allowed', count === 0);
            }
            // Move to Batch button
            const batchBtn = document.getElementById('move-to-batch-btn');
            if (batchBtn) {
                batchBtn.disabled = count === 0;
                batchBtn.classList.toggle('opacity-50', count === 0);
                batchBtn.classList.toggle('cursor-not-allowed', count === 0);
            }
            // Discard Selected button
            const discardBtn = document.getElementById('discard-selected-btn');
            if (discardBtn) {
                discardBtn.disabled = count === 0;
                discardBtn.classList.toggle('opacity-50', count === 0);
                discardBtn.classList.toggle('cursor-not-allowed', count === 0);
            }
        }

        // Toggle individual row selection
        function toggleRowSelection(checkbox) {
            const jobId = checkbox.dataset.jobId;
            if (checkbox.checked) {
                selectedJobIds.add(jobId);
            } else {
                selectedJobIds.delete(jobId);
            }
            updateSelectionCount();
            updateSelectAllCheckbox();
        }

        // Toggle all visible rows
        function toggleSelectAll(checkbox) {
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            rowCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const jobId = cb.dataset.jobId;
                if (checkbox.checked) {
                    selectedJobIds.add(jobId);
                } else {
                    selectedJobIds.delete(jobId);
                }
            });
            updateSelectionCount();
        }

        // Update select-all checkbox state
        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('select-all');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            if (selectAll && rowCheckboxes.length > 0) {
                const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
                selectAll.checked = allChecked;
                selectAll.indeterminate = someChecked && !allChecked;
            }
        }

        // Open delete confirmation modal
        function openDeleteModal() {
            if (selectedJobIds.size === 0) return;
            document.getElementById('delete-count').textContent = selectedJobIds.size;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
        }

        // Confirm and execute delete
        async function confirmDelete() {
            if (selectedJobIds.size === 0) return;

            try {
                // Animate rows and close modal
                animateSelectedRows('row-action-deleting');
                closeDeleteModal();

                const response = await fetch('/api/jobs/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_ids: Array.from(selectedJobIds) })
                });

                const result = await response.json();

                if (result.success) {
                    // Clear selection
                    selectedJobIds.clear();
                    updateSelectionCount();

                    // Refresh table via HTMX
                    htmx.trigger('#job-table-container', 'refresh');

                    // Show success message
                    showToast(`Deleted ${result.deleted_count} job(s)`);
                } else {
                    showToast(result.error || 'Delete failed', 'error');
                }
            } catch (err) {
                showToast('Delete failed: ' + err.message, 'error');
            }

            closeDeleteModal();
        }

        // Update job status
        async function updateStatus(jobId, newStatus) {
            try {
                const response = await fetch('/api/jobs/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId, status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`Status updated to "${newStatus}"`);
                    // Refresh stats
                    htmx.trigger('#stats-container', 'refresh');
                } else {
                    showToast(result.error || 'Status update failed', 'error');
                }
            } catch (err) {
                showToast('Status update failed: ' + err.message, 'error');
            }
        }

        // ===== GAP-067: Editable Score Field =====
        function enableScoreEdit(displayEl, jobId, currentScore) {
            const container = displayEl.closest('.editable-score-container');
            const input = container.querySelector('.score-input');

            // Hide display, show input
            displayEl.classList.add('hidden');
            input.classList.remove('hidden');
            input.value = currentScore !== null ? currentScore : '';
            input.focus();
            input.select();
        }

        function handleScoreKeydown(event, input, jobId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                input.blur(); // Triggers saveScore via onblur
            } else if (event.key === 'Escape') {
                cancelScoreEdit(input);
            }
        }

        function cancelScoreEdit(input) {
            const container = input.closest('.editable-score-container');
            const display = container.querySelector('.score-display');
            input.classList.add('hidden');
            display.classList.remove('hidden');
        }

        // Save application URL for a job (main page)
        async function saveJobApplicationUrl(jobId, url) {
            try {
                const response = await fetch(`/api/jobs/${jobId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ application_url: url })
                });

                if (response.ok) {
                    showToast('Application URL saved', 'success');
                    // Refresh the job table to show updated URL
                    htmx.trigger('#job-table-container', 'refresh');
                } else {
                    const data = await response.json();
                    showToast(data.error || 'Failed to save URL', 'error');
                }
            } catch (error) {
                console.error('Failed to save application URL:', error);
                showToast('Failed to save URL', 'error');
            }
        }

        async function saveScore(input, jobId) {
            const container = input.closest('.editable-score-container');
            const display = container.querySelector('.score-display');
            const newScore = input.value.trim();

            // Validate score
            let scoreValue = null;
            if (newScore !== '') {
                scoreValue = parseInt(newScore, 10);
                if (isNaN(scoreValue) || scoreValue < 0 || scoreValue > 100) {
                    showToast('Score must be between 0 and 100', 'error');
                    cancelScoreEdit(input);
                    return;
                }
            }

            try {
                const response = await fetch('/api/jobs/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id: jobId, score: scoreValue })
                });

                const result = await response.json();

                if (result.success) {
                    // Update the display badge
                    updateScoreBadge(display, scoreValue);
                    showToast('Score updated', 'success');
                } else {
                    showToast(result.error || 'Failed to update score', 'error');
                }
            } catch (error) {
                console.error('Error updating score:', error);
                showToast('Failed to update score', 'error');
            }

            // Hide input, show display
            input.classList.add('hidden');
            display.classList.remove('hidden');
        }

        function updateScoreBadge(display, score) {
            let badgeClass = 'badge-gray';
            let displayText = '—';

            if (score !== null) {
                displayText = score;
                if (score >= 80) badgeClass = 'badge-success';
                else if (score >= 60) badgeClass = 'badge-warning';
            }

            display.innerHTML = `<span class="px-2 py-1 rounded-full text-xs font-medium ${badgeClass}">${displayText}</span>`;
        }
        // ===== End GAP-067 =====

        // Toast notification using new design system
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');

            // Map type to toast class
            const typeClass = type === 'error' ? 'toast-error' : type === 'info' ? 'toast-info' : 'toast-success';
            toast.className = `toast ${typeClass}`;

            // Icon based on type
            const icons = {
                success: `<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
                error: `<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`,
                info: `<svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>`
            };

            toast.innerHTML = `
                ${icons[type] || icons.success}
                <span class="text-sm font-medium text-gray-900">${message}</span>
                <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;

            document.body.appendChild(toast);

            // Auto-dismiss after 4 seconds (slide up since toast is at top)
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-1rem)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ============================================================================
        // Discard with Undo - 5 second countdown before actual discard
        // ============================================================================

        let pendingDiscard = null; // { jobIds: Set, timeoutId: number, toastEl: HTMLElement, intervalId: number }

        function showDiscardCountdown(jobIds, onConfirm) {
            const count = jobIds.size;
            let secondsLeft = 5;

            // Create countdown toast
            const toast = document.createElement('div');
            toast.className = 'toast toast-warning';
            toast.style.cssText = 'position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 10000; min-width: 320px;';

            const updateToastContent = () => {
                toast.innerHTML = `
                    <div class="flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg bg-amber-50 border border-amber-200">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <span class="text-amber-800 font-medium">Discarding ${count} job${count > 1 ? 's' : ''} in ${secondsLeft}s...</span>
                        </div>
                        <button onclick="cancelPendingDiscard()" class="px-3 py-1 text-sm font-medium text-amber-700 bg-amber-100 hover:bg-amber-200 rounded-md transition-colors">
                            Undo
                        </button>
                    </div>
                `;
            };

            updateToastContent();
            document.body.appendChild(toast);

            // Countdown interval
            const intervalId = setInterval(() => {
                secondsLeft--;
                if (secondsLeft > 0) {
                    updateToastContent();
                }
            }, 1000);

            // Timeout to execute discard
            const timeoutId = setTimeout(() => {
                clearInterval(intervalId);
                toast.remove();
                pendingDiscard = null;
                onConfirm();
            }, 5000);

            // Store pending state
            pendingDiscard = {
                jobIds: new Set(jobIds),
                timeoutId,
                toastEl: toast,
                intervalId
            };
        }

        function cancelPendingDiscard() {
            if (!pendingDiscard) return;

            // Clear timers
            clearTimeout(pendingDiscard.timeoutId);
            clearInterval(pendingDiscard.intervalId);

            // Remove toast
            if (pendingDiscard.toastEl) {
                pendingDiscard.toastEl.remove();
            }

            // Remove animation classes from rows
            pendingDiscard.jobIds.forEach(id => {
                const row = document.querySelector(`tr[data-job-id="${id}"]`);
                if (row) {
                    row.classList.remove('row-action-discarding');
                }
            });

            showToast('Discard cancelled', 'info');
            pendingDiscard = null;
        }

        // Clear selections when table refreshes
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.target.id === 'job-table-container') {
                // Restore checkbox states for selected items
                selectedJobIds.forEach(id => {
                    const checkbox = document.querySelector(`input[data-job-id="${id}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                updateSelectAllCheckbox();
            }
        });

        // ============================================================================
        // Job Prefetch System - Reduces detail page load latency
        // ============================================================================

        const jobPrefetchCache = new Map();
        const PREFETCH_CACHE_TTL = 5 * 60 * 1000; // 5 minutes
        const PREFETCH_CACHE_MAX = 20;
        const PREFETCH_DEBOUNCE_MS = 150;

        let prefetchTimeout = null;
        const prefetchingJobIds = new Set();

        /**
         * Prefetch job data when user hovers over a row
         * @param {string} jobId - The job ID to prefetch
         */
        function prefetchJobOnHover(jobId) {
            // Debounce rapid hover events
            clearTimeout(prefetchTimeout);
            prefetchTimeout = setTimeout(() => {
                // Skip if already cached with valid TTL
                if (jobPrefetchCache.has(jobId)) {
                    const cached = jobPrefetchCache.get(jobId);
                    if (Date.now() - cached.timestamp < PREFETCH_CACHE_TTL) return;
                }

                // Skip if already prefetching this job
                if (prefetchingJobIds.has(jobId)) return;

                prefetchingJobIds.add(jobId);

                fetch(`/api/jobs/${jobId}`)
                    .then(r => r.json())
                    .then(data => {
                        // Evict oldest entry if at capacity (LRU eviction)
                        if (jobPrefetchCache.size >= PREFETCH_CACHE_MAX) {
                            const oldest = [...jobPrefetchCache.entries()]
                                .sort((a, b) => a[1].timestamp - b[1].timestamp)[0][0];
                            jobPrefetchCache.delete(oldest);
                        }
                        jobPrefetchCache.set(jobId, { data, timestamp: Date.now() });
                    })
                    .catch(e => console.debug('Job prefetch failed (non-critical):', e))
                    .finally(() => prefetchingJobIds.delete(jobId));
            }, PREFETCH_DEBOUNCE_MS);
        }

        /**
         * Get prefetched job data from cache if available
         * @param {string} jobId - The job ID to retrieve
         * @returns {object|null} - Cached job data or null
         */
        function getPrefetchedJob(jobId) {
            if (!jobPrefetchCache.has(jobId)) return null;
            const cached = jobPrefetchCache.get(jobId);
            if (Date.now() - cached.timestamp > PREFETCH_CACHE_TTL) {
                jobPrefetchCache.delete(jobId);
                return null;
            }
            return cached.data;
        }

        // Navigate to job detail page
        function navigateToJob(event, jobId) {
            // Don't navigate if clicking on interactive elements
            const target = event.target;
            const tagName = target.tagName.toLowerCase();

            if (tagName === 'a' || tagName === 'button' || tagName === 'input' || tagName === 'select') {
                return;
            }

            // Check if clicking inside a link or button
            if (target.closest('a') || target.closest('button') || target.closest('select')) {
                return;
            }

            // Check for prefetched data and store in sessionStorage for detail page
            const prefetched = getPrefetchedJob(jobId);
            if (prefetched) {
                try {
                    sessionStorage.setItem(`prefetch_job_${jobId}`, JSON.stringify(prefetched));
                } catch (e) {
                    // sessionStorage might be full or disabled, continue anyway
                    console.debug('Could not store prefetched data:', e);
                }
            }

            // Navigate to job detail page
            window.location.href = `/job/${jobId}`;
        }

        // ============================================================================
        // Pipeline Cancellation Functions
        // ============================================================================

        // Track current pipeline run for cancellation
        let currentPipelineRunId = null;

        /**
         * Show the stop button when a pipeline starts
         * @param {string} runId - The run ID of the started pipeline
         */
        function showPipelineStopButton(runId) {
            currentPipelineRunId = runId;
            const btn = document.getElementById('pipeline-stop-btn');
            if (btn) {
                btn.classList.remove('hidden');
            }
        }

        /**
         * Hide the stop button when pipeline completes/fails/cancels
         */
        function hidePipelineStopButton() {
            const btn = document.getElementById('pipeline-stop-btn');
            if (btn) {
                btn.classList.add('hidden');
            }
            currentPipelineRunId = null;
        }

        /**
         * Cancel the currently running pipeline
         * Sends SIGKILL to subprocess and discards all partial results
         */
        async function cancelPipeline() {
            if (!currentPipelineRunId) {
                showToast('No active pipeline to cancel', 'warning');
                return;
            }

            // Confirmation dialog
            const confirmed = confirm(
                'Cancel pipeline?\n\n' +
                'This will immediately stop the pipeline and discard ALL partial results.\n' +
                'The job will remain unchanged as if the pipeline never ran.\n\n' +
                'This cannot be undone.'
            );

            if (!confirmed) return;

            try {
                showToast('Cancelling pipeline...', 'info');

                const response = await fetch(`/api/runner/jobs/${currentPipelineRunId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast('Pipeline cancelled - all changes discarded', 'info');
                    hidePipelineStopButton();

                    // Update UI to show cancelled state
                    const progressContainer = document.getElementById('pipeline-progress-container');
                    if (progressContainer) {
                        // Update progress bar to show cancelled
                        const progressBar = document.getElementById('pipeline-overall-progress-bar');
                        if (progressBar) {
                            progressBar.classList.remove('from-indigo-500', 'to-indigo-600');
                            progressBar.classList.add('from-gray-400', 'to-gray-500');
                        }

                        // Update percentage text
                        const percentText = document.getElementById('pipeline-overall-percent');
                        if (percentText) {
                            percentText.textContent = 'Cancelled';
                            percentText.classList.remove('text-indigo-700', 'dark:text-indigo-400');
                            percentText.classList.add('text-gray-600', 'dark:text-gray-400');
                        }
                    }
                } else {
                    showToast(result.error || 'Failed to cancel pipeline', 'error');
                }
            } catch (err) {
                showToast('Cancel failed: ' + err.message, 'error');
            }
        }

        // ============================================================================
        // Process Job Functions
        // ============================================================================

        // Process job through pipeline
        async function processJob(jobId, jobTitle) {
            // Confirmation dialog
            const confirmed = confirm(
                `Process job through pipeline?\n\n` +
                `Job: ${jobTitle}\n\n` +
                `This will trigger the full processing pipeline on the VPS runner.`
            );

            if (!confirmed) return;

            try {
                showToast('Starting pipeline...', 'info');

                // Trigger pipeline via proxy
                const response = await fetch('/api/runner/jobs/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_id: jobId,
                        level: 2  // Process at level 2
                    })
                });

                const result = await response.json();

                if (response.ok && result.run_id) {
                    showToast(`Pipeline started! Run ID: ${result.run_id}`);
                    // Show stop button for cancellation
                    showPipelineStopButton(result.run_id);
                    // Redirect to job detail page to see progress
                    setTimeout(() => {
                        window.location.href = `/job/${jobId}?run_id=${result.run_id}`;
                    }, 1500);
                } else {
                    showToast(result.error || 'Failed to start pipeline', 'error');
                }
            } catch (err) {
                showToast('Pipeline failed: ' + err.message, 'error');
            }
        }

        // Bulk processing tier labels
        const bulkTierLabels = {
            'auto': 'Auto',
            'A': 'Gold (A)',
            'B': 'Silver (B)',
            'C': 'Bronze (C)'
        };

        // Set bulk processing tier
        function setBulkProcessingTier(tier) {
            document.getElementById('bulk-selected-tier').value = tier;
            const label = document.getElementById('bulk-process-btn-label');
            if (label) label.textContent = `Process (${bulkTierLabels[tier] || tier})`;
        }

        // Process multiple selected jobs through pipeline (batch)
        async function processSelectedJobs() {
            if (selectedJobIds.size === 0) return;

            const tier = document.getElementById('bulk-selected-tier')?.value || 'auto';
            const tierDisplay = bulkTierLabels[tier] || tier;
            const count = selectedJobIds.size;
            const confirmed = confirm(
                `Process ${count} job${count > 1 ? 's' : ''} through pipeline?\n\n` +
                `Tier: ${tierDisplay}\n` +
                `This will trigger the pipeline for all selected jobs on the VPS runner.\n` +
                `Jobs will be processed concurrently (up to MAX_CONCURRENCY limit).`
            );

            if (!confirmed) return;

            try {
                showToast(`Starting batch pipeline (${tierDisplay}) for ${count} jobs...`, 'info');

                // Call bulk endpoint
                const response = await fetch('/api/runner/jobs/run-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_ids: Array.from(selectedJobIds),
                        level: 2,
                        processing_tier: tier
                    })
                });

                const result = await response.json();

                if (response.ok && result.runs) {
                    showToast(`Batch pipeline started! ${result.runs.length} jobs queued.`);
                    // Clear selection after successful queue
                    selectedJobIds.clear();
                    updateSelectionCount();
                    // Uncheck all checkboxes
                    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
                    const selectAll = document.getElementById('select-all');
                    if (selectAll) selectAll.checked = false;
                } else {
                    showToast(result.error || 'Failed to start batch pipeline', 'error');
                }
            } catch (err) {
                showToast('Batch pipeline failed: ' + err.message, 'error');
            }
        }

        // ============================================================================
        // Row Action Animation Helper
        // ============================================================================
        // Animate selected rows with gradient effect before action completes

        function animateSelectedRows(animationClass) {
            selectedJobIds.forEach(jobId => {
                const row = document.querySelector(`tr[data-job-id="${jobId}"]`);
                if (row) {
                    row.classList.add(animationClass);
                }
            });
        }

        // Mark multiple selected jobs as "applied"
        async function markSelectedAsApplied() {
            if (selectedJobIds.size === 0) return;

            const count = selectedJobIds.size;
            const confirmed = confirm(
                `Mark ${count} job${count > 1 ? 's' : ''} as "applied"?\n\n` +
                `This will update the status of all selected jobs.`
            );

            if (!confirmed) return;

            try {
                // Animate rows
                animateSelectedRows('row-action-applying');
                showToast(`Updating ${count} jobs...`, 'info');

                // Call bulk status update endpoint
                const response = await fetch('/api/jobs/status/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_ids: Array.from(selectedJobIds),
                        status: 'applied'
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast(`${result.updated_count} jobs marked as applied!`);
                    // Clear selection
                    selectedJobIds.clear();
                    updateSelectionCount();
                    // Uncheck all checkboxes
                    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
                    const selectAll = document.getElementById('select-all');
                    if (selectAll) selectAll.checked = false;
                    // Refresh the table to show updated status
                    htmx.trigger('#job-table-container', 'refresh');
                } else {
                    showToast(result.error || 'Failed to update jobs', 'error');
                }
            } catch (err) {
                showToast('Update failed: ' + err.message, 'error');
            }
        }

        // Mark multiple selected jobs as "discarded" with 5-second undo window
        async function markSelectedAsDiscarded() {
            if (selectedJobIds.size === 0) return;

            // If there's already a pending discard, cancel it first
            if (pendingDiscard) {
                cancelPendingDiscard();
            }

            // Copy the current selection (in case it changes during countdown)
            const jobIdsToDiscard = new Set(selectedJobIds);

            // Animate rows to show pending state
            animateSelectedRows('row-action-discarding');

            // Show countdown toast with undo option
            showDiscardCountdown(jobIdsToDiscard, async () => {
                // This runs after 5 seconds if not cancelled
                try {
                    const response = await fetch('/api/jobs/status/bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            job_ids: Array.from(jobIdsToDiscard),
                            status: 'discarded'
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        showToast(`Discarded ${result.updated_count} job${result.updated_count !== 1 ? 's' : ''}`, 'success');
                        // Clear selection
                        selectedJobIds.clear();
                        updateSelectionCount();
                        // Uncheck all checkboxes
                        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
                        const selectAll = document.getElementById('select-all');
                        if (selectAll) selectAll.checked = false;
                        // Refresh the table to show updated status
                        htmx.trigger('#job-table-container', 'refresh');
                    } else {
                        showToast(result.error || 'Failed to discard jobs', 'error');
                        // Remove animation on failure
                        jobIdsToDiscard.forEach(id => {
                            const row = document.querySelector(`tr[data-job-id="${id}"]`);
                            if (row) row.classList.remove('row-action-discarding');
                        });
                    }
                } catch (err) {
                    showToast('Discard failed: ' + err.message, 'error');
                    // Remove animation on error
                    jobIdsToDiscard.forEach(id => {
                        const row = document.querySelector(`tr[data-job-id="${id}"]`);
                        if (row) row.classList.remove('row-action-discarding');
                    });
                }
            });
        }

        // Move selected jobs to batch processing queue
        async function moveSelectedToBatch() {
            if (selectedJobIds.size === 0) return;

            const count = selectedJobIds.size;

            try {
                // Animate rows
                animateSelectedRows('row-action-batching');
                showToast(`Moving ${count} jobs to batch...`, 'info');

                const response = await fetch('/api/jobs/move-to-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_ids: Array.from(selectedJobIds)
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showToast(`${result.updated_count} job${result.updated_count > 1 ? 's' : ''} moved to batch!`, 'success');

                    // Clear selection
                    selectedJobIds.clear();
                    updateSelectionCount();

                    // Invalidate batch count cache and notify listeners
                    window.dispatchEvent(new CustomEvent('batch:updated'));

                    // Refresh the table to remove moved jobs (consistent with single job behavior)
                    htmx.trigger('#job-table-container', 'refresh');
                } else {
                    showToast(result.error || 'Failed to move jobs to batch', 'error');
                }
            } catch (err) {
                showToast('Move to batch failed: ' + err.message, 'error');
            }
        }

        // ============================================================================
        // Job Row Context Menu Functions
        // ============================================================================

        // Context menu state
        let contextMenuTargetJobId = null;
        let contextMenuTargetJobTitle = null;
        let contextMenuTargetJobUrl = null;

        /**
         * Show the context menu at the click position
         * @param {Event} event - The contextmenu event
         * @param {string} jobId - The job ID
         * @param {string} jobTitle - The job title for display
         * @param {string} jobUrl - The external job URL (optional)
         */
        function showJobContextMenu(event, jobId, jobTitle, jobUrl) {
            event.preventDefault();
            event.stopPropagation();

            const menu = document.getElementById('job-context-menu');
            if (!menu) return;

            // Store target job info
            contextMenuTargetJobId = jobId;
            contextMenuTargetJobTitle = jobTitle || 'this job';
            contextMenuTargetJobUrl = jobUrl || null;

            // Show/hide the "Open Job URL" option based on whether URL exists
            const openJobUrlBtn = document.getElementById('context-menu-open-job-url');
            if (openJobUrlBtn) {
                openJobUrlBtn.style.display = jobUrl ? 'flex' : 'none';
            }

            // Position menu at click location, but ensure it stays on screen
            const menuWidth = 180;
            const menuHeight = 160;
            let x = event.clientX;
            let y = event.clientY;

            // Adjust if would go off right edge
            if (x + menuWidth > window.innerWidth) {
                x = window.innerWidth - menuWidth - 10;
            }

            // Adjust if would go off bottom
            if (y + menuHeight > window.innerHeight) {
                y = y - menuHeight;
            }

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.remove('hidden');

            // Add click outside listener
            setTimeout(() => {
                document.addEventListener('click', hideJobContextMenuOnClickOutside);
                document.addEventListener('keydown', hideJobContextMenuOnEscape);
            }, 0);
        }

        /**
         * Hide the context menu
         */
        function hideJobContextMenu() {
            const menu = document.getElementById('job-context-menu');
            if (menu) {
                menu.classList.add('hidden');
            }
            contextMenuTargetJobId = null;
            contextMenuTargetJobTitle = null;
            contextMenuTargetJobUrl = null;
            document.removeEventListener('click', hideJobContextMenuOnClickOutside);
            document.removeEventListener('keydown', hideJobContextMenuOnEscape);
        }

        function hideJobContextMenuOnClickOutside(event) {
            const menu = document.getElementById('job-context-menu');
            if (menu && !menu.contains(event.target)) {
                hideJobContextMenu();
            }
        }

        function hideJobContextMenuOnEscape(event) {
            if (event.key === 'Escape') {
                hideJobContextMenu();
            }
        }

        /**
         * Execute a context menu action
         * @param {string} action - The action to perform
         */
        async function contextMenuAction(action) {
            const jobId = contextMenuTargetJobId;
            const jobTitle = contextMenuTargetJobTitle;
            const jobUrl = contextMenuTargetJobUrl;

            if (!jobId) {
                hideJobContextMenu();
                return;
            }

            hideJobContextMenu();

            switch (action) {
                case 'batch':
                    // Move single job to batch
                    await moveSingleJobToBatch(jobId, jobTitle);
                    break;

                case 'open':
                    // Open job detail in new tab
                    window.open(`/job/${jobId}`, '_blank');
                    break;

                case 'openJobUrl':
                    // Open external job URL in new tab
                    if (jobUrl) {
                        window.open(jobUrl, '_blank');
                    } else {
                        showToast('No external URL available for this job', 'warning');
                    }
                    break;

                case 'applied':
                    // Mark as applied
                    await updateStatus(jobId, 'applied');
                    htmx.trigger('#job-table-container', 'refresh');
                    break;

                case 'discard':
                    // Mark as discarded
                    await updateStatus(jobId, 'discarded');
                    htmx.trigger('#job-table-container', 'refresh');
                    break;
            }
        }

        /**
         * Move a single job to batch processing
         * @param {string} jobId - The job ID
         * @param {string} jobTitle - The job title for feedback
         */
        async function moveSingleJobToBatch(jobId, jobTitle) {
            try {
                showToast(`Moving "${jobTitle}" to batch...`, 'info');

                const response = await fetch('/api/jobs/move-to-batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_ids: [jobId]
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Dispatch events for each queued job so live status badges update immediately
                    if (result.all_ops_runs && result.all_ops_runs.length > 0) {
                        result.all_ops_runs.forEach((run, index) => {
                            window.dispatchEvent(new CustomEvent('queue:job-status-changed', {
                                detail: {
                                    jobId: run.job_id,
                                    status: 'pending',
                                    runId: run.run_id,
                                    operation: 'all-ops',
                                    position: index + 1
                                }
                            }));
                        });

                        // Force QueuePoller to refresh immediately
                        if (window.Alpine && Alpine.store('queue')._poller) {
                            Alpine.store('queue')._poller.refresh();
                        }
                    }

                    // Show warning if pipeline auto-queue failed
                    if (result.all_ops_error) {
                        showToast(`"${jobTitle}" moved but pipeline failed: ${result.all_ops_error}`, 'error');
                        console.error('Pipeline auto-queue failed:', result.all_ops_error);
                    } else if (result.all_ops_queued > 0) {
                        showToast(`"${jobTitle}" moved and queued for processing!`, 'success');
                    } else {
                        showToast(`"${jobTitle}" moved to batch!`, 'success');
                    }
                    htmx.trigger('#job-table-container', 'refresh');
                } else {
                    showToast(result.error || 'Failed to move job to batch', 'error');
                }
            } catch (err) {
                showToast('Move to batch failed: ' + err.message, 'error');
            }
        }

        // Import LinkedIn job by ID or URL (GAP-065)
        async function importLinkedInJob() {
            const input = document.getElementById('linkedin-job-input');
            const button = document.getElementById('linkedin-import-btn');
            const statusDiv = document.getElementById('linkedin-import-status');
            const jobIdOrUrl = input?.value?.trim();

            if (!jobIdOrUrl) {
                showToast('Please enter a LinkedIn job ID or URL', 'warning');
                input?.focus();
                return;
            }

            // Disable button and show loading state
            if (button) {
                button.disabled = true;
                button.innerHTML = `
                    <svg class="animate-spin h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Importing...
                `;
            }

            // Show status
            if (statusDiv) {
                statusDiv.classList.remove('hidden');
                statusDiv.className = 'text-sm text-blue-600';
                statusDiv.textContent = 'Scraping LinkedIn job...';
            }

            try {
                const response = await fetch('/api/jobs/import-linkedin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_id_or_url: jobIdOrUrl })
                });

                // Handle non-JSON responses (timeout, server errors return HTML)
                const contentType = response.headers.get('content-type');
                let result;
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    // Server returned HTML or plain text (likely timeout/error)
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error(response.status === 504 ? 'Request timed out. Try again.' :
                                   response.status >= 500 ? 'Server error. The scraper may have timed out.' :
                                   'Server returned unexpected response');
                }

                if (response.ok && result.job_id) {
                    // Update status
                    if (statusDiv) {
                        statusDiv.className = 'text-sm text-green-600';
                        statusDiv.textContent = `Imported! Score: ${result.score || 'N/A'}. Redirecting...`;
                    }

                    showToast(`Job imported: ${result.title} at ${result.company}. Score: ${result.score || 'N/A'}`, 'success');

                    // Clear input
                    if (input) input.value = '';

                    // Redirect to job detail page after a short delay
                    setTimeout(() => {
                        window.location.href = `/job/${result.job_id}`;
                    }, 1500);
                } else {
                    // Show error
                    if (statusDiv) {
                        statusDiv.className = 'text-sm text-red-600';
                        statusDiv.textContent = result.error || 'Import failed';
                    }
                    showToast(result.error || 'Failed to import LinkedIn job', 'error');
                }
            } catch (err) {
                if (statusDiv) {
                    statusDiv.className = 'text-sm text-red-600';
                    statusDiv.textContent = 'Network error: ' + err.message;
                }
                showToast('Import failed: ' + err.message, 'error');
            } finally {
                // Re-enable button
                if (button) {
                    button.disabled = false;
                    button.innerHTML = `
                        <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        <span class="hidden sm:inline">Import & Score</span>
                        <span class="sm:hidden">Import</span>
                    `;
                }

                // Hide status after 5 seconds on error
                setTimeout(() => {
                    if (statusDiv && statusDiv.classList.contains('text-red-600')) {
                        statusDiv.classList.add('hidden');
                    }
                }, 5000);
            }
        }

        // Health status caching for faster page loads
        const HEALTH_CACHE_KEY = 'health_status_cache';
        const HEALTH_CACHE_TTL = 30 * 1000; // 30 seconds (health changes more frequently)

        function getCachedHealth() {
            try {
                const cached = localStorage.getItem(HEALTH_CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < HEALTH_CACHE_TTL) {
                        return data;
                    }
                }
            } catch (e) {}
            return null;
        }

        function setCachedHealth(data) {
            try {
                localStorage.setItem(HEALTH_CACHE_KEY, JSON.stringify({
                    data,
                    timestamp: Date.now()
                }));
            } catch (e) {}
        }

        function renderHealthIndicators(data) {
            const healthContainer = document.getElementById('health-status');
            if (!healthContainer || !data) return;

            const indicators = [];

            // Runner Health
            const runnerClass = data.runner?.status === 'healthy' ? 'health-healthy' :
                                data.runner?.status === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
            indicators.push(`
                <div class="health-indicator" title="Runner: ${data.runner?.status || 'unknown'}">
                    <div class="health-dot ${runnerClass}"></div>
                    <span class="text-gray-700">Runner</span>
                </div>
            `);

            // MongoDB Health
            const mongoClass = data.mongodb?.status === 'healthy' ? 'health-healthy' :
                               data.mongodb?.status === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
            indicators.push(`
                <div class="health-indicator" title="MongoDB: ${data.mongodb?.status || 'unknown'}">
                    <div class="health-dot ${mongoClass}"></div>
                    <span class="text-gray-700">DB</span>
                </div>
            `);

            // PDF Service Health
            const pdfStatus = data.runner_response?.pdf_service_status || 'unknown';
            const pdfClass = pdfStatus === 'healthy' ? 'health-healthy' :
                             pdfStatus === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
            const pdfError = data.runner_response?.pdf_service_error || '';
            const pdfTitle = pdfStatus === 'healthy' ? 'PDF Service: Healthy' :
                             pdfStatus === 'unhealthy' ? `PDF Service: Unhealthy (${pdfError})` :
                             'PDF Service: Unknown';
            indicators.push(`
                <div class="health-indicator" id="pdf-health-indicator" title="${pdfTitle}">
                    <div class="health-dot ${pdfClass}"></div>
                    <span class="text-gray-700">PDF</span>
                </div>
            `);

            // n8n Health (if available)
            if (data.n8n) {
                const n8nClass = data.n8n?.status === 'healthy' ? 'health-healthy' :
                                 data.n8n?.status === 'unhealthy' ? 'health-unhealthy' : 'health-unknown';
                indicators.push(`
                    <div class="health-indicator" title="n8n: ${data.n8n?.status || 'unknown'}">
                        <div class="health-dot ${n8nClass}"></div>
                        <span class="text-gray-700">n8n</span>
                    </div>
                `);
            }

            healthContainer.innerHTML = indicators.join('');
        }

        // Non-blocking health status loader with caching
        function updateHealthStatus() {
            // Show cached data immediately (non-blocking)
            const cached = getCachedHealth();
            if (cached) {
                renderHealthIndicators(cached);
            }

            // Fetch fresh data in background
            fetch('/api/health')
                .then(res => res.ok ? res.json() : null)
                .then(data => {
                    if (data) {
                        setCachedHealth(data);
                        renderHealthIndicators(data);
                    }
                })
                .catch(() => {}); // Silently fail - we have cached data
        }

        // Stats caching for faster page loads
        const STATS_CACHE_KEY = 'job_stats_cache';
        const STATS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

        function getCachedStats() {
            try {
                const cached = localStorage.getItem(STATS_CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    // Return cached data if still valid
                    if (Date.now() - timestamp < STATS_CACHE_TTL) {
                        return data;
                    }
                }
            } catch (e) {}
            return null;
        }

        function setCachedStats(data) {
            try {
                localStorage.setItem(STATS_CACHE_KEY, JSON.stringify({
                    data,
                    timestamp: Date.now()
                }));
            } catch (e) {}
        }

        function updateStatsDisplay(data) {
            const container = document.getElementById('stats-container');
            if (container && data && data.level2_count !== undefined) {
                container.innerHTML = `Level-2: <span class="font-semibold">${data.level2_count.toLocaleString()}</span> jobs`;
            }
        }

        async function loadStats(forceRefresh = false) {
            // Show cached data immediately (non-blocking)
            const cached = getCachedStats();
            if (cached && !forceRefresh) {
                updateStatsDisplay(cached);
            }

            // Fetch fresh data in background (don't await if we have cache)
            const fetchPromise = fetch('/api/stats')
                .then(res => res.ok ? res.json() : null)
                .then(data => {
                    if (data) {
                        setCachedStats(data);
                        updateStatsDisplay(data);
                    }
                })
                .catch(() => {}); // Silently fail - we have cached data

            // Only wait for fetch if no cache
            if (!cached || forceRefresh) {
                await fetchPromise;
            }
        }

        // Load initial stats
        document.addEventListener('DOMContentLoaded', function() {
            // Hide page loader
            setTimeout(() => {
                document.getElementById('page-loader').classList.add('hidden');
            }, 500);

            // Load stats (async with cache)
            loadStats();

            // Load health status
            updateHealthStatus();

            // Load batch count
            loadBatchCount();

            // Refresh health status every 30 seconds
            setInterval(updateHealthStatus, 30000);

            // Refresh batch count every 60 seconds
            setInterval(loadBatchCount, 60000);
        });

        // ============================================================================
        // Batch Count Badge
        // ============================================================================

        let batchCountCache = { count: null, timestamp: 0 };
        const BATCH_COUNT_CACHE_TTL = 30000; // 30 seconds cache

        async function loadBatchCount() {
            const badge = document.getElementById('batch-count-badge');
            if (!badge) return;

            // Check cache
            const now = Date.now();
            if (batchCountCache.count !== null && (now - batchCountCache.timestamp) < BATCH_COUNT_CACHE_TTL) {
                updateBatchCountBadge(batchCountCache.count);
                return;
            }

            try {
                const response = await fetch('/api/jobs/batch/count');
                if (response.ok) {
                    const data = await response.json();
                    const count = data.count || 0;
                    batchCountCache = { count, timestamp: now };
                    updateBatchCountBadge(count);
                }
            } catch (err) {
                console.error('Failed to load batch count:', err);
            }
        }

        function updateBatchCountBadge(count) {
            const badge = document.getElementById('batch-count-badge');
            if (!badge) return;

            if (count > 0) {
                badge.textContent = count > 9999 ? '9999+' : count;
                badge.style.display = 'flex';
                badge.classList.remove('opacity-0', 'scale-0');
                badge.classList.add('opacity-100', 'scale-100');
            } else {
                badge.classList.remove('opacity-100', 'scale-100');
                badge.classList.add('opacity-0', 'scale-0');
                setTimeout(() => { badge.style.display = 'none'; }, 200);
            }
        }

        // Invalidate cache and refresh when jobs are moved to batch
        window.addEventListener('batch:updated', () => {
            batchCountCache = { count: null, timestamp: 0 };
            loadBatchCount();
        });
    </script>

    <!-- Global Debug Mode Helpers -->
    <script>
    /**
     * Enable debug modes via URL params or console
     * Usage: Add ?debug=true to URL or call enableDebug() in console
     */
    (function() {
        // Auto-enable debug modes if ?debug=true in URL
        if (window.location.search.includes('debug=true')) {
            localStorage.setItem('ws_debug', 'true');
            localStorage.setItem('cli_debug', 'true');
            console.log('[Debug] All debug modes enabled via URL param');
        }

        // Global helper to enable debug modes
        window.enableDebug = function(modes) {
            const allModes = modes || ['ws', 'cli'];
            allModes.forEach(mode => {
                localStorage.setItem(`${mode}_debug`, 'true');
            });
            console.log('[Debug] Enabled for:', allModes);
            console.log('[Debug] Reload page to take effect');
        };

        // Global helper to disable all debug modes
        window.disableDebug = function() {
            localStorage.removeItem('ws_debug');
            localStorage.removeItem('cli_debug');
            console.log('[Debug] All debug modes disabled');
            console.log('[Debug] Reload page to take effect');
        };

        // Log debug helpers availability
        if (localStorage.getItem('ws_debug') === 'true' || localStorage.getItem('cli_debug') === 'true') {
            console.log('[Debug] Debug mode is active. Use disableDebug() to turn off.');
        }
    })();
    </script>

    <!-- Theme Manager (Phase 2: Dark/Light Mode Toggle) -->
    <script>
    /**
     * ThemeManager - Handles dark/light mode switching with persistence
     *
     * Features:
     * - localStorage persistence across sessions
     * - System preference detection (prefers-color-scheme)
     * - Smooth transitions when switching themes
     * - Updates UI icons to reflect current theme
     */
    class ThemeManager {
        constructor() {
            this.THEME_KEY = 'app-theme';
            this.DARK_THEME = 'dark';
            this.LIGHT_THEME = 'light';
            this.initialize();
        }

        initialize() {
            // Theme is already applied by early script in <head>
            // Just update icons and set up listeners

            // Update icons based on current state
            this.updateIcons();

            // Set up toggle button
            const toggleBtn = document.getElementById('theme-toggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => this.toggleTheme());
            }

            // Listen for system preference changes (when no saved preference)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem(this.THEME_KEY)) {
                    this.setTheme(e.matches ? this.DARK_THEME : this.LIGHT_THEME);
                }
            });
        }

        getTheme() {
            return localStorage.getItem(this.THEME_KEY) ||
                   (window.matchMedia('(prefers-color-scheme: dark)').matches ? this.DARK_THEME : this.LIGHT_THEME);
        }

        setTheme(theme) {
            const root = document.documentElement;

            if (theme === this.DARK_THEME) {
                root.classList.add('dark');
            } else {
                root.classList.remove('dark');
            }

            // Save preference
            localStorage.setItem(this.THEME_KEY, theme);

            // Update icons
            this.updateIcons();
        }

        toggleTheme() {
            const current = this.getTheme();
            const newTheme = current === this.DARK_THEME ? this.LIGHT_THEME : this.DARK_THEME;
            this.setTheme(newTheme);
        }

        updateIcons() {
            const sunIcon = document.getElementById('theme-icon-sun');
            const moonIcon = document.getElementById('theme-icon-moon');

            if (sunIcon && moonIcon) {
                const isDark = document.documentElement.classList.contains('dark');

                // Show sun in dark mode (click to go light)
                // Show moon in light mode (click to go dark)
                if (isDark) {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                } else {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                }
            }
        }
    }

    // Initialize ThemeManager when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        window.themeManager = new ThemeManager();

        // Analytics dashboard collapsible state persistence
        const analyticsDetails = document.getElementById('analytics-dashboard-details');
        if (analyticsDetails) {
            const savedState = localStorage.getItem('analytics-dashboard-open');
            // Default to collapsed (closed)
            if (savedState === 'true') {
                analyticsDetails.open = true;
            }

            // Save state on toggle
            analyticsDetails.addEventListener('toggle', () => {
                localStorage.setItem('analytics-dashboard-open', analyticsDetails.open);
            });
        }
    });
    </script>

    <!-- Pipeline Actions JS (must load after Alpine.js) -->
    <script src="/static/js/pipeline-actions.js?v=20251229d"></script>

    <!-- CLI Panel JS (must load after Alpine.js for store registration) -->
    <script src="/static/js/cli-panel.js"></script>

    <!-- Queue Store (must load after Alpine.js and pollers) -->
    <script src="/static/js/queue-store.js"></script>
    <script src="/static/js/live-status-badge.js"></script>

    <!-- LinkedIn Import Component (must load after Alpine.js) -->
    <script src="/static/js/linkedin-import.js"></script>

    <!-- Indeed Import Component (must load after Alpine.js) -->
    <script src="/static/js/indeed-import.js"></script>

    <!-- JD Preview: Formatter, Prefetch, and Batch Sync -->
    <script src="/static/js/jd-formatter.js"></script>
    <script src="/static/js/jd-prefetch.js"></script>
    <script src="/static/js/batch-sync.js"></script>

    {% block extra_js %}{% endblock %}
</body>
</html>
