<!-- Single batch job row - used for both full list and HTMX row refresh -->
{% set job_url = job.url or job.jobUrl %}
{% set app_url = job.application_url or job_url %}
<tbody x-data="{ expanded: isJobExpanded('{{ job._id }}'), jobId: '{{ job._id }}' }"
       x-on:queue:job-completed.window="if ($event.detail.jobId === jobId) htmx.trigger($el, 'refresh-row')"
       data-job-id="{{ job._id }}"
       data-batch-added-at="{{ job.batch_added_at if job.batch_added_at is string else (job.batch_added_at.isoformat() if job.batch_added_at else '') }}"
       class="theme-bg-card"
       hx-get="/partials/batch-job-row/{{ job._id }}"
       hx-trigger="refresh-row"
       hx-swap="outerHTML">
    <!-- Main row -->
    <tr class="job-row hover:theme-bg-hover border-b theme-border"
        :class="{ 'theme-bg-hover': expanded }"
        oncontextmenu="showBatchJobContextMenu(event, '{{ job._id }}', '{{ (job.title or '') | e | replace("'", "\\'") }}', '{{ (job_url or '') | e | replace("'", "\\'") }}'); return false;">
        <!-- Expand toggle -->
        <td class="px-2 py-3 no-navigate" onclick="event.stopPropagation()">
            <button @click="expanded = toggleJobExpand('{{ job._id }}')"
                    class="p-1 rounded hover:theme-bg-tertiary transition-transform duration-200"
                    :class="{ 'rotate-90': expanded }">
                <svg class="w-4 h-4 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </td>

        <!-- Checkbox -->
        <td class="px-2 py-3 no-navigate" onclick="event.stopPropagation()">
            <input type="checkbox"
                   class="batch-row-checkbox h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500"
                   data-job-id="{{ job._id }}"
                   onchange="toggleBatchRowSelection(this)">
        </td>

        <!-- Company -->
        <td class="px-2 sm:px-4 py-3 whitespace-nowrap cursor-pointer overflow-hidden"
            onclick="navigateToBatchJob(event, '{{ job._id }}')">
            <div class="flex items-center gap-1.5">
                <div class="text-sm font-medium theme-text-primary truncate" title="{{ job.company or '-' }}">
                    {{ job.company or '-' }}
                </div>
                {% if job.source == 'linkedin_import' %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 flex-shrink-0" title="Imported from LinkedIn">
                    <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M2.5 3.5a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM3 7h3v10H3V7zm5.5 0h3v1.4h.1c.4-.8 1.4-1.7 3-1.7 3.2 0 3.8 2.1 3.8 4.9V17h-3.2v-4.7c0-1.1 0-2.5-1.5-2.5s-1.7 1.2-1.7 2.4V17h-3.5V7z"/></svg>
                    LinkedIn
                </span>
                {% elif job.auto_discovered %}
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200 flex-shrink-0" title="Auto-discovered job">
                    {% if job.source == 'indeed_auto' %}
                    <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-3H9V6h2v4z"/></svg>
                    Indeed
                    {% elif job.source == 'himalayas_auto' %}
                    <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z"/></svg>
                    Remote
                    {% else %}
                    Auto
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </td>

        <!-- Role/Title with Hover Preview + Application URL -->
        {% set has_extracted = job.extracted_jd is defined and job.extracted_jd %}
        {% set jd = job.extracted_jd if has_extracted else {} %}
        {% set desc = job.description or job.job_description or job.jobDescription or '' %}
        <td class="px-2 sm:px-4 py-3 cursor-pointer group overflow-visible relative"
            x-data="{ showPreview: false, hoverTimeout: null, leaveTimeout: null }"
            @mouseenter="clearTimeout(leaveTimeout); hoverTimeout = setTimeout(() => showPreview = true, 200)"
            @mouseleave="clearTimeout(hoverTimeout); leaveTimeout = setTimeout(() => showPreview = false, 150)"
            onclick="navigateToBatchJob(event, '{{ job._id }}')">
            <div class="flex items-center gap-1.5">
                <div class="text-sm theme-text-primary max-w-[180px] truncate">
                    {% if job_url %}
                    <a href="{{ job_url }}" target="_blank"
                       class="text-accent-500 hover:text-accent-400 hover:underline no-navigate"
                       onclick="event.stopPropagation()">
                        {{ job.title or '-' }}
                    </a>
                    {% else %}
                    {{ job.title or '-' }}
                    {% endif %}
                </div>
                <!-- Application URL Quick Entry + Quick Open Link -->
                <div class="relative no-navigate flex-shrink-0 flex items-center gap-0.5"
                     x-data="{ showPopover: false, url: '{{ (app_url or '') | e }}', saving: false }"
                     onclick="event.stopPropagation()">
                    <!-- Quick open link (if URL exists) -->
                    {% if app_url %}
                    <a href="{{ app_url }}" target="_blank"
                       class="p-1 text-green-500 hover:text-green-600 rounded hover:bg-green-50 dark:hover:bg-green-900/30 transition-all"
                       title="Open application form">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </a>
                    {% endif %}
                    <!-- Edit button -->
                    <button @click="showPopover = !showPopover"
                            class="p-1 rounded transition-all
                                   {% if app_url %}opacity-0 group-hover:opacity-100 theme-text-tertiary hover:theme-text-primary hover:theme-bg-hover
                                   {% else %}opacity-0 group-hover:opacity-100 theme-text-tertiary hover:theme-text-primary hover:theme-bg-hover{% endif %}"
                            title="{{ 'Edit application URL' if app_url else 'Set application URL' }}">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    <!-- Popover -->
                    <div x-show="showPopover"
                         x-cloak
                         @click.away="showPopover = false"
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="transform opacity-0 scale-95"
                         x-transition:enter-end="transform opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="transform opacity-100 scale-100"
                         x-transition:leave-end="transform opacity-0 scale-95"
                         class="absolute left-0 top-full mt-1 w-72 p-3 rounded-lg shadow-xl theme-bg-card border theme-border z-50">
                        <label class="block text-xs font-medium theme-text-secondary mb-1.5">Application URL</label>
                        <div class="flex gap-2">
                            <input type="url"
                                   x-model="url"
                                   class="flex-1 px-2 py-1.5 text-sm rounded border theme-border theme-bg-secondary theme-text-primary focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
                                   placeholder="https://..."
                                   @keydown.enter="saving = true; saveBatchJobUrl('{{ job._id }}', url).then(() => { saving = false; showPopover = false; })"
                                   @keydown.escape="showPopover = false">
                            <button @click="saving = true; saveBatchJobUrl('{{ job._id }}', url).then(() => { saving = false; showPopover = false; })"
                                    :disabled="saving"
                                    class="px-2.5 py-1.5 rounded bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white text-xs font-medium transition flex items-center gap-1">
                                <template x-if="saving">
                                    <svg class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                </template>
                                <span x-text="saving ? '' : 'Save'"></span>
                            </button>
                        </div>
                        <p class="text-xs theme-text-tertiary mt-1.5">Press Enter to save, Escape to cancel</p>
                    </div>
                </div>
            </div>

            <!-- Hover Preview Card -->
            <div x-show="showPreview"
                 x-cloak
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 @mouseenter="clearTimeout(leaveTimeout)"
                 @mouseleave="leaveTimeout = setTimeout(() => showPreview = false, 150)"
                 class="absolute left-0 top-full mt-1 job-preview-card rounded-lg shadow-xl theme-bg-card border theme-border z-50 p-4 no-navigate"
                 onclick="event.stopPropagation()">
                <!-- Header -->
                <div class="mb-3 pb-2 border-b theme-border">
                    <h4 class="font-semibold theme-text-primary text-sm">{{ job.title or 'Untitled' }}</h4>
                    <p class="text-xs theme-text-secondary">{{ job.company or 'Unknown' }} ‚Ä¢ {{ job.location or 'Location N/A' }}</p>
                </div>

                {% if has_extracted %}
                <!-- Extracted JD Info -->
                <div class="space-y-2 mb-3">
                    {% if jd.role_category %}
                    <div class="flex items-center gap-2 text-xs">
                        <span class="theme-text-tertiary">üìã Role:</span>
                        <span class="theme-text-primary font-medium">{{ jd.role_category | replace('_', ' ') | title }}</span>
                    </div>
                    {% endif %}
                    {% if jd.seniority_level %}
                    <div class="flex items-center gap-2 text-xs">
                        <span class="theme-text-tertiary">üéØ Level:</span>
                        <span class="theme-text-primary font-medium">{{ jd.seniority_level | title }}</span>
                    </div>
                    {% endif %}
                </div>

                <!-- Skills -->
                {% if jd.technical_skills or jd.top_keywords %}
                <div class="mb-3">
                    <p class="text-xs theme-text-tertiary mb-1">üîß Skills:</p>
                    <div class="flex flex-wrap">
                        {% for skill in (jd.technical_skills or jd.top_keywords or [])[:8] %}
                        <span class="skill-badge">{{ skill }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Key Responsibilities -->
                {% if jd.responsibilities %}
                <div class="mb-3 preview-section">
                    <p class="text-xs theme-text-tertiary mb-1 font-medium">üìå Key Responsibilities:</p>
                    <div class="preview-section-scroll">
                        <ul class="space-y-1.5 text-xs theme-text-secondary">
                            {% for resp in jd.responsibilities %}
                            <li class="flex items-start gap-1.5">
                                <span class="text-accent-500 flex-shrink-0 mt-0.5">‚Ä∫</span>
                                <span>{{ resp }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}

                <!-- Required Qualifications -->
                {% if jd.required_qualifications %}
                <div class="mb-3 preview-section">
                    <p class="text-xs theme-text-tertiary mb-1 font-medium">‚úì Required Qualifications:</p>
                    <div class="preview-section-scroll">
                        <ul class="space-y-1.5 text-xs theme-text-secondary">
                            {% for qual in jd.required_qualifications %}
                            <li class="flex items-start gap-1.5">
                                <span class="text-green-500 flex-shrink-0 mt-0.5">‚úì</span>
                                <span>{{ qual }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <!-- Not analyzed notice -->
                <div class="mb-3 p-2 rounded bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800">
                    <p class="text-xs text-yellow-700 dark:text-yellow-300">‚ö†Ô∏è Not yet analyzed</p>
                </div>
                {% endif %}

                <!-- Description Preview (scrollable) -->
                {% if desc %}
                <div class="description-container">
                    <p class="text-xs theme-text-tertiary mb-1">Description:</p>
                    <div class="description-scroll">
                        <p class="text-xs theme-text-secondary description-text">{{ desc }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </td>

        <!-- Score (editable) -->
        <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm"
            x-data="{ editing: false, score: {{ job.score if job.score is not none else 'null' }} }">
            <!-- View mode -->
            <template x-if="!editing">
                <div class="flex items-center gap-1">
                    <span @click="editing = true" class="cursor-pointer"
                          :class="{
                              'px-2 py-1 rounded-full text-xs font-medium badge-success': score >= 80,
                              'px-2 py-1 rounded-full text-xs font-medium badge-warning': score >= 60 && score < 80,
                              'px-2 py-1 rounded-full text-xs font-medium badge-gray': score < 60 || score === null
                          }"
                          x-text="score !== null ? score : '-'"
                          title="Click to edit"></span>
                </div>
            </template>
            <!-- Edit mode -->
            <template x-if="editing">
                <div class="flex items-center gap-1">
                    <input type="number" min="0" max="100"
                           x-model="score"
                           class="w-16 px-2 py-1 text-sm rounded border theme-border theme-bg-card theme-text-primary focus:ring-2 focus:ring-accent-500"
                           @keydown.enter="saveBatchJobScore('{{ job._id }}', score); editing = false"
                           @keydown.escape="editing = false"
                           x-init="$nextTick(() => $el.focus())">
                    <button @click="saveBatchJobScore('{{ job._id }}', score); editing = false"
                            class="p-1 rounded bg-green-600 hover:bg-green-700 text-white" title="Save">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </button>
                    <button @click="editing = false"
                            class="p-1 rounded hover:theme-bg-hover theme-text-tertiary" title="Cancel">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </template>
        </td>

        <!-- Added to batch -->
        <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm theme-text-secondary">
            {% if job.batch_added_at %}
                {{ job.batch_added_at.strftime('%m/%d %H:%M') if job.batch_added_at is not string else job.batch_added_at[:16] }}
            {% elif job.createdAt %}
                {{ job.createdAt[:10] }}
            {% else %}
                <span class="theme-text-muted">-</span>
            {% endif %}
        </td>

        <!-- Status dropdown - hx-preserve prevents HTMX swap race conditions that could trigger onChange -->
        <td class="px-4 py-3 whitespace-nowrap no-navigate" onclick="event.stopPropagation()">
            {% set status = job.status or 'not processed' %}
            {% set status_class = status | replace(' ', '-') %}
            <select id="status-select-{{ job._id }}"
                    hx-preserve="true"
                    class="text-xs px-2 py-1 rounded-full border-0 cursor-pointer status-{{ status_class }}"
                    onchange="updateBatchJobStatus('{{ job._id }}', this.value)"
                    data-current-status="{{ status }}"
                    style="min-width: 130px;">
                {% for s in statuses %}
                <option value="{{ s }}" {{ 'selected' if status == s else '' }}>{{ s }}</option>
                {% endfor %}
            </select>
        </td>

        <!-- Progress indicators with tri-state colors -->
        <!-- JD: gray=none, orange=extracted (no annotations), green=has annotations -->
        <!-- RS: gray=none, orange=has research (no contacts), green=has contacts -->
        <!-- CV: gray=none, orange=generated (not edited), green=edited in CV editor -->
        {% set has_jd_extraction = job.extracted_jd or job.processed_jd %}
        {% set jd_annotations_list = (job.jd_annotations.annotations if job.jd_annotations else []) %}
        {% set has_jd_annotations = jd_annotations_list | length > 0 %}
        {% set jd_state = 'green' if has_jd_annotations else ('orange' if has_jd_extraction else 'gray') %}

        {% set has_research = job.company_research or job.role_skills %}
        {% set primary_contacts = job.primary_contacts if job.primary_contacts else [] %}
        {% set secondary_contacts = job.secondary_contacts if job.secondary_contacts else [] %}
        {% set has_contacts = (primary_contacts | length > 0) or (secondary_contacts | length > 0) %}
        {% set rs_state = 'green' if has_contacts else ('orange' if has_research else 'gray') %}

        {% set has_cv_generated = job.generated_cv or job.cv_output or job.cv_text %}
        {% set has_cv_edited = job.cv_editor_state is defined and job.cv_editor_state %}
        {% set cv_state = 'green' if has_cv_edited else ('orange' if has_cv_generated else 'gray') %}

        <td class="px-2 sm:px-4 py-3 whitespace-nowrap no-navigate" onclick="event.stopPropagation()">
            <div class="flex items-center gap-1.5">
                <!-- JD Badge - updates via annotations:updated event -->
                <span data-jd-badge="{{ job._id }}"
                      class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium transition-colors
                             {% if jd_state == 'green' %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 cursor-pointer hover:bg-green-200 dark:hover:bg-green-800
                             {% elif jd_state == 'orange' %}bg-orange-100 text-orange-600 dark:bg-orange-900/50 dark:text-orange-300 cursor-pointer hover:bg-orange-200 dark:hover:bg-orange-800
                             {% else %}bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500{% endif %}"
                      title="JD: {{ 'Annotated' if jd_state == 'green' else ('Extracted' if jd_state == 'orange' else 'Not extracted') }}"
                      onclick="openBatchAnnotationPanel('{{ job._id }}')">
                    JD
                </span>
                <!-- RS Badge - updates via research:updated event -->
                <span data-rs-badge="{{ job._id }}"
                      class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium transition-colors
                             {% if rs_state == 'green' %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 cursor-pointer hover:bg-green-200 dark:hover:bg-green-800
                             {% elif rs_state == 'orange' %}bg-orange-100 text-orange-600 dark:bg-orange-900/50 dark:text-orange-300 cursor-pointer hover:bg-orange-200 dark:hover:bg-orange-800
                             {% else %}bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500{% endif %}"
                      title="Research: {{ 'Has contacts' if rs_state == 'green' else ('Researched' if rs_state == 'orange' else 'Not researched') }}"
                      {% if rs_state in ['green', 'orange'] %}onclick="openBatchContactsSidebar('{{ job._id }}')"{% endif %}>
                    RS
                </span>
                <!-- CV Badge - updates via cv:generated event -->
                <span data-cv-badge="{{ job._id }}"
                      class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-medium transition-colors
                             {% if cv_state == 'green' %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 cursor-pointer hover:bg-green-200 dark:hover:bg-green-800
                             {% elif cv_state == 'orange' %}bg-orange-100 text-orange-600 dark:bg-orange-900/50 dark:text-orange-300 cursor-pointer hover:bg-orange-200 dark:hover:bg-orange-800
                             {% else %}bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500{% endif %}"
                      title="CV: {{ 'Edited' if cv_state == 'green' else ('Generated' if cv_state == 'orange' else 'Not generated') }}"
                      {% if cv_state in ['green', 'orange'] %}onclick="openBatchCVEditor('{{ job._id }}')"{% endif %}>
                    CV
                </span>
            </div>
        </td>

        <!-- Pipeline Status (Live WebSocket Badge) -->
        <td class="px-2 sm:px-4 py-3 whitespace-nowrap no-navigate" onclick="event.stopPropagation()">
            {% set job_id = job._id | string %}
            {% include 'components/live_status_badge.html' %}
        </td>

        <!-- Actions -->
        <td class="px-4 py-3 whitespace-nowrap text-sm no-navigate" onclick="event.stopPropagation()">
            <div class="flex items-center gap-2">
                {% if job_url %}
                <a href="{{ job_url }}" target="_blank"
                   class="text-accent-500 hover:text-accent-400"
                   title="Open job posting">
                    <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                    </svg>
                </a>
                {% endif %}
                <a href="/job/{{ job._id }}"
                   class="theme-text-secondary hover:text-accent-400"
                   title="View details">
                    <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                </a>
                <button onclick="processSingleBatchJob('{{ job._id }}')"
                        class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"
                        title="Process job through pipeline">
                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </button>
            </div>
        </td>
    </tr>

    <!-- Expandable details row -->
    <tr x-show="expanded" x-collapse.duration.200ms
        x-cloak
        class="theme-bg-secondary border-b theme-border expanded-detail-row">
        <td colspan="10" class="px-4 py-3">
            <!-- Overflow wrapper to handle wide content -->
            <div class="max-w-full overflow-x-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm min-w-0">
                <!-- Location -->
                <div>
                    <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Location</label>
                    <span class="theme-text-primary">{{ job.location or 'Not specified' }}</span>
                </div>

                <!-- Application URL (editable) -->
                <div class="md:col-span-2" x-data="{ editing: false, url: '{{ (app_url or '') | e }}' }">
                    <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Application URL</label>
                    <div class="flex items-center gap-2">
                        <template x-if="!editing">
                            <div class="flex items-center gap-2 flex-1 min-w-0">
                                {% if app_url %}
                                <a :href="url" target="_blank"
                                   class="text-accent-500 hover:text-accent-400 truncate max-w-md"
                                   x-text="url || 'Not set'"></a>
                                {% else %}
                                <span class="theme-text-muted">Not set</span>
                                {% endif %}
                                <button @click="editing = true"
                                        class="p-1 rounded hover:theme-bg-hover theme-text-tertiary hover:theme-text-primary"
                                        title="Edit URL">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                    </svg>
                                </button>
                            </div>
                        </template>
                        <template x-if="editing">
                            <div class="flex items-center gap-2 flex-1">
                                <input type="url"
                                       x-model="url"
                                       class="flex-1 px-2 py-1 text-sm rounded border theme-border theme-bg-card theme-text-primary focus:ring-2 focus:ring-accent-500"
                                       placeholder="https://..."
                                       @keydown.enter="saveBatchJobUrl('{{ job._id }}', url); editing = false"
                                       @keydown.escape="editing = false">
                                <button @click="saveBatchJobUrl('{{ job._id }}', url); editing = false"
                                        class="p-1 rounded bg-green-600 hover:bg-green-700 text-white"
                                        title="Save">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </button>
                                <button @click="editing = false"
                                        class="p-1 rounded hover:theme-bg-hover theme-text-tertiary"
                                        title="Cancel">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Extraction status -->
                <div>
                    <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">JD Extraction</label>
                    {% if has_jd_extraction %}
                    <span class="inline-flex items-center gap-1 text-green-600 dark:text-green-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Complete
                    </span>
                    {% else %}
                    <span class="theme-text-muted">Not extracted</span>
                    {% endif %}
                </div>

                <!-- Research status -->
                <div>
                    <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Company Research</label>
                    {% if job.company_research %}
                    <span class="inline-flex items-center gap-1 text-green-600 dark:text-green-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Complete
                    </span>
                    {% else %}
                    <span class="theme-text-muted">Not researched</span>
                    {% endif %}
                </div>

                <!-- Planned answers count -->
                <div>
                    <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Planned Answers</label>
                    {% set answer_count = (job.planned_answers | length) if job.planned_answers else 0 %}
                    {% if answer_count > 0 %}
                    <span class="theme-text-primary">{{ answer_count }} answers</span>
                    {% else %}
                    <span class="theme-text-muted">None</span>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="md:col-span-2 lg:col-span-3 pt-2 border-t theme-border mt-2">
                    <label class="block text-xs font-medium theme-text-tertiary uppercase mb-2">Actions</label>
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- View Logs Button -->
                        <button @click="$store.cli.showJobLogs('{{ job._id }}', '{{ (job.title or '') | e | replace("'", "\\'") }}')"
                                class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md transition
                                       text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500"
                                title="View pipeline logs for this job">
                            <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            View Logs
                        </button>

                        <!-- Scrape & Fill Button -->
                        <button onclick="scrapeAndFillJob('{{ job._id }}', '{{ (job.title or '') | e | replace("'", "\\'") }}')"
                                class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md transition
                                       {% if app_url %}text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500
                                       {% else %}text-gray-400 bg-gray-200 dark:bg-gray-700 cursor-not-allowed{% endif %}"
                                {% if not app_url %}disabled title="Application URL required"{% else %}title="Scrape application form and generate answers"{% endif %}>
                            <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                            Scrape & Fill
                        </button>
                        {% if not app_url %}
                        <span class="text-xs theme-text-muted">(Set application URL above to enable)</span>
                        {% endif %}
                    </div>
                </div>
                </div> <!-- Close grid -->
            </div> <!-- Close overflow wrapper -->
        </td>
    </tr>
</tbody>
