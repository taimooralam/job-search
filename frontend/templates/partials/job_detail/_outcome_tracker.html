{# Outcome Tracker - Phase 7 #}
{# Compact status badge + dropdown in Status & Actions section #}
{# This partial should be included within the Status & Actions section of job_detail.html #}

{% set outcome = job.application_outcome or {'status': 'not_applied', 'interview_rounds': 0} %}

<div class="outcome-tracker flex flex-wrap items-center gap-4" data-job-id="{{ job._id }}" id="outcome-tracker">
    {# Application Outcome Status #}
    <div>
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Application Outcome</label>
        <div class="flex items-center gap-2">
            {# Status Badge #}
            <span id="outcome-badge" class="outcome-badge px-2 py-1 text-xs font-medium rounded-full
                {% if outcome.status == 'offer_received' or outcome.status == 'offer_accepted' %}bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-400
                {% elif outcome.status == 'interviewing' or outcome.status == 'interview_scheduled' %}bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-400
                {% elif outcome.status == 'response_received' or outcome.status == 'screening_scheduled' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-400
                {% elif outcome.status == 'applied' %}bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-400
                {% elif outcome.status == 'rejected' %}bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-400
                {% elif outcome.status == 'withdrawn' %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300
                {% else %}bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400{% endif %}">
                {{ outcome.status | replace('_', ' ') | title }}
            </span>

            {# Status Dropdown #}
            <select id="outcome-status-select"
                    class="form-select text-xs py-1 px-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                    onchange="updateOutcomeStatus('{{ job._id }}', this.value)">
                <option value="not_applied" {% if outcome.status == 'not_applied' %}selected{% endif %}>Not Applied</option>
                <option value="applied" {% if outcome.status == 'applied' %}selected{% endif %}>Applied</option>
                <option value="response_received" {% if outcome.status == 'response_received' %}selected{% endif %}>Response Received</option>
                <option value="screening_scheduled" {% if outcome.status == 'screening_scheduled' %}selected{% endif %}>Screening Scheduled</option>
                <option value="interview_scheduled" {% if outcome.status == 'interview_scheduled' %}selected{% endif %}>Interview Scheduled</option>
                <option value="interviewing" {% if outcome.status == 'interviewing' %}selected{% endif %}>Interviewing</option>
                <option value="offer_received" {% if outcome.status == 'offer_received' %}selected{% endif %}>Offer Received</option>
                <option value="offer_accepted" {% if outcome.status == 'offer_accepted' %}selected{% endif %}>Offer Accepted</option>
                <option value="rejected" {% if outcome.status == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="withdrawn" {% if outcome.status == 'withdrawn' %}selected{% endif %}>Withdrawn</option>
            </select>
        </div>
    </div>

    {# Applied Via (shown when status >= applied) #}
    <div id="applied-via-container" class="{% if outcome.status == 'not_applied' %}hidden{% endif %}">
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Applied Via</label>
        <select id="applied-via-select"
                class="form-select text-xs py-1 px-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                onchange="updateOutcomeField('{{ job._id }}', 'applied_via', this.value)">
            <option value="" {% if not outcome.applied_via %}selected{% endif %}>Select...</option>
            <option value="linkedin" {% if outcome.applied_via == 'linkedin' %}selected{% endif %}>LinkedIn</option>
            <option value="website" {% if outcome.applied_via == 'website' %}selected{% endif %}>Company Website</option>
            <option value="email" {% if outcome.applied_via == 'email' %}selected{% endif %}>Email</option>
            <option value="referral" {% if outcome.applied_via == 'referral' %}selected{% endif %}>Referral</option>
            <option value="other" {% if outcome.applied_via == 'other' %}selected{% endif %}>Other</option>
        </select>
    </div>

    {# Interview Rounds (shown when interviewing/offer) #}
    <div id="interview-rounds-container" class="{% if outcome.status not in ['interview_scheduled', 'interviewing', 'offer_received', 'offer_accepted'] %}hidden{% endif %}">
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Interview Rounds</label>
        <input type="number" min="0" max="10"
               id="interview-rounds-input"
               class="form-input text-xs w-16 py-1 px-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"
               value="{{ outcome.interview_rounds or 0 }}"
               onchange="updateOutcomeField('{{ job._id }}', 'interview_rounds', parseInt(this.value))">
    </div>

    {# Response Type (shown when response received) #}
    <div id="response-type-container" class="{% if outcome.status not in ['response_received', 'screening_scheduled', 'interview_scheduled', 'interviewing', 'offer_received', 'offer_accepted', 'rejected'] %}hidden{% endif %}">
        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Response Type</label>
        <select id="response-type-select"
                class="form-select text-xs py-1 px-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300"
                onchange="updateOutcomeField('{{ job._id }}', 'response_type', this.value)">
            <option value="" {% if not outcome.response_type %}selected{% endif %}>Select...</option>
            <option value="interest" {% if outcome.response_type == 'interest' %}selected{% endif %}>Interest</option>
            <option value="screening" {% if outcome.response_type == 'screening' %}selected{% endif %}>Screening Request</option>
            <option value="rejection" {% if outcome.response_type == 'rejection' %}selected{% endif %}>Rejection</option>
            <option value="followup" {% if outcome.response_type == 'followup' %}selected{% endif %}>Follow-up Questions</option>
        </select>
    </div>

    {# Timeline Summary (shown when there's data) #}
    {% if outcome.applied_at or outcome.response_at or outcome.interview_at %}
    <div class="ml-auto text-xs text-gray-500 dark:text-gray-400">
        <div class="flex items-center gap-3">
            {% if outcome.applied_at %}
            <span title="Applied on {{ outcome.applied_at[:10] }}">
                <svg class="inline h-3 w-3 mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                </svg>
                {{ outcome.applied_at[:10] }}
            </span>
            {% endif %}
            {% if outcome.days_to_response is defined and outcome.days_to_response is not none %}
            <span class="text-yellow-600 dark:text-yellow-400" title="Days to response">
                {{ outcome.days_to_response }}d to response
            </span>
            {% endif %}
            {% if outcome.days_to_interview is defined and outcome.days_to_interview is not none %}
            <span class="text-blue-600 dark:text-blue-400" title="Days to interview">
                {{ outcome.days_to_interview }}d to interview
            </span>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{# Outcome Notes (collapsible, shown when there's an outcome) #}
{% if outcome.status != 'not_applied' %}
<div class="mt-3">
    <details class="group">
        <summary class="cursor-pointer text-xs font-medium text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-300 flex items-center">
            <svg class="h-3 w-3 mr-1 transform group-open:rotate-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
            Outcome Notes
            {% if outcome.notes %}
            <span class="ml-2 px-1.5 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 rounded">Has notes</span>
            {% endif %}
        </summary>
        <div class="mt-2">
            <textarea id="outcome-notes"
                      class="w-full text-sm p-2 border border-gray-300 dark:border-gray-600 rounded resize-none bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-indigo-500"
                      rows="2"
                      placeholder="Add notes about this application outcome..."
                      onblur="updateOutcomeField('{{ job._id }}', 'notes', this.value)">{{ outcome.notes or '' }}</textarea>
        </div>
    </details>
</div>
{% endif %}

{# Offer Details (shown when offer received/accepted) #}
{% if outcome.status in ['offer_received', 'offer_accepted'] %}
<div class="mt-3 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
    <label class="block text-xs font-medium text-green-700 dark:text-green-400 mb-1">Offer Details</label>
    <textarea id="offer-details"
              class="w-full text-sm p-2 border border-green-300 dark:border-green-700 rounded resize-none bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-green-500"
              rows="2"
              placeholder="Enter offer details (compensation, start date, etc.)..."
              onblur="updateOutcomeField('{{ job._id }}', 'offer_details', this.value)">{{ outcome.offer_details or '' }}</textarea>
</div>
{% endif %}
