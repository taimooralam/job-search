{# CV Editor sidebar content - Batch Page #}
{# Uses unified CV editor component in sidebar mode #}
{# Loaded via HTMX/fetch when CV sidebar is opened #}

{% set mode = 'sidebar' %}
{% set id_prefix = 'batch-' %}
{% set show_overlay = false %}
{% set show_close_button = false %}
{% set show_panel_toggle = false %}
{% set show_job_info = true %}
{% set compact_toolbar = true %}

{% include 'components/cv_editor.html' %}

{# Batch-specific JavaScript for save indicator and toolbar state updates #}
{# These functions are called from batch-sidebars.js via the CVEditor class overrides #}
<script>
/**
 * Update save indicator in batch CV sidebar
 * Called from CVEditor.updateSaveIndicator override in batch-sidebars.js
 */
function updateBatchCVSaveIndicator(status) {
    const indicator = document.getElementById('batch-cv-save-indicator');
    if (!indicator) return;

    indicator.classList.remove('hidden');

    const states = {
        unsaved: { icon: '\u25CB', text: 'Unsaved', class: 'text-gray-500' },
        saving: { icon: '\u25D0', text: 'Saving...', class: 'text-blue-500 animate-pulse' },
        saved: { icon: '\u25CF', text: 'Saved', class: 'text-green-500' },
        error: { icon: '\u26A0', text: 'Error', class: 'text-red-500' }
    };

    const state = states[status] || states.saved;
    indicator.innerHTML = '<span class="' + state.class + '">' + state.icon + ' ' + state.text + '</span>';
}

/**
 * Update toolbar button states based on current selection
 * Called from CVEditor.updateToolbarState override in batch-sidebars.js
 */
function updateBatchCVToolbarState() {
    if (!batchCVEditorInstance || !batchCVEditorInstance.editor) return;

    const editor = batchCVEditorInstance.editor;

    // Update alignment buttons (including justify)
    const alignments = ['left', 'center', 'right', 'justify'];
    alignments.forEach(function(align) {
        const btn = document.querySelector('#batch-cv-content button[data-align="' + align + '"]');
        if (btn) {
            const isActive = editor.isActive({ textAlign: align });
            btn.classList.toggle('bg-indigo-100', isActive);
            btn.classList.toggle('dark:bg-indigo-900', isActive);
            btn.setAttribute('aria-pressed', isActive.toString());
        }
    });

    // Update formatting buttons (including smallCaps)
    ['bold', 'italic', 'underline', 'bulletList', 'orderedList', 'smallCaps'].forEach(function(format) {
        const btn = document.querySelector('#batch-cv-content button[data-format="' + format + '"]');
        if (btn) {
            const isActive = editor.isActive(format);
            btn.classList.toggle('bg-gray-300', isActive);
            btn.classList.toggle('dark:bg-gray-600', isActive);
            btn.setAttribute('aria-pressed', isActive.toString());
        }
    });

    // Update heading buttons
    [1, 2, 3].forEach(function(level) {
        const btn = document.querySelector('#batch-cv-content button[data-heading="' + level + '"]');
        if (btn) {
            const isActive = editor.isActive('heading', { level: level });
            btn.classList.toggle('bg-gray-300', isActive);
            btn.classList.toggle('dark:bg-gray-600', isActive);
            btn.setAttribute('aria-pressed', isActive.toString());
        }
    });

    // Update undo/redo buttons
    const undoBtn = document.getElementById('batch-cv-undo-btn');
    const redoBtn = document.getElementById('batch-cv-redo-btn');

    if (undoBtn) {
        const canUndo = editor.can().undo();
        undoBtn.disabled = !canUndo;
    }

    if (redoBtn) {
        const canRedo = editor.can().redo();
        redoBtn.disabled = !canRedo;
    }
}

/**
 * Apply document-level styles (line height, margins, page size, header/footer)
 * Called from toolbar controls in the sidebar
 */
function applyBatchDocumentStyle(styleType) {
    if (!batchCVEditorInstance) return;

    const container = document.getElementById('batch-cv-editor-content');
    if (!container) return;

    switch (styleType) {
        case 'lineHeight':
            var lineHeightSelect = document.getElementById('batch-cv-line-height');
            if (lineHeightSelect) {
                container.style.lineHeight = lineHeightSelect.value;
                if (batchCVEditorInstance.documentStyles) {
                    batchCVEditorInstance.documentStyles.lineHeight = lineHeightSelect.value;
                }
            }
            break;

        case 'margins':
            var marginTop = (document.getElementById('batch-cv-margin-top') || {}).value || '0.5';
            var marginRight = (document.getElementById('batch-cv-margin-right') || {}).value || '0.5';
            var marginBottom = (document.getElementById('batch-cv-margin-bottom') || {}).value || '0.5';
            var marginLeft = (document.getElementById('batch-cv-margin-left') || {}).value || '0.5';
            container.style.padding = marginTop + 'in ' + marginRight + 'in ' + marginBottom + 'in ' + marginLeft + 'in';
            if (batchCVEditorInstance.documentStyles) {
                batchCVEditorInstance.documentStyles.margins = {
                    top: marginTop, right: marginRight, bottom: marginBottom, left: marginLeft
                };
            }
            break;

        case 'pageSize':
            var pageSizeSelect = document.getElementById('batch-cv-page-size');
            if (pageSizeSelect) {
                var pageSize = pageSizeSelect.value;
                if (pageSize === 'letter') {
                    container.style.maxWidth = '8.5in';
                    container.style.minHeight = '11in';
                } else if (pageSize === 'a4') {
                    container.style.maxWidth = '210mm';
                    container.style.minHeight = '297mm';
                }
                if (batchCVEditorInstance.documentStyles) {
                    batchCVEditorInstance.documentStyles.pageSize = pageSize;
                }
            }
            break;

        case 'header':
        case 'footer':
            var headerText = (document.getElementById('batch-cv-header-text') || {}).value || '';
            var footerText = (document.getElementById('batch-cv-footer-text') || {}).value || '';
            if (batchCVEditorInstance.documentStyles) {
                batchCVEditorInstance.documentStyles.header = headerText;
                batchCVEditorInstance.documentStyles.footer = footerText;
            }
            break;
    }

    // Trigger auto-save
    if (batchCVEditorInstance && typeof batchCVEditorInstance.scheduleAutoSave === 'function') {
        batchCVEditorInstance.scheduleAutoSave();
    }
}

/**
 * Apply margin preset
 */
function applyBatchMarginPreset() {
    var presetSelect = document.getElementById('batch-cv-margin-preset');
    var customContainer = document.getElementById('batch-custom-margins-container');

    if (!presetSelect) return;

    var preset = presetSelect.value;
    var marginPresets = {
        normal: { top: '1.0', right: '1.0', bottom: '1.0', left: '1.0' },
        narrow: { top: '0.5', right: '0.5', bottom: '0.5', left: '0.5' },
        moderate: { top: '0.75', right: '0.75', bottom: '0.75', left: '0.75' },
        wide: { top: '1.5', right: '1.5', bottom: '1.5', left: '1.5' }
    };

    if (preset === 'custom') {
        // Show custom margin controls
        if (customContainer) customContainer.classList.remove('hidden');
    } else {
        // Hide custom margin controls and apply preset
        if (customContainer) customContainer.classList.add('hidden');

        var margins = marginPresets[preset];
        if (margins) {
            var topSelect = document.getElementById('batch-cv-margin-top');
            var rightSelect = document.getElementById('batch-cv-margin-right');
            var bottomSelect = document.getElementById('batch-cv-margin-bottom');
            var leftSelect = document.getElementById('batch-cv-margin-left');

            if (topSelect) topSelect.value = margins.top;
            if (rightSelect) rightSelect.value = margins.right;
            if (bottomSelect) bottomSelect.value = margins.bottom;
            if (leftSelect) leftSelect.value = margins.left;

            applyBatchDocumentStyle('margins');
        }
    }
}

/**
 * Update margin preset dropdown based on current margin values
 */
function updateBatchMarginPreset() {
    var presetSelect = document.getElementById('batch-cv-margin-preset');
    var topSelect = document.getElementById('batch-cv-margin-top');
    var rightSelect = document.getElementById('batch-cv-margin-right');
    var bottomSelect = document.getElementById('batch-cv-margin-bottom');
    var leftSelect = document.getElementById('batch-cv-margin-left');

    if (!presetSelect || !topSelect || !rightSelect || !bottomSelect || !leftSelect) return;

    var top = topSelect.value;
    var right = rightSelect.value;
    var bottom = bottomSelect.value;
    var left = leftSelect.value;

    // Check if margins match a preset
    if (top === '1.0' && right === '1.0' && bottom === '1.0' && left === '1.0') {
        presetSelect.value = 'normal';
    } else if (top === '0.5' && right === '0.5' && bottom === '0.5' && left === '0.5') {
        presetSelect.value = 'narrow';
    } else if (top === '0.75' && right === '0.75' && bottom === '0.75' && left === '0.75') {
        presetSelect.value = 'moderate';
    } else if (top === '1.5' && right === '1.5' && bottom === '1.5' && left === '1.5') {
        presetSelect.value = 'wide';
    } else {
        presetSelect.value = 'custom';
    }
}
</script>
