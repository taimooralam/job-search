{# Annotation sidebar content - loaded via HTMX/fetch #}
{# Displays JD with annotations in a read-only view #}

{% set annotations = job.jd_annotations.annotations if job.jd_annotations and job.jd_annotations.annotations else [] %}
{% set processed_jd_html = job.jd_annotations.processed_jd_html if job.jd_annotations else '' %}

<div class="flex flex-col lg:flex-row h-full">
    {# Left side: JD Content with highlights #}
    <div class="flex-1 lg:w-2/3 overflow-y-auto border-b lg:border-b-0 lg:border-r theme-border" style="overscroll-behavior: contain;">
        <div class="p-4 sm:p-6">
            {# Job info header #}
            <div class="pb-4 mb-4 border-b theme-border">
                <h3 class="font-semibold theme-text-primary text-lg">{{ job.title or 'Untitled Position' }}</h3>
                <p class="text-sm theme-text-secondary">{{ job.company or 'Unknown Company' }}</p>
                {% if job.location %}
                <p class="text-xs theme-text-tertiary mt-1">{{ job.location }}</p>
                {% endif %}
            </div>

            {# JD Content with annotation highlights #}
            {% if processed_jd_html %}
            <div id="batch-jd-content" class="prose prose-sm dark:prose-invert max-w-none jd-annotation-viewer">
                {{ processed_jd_html | safe }}
            </div>
            {% elif job.extracted_jd %}
            {# Fallback: show extracted JD sections #}
            <div class="space-y-4">
                {% if job.extracted_jd.responsibilities %}
                <div>
                    <h4 class="text-sm font-semibold theme-text-primary mb-2">Responsibilities</h4>
                    <ul class="list-disc list-inside text-sm theme-text-secondary space-y-1">
                        {% for item in job.extracted_jd.responsibilities %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if job.extracted_jd.qualifications %}
                <div>
                    <h4 class="text-sm font-semibold theme-text-primary mb-2">Qualifications</h4>
                    <ul class="list-disc list-inside text-sm theme-text-secondary space-y-1">
                        {% for item in job.extracted_jd.qualifications %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if job.extracted_jd.nice_to_haves %}
                <div>
                    <h4 class="text-sm font-semibold theme-text-primary mb-2">Nice to Have</h4>
                    <ul class="list-disc list-inside text-sm theme-text-secondary space-y-1">
                        {% for item in job.extracted_jd.nice_to_haves %}
                        <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <p class="theme-text-tertiary">No JD content available</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Right side: Annotation list #}
    <div class="lg:w-1/3 overflow-y-auto theme-bg-secondary" style="overscroll-behavior: contain;">
        <div class="p-4">
            <h4 class="text-xs font-semibold theme-text-tertiary uppercase tracking-wide mb-3 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
                Annotations ({{ annotations | length }})
            </h4>

            {% if annotations | length > 0 %}
            <div class="space-y-3">
                {% for annotation in annotations %}
                <div class="annotation-card p-3 rounded-lg border theme-border theme-bg-card hover:theme-bg-hover transition"
                     data-annotation-id="{{ annotation.id or loop.index0 }}">
                    {# Annotated text preview - text is nested in target.text #}
                    {% set ann_text = annotation.target.text if annotation.target and annotation.target.text else '' %}
                    <div class="text-sm theme-text-primary mb-2 line-clamp-2 font-medium">
                        "{{ ann_text[:100] }}{% if ann_text | length > 100 %}...{% endif %}"
                    </div>

                    {# Annotation metadata #}
                    <div class="flex flex-wrap gap-1.5 mb-2">
                        {# Relevance badge #}
                        {% if annotation.relevance %}
                        {% set relevance_colors = {
                            'critical': 'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300',
                            'important': 'bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300',
                            'nice-to-have': 'bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300',
                            'low': 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300'
                        } %}
                        <span class="px-1.5 py-0.5 text-[10px] font-medium rounded {{ relevance_colors.get(annotation.relevance, 'bg-gray-100 text-gray-600') }}">
                            {{ annotation.relevance | title }}
                        </span>
                        {% endif %}

                        {# Requirement type badge #}
                        {% if annotation.requirement_type %}
                        {% set type_colors = {
                            'must-have': 'bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300',
                            'nice-to-have': 'bg-teal-100 text-teal-700 dark:bg-teal-900/50 dark:text-teal-300',
                            'implied': 'bg-amber-100 text-amber-700 dark:bg-amber-900/50 dark:text-amber-300'
                        } %}
                        <span class="px-1.5 py-0.5 text-[10px] font-medium rounded {{ type_colors.get(annotation.requirement_type, 'bg-gray-100 text-gray-600') }}">
                            {{ annotation.requirement_type | replace('-', ' ') | title }}
                        </span>
                        {% endif %}

                        {# Passion indicator #}
                        {% if annotation.passion %}
                        <span class="px-1.5 py-0.5 text-[10px] font-medium rounded bg-pink-100 text-pink-700 dark:bg-pink-900/50 dark:text-pink-300 flex items-center gap-0.5">
                            <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            Passion
                        </span>
                        {% endif %}

                        {# Identity indicator #}
                        {% if annotation.identity %}
                        <span class="px-1.5 py-0.5 text-[10px] font-medium rounded bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300 flex items-center gap-0.5">
                            <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                            </svg>
                            Identity
                        </span>
                        {% endif %}
                    </div>

                    {# Notes preview #}
                    {% set strat_note = annotation.strategic_note or '' %}
                    {% if strat_note %}
                    <div class="text-xs theme-text-secondary mt-2 p-2 rounded bg-gray-50 dark:bg-gray-800/50">
                        <span class="font-medium">Strategy:</span> {{ strat_note[:80] }}{% if strat_note | length > 80 %}...{% endif %}
                    </div>
                    {% endif %}

                    {# STAR stories #}
                    {% if annotation.star_story_ids and annotation.star_story_ids | length > 0 %}
                    <div class="flex items-center gap-1 mt-2 text-xs theme-text-tertiary">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                        </svg>
                        {{ annotation.star_story_ids | length }} STAR {{ 'story' if annotation.star_story_ids | length == 1 else 'stories' }} linked
                    </div>
                    {% endif %}

                    {# ATS Keywords #}
                    {% if annotation.ats_keywords and annotation.ats_keywords | length > 0 %}
                    <div class="flex flex-wrap gap-1 mt-2">
                        {% for keyword in annotation.ats_keywords[:5] %}
                        <span class="px-1.5 py-0.5 text-[10px] bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-300 rounded">
                            {{ keyword }}
                        </span>
                        {% endfor %}
                        {% if annotation.ats_keywords | length > 5 %}
                        <span class="px-1.5 py-0.5 text-[10px] theme-text-tertiary">+{{ annotation.ats_keywords | length - 5 }} more</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-8">
                <svg class="h-12 w-12 mx-auto theme-text-tertiary mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                </svg>
                <p class="theme-text-secondary text-sm mb-1">No annotations yet</p>
                <p class="theme-text-tertiary text-xs">Open the full view to add annotations.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Styles for annotation highlights in JD content #}
<style>
.jd-annotation-viewer .annotation-highlight {
    background-color: rgba(251, 191, 36, 0.3);
    border-bottom: 2px solid rgb(251, 191, 36);
    cursor: default;
}
.jd-annotation-viewer .annotation-highlight.relevance-critical {
    background-color: rgba(239, 68, 68, 0.2);
    border-bottom-color: rgb(239, 68, 68);
}
.jd-annotation-viewer .annotation-highlight.relevance-important {
    background-color: rgba(249, 115, 22, 0.2);
    border-bottom-color: rgb(249, 115, 22);
}
.jd-annotation-viewer .annotation-highlight.passion {
    background-color: rgba(236, 72, 153, 0.2);
    border-bottom-color: rgb(236, 72, 153);
}
.jd-annotation-viewer .annotation-highlight.identity {
    background-color: rgba(99, 102, 241, 0.2);
    border-bottom-color: rgb(99, 102, 241);
}
</style>
