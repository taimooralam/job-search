{# Batch Annotation sidebar content - loaded via HTMX/fetch #}
{# Full interactive JD viewer with annotation capabilities #}
{# Mirrors job_detail/_jd_annotation_panel.html but uses batch-prefixed IDs #}

{% set annotations = job.jd_annotations.annotations if job.jd_annotations and job.jd_annotations.annotations else [] %}
{% set processed_jd_html = job.jd_annotations.processed_jd_html if job.jd_annotations else '' %}

<div class="flex flex-col h-full" data-job-id="{{ job._id }}">
    {# Toolbar - Quick Annotation Presets #}
    <div class="px-4 py-3 border-b theme-border theme-bg-secondary flex-shrink-0">
        <div class="flex flex-wrap items-center gap-2">
            <span class="text-xs font-medium theme-text-tertiary uppercase">Quick Add:</span>

            {# Relevance Presets #}
            <div class="flex gap-1" role="group" aria-label="Relevance presets">
                <button onclick="setQuickAnnotation('core_strength')"
                        class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800 hover:bg-green-200 transition border border-green-300 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700"
                        title="Core Strength (3.0x boost)">
                    Core
                </button>
                <button onclick="setQuickAnnotation('extremely_relevant')"
                        class="px-2 py-1 rounded text-xs font-medium bg-emerald-100 text-emerald-800 hover:bg-emerald-200 transition border border-emerald-300 dark:bg-emerald-900/50 dark:text-emerald-300 dark:border-emerald-700"
                        title="Extremely Relevant (2.0x)">
                    Strong
                </button>
                <button onclick="setQuickAnnotation('relevant')"
                        class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition border border-yellow-300 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-700"
                        title="Relevant (1.5x)">
                    Medium
                </button>
                <button onclick="setQuickAnnotation('tangential')"
                        class="px-2 py-1 rounded text-xs font-medium bg-orange-100 text-orange-800 hover:bg-orange-200 transition border border-orange-300 dark:bg-orange-900/50 dark:text-orange-300 dark:border-orange-700"
                        title="Tangential (1.0x)">
                    Weak
                </button>
                <button onclick="setQuickAnnotation('gap')"
                        class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800 hover:bg-red-200 transition border border-red-300 dark:bg-red-900/50 dark:text-red-300 dark:border-red-700"
                        title="Gap (0.3x penalty)">
                    Gap
                </button>
            </div>

            <div class="w-px h-6 theme-bg-tertiary hidden sm:block"></div>

            {# Requirement Type #}
            <div class="flex gap-1" role="group" aria-label="Requirement type">
                <button onclick="setRequirementType('must_have')"
                        class="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800 hover:bg-blue-200 transition border border-blue-300 dark:bg-blue-900/50 dark:text-blue-300 dark:border-blue-700"
                        title="Must-Have (1.5x multiplier)">
                    Must
                </button>
                <button onclick="setRequirementType('nice_to_have')"
                        class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700 hover:bg-gray-200 transition border border-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600"
                        title="Nice-to-Have (1.0x)">
                    Nice
                </button>
            </div>

            <div class="w-px h-6 theme-bg-tertiary hidden sm:block"></div>

            {# Passion Quick Add #}
            <div class="flex gap-1" role="group" aria-label="Passion level presets">
                <button onclick="setQuickPassion('love_it')"
                        class="px-2 py-1 rounded text-xs font-medium bg-pink-100 text-pink-800 hover:bg-pink-200 transition border border-pink-300 dark:bg-pink-900/50 dark:text-pink-300 dark:border-pink-700"
                        title="Love it - genuinely excited (1.5x boost)">
                    üî• Love
                </button>
                <button onclick="setQuickPassion('avoid')"
                        class="px-2 py-1 rounded text-xs font-medium bg-stone-100 text-stone-700 hover:bg-stone-200 transition border border-stone-300 dark:bg-stone-700 dark:text-stone-300 dark:border-stone-600"
                        title="Avoid - would prefer not to do (0.5x penalty)">
                    üö´ Avoid
                </button>
            </div>

            <div class="w-px h-6 theme-bg-tertiary hidden sm:block"></div>

            {# Identity Quick Add #}
            <div class="flex gap-1" role="group" aria-label="Identity level presets">
                <button onclick="setQuickIdentity('core_identity')"
                        class="px-2 py-1 rounded text-xs font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200 transition border border-indigo-300 dark:bg-indigo-900/50 dark:text-indigo-300 dark:border-indigo-700"
                        title="Core Identity - this IS who I am (2.0x boost)">
                    ‚≠ê Core ID
                </button>
                <button onclick="setQuickIdentity('not_identity')"
                        class="px-2 py-1 rounded text-xs font-medium bg-zinc-100 text-zinc-700 hover:bg-zinc-200 transition border border-zinc-300 dark:bg-zinc-700 dark:text-zinc-300 dark:border-zinc-600"
                        title="Not Me - NOT how I want to be seen (0.3x penalty)">
                    ‚úó Not Me
                </button>
            </div>
        </div>
    </div>

    {# Main Content Area - Split View #}
    <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
        {# Left: JD Viewer (with text selection for annotation) #}
        <div class="flex-1 lg:w-2/3 overflow-y-auto theme-bg-tertiary" style="overscroll-behavior: contain;">
            <div id="batch-jd-viewer-content"
                 class="theme-bg-card border theme-border rounded-lg shadow-inner m-4 p-6 min-h-full prose prose-sm dark:prose-invert max-w-none"
                 style="font-family: 'Inter', sans-serif; font-size: 14px; line-height: 1.6;">
                {# Loading state #}
                <div id="batch-jd-loading" class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <svg class="animate-spin h-8 w-8 mx-auto text-accent-500 mb-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="theme-text-secondary">Loading job description...</p>
                        <p class="text-xs theme-text-tertiary mt-2">Select text to create annotations</p>
                    </div>
                </div>

                {# Empty state #}
                <div id="batch-jd-empty" class="hidden text-center py-12">
                    <svg class="h-12 w-12 mx-auto theme-text-tertiary mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p class="theme-text-secondary">Job description not available</p>
                    <p class="text-xs theme-text-tertiary mt-2">Process the JD from the job detail page first</p>
                </div>

                {# Processed JD content (rendered by AnnotationManager) #}
                <div id="batch-jd-processed-content" class="hidden">
                    {# Content will be loaded by JavaScript #}
                </div>
            </div>
        </div>

        {# Right: Annotation List Sidebar #}
        <div class="lg:w-1/3 border-t lg:border-t-0 lg:border-l theme-border theme-bg-card overflow-y-auto" style="overscroll-behavior: contain;">
            <div class="flex flex-col h-full">
                {# Header #}
                <div class="px-4 py-3 border-b theme-border theme-bg-secondary flex-shrink-0">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold theme-text-primary">Annotations</h3>
                        <span id="batch-annotation-list-count" class="text-xs theme-text-tertiary bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded-full">{{ annotations | length }}</span>
                    </div>

                    {# Filter Controls #}
                    <div class="flex flex-wrap gap-1">
                        <button onclick="filterAnnotations('all')"
                                data-filter="all"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-accent-100 text-accent-800 dark:bg-accent-900/50 dark:text-accent-300 transition">
                            All
                        </button>
                        <button onclick="filterAnnotations('core_strength')"
                                data-filter="core_strength"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-green-50 hover:text-green-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-green-900/30 transition">
                            Core
                        </button>
                        <button onclick="filterAnnotations('gap')"
                                data-filter="gap"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-red-900/30 transition">
                            Gaps
                        </button>
                        <button onclick="filterAnnotations('must_have')"
                                data-filter="must_have"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-blue-50 hover:text-blue-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-blue-900/30 transition">
                            Must-Have
                        </button>
                        <button onclick="filterAnnotations('active')"
                                data-filter="active"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-green-50 hover:text-green-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-green-900/30 transition">
                            Active
                        </button>
                    </div>
                    {# Passion & Identity Filters #}
                    <div class="flex flex-wrap gap-1 mt-2">
                        <span class="text-xs theme-text-tertiary mr-1">Passion:</span>
                        <button onclick="filterAnnotations('love_it')"
                                data-filter="love_it"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-pink-50 hover:text-pink-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-pink-900/30 transition"
                                title="Filter by 'Love it' passion">
                            üî•
                        </button>
                        <button onclick="filterAnnotations('avoid')"
                                data-filter="avoid"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-stone-50 hover:text-stone-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-stone-900/30 transition"
                                title="Filter by 'Avoid' passion">
                            üö´
                        </button>
                        <span class="text-xs theme-text-tertiary mx-1">|</span>
                        <span class="text-xs theme-text-tertiary mr-1">Identity:</span>
                        <button onclick="filterAnnotations('core_identity')"
                                data-filter="core_identity"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-indigo-50 hover:text-indigo-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-indigo-900/30 transition"
                                title="Filter by 'Core Identity'">
                            ‚≠ê
                        </button>
                        <button onclick="filterAnnotations('not_identity')"
                                data-filter="not_identity"
                                class="annotation-filter-btn px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600 hover:bg-zinc-50 hover:text-zinc-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-zinc-900/30 transition"
                                title="Filter by 'Not Me'">
                            ‚úó
                        </button>
                    </div>
                </div>

                {# Annotation List #}
                <div id="batch-annotation-list" class="flex-1 overflow-y-auto">
                    {# Empty State #}
                    <div id="batch-annotation-list-empty" class="{% if annotations | length > 0 %}hidden{% endif %} flex flex-col items-center justify-center py-12 px-4 text-center">
                        <svg class="h-12 w-12 theme-text-tertiary mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                        </svg>
                        <p class="text-sm theme-text-secondary mb-1">No annotations yet</p>
                        <p class="text-xs theme-text-tertiary">Select text in the JD to create annotations</p>
                    </div>

                    {# Annotation Items Container (populated by JS) #}
                    <div id="batch-annotation-items" class="divide-y divide-gray-100 dark:divide-gray-700">
                        {# Annotations will be rendered here by AnnotationManager #}
                    </div>
                </div>

                {# Footer Stats #}
                <div class="px-4 py-3 border-t theme-border theme-bg-secondary flex-shrink-0">
                    <div class="flex items-center justify-between text-xs theme-text-tertiary">
                        <span id="batch-annotation-count">{{ annotations | length }} annotations</span>
                        <span id="batch-active-annotation-count">{{ annotations | selectattr('is_active', 'true') | list | length if annotations else 0 }} active</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Persona Panel - Shows synthesized persona from identity annotations #}
    <div id="batch-persona-panel-container" class="px-4 py-3 border-t theme-border flex-shrink-0">
        {# Content rendered by JS based on identity annotations #}
    </div>
</div>

{# Styles for annotation highlights in JD content #}
<style>
/* Annotation highlight colors matching jd-annotation.css */
#batch-jd-processed-content .annotation-highlight {
    cursor: pointer;
    border-radius: 2px;
    padding: 1px 0;
    transition: background-color 0.2s ease;
}

#batch-jd-processed-content .annotation-highlight-core_strength {
    background-color: rgba(34, 197, 94, 0.3);
    border-bottom: 2px solid rgb(34, 197, 94);
}

#batch-jd-processed-content .annotation-highlight-extremely_relevant {
    background-color: rgba(16, 185, 129, 0.3);
    border-bottom: 2px solid rgb(16, 185, 129);
}

#batch-jd-processed-content .annotation-highlight-relevant {
    background-color: rgba(234, 179, 8, 0.3);
    border-bottom: 2px solid rgb(234, 179, 8);
}

#batch-jd-processed-content .annotation-highlight-tangential {
    background-color: rgba(249, 115, 22, 0.3);
    border-bottom: 2px solid rgb(249, 115, 22);
}

#batch-jd-processed-content .annotation-highlight-gap {
    background-color: rgba(239, 68, 68, 0.3);
    border-bottom: 2px solid rgb(239, 68, 68);
}

#batch-jd-processed-content .annotation-highlight:hover {
    filter: brightness(0.95);
}

#batch-jd-processed-content .annotation-highlight-pulse {
    animation: annotation-pulse 1.5s ease-in-out;
}

@keyframes annotation-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); }
}

/* Raw JD styling for pre-processed content */
#batch-jd-processed-content .raw-jd-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Annotation list item styles */
#batch-annotation-items .annotation-item {
    cursor: pointer;
    transition: background-color 0.15s ease;
}

#batch-annotation-items .annotation-item:hover {
    background-color: var(--color-bg-hover, rgba(0, 0, 0, 0.05));
}

#batch-annotation-items .annotation-item.selected {
    background-color: var(--color-bg-selected, rgba(99, 102, 241, 0.1));
    border-left: 3px solid var(--color-accent-500, rgb(99, 102, 241));
}
</style>
