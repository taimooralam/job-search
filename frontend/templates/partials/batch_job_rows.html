<!-- Batch processing job table rows with expandable details -->
<table class="min-w-full theme-table">
    <thead class="sticky-header">
        <tr>
            <!-- Expand toggle -->
            <th scope="col" class="px-2 py-3 w-8"></th>

            <!-- Select checkbox -->
            <th scope="col" class="px-2 py-3 w-10">
                <input type="checkbox"
                       id="batch-select-all-header"
                       onchange="toggleBatchSelectAll(this)"
                       class="h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500">
            </th>

            {% set sort_fields = [
                ('company', 'Company'),
                ('title', 'Role'),
                ('score', 'Score'),
                ('batch_added_at', 'Added'),
            ] %}

            {% for field, label in sort_fields %}
            {% set is_active = current_sort == field %}
            {% set new_direction = 'asc' if (is_active and current_direction == 'desc') else 'desc' %}
            <th scope="col"
                class="px-2 sm:px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider cursor-pointer hover:theme-bg-hover {{ 'sort-active' if is_active }}"
                hx-get="/partials/batch-job-rows?sort={{ field }}&direction={{ new_direction }}"
                hx-target="#batch-table-container"
                hx-indicator=".htmx-indicator">
                <div class="flex items-center gap-1">
                    {{ label }}
                    <span class="sort-icon">
                        {% if is_active %}
                            {% if current_direction == 'desc' %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            {% else %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                            {% endif %}
                        {% else %}
                            <svg class="h-4 w-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                            </svg>
                        {% endif %}
                    </span>
                </div>
            </th>
            {% endfor %}

            <!-- Status column -->
            <th scope="col" class="px-2 sm:px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider">
                Status
            </th>

            <!-- Progress indicators column -->
            <th scope="col" class="px-2 sm:px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider">
                Progress
            </th>

            <!-- Actions column -->
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider">
                Actions
            </th>
        </tr>
    </thead>
    {% if jobs %}
        {% for job in jobs %}
        {% set job_url = job.url or job.jobUrl %}
        {% set app_url = job.application_url or job_url %}
        <tbody x-data="{ expanded: false }" class="theme-bg-card">
            <!-- Main row -->
            <tr class="job-row hover:theme-bg-hover border-b theme-border"
                :class="{ 'theme-bg-hover': expanded }"
                data-job-id="{{ job._id }}">
                <!-- Expand toggle -->
                <td class="px-2 py-3 no-navigate" onclick="event.stopPropagation()">
                    <button @click="expanded = !expanded"
                            class="p-1 rounded hover:theme-bg-tertiary transition-transform duration-200"
                            :class="{ 'rotate-90': expanded }">
                        <svg class="w-4 h-4 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </td>

                <!-- Checkbox -->
                <td class="px-2 py-3 no-navigate" onclick="event.stopPropagation()">
                    <input type="checkbox"
                           class="batch-row-checkbox h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500"
                           data-job-id="{{ job._id }}"
                           onchange="toggleBatchRowSelection(this)">
                </td>

                <!-- Company -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap cursor-pointer"
                    onclick="navigateToBatchJob(event, '{{ job._id }}')">
                    <div class="text-sm font-medium theme-text-primary">
                        {{ job.company or '-' }}
                    </div>
                </td>

                <!-- Role/Title -->
                <td class="px-2 sm:px-4 py-3 cursor-pointer"
                    onclick="navigateToBatchJob(event, '{{ job._id }}')">
                    <div class="text-sm theme-text-primary max-w-[200px] truncate" title="{{ job.title or '' }}">
                        {% if job_url %}
                        <a href="{{ job_url }}" target="_blank"
                           class="text-accent-500 hover:text-accent-400 hover:underline no-navigate"
                           onclick="event.stopPropagation()">
                            {{ job.title or '-' }}
                        </a>
                        {% else %}
                        {{ job.title or '-' }}
                        {% endif %}
                    </div>
                </td>

                <!-- Score -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm">
                    {% if job.score is not none %}
                        {% if job.score >= 80 %}
                        <span class="px-2 py-1 rounded-full text-xs font-medium badge-success">{{ job.score }}</span>
                        {% elif job.score >= 60 %}
                        <span class="px-2 py-1 rounded-full text-xs font-medium badge-warning">{{ job.score }}</span>
                        {% else %}
                        <span class="px-2 py-1 rounded-full text-xs font-medium badge-gray">{{ job.score }}</span>
                        {% endif %}
                    {% else %}
                        <span class="px-2 py-1 rounded-full text-xs font-medium badge-gray">â€”</span>
                    {% endif %}
                </td>

                <!-- Added to batch -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm theme-text-secondary">
                    {% if job.batch_added_at %}
                        {{ job.batch_added_at.strftime('%m/%d %H:%M') if job.batch_added_at is not string else job.batch_added_at[:16] }}
                    {% elif job.createdAt %}
                        {{ job.createdAt[:10] }}
                    {% else %}
                        <span class="theme-text-muted">-</span>
                    {% endif %}
                </td>

                <!-- Status dropdown -->
                <td class="px-4 py-3 whitespace-nowrap no-navigate" onclick="event.stopPropagation()">
                    {% set status = job.status or 'not processed' %}
                    {% set status_class = status | replace(' ', '-') %}
                    <select class="text-xs px-2 py-1 rounded-full border-0 cursor-pointer status-{{ status_class }}"
                            onchange="updateBatchJobStatus('{{ job._id }}', this.value)"
                            style="min-width: 130px;">
                        {% for s in statuses %}
                        <option value="{{ s }}" {{ 'selected' if status == s else '' }}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </td>

                <!-- Progress indicators -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap no-navigate" onclick="event.stopPropagation()">
                    <div class="flex items-center gap-1.5">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs
                                     {% if job.processed_jd %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300
                                     {% else %}bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500{% endif %}"
                              title="JD {{ 'Extracted' if job.processed_jd else 'Not extracted' }}">
                            JD
                        </span>
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs
                                     {% if job.company_research %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300
                                     {% else %}bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500{% endif %}"
                              title="Research {{ 'Complete' if job.company_research else 'Not done' }}">
                            RS
                        </span>
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs
                                     {% if job.generated_cv %}bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300
                                     {% else %}bg-gray-100 text-gray-400 dark:bg-gray-700 dark:text-gray-500{% endif %}"
                              title="CV {{ 'Generated' if job.generated_cv else 'Not generated' }}">
                            CV
                        </span>
                    </div>
                </td>

                <!-- Actions -->
                <td class="px-4 py-3 whitespace-nowrap text-sm no-navigate" onclick="event.stopPropagation()">
                    <div class="flex items-center gap-2">
                        {% if job_url %}
                        <a href="{{ job_url }}" target="_blank"
                           class="text-accent-500 hover:text-accent-400"
                           title="Open job posting">
                            <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </a>
                        {% endif %}
                        <a href="/job/{{ job._id }}"
                           class="theme-text-secondary hover:text-accent-400"
                           title="View details">
                            <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </a>
                        <button onclick="processSingleBatchJob('{{ job._id }}')"
                                class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"
                                title="Process job through pipeline">
                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>

            <!-- Expandable details row -->
            <tr x-show="expanded" x-collapse.duration.200ms class="theme-bg-secondary border-b theme-border">
                <td colspan="9" class="px-4 py-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                        <!-- Location -->
                        <div>
                            <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Location</label>
                            <span class="theme-text-primary">{{ job.location or 'Not specified' }}</span>
                        </div>

                        <!-- Application URL (editable) -->
                        <div class="md:col-span-2" x-data="{ editing: false, url: '{{ (app_url or '') | e }}' }">
                            <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Application URL</label>
                            <div class="flex items-center gap-2">
                                <template x-if="!editing">
                                    <div class="flex items-center gap-2 flex-1 min-w-0">
                                        {% if app_url %}
                                        <a :href="url" target="_blank"
                                           class="text-accent-500 hover:text-accent-400 truncate max-w-md"
                                           x-text="url || 'Not set'"></a>
                                        {% else %}
                                        <span class="theme-text-muted">Not set</span>
                                        {% endif %}
                                        <button @click="editing = true"
                                                class="p-1 rounded hover:theme-bg-hover theme-text-tertiary hover:theme-text-primary"
                                                title="Edit URL">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                <template x-if="editing">
                                    <div class="flex items-center gap-2 flex-1">
                                        <input type="url"
                                               x-model="url"
                                               class="flex-1 px-2 py-1 text-sm rounded border theme-border theme-bg-card theme-text-primary focus:ring-2 focus:ring-accent-500"
                                               placeholder="https://..."
                                               @keydown.enter="saveBatchJobUrl('{{ job._id }}', url); editing = false"
                                               @keydown.escape="editing = false">
                                        <button @click="saveBatchJobUrl('{{ job._id }}', url); editing = false"
                                                class="p-1 rounded bg-green-600 hover:bg-green-700 text-white"
                                                title="Save">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </button>
                                        <button @click="editing = false"
                                                class="p-1 rounded hover:theme-bg-hover theme-text-tertiary"
                                                title="Cancel">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Extraction status -->
                        <div>
                            <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">JD Extraction</label>
                            {% if job.processed_jd %}
                            <span class="inline-flex items-center gap-1 text-green-600 dark:text-green-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Complete
                            </span>
                            {% else %}
                            <span class="theme-text-muted">Not extracted</span>
                            {% endif %}
                        </div>

                        <!-- Research status -->
                        <div>
                            <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Company Research</label>
                            {% if job.company_research %}
                            <span class="inline-flex items-center gap-1 text-green-600 dark:text-green-400">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Complete
                            </span>
                            {% else %}
                            <span class="theme-text-muted">Not researched</span>
                            {% endif %}
                        </div>

                        <!-- Planned answers count -->
                        <div>
                            <label class="block text-xs font-medium theme-text-tertiary uppercase mb-1">Planned Answers</label>
                            {% set answer_count = (job.planned_answers | length) if job.planned_answers else 0 %}
                            {% if answer_count > 0 %}
                            <span class="theme-text-primary">{{ answer_count }} answers</span>
                            {% else %}
                            <span class="theme-text-muted">None</span>
                            {% endif %}
                        </div>

                        <!-- Scrape & Fill Action -->
                        <div class="md:col-span-2 lg:col-span-3 pt-2 border-t theme-border mt-2">
                            <label class="block text-xs font-medium theme-text-tertiary uppercase mb-2">Application Form Actions</label>
                            <div class="flex items-center gap-3">
                                <button onclick="scrapeAndFillJob('{{ job._id }}', '{{ (job.title or '') | e | replace("'", "\\'") }}')"
                                        class="inline-flex items-center px-3 py-1.5 text-sm font-medium rounded-md transition
                                               {% if app_url %}text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500
                                               {% else %}text-gray-400 bg-gray-200 dark:bg-gray-700 cursor-not-allowed{% endif %}"
                                        {% if not app_url %}disabled title="Application URL required"{% else %}title="Scrape application form and generate answers"{% endif %}>
                                    <svg class="h-4 w-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                                    </svg>
                                    Scrape & Fill
                                </button>
                                {% if not app_url %}
                                <span class="text-xs theme-text-muted">(Set application URL above to enable)</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
        {% endfor %}
    {% else %}
        <tbody class="theme-bg-card">
            <tr>
                <td colspan="9" class="px-4 py-12 text-center">
                    <svg class="mx-auto h-12 w-12 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium theme-text-primary">No jobs in batch queue</h3>
                    <p class="mt-1 text-sm theme-text-secondary">
                        Select jobs from the main page and click "Move to Batch" to add them here.
                    </p>
                    <a href="/" class="mt-4 inline-flex items-center btn btn-primary btn-md">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                        </svg>
                        Go to Jobs
                    </a>
                </td>
            </tr>
        </tbody>
    {% endif %}
</table>

<script>
    // Scrape & Fill job application form
    async function scrapeAndFillJob(jobId, jobTitle) {
        const confirmed = confirm(
            `Scrape & Fill application form?\n\n` +
            `Job: ${jobTitle}\n\n` +
            `This will:\n` +
            `1. Scrape the application form questions\n` +
            `2. Generate AI-powered answers\n` +
            `3. Save planned answers to the job`
        );

        if (!confirmed) return;

        try {
            showToast('Starting Scrape & Fill...', 'info');

            // Open CLI panel to show logs
            if (typeof window.cliPanel !== 'undefined') {
                window.cliPanel.open();
                window.cliPanel.clear();
                window.cliPanel.appendOutput(`[Scrape & Fill] Starting for job ${jobId}...`, 'info');
            }

            const response = await fetch(`/api/runner/operations/${jobId}/scrape-form-answers/stream`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const result = await response.json();

            if (response.ok && result.run_id) {
                showToast(`Scrape & Fill started! Run ID: ${result.run_id}`, 'success');

                // Connect to SSE log stream
                if (result.log_stream_url && typeof window.cliPanel !== 'undefined') {
                    connectToScrapeAndFillStream(result.log_stream_url, jobId);
                }
            } else {
                showToast(result.error || 'Failed to start Scrape & Fill', 'error');
                if (typeof window.cliPanel !== 'undefined') {
                    window.cliPanel.appendOutput(`[ERROR] ${result.error || 'Failed to start Scrape & Fill'}`, 'error');
                }
            }
        } catch (err) {
            showToast('Scrape & Fill failed: ' + err.message, 'error');
            if (typeof window.cliPanel !== 'undefined') {
                window.cliPanel.appendOutput(`[ERROR] ${err.message}`, 'error');
            }
        }
    }

    // Connect to SSE stream for Scrape & Fill logs
    function connectToScrapeAndFillStream(streamUrl, jobId) {
        const eventSource = new EventSource(streamUrl);

        eventSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'log') {
                    window.cliPanel.appendOutput(data.message, data.level || 'info');
                } else if (data.type === 'complete') {
                    window.cliPanel.appendOutput('[Scrape & Fill] Complete!', 'success');
                    showToast('Scrape & Fill complete!', 'success');
                    eventSource.close();
                    // Refresh the batch table to show updated data
                    htmx.trigger('#batch-table-container', 'refresh');
                } else if (data.type === 'error') {
                    window.cliPanel.appendOutput(`[ERROR] ${data.message}`, 'error');
                    showToast('Scrape & Fill failed: ' + data.message, 'error');
                    eventSource.close();
                }
            } catch (e) {
                // Plain text message
                window.cliPanel.appendOutput(event.data, 'info');
            }
        };

        eventSource.onerror = function(err) {
            console.error('SSE error:', err);
            window.cliPanel.appendOutput('[Connection closed]', 'warning');
            eventSource.close();
        };
    }

    // Process single job from batch view
    async function processSingleBatchJob(jobId) {
        const tier = document.getElementById('batch-tier')?.value || 'auto';
        const tierLabels = { 'auto': 'Auto', 'A': 'Gold (A)', 'B': 'Silver (B)', 'C': 'Bronze (C)' };

        const confirmed = confirm(
            `Process this job through the full pipeline?\n\nTier: ${tierLabels[tier] || tier}`
        );

        if (!confirmed) return;

        try {
            showToast('Starting pipeline...', 'info');

            const response = await fetch(`/api/jobs/${jobId}/full-extraction`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tier })
            });

            const result = await response.json();
            if (result.run_id) {
                showToast('Pipeline started! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = `/job/${jobId}?run_id=${result.run_id}`;
                }, 1000);
            } else {
                showToast(result.error || 'Failed to start pipeline', 'error');
            }
        } catch (err) {
            showToast('Pipeline failed: ' + err.message, 'error');
        }
    }

    // Save application URL for a job
    async function saveBatchJobUrl(jobId, url) {
        try {
            const response = await fetch(`/api/jobs/${jobId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ application_url: url })
            });

            if (response.ok) {
                showToast('Application URL saved', 'success');
            } else {
                showToast('Failed to save URL', 'error');
            }
        } catch (err) {
            showToast('Save failed: ' + err.message, 'error');
        }
    }

    // Sync the header checkbox with the main one
    document.addEventListener('DOMContentLoaded', function() {
        const headerCheckbox = document.getElementById('batch-select-all-header');
        const mainCheckbox = document.getElementById('batch-select-all');
        if (headerCheckbox && mainCheckbox) {
            headerCheckbox.addEventListener('change', function() {
                mainCheckbox.checked = this.checked;
                mainCheckbox.dispatchEvent(new Event('change'));
            });
        }
    });
</script>
