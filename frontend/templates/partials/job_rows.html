<!-- Job table with sortable headers and data rows -->
{# Build filter query string for HTMX calls #}
{% set filter_params = [] %}
{% if current_datetime_from %}{% set _ = filter_params.append('datetime_from=' ~ current_datetime_from) %}{% endif %}
{% if current_datetime_to %}{% set _ = filter_params.append('datetime_to=' ~ current_datetime_to) %}{% endif %}
{% for loc in current_locations %}{% set _ = filter_params.append('locations=' ~ (loc | urlencode)) %}{% endfor %}
{% if current_applied_only %}{% set _ = filter_params.append('applied_only=' ~ current_applied_only) %}{% endif %}
{% set filter_query = ('&' ~ filter_params | join('&')) if filter_params else '' %}

<table class="w-full table-fixed theme-table">
    <thead class="sticky-header">
        <tr>
            <!-- Select all checkbox -->
            <th scope="col" class="px-4 py-3 w-10">
                <input type="checkbox"
                       id="select-all"
                       onchange="toggleSelectAll(this)"
                       class="h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500">
            </th>

            {# Column widths: narrow for metadata, wider for role/company #}
            {% set sort_fields = [
                ('createdAt', 'Created', 'hide-mobile', 'w-[70px]'),
                ('company', 'Company', '', 'w-[140px]'),
                ('title', 'Role/Title', '', ''),
                ('location', 'Location', 'hide-mobile', 'w-[50px]'),
                ('url', 'URL', 'hide-mobile', 'w-[100px]'),
                ('jobId', 'Job ID', 'hide-mobile', 'w-[90px]'),
                ('status', 'Status', '', 'w-[100px]'),
                ('pipeline', 'Pipeline', 'hide-mobile', 'w-[80px]'),
                ('score', 'Score', 'hide-mobile', 'w-[60px]')
            ] %}

            {% for field, label, css_class, width_class in sort_fields %}
            {% set is_active = current_sort == field %}
            {% set new_direction = 'asc' if (is_active and current_direction == 'desc') else 'desc' %}
            <th scope="col"
                class="px-2 sm:px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider cursor-pointer hover:theme-bg-hover {{ 'sort-active' if is_active }} {{ css_class }} {{ width_class }}"
                hx-get="/partials/job-rows?sort={{ field }}&direction={{ new_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                hx-target="#job-table-container"
                hx-indicator=".htmx-indicator">
                <div class="flex items-center gap-1">
                    {{ label }}
                    <span class="sort-icon">
                        {% if is_active %}
                            {% if current_direction == 'desc' %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            {% else %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                            {% endif %}
                        {% else %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                            </svg>
                        {% endif %}
                    </span>
                </div>
            </th>
            {% endfor %}

            <!-- Actions column -->
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider w-[90px]">
                Actions
            </th>
        </tr>
    </thead>
    <tbody class="theme-bg-card">
        {% if jobs %}
            {% for job in jobs %}
            {% set job_url = job.url or job.jobUrl %}
            <tr class="job-row cursor-pointer"
                data-job-id="{{ job._id }}"
                onclick="navigateToJob(event, '{{ job._id }}')"
                onmouseenter="prefetchJobOnHover('{{ job._id }}')"
                oncontextmenu="showJobContextMenu(event, '{{ job._id }}', '{{ (job.title or '') | e | replace("'", "\\'") }}'); return false;">
                <!-- Checkbox -->
                <td class="px-4 py-3" onclick="event.stopPropagation()">
                    <input type="checkbox"
                           class="row-checkbox h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500"
                           data-job-id="{{ job._id }}"
                           onchange="toggleRowSelection(this)">
                </td>

                <!-- Created At (DD/MM format) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm theme-text-secondary hide-mobile">
                    {% if job.createdAt %}
                        {{ job.createdAt[8:10] }}/{{ job.createdAt[5:7] }}
                    {% else %}
                        <span class="theme-text-muted">-</span>
                    {% endif %}
                </td>

                <!-- Company -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap">
                    <div class="text-sm font-semibold theme-text-primary">
                        {{ job.company or '-' }}
                    </div>
                    {% if job.auto_discovered %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200" title="Auto-discovered job">
                        {% if job.source == 'indeed_auto' %}
                        <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-3H9V6h2v4z"/></svg>
                        Indeed
                        {% elif job.source == 'himalayas_auto' %}
                        <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z"/></svg>
                        Remote
                        {% else %}
                        Auto
                        {% endif %}
                    </span>
                    {% endif %}
                </td>

                <!-- Role/Title with preview tooltip -->
                {% set desc_preview = (job.description or '')[:200] %}
                {% set tooltip_text = job.title or '' %}
                {% if desc_preview %}
                    {% set tooltip_text = tooltip_text ~ '\n\n' ~ desc_preview ~ ('...' if (job.description or '')|length > 200 else '') %}
                {% endif %}
                {% if job.fit_score is defined and job.fit_score %}
                    {% set fit_val = job.fit_score if job.fit_score is number else job.fit_score.score %}
                    {% if fit_val %}
                        {% set tooltip_text = tooltip_text ~ '\n\nFit Score: ' ~ fit_val ~ '%' %}
                    {% endif %}
                {% endif %}
                <td class="px-2 sm:px-4 py-3 role-col overflow-hidden">
                    <div class="text-sm font-semibold theme-text-primary truncate" title="{{ tooltip_text }}">
                        {% if job_url %}
                        <a href="{{ job_url }}" target="_blank" class="text-accent-500 hover:text-accent-400 hover:underline font-medium" onclick="event.stopPropagation()">
                            {{ job.title or '-' }}
                        </a>
                        {% else %}
                        {{ job.title or '-' }}
                        {% endif %}
                    </div>
                </td>

                <!-- Location (2-letter country code) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm theme-text-secondary hide-mobile location-col" title="{{ job.location or '' }}">
                    {% set cc = job.country_code or '??' %}
                    {% if cc == 'RMT' %}
                        <span class="text-xs font-medium text-purple-600 dark:text-purple-400">rte</span>
                    {% else %}
                        <span class="text-xs font-medium">{{ cc }}</span>
                    {% endif %}
                </td>

                <!-- Job URL -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm hide-mobile" onclick="event.stopPropagation()">
                    {% if job_url %}
                    <a href="{{ job_url }}" target="_blank"
                       class="text-accent-500 hover:text-accent-400 hover:underline flex items-center gap-1 max-w-[120px]"
                       title="{{ job_url }}">
                        <span class="truncate text-xs">{{ job_url | replace('https://', '') | replace('http://', '') | truncate(20, True, '...') }}</span>
                        <svg class="flex-shrink-0 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                    {% else %}
                    <span class="theme-text-muted">-</span>
                    {% endif %}
                </td>

                <!-- Job ID -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap hide-mobile">
                    <span class="text-xs font-mono theme-text-secondary" title="{{ job.jobId or '' }}">
                        {{ (job.jobId or '-')[:12] }}{% if job.jobId and job.jobId|length > 12 %}...{% endif %}
                    </span>
                </td>

                <!-- Status -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap status-col" onclick="event.stopPropagation()">
                    {% set status = job.status or 'not processed' %}
                    {% set status_class = status | replace(' ', '-') %}
                    <select class="text-xs px-2 py-1 rounded-full border-0 cursor-pointer status-{{ status_class }}"
                            onchange="updateStatus('{{ job._id }}', this.value)"
                            style="max-width: 120px;">
                        {% for s in statuses %}
                        <option value="{{ s }}" {{ 'selected' if status == s else '' }}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </td>

                <!-- Pipeline Status (Live WebSocket Badge) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap hide-mobile" onclick="event.stopPropagation()">
                    {% set job_id = job._id | string %}
                    {% include 'components/live_status_badge.html' %}
                </td>

                <!-- Score (Editable - GAP-067) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm hide-mobile score-col" onclick="event.stopPropagation()">
                    <div class="editable-score-container" data-job-id="{{ job._id }}">
                        <!-- Display mode -->
                        <span class="score-display cursor-pointer hover:ring-2 hover:ring-accent-400 hover:ring-offset-1 rounded-full transition-all"
                              onclick="enableScoreEdit(this, '{{ job._id }}', {{ job.score if job.score is not none else 'null' }})"
                              title="Click to edit score">
                            {% if job.score is not none %}
                                {% if job.score >= 80 %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-success">{{ job.score }}</span>
                                {% elif job.score >= 60 %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-warning">{{ job.score }}</span>
                                {% else %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-gray">{{ job.score }}</span>
                                {% endif %}
                            {% else %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-gray cursor-pointer">â€”</span>
                            {% endif %}
                        </span>
                        <!-- Edit mode (hidden by default) -->
                        <input type="number" min="0" max="100"
                               class="score-input hidden w-14 px-2 py-1 text-xs text-center rounded-full border theme-border theme-bg-secondary theme-text-primary focus:ring-2 focus:ring-accent-500"
                               onblur="saveScore(this, '{{ job._id }}')"
                               onkeydown="handleScoreKeydown(event, this, '{{ job._id }}')"
                               value="{{ job.score if job.score is not none else '' }}">
                    </div>
                </td>

                <!-- Actions -->
                <td class="px-4 py-3 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                    <div class="flex items-center gap-2">
                        {% if job_url %}
                        <a href="{{ job_url }}" target="_blank"
                           class="text-accent-500 hover:text-accent-400"
                           title="Open job posting">
                            <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </a>
                        {% endif %}
                        <a href="/job/{{ job._id }}"
                           class="theme-text-secondary hover:text-accent-400"
                           title="View details">
                            <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </a>
                        <button onclick="processJob('{{ job._id }}', '{{ job.title | replace("'", "\\'") | replace('"', '&quot;') }}')"
                                class="inline-flex items-center justify-center w-7 h-7 text-sm rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"
                                title="Process job through pipeline">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="11" class="px-4 py-12 text-center">
                    <svg class="mx-auto h-12 w-12 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium theme-text-primary">No jobs found</h3>
                    <p class="mt-1 text-sm theme-text-secondary">
                        {% if current_query or current_datetime_from or current_datetime_to or current_locations %}
                            No jobs match your filters. Try adjusting your search criteria.
                        {% else %}
                            No jobs in the database yet. Add jobs via the pipeline or seed script.
                        {% endif %}
                    </p>
                </td>
            </tr>
        {% endif %}
    </tbody>
</table>

<!-- Pagination -->
{% if pagination.total_count > 0 %}
<div class="theme-bg-secondary px-4 py-3 flex items-center justify-between theme-border border-t">
    <div class="flex-1 flex justify-between sm:hidden">
        {% if pagination.has_prev %}
        <button hx-get="/partials/job-rows?page={{ pagination.page - 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                hx-target="#job-table-container"
                class="relative inline-flex items-center px-4 py-2 theme-border border text-sm font-medium rounded-md theme-text-primary theme-bg-card hover:theme-bg-hover">
            Previous
        </button>
        {% endif %}
        {% if pagination.has_next %}
        <button hx-get="/partials/job-rows?page={{ pagination.page + 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                hx-target="#job-table-container"
                class="ml-3 relative inline-flex items-center px-4 py-2 theme-border border text-sm font-medium rounded-md theme-text-primary theme-bg-card hover:theme-bg-hover">
            Next
        </button>
        {% endif %}
    </div>
    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
            <p class="text-sm theme-text-secondary">
                Showing
                <span class="font-medium">{{ (pagination.page - 1) * pagination.page_size + 1 }}</span>
                to
                <span class="font-medium">{{ [pagination.page * pagination.page_size, pagination.total_count] | min }}</span>
                of
                <span class="font-medium">{{ pagination.total_count }}</span>
                results
            </p>
        </div>
        <div>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <!-- Previous button -->
                <button {% if not pagination.has_prev %}disabled{% endif %}
                        hx-get="/partials/job-rows?page={{ pagination.page - 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-2 py-2 rounded-l-md theme-border border theme-bg-card text-sm font-medium theme-text-secondary hover:theme-bg-hover disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>

                <!-- Page numbers -->
                {% set start_page = [1, pagination.page - 2] | max %}
                {% set end_page = [pagination.total_pages, pagination.page + 2] | min %}

                {% if start_page > 1 %}
                <button hx-get="/partials/job-rows?page=1&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-primary hover:theme-bg-hover">
                    1
                </button>
                {% if start_page > 2 %}
                <span class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-secondary">...</span>
                {% endif %}
                {% endif %}

                {% for p in range(start_page, end_page + 1) %}
                <button hx-get="/partials/job-rows?page={{ p }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-4 py-2 border text-sm font-medium {{ 'z-10 bg-primary-50 border-primary-500 text-primary-600' if p == pagination.page else 'theme-border theme-bg-card theme-text-primary hover:theme-bg-hover' }}">
                    {{ p }}
                </button>
                {% endfor %}

                {% if end_page < pagination.total_pages %}
                {% if end_page < pagination.total_pages - 1 %}
                <span class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-secondary">...</span>
                {% endif %}
                <button hx-get="/partials/job-rows?page={{ pagination.total_pages }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-primary hover:theme-bg-hover">
                    {{ pagination.total_pages }}
                </button>
                {% endif %}

                <!-- Next button -->
                <button {% if not pagination.has_next %}disabled{% endif %}
                        hx-get="/partials/job-rows?page={{ pagination.page + 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-2 py-2 rounded-r-md theme-border border theme-bg-card text-sm font-medium theme-text-secondary hover:theme-bg-hover disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </nav>
        </div>
    </div>
</div>
{% endif %}
