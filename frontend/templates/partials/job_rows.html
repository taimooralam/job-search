<!-- Job table with sortable headers and data rows -->
{# Build filter query string for HTMX calls #}
{% set filter_params = [] %}
{% if current_datetime_from %}{% set _ = filter_params.append('datetime_from=' ~ current_datetime_from) %}{% endif %}
{% if current_datetime_to %}{% set _ = filter_params.append('datetime_to=' ~ current_datetime_to) %}{% endif %}
{% for loc in current_locations %}{% set _ = filter_params.append('locations=' ~ (loc | urlencode)) %}{% endfor %}
{% if current_applied_only %}{% set _ = filter_params.append('applied_only=' ~ current_applied_only) %}{% endif %}
{% set filter_query = ('&' ~ filter_params | join('&')) if filter_params else '' %}

<table class="w-full table-fixed theme-table">
    <thead class="sticky-header">
        <tr>
            <!-- Select all checkbox -->
            <th scope="col" class="px-4 py-3 w-10">
                <input type="checkbox"
                       id="select-all"
                       onchange="toggleSelectAll(this)"
                       class="h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500">
            </th>

            {# Column widths: narrow for metadata, wider for role/company #}
            {# Total fixed ~650px + flexible role column to fit 1024px+ screens #}
            {% set sort_fields = [
                ('createdAt', 'Created', 'hide-mobile', 'w-[60px]'),
                ('company', 'Company', '', 'w-[100px] max-w-[100px]'),
                ('title', 'Role/Title', '', ''),
                ('location', 'Location', 'hide-mobile', 'w-[40px]'),
                ('url', 'URL', 'hide-tablet', 'w-[80px]'),
                ('jobId', 'Job ID', 'hide-tablet', 'w-[75px]'),
                ('status', 'Status', '', 'w-[90px]'),
                ('pipeline', 'Pipeline', 'hide-mobile', 'w-[70px]'),
                ('score', 'Score', 'hide-mobile', 'w-[50px]')
            ] %}

            {% for field, label, css_class, width_class in sort_fields %}
            {% set is_active = current_sort == field %}
            {% set new_direction = 'asc' if (is_active and current_direction == 'desc') else 'desc' %}
            <th scope="col"
                class="px-2 sm:px-4 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider cursor-pointer hover:theme-bg-hover {{ 'sort-active' if is_active }} {{ css_class }} {{ width_class }}"
                hx-get="/partials/job-rows?sort={{ field }}&direction={{ new_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                hx-target="#job-table-container"
                hx-indicator=".htmx-indicator">
                <div class="flex items-center gap-1">
                    {{ label }}
                    <span class="sort-icon">
                        {% if is_active %}
                            {% if current_direction == 'desc' %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                            {% else %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                            </svg>
                            {% endif %}
                        {% else %}
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                            </svg>
                        {% endif %}
                    </span>
                </div>
            </th>
            {% endfor %}

            <!-- Actions column -->
            <th scope="col" class="px-2 py-3 text-left text-xs font-medium theme-text-secondary uppercase tracking-wider w-[80px]">
                Actions
            </th>
        </tr>
    </thead>
    <tbody class="theme-bg-card">
        {% if jobs %}
            {% for job in jobs %}
            {% set job_url = job.url or job.jobUrl %}
            {% set app_url = job.application_url or job_url %}
            <tr class="job-row cursor-pointer"
                x-data="{ anyPopoverOpen: false }"
                data-job-id="{{ job._id }}"
                onclick="navigateToJob(event, '{{ job._id }}')"
                onmouseenter="prefetchJobOnHover('{{ job._id }}')"
                oncontextmenu="showJobContextMenu(event, '{{ job._id }}', '{{ (job.title or '') | e | replace("'", "\\'") }}', '{{ (job_url or '') | e | replace("'", "\\'") }}'); return false;">
                <!-- Checkbox -->
                <td class="px-4 py-3" onclick="event.stopPropagation()">
                    <input type="checkbox"
                           class="row-checkbox h-4 w-4 rounded theme-border text-accent-500 focus:ring-accent-500"
                           data-job-id="{{ job._id }}"
                           onchange="toggleRowSelection(this)">
                </td>

                <!-- Created At (DD/MM format) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm theme-text-secondary hide-mobile">
                    {% if job.createdAt %}
                        {{ job.createdAt[8:10] }}/{{ job.createdAt[5:7] }}
                    {% else %}
                        <span class="theme-text-muted">-</span>
                    {% endif %}
                </td>

                <!-- Company -->
                <td class="px-2 sm:px-4 py-3 max-w-[120px]">
                    <div class="text-sm font-semibold theme-text-primary truncate" title="{{ job.company or '-' }}">
                        {{ job.company or '-' }}
                    </div>
                    {% if job.source == 'linkedin_import' %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300" title="Imported from LinkedIn">
                        <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M2.5 3.5a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM3 7h3v10H3V7zm5.5 0h3v1.4h.1c.4-.8 1.4-1.7 3-1.7 3.2 0 3.8 2.1 3.8 4.9V17h-3.2v-4.7c0-1.1 0-2.5-1.5-2.5s-1.7 1.2-1.7 2.4V17h-3.5V7z"/></svg>
                        LinkedIn
                    </span>
                    {% elif job.auto_discovered %}
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-800 dark:bg-sky-900 dark:text-sky-200" title="Auto-discovered job">
                        {% if job.source == 'indeed_auto' %}
                        <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-3H9V6h2v4z"/></svg>
                        Indeed
                        {% elif job.source == 'himalayas_auto' %}
                        <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z"/></svg>
                        Remote
                        {% else %}
                        Auto
                        {% endif %}
                    </span>
                    {% endif %}
                </td>

                <!-- Role/Title with hover preview card + Application URL -->
                {% set has_extracted = job.extracted_jd is defined and job.extracted_jd %}
                {% set jd = job.extracted_jd if has_extracted else {} %}
                {% set desc = job.description or job.job_description or job.jobDescription or '' %}
                <td class="px-2 sm:px-4 py-3 role-col overflow-visible relative group"
                    x-data="{ showPreview: false, hoverTimeout: null, leaveTimeout: null }"
                    @mouseenter="if (!anyPopoverOpen) { clearTimeout(leaveTimeout); hoverTimeout = setTimeout(() => showPreview = true, 200) }"
                    @mouseleave="clearTimeout(hoverTimeout); leaveTimeout = setTimeout(() => showPreview = false, 150)">
                    <div class="flex items-center gap-1.5">
                        <div class="text-sm font-semibold theme-text-primary truncate">
                            {% if job_url %}
                            <a href="{{ job_url }}" target="_blank" class="text-accent-500 hover:text-accent-400 hover:underline font-medium" onclick="event.stopPropagation()">
                                {{ job.title or '-' }}
                            </a>
                            {% else %}
                            {{ job.title or '-' }}
                            {% endif %}
                        </div>
                        <!-- Application URL Quick Entry + Quick Open Link -->
                        <div class="relative no-navigate flex-shrink-0 flex items-center gap-0.5"
                             x-data="{ showPopover: false, url: '{{ (app_url or '') | e }}', saving: false }"
                             onclick="event.stopPropagation()">
                            <!-- Quick open link (if URL exists) -->
                            {% if app_url %}
                            <a href="{{ app_url }}" target="_blank"
                               class="p-1 text-green-500 hover:text-green-600 rounded hover:bg-green-50 dark:hover:bg-green-900/30 transition-all"
                               title="Open application form">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </a>
                            {% endif %}
                            <!-- Edit button -->
                            <button @click="showPopover = !showPopover; anyPopoverOpen = showPopover"
                                    class="p-1 rounded transition-all opacity-0 group-hover:opacity-100 theme-text-tertiary hover:theme-text-primary hover:theme-bg-hover"
                                    title="{{ 'Edit application URL' if app_url else 'Set application URL' }}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                            <!-- Popover -->
                            <div x-show="showPopover"
                                 x-cloak
                                 @click.away="showPopover = false; anyPopoverOpen = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="transform opacity-0 scale-95"
                                 x-transition:enter-end="transform opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 x-transition:leave-start="transform opacity-100 scale-100"
                                 x-transition:leave-end="transform opacity-0 scale-95"
                                 class="absolute left-0 top-full mt-1 w-72 p-3 rounded-lg shadow-xl theme-bg-card border theme-border z-50">
                                <label class="block text-xs font-medium theme-text-secondary mb-1.5">Application URL</label>
                                <div class="flex gap-2">
                                    <input type="url"
                                           x-model="url"
                                           class="flex-1 px-2 py-1.5 text-sm rounded border theme-border theme-bg-secondary theme-text-primary focus:ring-2 focus:ring-accent-500 focus:border-accent-500"
                                           placeholder="https://..."
                                           @keydown.enter="saving = true; saveJobApplicationUrl('{{ job._id }}', url).then(() => { saving = false; showPopover = false; anyPopoverOpen = false; })"
                                           @keydown.escape="showPopover = false; anyPopoverOpen = false">
                                    <button @click="saving = true; saveJobApplicationUrl('{{ job._id }}', url).then(() => { saving = false; showPopover = false; anyPopoverOpen = false; })"
                                            :disabled="saving"
                                            class="px-2.5 py-1.5 rounded bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white text-xs font-medium transition flex items-center gap-1">
                                        <template x-if="saving">
                                            <svg class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                            </svg>
                                        </template>
                                        <span x-text="saving ? '' : 'Save'"></span>
                                    </button>
                                </div>
                                <p class="text-xs theme-text-tertiary mt-1.5">Press Enter to save, Escape to cancel</p>
                            </div>
                        </div>
                    </div>

                    <!-- Hover Preview Card -->
                    <div x-show="showPreview && !anyPopoverOpen"
                         x-cloak
                         x-transition:enter="transition ease-out duration-100"
                         x-transition:enter-start="opacity-0 scale-95"
                         x-transition:enter-end="opacity-100 scale-100"
                         x-transition:leave="transition ease-in duration-75"
                         x-transition:leave-start="opacity-100 scale-100"
                         x-transition:leave-end="opacity-0 scale-95"
                         @mouseenter="clearTimeout(leaveTimeout)"
                         @mouseleave="leaveTimeout = setTimeout(() => showPreview = false, 150)"
                         class="absolute left-0 top-full mt-1 job-preview-card rounded-lg shadow-xl theme-bg-card border theme-border z-50 p-4"
                         onclick="event.stopPropagation()">
                        <!-- Header -->
                        <div class="mb-3 pb-2 border-b theme-border">
                            <h4 class="font-semibold theme-text-primary text-sm">{{ job.title or 'Untitled' }}</h4>
                            <p class="text-xs theme-text-secondary">{{ job.company or 'Unknown' }} ‚Ä¢ {{ job.location or 'Location N/A' }}</p>
                        </div>

                        {% if has_extracted %}
                        <!-- Extracted JD Info -->
                        <div class="space-y-2 mb-3">
                            {% if jd.role_category %}
                            <div class="flex items-center gap-2 text-xs">
                                <span class="theme-text-tertiary">üìã Role:</span>
                                <span class="theme-text-primary font-medium">{{ jd.role_category | replace('_', ' ') | title }}</span>
                            </div>
                            {% endif %}
                            {% if jd.seniority_level %}
                            <div class="flex items-center gap-2 text-xs">
                                <span class="theme-text-tertiary">üéØ Level:</span>
                                <span class="theme-text-primary font-medium">{{ jd.seniority_level | title }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Skills -->
                        {% if jd.technical_skills or jd.top_keywords %}
                        <div class="mb-3">
                            <p class="text-xs theme-text-tertiary mb-1">üîß Skills:</p>
                            <div class="flex flex-wrap">
                                {% for skill in (jd.technical_skills or jd.top_keywords or [])[:8] %}
                                <span class="skill-badge">{{ skill }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Key Responsibilities -->
                        {% if jd.responsibilities %}
                        <div class="mb-3 preview-section">
                            <p class="text-xs theme-text-tertiary mb-1 font-medium">üìå Key Responsibilities:</p>
                            <div class="preview-section-scroll">
                                <ul class="space-y-1.5 text-xs theme-text-secondary">
                                    {% for resp in jd.responsibilities %}
                                    <li class="flex items-start gap-1.5">
                                        <span class="text-accent-500 flex-shrink-0 mt-0.5">‚Ä∫</span>
                                        <span>{{ resp }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Required Qualifications -->
                        {% if jd.required_qualifications %}
                        <div class="mb-3 preview-section">
                            <p class="text-xs theme-text-tertiary mb-1 font-medium">‚úì Required Qualifications:</p>
                            <div class="preview-section-scroll">
                                <ul class="space-y-1.5 text-xs theme-text-secondary">
                                    {% for qual in jd.required_qualifications %}
                                    <li class="flex items-start gap-1.5">
                                        <span class="text-green-500 flex-shrink-0 mt-0.5">‚úì</span>
                                        <span>{{ qual }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        {% else %}
                        <!-- Not analyzed notice -->
                        <div class="mb-3 p-2 rounded bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800">
                            <p class="text-xs text-yellow-700 dark:text-yellow-300">‚ö†Ô∏è Not yet analyzed</p>
                        </div>
                        {% endif %}

                        <!-- Description Preview (scrollable) -->
                        {% if desc %}
                        <div class="description-container">
                            <p class="text-xs theme-text-tertiary mb-1">Description:</p>
                            <div class="description-scroll">
                                <p class="text-xs theme-text-secondary description-text">{{ desc }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </td>

                <!-- Location (2-letter country code) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm theme-text-secondary hide-mobile location-col" title="{{ job.location or '' }}">
                    {% set cc = job.country_code or '??' %}
                    {% if cc == 'RMT' %}
                        <span class="text-xs font-medium text-purple-600 dark:text-purple-400">rte</span>
                    {% else %}
                        <span class="text-xs font-medium">{{ cc }}</span>
                    {% endif %}
                </td>

                <!-- Job URL -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm hide-tablet" onclick="event.stopPropagation()">
                    {% if job_url %}
                    <a href="{{ job_url }}" target="_blank"
                       class="text-accent-500 hover:text-accent-400 hover:underline flex items-center gap-1 max-w-[120px]"
                       title="{{ job_url }}">
                        <span class="truncate text-xs">{{ job_url | replace('https://', '') | replace('http://', '') | truncate(20, True, '...') }}</span>
                        <svg class="flex-shrink-0 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                    </a>
                    {% else %}
                    <span class="theme-text-muted">-</span>
                    {% endif %}
                </td>

                <!-- Job ID -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap hide-tablet">
                    <span class="text-xs font-mono theme-text-secondary" title="{{ job.jobId or '' }}">
                        {{ (job.jobId or '-')[:12] }}{% if job.jobId and job.jobId|length > 12 %}...{% endif %}
                    </span>
                </td>

                <!-- Status -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap status-col" onclick="event.stopPropagation()">
                    {% set status = job.status or 'not processed' %}
                    {% set status_class = status | replace(' ', '-') %}
                    <select class="text-xs px-2 py-1 rounded-full border-0 cursor-pointer status-{{ status_class }}"
                            onchange="updateStatus('{{ job._id }}', this.value)"
                            style="max-width: 120px;">
                        {% for s in statuses %}
                        <option value="{{ s }}" {{ 'selected' if status == s else '' }}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </td>

                <!-- Pipeline Status (Live WebSocket Badge) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap hide-mobile" onclick="event.stopPropagation()">
                    {% set job_id = job._id | string %}
                    {% include 'components/live_status_badge.html' %}
                </td>

                <!-- Score (Editable - GAP-067) -->
                <td class="px-2 sm:px-4 py-3 whitespace-nowrap text-sm hide-mobile score-col" onclick="event.stopPropagation()">
                    <div class="editable-score-container" data-job-id="{{ job._id }}">
                        <!-- Display mode -->
                        <span class="score-display cursor-pointer hover:ring-2 hover:ring-accent-400 hover:ring-offset-1 rounded-full transition-all"
                              onclick="enableScoreEdit(this, '{{ job._id }}', {{ job.score if job.score is not none else 'null' }})"
                              title="Click to edit score">
                            {% if job.score is not none %}
                                {% if job.score >= 80 %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-success">{{ job.score }}</span>
                                {% elif job.score >= 60 %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-warning">{{ job.score }}</span>
                                {% else %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-gray">{{ job.score }}</span>
                                {% endif %}
                            {% else %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium badge-gray cursor-pointer">‚Äî</span>
                            {% endif %}
                        </span>
                        <!-- Edit mode (hidden by default) -->
                        <input type="number" min="0" max="100"
                               class="score-input hidden w-14 px-2 py-1 text-xs text-center rounded-full border theme-border theme-bg-secondary theme-text-primary focus:ring-2 focus:ring-accent-500"
                               onblur="saveScore(this, '{{ job._id }}')"
                               onkeydown="handleScoreKeydown(event, this, '{{ job._id }}')"
                               value="{{ job.score if job.score is not none else '' }}">
                    </div>
                </td>

                <!-- Actions -->
                <td class="px-4 py-3 whitespace-nowrap text-sm" onclick="event.stopPropagation()">
                    <div class="flex items-center gap-2">
                        {% if job_url %}
                        <a href="{{ job_url }}" target="_blank"
                           class="text-accent-500 hover:text-accent-400"
                           title="Open job posting">
                            <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </a>
                        {% endif %}
                        <!-- Application URL (popover + quick link) -->
                        <div class="relative group"
                             x-data="{ showPopover: false, url: '{{ (app_url or '') | e }}', saving: false }">
                            <!-- Quick open link (if URL exists) -->
                            {% if app_url %}
                            <a href="{{ app_url }}" target="_blank"
                               class="text-green-500 hover:text-green-600"
                               title="Open application form">
                                <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </a>
                            {% endif %}
                            <!-- Edit button (shows on hover or if no URL) -->
                            <button @click="showPopover = !showPopover; anyPopoverOpen = showPopover"
                                    class="p-0.5 rounded transition-all
                                           {% if not app_url %}theme-text-tertiary hover:theme-text-primary{% else %}opacity-0 group-hover:opacity-100 theme-text-tertiary hover:theme-text-primary ml-0.5{% endif %}"
                                    title="{{ 'Edit application URL' if app_url else 'Set application URL' }}">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                            <!-- Popover -->
                            <div x-show="showPopover"
                                 x-cloak
                                 @click.away="showPopover = false; anyPopoverOpen = false"
                                 x-transition:enter="transition ease-out duration-100"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100"
                                 x-transition:leave="transition ease-in duration-75"
                                 class="absolute right-0 top-full mt-1 w-72 p-3 rounded-lg shadow-xl theme-bg-card border theme-border z-50">
                                <label class="block text-xs font-medium theme-text-secondary mb-1.5">Application URL</label>
                                <div class="flex gap-2">
                                    <input type="url"
                                           x-model="url"
                                           class="flex-1 px-2 py-1.5 text-sm rounded border theme-border theme-bg-secondary theme-text-primary focus:ring-2 focus:ring-accent-500"
                                           placeholder="https://..."
                                           @keydown.enter="saving = true; saveJobApplicationUrl('{{ job._id }}', url).then(() => { saving = false; showPopover = false; anyPopoverOpen = false; })"
                                           @keydown.escape="showPopover = false; anyPopoverOpen = false">
                                    <button @click="saving = true; saveJobApplicationUrl('{{ job._id }}', url).then(() => { saving = false; showPopover = false; anyPopoverOpen = false; })"
                                            :disabled="saving"
                                            class="px-2.5 py-1.5 rounded bg-green-600 hover:bg-green-700 disabled:opacity-50 text-white text-xs font-medium transition flex items-center gap-1">
                                        <template x-if="saving">
                                            <svg class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                            </svg>
                                        </template>
                                        <span x-text="saving ? '' : 'Save'"></span>
                                    </button>
                                </div>
                                <p class="text-xs theme-text-tertiary mt-1.5">Enter to save, Escape to cancel</p>
                            </div>
                        </div>
                        <a href="/job/{{ job._id }}"
                           class="theme-text-secondary hover:text-accent-400"
                           title="View details">
                            <svg class="inline h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </a>
                        <button onclick="processJob('{{ job._id }}', '{{ job.title | replace("'", "\\'") | replace('"', '&quot;') }}')"
                                class="inline-flex items-center justify-center w-7 h-7 text-sm rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"
                                title="Process job through pipeline">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="11" class="px-4 py-12 text-center">
                    <svg class="mx-auto h-12 w-12 theme-text-tertiary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium theme-text-primary">No jobs found</h3>
                    <p class="mt-1 text-sm theme-text-secondary">
                        {% if current_query or current_datetime_from or current_datetime_to or current_locations %}
                            No jobs match your filters. Try adjusting your search criteria.
                        {% else %}
                            No jobs in the database yet. Add jobs via the pipeline or seed script.
                        {% endif %}
                    </p>
                </td>
            </tr>
        {% endif %}
    </tbody>
</table>

<!-- Pagination -->
{% if pagination.total_count > 0 %}
<div class="theme-bg-secondary px-4 py-3 flex items-center justify-between theme-border border-t">
    <div class="flex-1 flex justify-between sm:hidden">
        {% if pagination.has_prev %}
        <button hx-get="/partials/job-rows?page={{ pagination.page - 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                hx-target="#job-table-container"
                class="relative inline-flex items-center px-4 py-2 theme-border border text-sm font-medium rounded-md theme-text-primary theme-bg-card hover:theme-bg-hover">
            Previous
        </button>
        {% endif %}
        {% if pagination.has_next %}
        <button hx-get="/partials/job-rows?page={{ pagination.page + 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                hx-target="#job-table-container"
                class="ml-3 relative inline-flex items-center px-4 py-2 theme-border border text-sm font-medium rounded-md theme-text-primary theme-bg-card hover:theme-bg-hover">
            Next
        </button>
        {% endif %}
    </div>
    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
            <p class="text-sm theme-text-secondary">
                Showing
                <span class="font-medium">{{ (pagination.page - 1) * pagination.page_size + 1 }}</span>
                to
                <span class="font-medium">{{ [pagination.page * pagination.page_size, pagination.total_count] | min }}</span>
                of
                <span class="font-medium">{{ pagination.total_count }}</span>
                results
            </p>
        </div>
        <div>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <!-- Previous button -->
                <button {% if not pagination.has_prev %}disabled{% endif %}
                        hx-get="/partials/job-rows?page={{ pagination.page - 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-2 py-2 rounded-l-md theme-border border theme-bg-card text-sm font-medium theme-text-secondary hover:theme-bg-hover disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>

                <!-- Page numbers -->
                {% set start_page = [1, pagination.page - 2] | max %}
                {% set end_page = [pagination.total_pages, pagination.page + 2] | min %}

                {% if start_page > 1 %}
                <button hx-get="/partials/job-rows?page=1&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-primary hover:theme-bg-hover">
                    1
                </button>
                {% if start_page > 2 %}
                <span class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-secondary">...</span>
                {% endif %}
                {% endif %}

                {% for p in range(start_page, end_page + 1) %}
                <button hx-get="/partials/job-rows?page={{ p }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-4 py-2 border text-sm font-medium {{ 'z-10 bg-primary-50 border-primary-500 text-primary-600' if p == pagination.page else 'theme-border theme-bg-card theme-text-primary hover:theme-bg-hover' }}">
                    {{ p }}
                </button>
                {% endfor %}

                {% if end_page < pagination.total_pages %}
                {% if end_page < pagination.total_pages - 1 %}
                <span class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-secondary">...</span>
                {% endif %}
                <button hx-get="/partials/job-rows?page={{ pagination.total_pages }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-4 py-2 theme-border border theme-bg-card text-sm font-medium theme-text-primary hover:theme-bg-hover">
                    {{ pagination.total_pages }}
                </button>
                {% endif %}

                <!-- Next button -->
                <button {% if not pagination.has_next %}disabled{% endif %}
                        hx-get="/partials/job-rows?page={{ pagination.page + 1 }}&sort={{ current_sort }}&direction={{ current_direction }}&query={{ current_query }}&page_size={{ current_page_size }}{{ filter_query }}"
                        hx-target="#job-table-container"
                        class="relative inline-flex items-center px-2 py-2 rounded-r-md theme-border border theme-bg-card text-sm font-medium theme-text-secondary hover:theme-bg-hover disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </nav>
        </div>
    </div>
</div>
{% endif %}
