name: Frontend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci.yml'
  workflow_dispatch:

env:
  # Use uv for faster pip installs
  UV_SYSTEM_PYTHON: 1

jobs:
  # Frontend tests split into parallel jobs for faster execution
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-group:
          - name: api
            paths: frontend/tests/test_api.py
          - name: filters
            paths: frontend/tests/test_applied_only_filter.py frontend/tests/test_datetime_filter_persistence.py
          - name: cv-editing
            paths: frontend/tests/test_cv_editing.py
          - name: job-detail
            paths: frontend/tests/test_job_detail_enhancements.py

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Cache pip packages (saves ~30-60s)
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-frontend-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-frontend-
            ${{ runner.os }}-pip-

      # Use uv for 10-100x faster installs
      - name: Install uv
        run: pip install uv

      - name: Install dependencies (using uv)
        run: |
          uv pip install flask pymongo python-dotenv pytest pytest-mock pytest-xdist requests

      - name: Run tests (${{ matrix.test-group.name }})
        run: |
          python -m pytest ${{ matrix.test-group.paths }} \
            --tb=short \
            -n auto \
            -q \
            --no-header
        env:
          MONGODB_URI: mongodb://localhost:27017/jobs_test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel
        run: |
          cd frontend
          vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
