name: Runner CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'runner_service/**'
      - 'pdf_service/**'
      - 'Dockerfile.runner'
      - 'Dockerfile.pdf-service'
      - 'docker-compose.runner.yml'
      - 'scripts/run_pipeline.py'
      - 'src/**'
      - 'tests/runner/**'
      - 'tests/pdf_service/**'
      - '.github/workflows/runner-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'runner_service/**'
      - 'pdf_service/**'
      - 'Dockerfile.runner'
      - 'Dockerfile.pdf-service'
      - 'src/**'
      - 'tests/runner/**'
      - 'tests/pdf_service/**'
  workflow_dispatch:  # Allow manual workflow triggers

env:
  REGISTRY: ghcr.io
  RUNNER_IMAGE_NAME: ${{ github.repository }}/runner
  PDF_IMAGE_NAME: ${{ github.repository }}/pdf-service
  # Optimization: Use uv for faster pip installs
  UV_SYSTEM_PYTHON: 1

jobs:
  # Unit tests split into parallel jobs for faster execution
  test-unit:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Split tests into groups that run in parallel
        # Note: No layer2 test files exist currently
        # Optimized: Heavy test files split for <1m execution time
        test-group:
          - name: layer1-3
            paths: tests/unit/test_layer1*.py tests/unit/test_layer3*.py
          - name: layer4
            paths: tests/unit/test_layer4*.py
          - name: layer5-people
            paths: tests/unit/test_layer5_people_mapper.py
          - name: layer5-null
            paths: tests/unit/test_layer5_null_handling.py
          - name: layer6-generators
            paths: tests/unit/test_layer6_cv_generator.py tests/unit/test_layer6_cv_generator_v2.py tests/unit/test_layer6_markdown_cv_generator.py
          - name: layer6-cover-letter
            paths: tests/unit/test_layer6_cover_letter_generator.py tests/unit/test_layer6_cover_letter_generator_v2.py tests/unit/test_layer6_cover_letter_improvements.py
          - name: layer6-outreach
            paths: tests/unit/test_layer6_outreach_generator.py
          - name: layer6-v2-header
            paths: tests/unit/test_layer6_v2_header_generator.py tests/unit/test_layer6_v2_ensemble_header.py
          - name: layer6-v2-role
            paths: tests/unit/test_layer6_v2_role_generator.py tests/unit/test_layer6_v2_role_qa.py tests/unit/test_layer6_v2_grader_improver.py
          - name: layer6-v2-achievement
            paths: tests/unit/test_layer6_v2_achievement_mapper.py
          - name: layer6-v2-cvloader
            paths: tests/unit/test_layer6_v2_cv_loader.py
          - name: layer6-v2-orchestrator-1
            paths: tests/unit/test_layer6_v2_orchestrator.py -k "initializes_with_defaults or initializes_with_custom or builds_default or assembles or builds_reasoning_for or builds_reasoning_with or generate_produces"
          - name: layer6-v2-orchestrator-2
            paths: tests/unit/test_layer6_v2_orchestrator.py -k "handles_generation or node_calls or logs_qa or logs_grade or handles_empty or handles_missing or handles_none"
          - name: layer6-v2-stitcher
            paths: tests/unit/test_layer6_v2_stitcher.py
          - name: layer7
            paths: tests/unit/test_layer7*.py
          - name: analytics
            paths: tests/unit/test_analytics*.py tests/unit/test_annotation_types*.py
          - name: circuit-breaker
            paths: tests/unit/test_circuit_breaker.py
          - name: token-rate
            paths: tests/unit/test_token_tracker.py tests/unit/test_rate_limiter.py
          - name: utilities
            paths: tests/unit/test_agency_detection.py tests/unit/test_ats_checker.py tests/unit/test_common_utils.py tests/unit/test_json_utils.py tests/unit/test_linkedin_scraper.py tests/unit/test_markdown_sanitizer.py tests/unit/test_pain_point_miner.py tests/unit/test_skills_taxonomy.py tests/unit/test_star_enforcement.py tests/unit/test_structured_logger.py tests/unit/test_tracing.py

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Cache pip packages (saves ~30-60s)
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # Use uv for 10-100x faster installs
      - name: Install uv
        run: pip install uv

      - name: Install dependencies (using uv)
        run: |
          uv pip install -r requirements.txt
          uv pip install pytest pytest-asyncio pytest-xdist httpx
          uv pip install -e .

      - name: Run unit tests (${{ matrix.test-group.name }})
        run: |
          python -m pytest ${{ matrix.test-group.paths }} \
            --tb=short \
            -n auto \
            -q \
            --no-header
        env:
          PYTHONPATH: ${{ github.workspace }}
          RUNNER_API_SECRET: test-secret
          ENVIRONMENT: development
          MONGODB_URI: mongodb://localhost:27017/test

  # Service-specific tests run in parallel with matrix
  # Split into fine-grained groups for maximum parallelization (~1-2 min each)
  test-services:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service-group:
          # Each large test file gets its own job for parallel execution
          # runner-api split into 3 groups for parallelization
          - name: runner-api-auth
            paths: tests/runner/test_runner_api.py -k "health or requires_auth or invalid_auth or valid_auth"
          - name: runner-api-jobs-1
            paths: tests/runner/test_runner_api.py -k "run_job_with_profile or bulk_run"
          - name: runner-api-jobs-2
            paths: tests/runner/test_runner_api.py -k "concurrency or missing_job or empty_bulk"
          - name: runner-api-status
            paths: tests/runner/test_runner_api.py -k "get_status or stream_logs or get_artifact or firecrawl"
          - name: executor
            paths: tests/runner/test_executor.py
          - name: pdf-service
            paths: tests/pdf_service/
          - name: pdf-integration
            paths: tests/runner/test_pdf_integration.py
          - name: cross-runner-events
            paths: tests/runner/test_cross_runner_events.py
          - name: master-cv-api
            paths: tests/runner/test_master_cv_api_comprehensive.py
          - name: master-cv-routes
            paths: tests/runner/test_master_cv_routes.py
          - name: outreach-request
            paths: tests/runner/test_outreach_request_model.py

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install uv
        run: pip install uv

      - name: Install dependencies (using uv)
        run: |
          uv pip install -r requirements.txt
          uv pip install pytest pytest-asyncio pytest-xdist httpx
          uv pip install -e .

      - name: Run service tests (${{ matrix.service-group.name }})
        run: |
          python -m pytest ${{ matrix.service-group.paths }} \
            --tb=short \
            -n auto \
            -q \
            --no-header
        env:
          PYTHONPATH: ${{ github.workspace }}
          RUNNER_API_SECRET: test-secret
          ENVIRONMENT: development
          MONGODB_URI: mongodb://localhost:27017/test

  # Detect which services changed and compare against deployed version
  changes:
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    outputs:
      runner: ${{ steps.filter.outputs.runner }}
      pdf-service: ${{ steps.filter.outputs.pdf-service }}
      runner_deployed_sha: ${{ steps.deployed.outputs.runner_sha }}
      pdf_deployed_sha: ${{ steps.deployed.outputs.pdf_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log comparison

      - name: Get deployed versions from running containers
        id: deployed
        run: |
          # Get runner service deployed SHA from container image tag
          RUNNER_IMAGE=$(docker inspect job-runner-runner-1 --format '{{.Config.Image}}' 2>/dev/null || echo "none")
          if [[ "$RUNNER_IMAGE" == *"main-"* ]]; then
            RUNNER_SHA=$(echo "$RUNNER_IMAGE" | grep -oP 'main-\K[a-f0-9]+' | head -1)
          else
            RUNNER_SHA="unknown"
          fi
          echo "runner_sha=$RUNNER_SHA" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Runner deployed: $RUNNER_SHA"

          # Get PDF service deployed SHA
          PDF_IMAGE=$(docker inspect job-runner-pdf-service-1 --format '{{.Config.Image}}' 2>/dev/null || echo "none")
          if [[ "$PDF_IMAGE" == *"main-"* ]]; then
            PDF_SHA=$(echo "$PDF_IMAGE" | grep -oP 'main-\K[a-f0-9]+' | head -1)
          else
            PDF_SHA="unknown"
          fi
          echo "pdf_sha=$PDF_SHA" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ PDF Service deployed: $PDF_SHA"

      - name: Show changes since last deployment
        run: |
          echo "## ðŸ”„ Changes since last deployment"
          echo ""

          # Runner service changes
          RUNNER_SHA="${{ steps.deployed.outputs.runner_sha }}"
          if [[ "$RUNNER_SHA" != "unknown" && "$RUNNER_SHA" != "" ]]; then
            echo "### Runner Service (deployed: $RUNNER_SHA)"
            COMMITS=$(git log --oneline ${RUNNER_SHA}..HEAD -- runner_service/ src/ scripts/ Dockerfile.runner docker-compose.runner.yml requirements.txt 2>/dev/null | head -20)
            if [[ -n "$COMMITS" ]]; then
              echo "\`\`\`"
              echo "$COMMITS"
              echo "\`\`\`"
            else
              echo "âœ… No changes since deployment"
            fi
          else
            echo "### Runner Service"
            echo "âš ï¸ Could not determine deployed version"
          fi
          echo ""

          # PDF service changes
          PDF_SHA="${{ steps.deployed.outputs.pdf_sha }}"
          if [[ "$PDF_SHA" != "unknown" && "$PDF_SHA" != "" ]]; then
            echo "### PDF Service (deployed: $PDF_SHA)"
            COMMITS=$(git log --oneline ${PDF_SHA}..HEAD -- pdf_service/ Dockerfile.pdf-service 2>/dev/null | head -20)
            if [[ -n "$COMMITS" ]]; then
              echo "\`\`\`"
              echo "$COMMITS"
              echo "\`\`\`"
            else
              echo "âœ… No changes since deployment"
            fi
          else
            echo "### PDF Service"
            echo "âš ï¸ Could not determine deployed version"
          fi

      - name: Detect changes since deployment
        id: filter
        run: |
          # Compare against deployed version, not just previous commit
          RUNNER_SHA="${{ steps.deployed.outputs.runner_sha }}"
          PDF_SHA="${{ steps.deployed.outputs.pdf_sha }}"

          # Check runner changes since deployment
          # IMPORTANT: Include docker-compose.runner.yml for env var changes (CORS_ORIGINS, etc.)
          if [[ "$RUNNER_SHA" != "unknown" && "$RUNNER_SHA" != "" ]]; then
            RUNNER_CHANGES=$(git diff --name-only ${RUNNER_SHA}..HEAD -- \
              runner_service/ src/ scripts/ Dockerfile.runner docker-compose.runner.yml requirements.txt 2>/dev/null | wc -l)
            if [[ $RUNNER_CHANGES -gt 0 ]]; then
              echo "runner=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Runner: $RUNNER_CHANGES files changed since $RUNNER_SHA"
            else
              echo "runner=false" >> $GITHUB_OUTPUT
              echo "âœ… Runner: No changes since $RUNNER_SHA"
            fi
          else
            # Unknown deployed version - check against previous commit as fallback
            RUNNER_CHANGES=$(git diff --name-only HEAD~1..HEAD -- \
              runner_service/ src/ scripts/ Dockerfile.runner docker-compose.runner.yml requirements.txt 2>/dev/null | wc -l)
            if [[ $RUNNER_CHANGES -gt 0 ]]; then
              echo "runner=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ Runner: $RUNNER_CHANGES files changed (unknown deployed version)"
            else
              echo "runner=false" >> $GITHUB_OUTPUT
            fi
          fi

          # Check PDF service changes since deployment
          if [[ "$PDF_SHA" != "unknown" && "$PDF_SHA" != "" ]]; then
            PDF_CHANGES=$(git diff --name-only ${PDF_SHA}..HEAD -- \
              pdf_service/ Dockerfile.pdf-service 2>/dev/null | wc -l)
            if [[ $PDF_CHANGES -gt 0 ]]; then
              echo "pdf-service=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ PDF Service: $PDF_CHANGES files changed since $PDF_SHA"
            else
              echo "pdf-service=false" >> $GITHUB_OUTPUT
              echo "âœ… PDF Service: No changes since $PDF_SHA"
            fi
          else
            # Unknown deployed version - check against previous commit as fallback
            PDF_CHANGES=$(git diff --name-only HEAD~1..HEAD -- \
              pdf_service/ Dockerfile.pdf-service 2>/dev/null | wc -l)
            if [[ $PDF_CHANGES -gt 0 ]]; then
              echo "pdf-service=true" >> $GITHUB_OUTPUT
              echo "ðŸ”„ PDF Service: $PDF_CHANGES files changed (unknown deployed version)"
            else
              echo "pdf-service=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Build runner image - only if runner files changed
  build-runner:
    needs: [test-unit, test-services, changes]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && needs.changes.outputs.runner == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/runner
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push runner image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.runner
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Build PDF service image - only if pdf_service files changed
  build-pdf-service:
    needs: [test-unit, test-services, changes]
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && needs.changes.outputs.pdf-service == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/pdf-service
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push pdf-service image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.pdf-service
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Deploy - runs on self-hosted VPS runner (GAP-097 fix)
  # No SSH needed since runner has direct local access to Docker and filesystem
  deploy:
    needs: [build-runner, build-pdf-service, changes]
    runs-on: self-hosted
    # Run if on main AND at least one build job ran (not skipped)
    if: |
      always() &&
      github.ref == 'refs/heads/main' &&
      (needs.build-runner.result == 'success' || needs.build-pdf-service.result == 'success')

    steps:
      - uses: actions/checkout@v4

      - name: Copy deployment files locally
        run: |
          # Copy compose file to job-runner directory (runner is on VPS)
          # github-runner user has access to /root/job-runner via chmod 711 /root
          cp docker-compose.runner.yml /root/job-runner/

          # Copy data directory
          mkdir -p /root/job-runner/data
          cp -r data/master-cv /root/job-runner/data/

          echo "âœ… Files copied locally"

      - name: Deploy services
        run: |
          cd /root/job-runner

          # Images are already built locally by build-runner/build-pdf-service jobs
          # No need to pull from GHCR - just restart with local images
          echo "Restarting services with locally built images..."

          # Restart services
          docker compose -f docker-compose.runner.yml up -d --remove-orphans

          # Clean up old images
          docker system prune -f

          # Wait for services to start (PDF service may take longer due to Playwright)
          echo "Waiting for services to start..."
          sleep 20

          # Check runner health
          echo "Checking runner health..."
          curl -f http://localhost:8000/health || exit 1

          # Check PDF service health via runner's network
          echo "Checking PDF service health..."
          docker exec job-runner-runner-1 curl -f http://pdf-service:8001/health || echo "Warning: PDF service health check failed"

          # Show container status
          docker compose -f docker-compose.runner.yml ps
